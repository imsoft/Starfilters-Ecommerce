---
import { getLangFromUrl, useTranslations } from "@/i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const stats = [
  { 
    label: t('stats.projects'), 
    value: t('stats.projectsNumber')?.trim(),
    image: '/images/home-page/stadistics/anos-de-experiencia.png',
    counterEnd: 40,
    counterPrefix: '+',
    counterSuffix: '',
    counterFormat: 'number'
  },
  { 
    label: t('stats.experience'), 
    value: t('stats.experienceNumber')?.trim(),
    image: '/images/home-page/stadistics/cuartos-limpios-construidos.png',
    counterEnd: 20000,
    counterPrefix: '+',
    counterSuffix: ' m²',
    counterFormat: 'comma'
  },
  { 
    label: t('stats.clients'), 
    value: t('stats.clientsNumber')?.trim(),
    image: '/images/home-page/stadistics/filtros-vendidos.png',
    counterEnd: 1,
    counterPrefix: '+',
    counterSuffix: t('stats.clientsNumberSuffix') ?? ' millón',
    counterFormat: 'number'
  },
];
---

<div id="stats-section" class="bg-background py-12 sm:py-16">
  <div class="mx-auto max-w-7xl px-4 lg:px-6">
    <dl class="grid grid-cols-1 gap-x-8 gap-y-16 text-center lg:grid-cols-3">
      {stats.map((stat) => (
        <div class="mx-auto flex max-w-xs flex-col gap-y-4">
          {stat.value ? (
            <>
              <!-- Imagen de la estadística -->
              <div class="mx-auto mb-2 flex h-20 w-20 items-center justify-center">
                <img 
                  src={stat.image} 
                  alt="" 
                  class="h-16 w-16 object-contain"
                  width="64"
                  height="64"
                  loading="lazy"
                />
              </div>
              <dd 
                class="text-3xl font-semibold tracking-tight text-foreground sm:text-5xl min-h-[2.5rem] sm:min-h-[3rem] flex items-center justify-center"
                data-counter
                data-end={stat.counterEnd}
                data-prefix={stat.counterPrefix}
                data-suffix={stat.counterSuffix}
                data-format={stat.counterFormat}
              >
                {stat.counterPrefix}0{stat.counterSuffix}
              </dd>
              <dt class="text-base/7 text-muted-foreground font-medium">
                {stat.label}
              </dt>
            </>
          ) : (
            <dd class="order-first text-2xl font-semibold tracking-tight text-foreground sm:text-3xl">
              {stat.label}
            </dd>
          )}
        </div>
      ))}
    </dl>
  </div>
</div>

<script>
  function formatCounterValue(current: number, format: string): string {
    if (format === 'comma') {
      return current.toLocaleString('es-MX');
    }
    return String(current);
  }

  function initCounters() {
    const counters = document.querySelectorAll<HTMLElement>('[data-counter]');
    const duration = 2000; // 2 segundos
    const startTime = performance.now();

    const animate = (now: number) => {
      const elapsed = now - startTime;
      const progress = Math.min(elapsed / duration, 1);
      // Easing easeOutQuart para que termine suave
      const eased = 1 - Math.pow(1 - progress, 4);

      counters.forEach((el) => {
        const end = Number(el.dataset.end);
        const prefix = el.dataset.prefix ?? '';
        const suffix = el.dataset.suffix ?? '';
        const format = el.dataset.format ?? 'number';
        const current = Math.round(eased * end);
        const formatted = formatCounterValue(current, format);
        el.textContent = `${prefix}${formatted}${suffix}`;
      });

      if (progress < 1) {
        requestAnimationFrame(animate);
      }
    };

    requestAnimationFrame(animate);
  }

  const observer = new IntersectionObserver(
    (entries) => {
      for (const entry of entries) {
        if (entry.isIntersecting) {
          initCounters();
          observer.disconnect();
          break;
        }
      }
    },
    { threshold: 0.2, rootMargin: '0px 0px -50px 0px' }
  );

  const section = document.getElementById('stats-section');
  if (section) observer.observe(section);
</script>
