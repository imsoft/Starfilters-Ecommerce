---
import { getLangFromUrl, useTranslations } from "@/i18n/utils";
import { sendEmail } from "@/lib/email";

export const prerender = false;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

type ContactFormValues = {
  name: string;
  city: string;
  email: string;
  phone: string;
  company: string;
  message: string;
};

const initialValues: ContactFormValues = {
  name: "",
  city: "",
  email: "",
  phone: "",
  company: "",
  message: "",
};

let formValues: ContactFormValues = { ...initialValues };
let submissionStatus: "success" | "error" | null = null;
let submissionMessage = "";

const alertStyles = {
  success: "border-emerald-300 bg-emerald-50 text-emerald-700",
  error: "border-red-300 bg-red-50 text-red-700",
} as const;

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();

  formValues = {
    name: (formData.get("name")?.toString() ?? "").trim(),
    city: (formData.get("city")?.toString() ?? "").trim(),
    email: (formData.get("email")?.toString() ?? "").trim(),
    phone: (formData.get("phone")?.toString() ?? "").trim(),
    company: (formData.get("company")?.toString() ?? "").trim(),
    message: (formData.get("message")?.toString() ?? "").trim(),
  };

  const hasEmpty = Object.entries(formValues).some(([key, value]) => key !== "company" && value.length === 0);

  if (hasEmpty) {
    submissionStatus = "error";
    submissionMessage = lang === "en" 
      ? "Please fill out all required fields."
      : "Por favor completa todos los campos.";
  } else {
    try {
      const messageHtml = formValues.message.replace(/\n/g, "<br />");
      const emailSent = await sendEmail({
        to: "starinfo@starfilters.mx",
        subject: lang === "en"
          ? `New validation service request - ${formValues.name}`
          : `Nueva solicitud de servicio de validación - ${formValues.name}`,
        html: `
          <h2>${lang === "en" ? "New validation service request" : "Nueva solicitud de servicio de validación"}</h2>
          <p><strong>${lang === "en" ? "Language" : "Idioma"}:</strong> ${lang === "en" ? "English" : "Español"}</p>
          <p><strong>${lang === "en" ? "Name" : "Nombre"}:</strong> ${formValues.name}</p>
          <p><strong>${lang === "en" ? "City" : "Ciudad"}:</strong> ${formValues.city}</p>
          <p><strong>${lang === "en" ? "Email" : "Correo electrónico"}:</strong> ${formValues.email}</p>
          <p><strong>${lang === "en" ? "Phone" : "Teléfono"}:</strong> ${formValues.phone}</p>
          <p><strong>${lang === "en" ? "Company" : "Empresa"}:</strong> ${formValues.company || (lang === "en" ? "N/A" : "N/A")}</p>
          <p><strong>${lang === "en" ? "Message" : "Mensaje"}:</strong><br />${messageHtml}</p>
        `,
        text: lang === "en"
          ? `New validation service request (English)\n\nName: ${formValues.name}\nCity: ${formValues.city}\nEmail: ${formValues.email}\nPhone: ${formValues.phone}\nCompany: ${formValues.company || "N/A"}\n\nMessage:\n${formValues.message}`
          : `Nueva solicitud de servicio de validación (Español)\n\nNombre: ${formValues.name}\nCiudad: ${formValues.city}\nCorreo electrónico: ${formValues.email}\nTeléfono: ${formValues.phone}\nEmpresa: ${formValues.company || "N/A"}\n\nMensaje:\n${formValues.message}`,
      });

      if (emailSent) {
        submissionStatus = "success";
        submissionMessage = lang === "en"
          ? "Thank you for reaching out. Our team will contact you very soon."
          : "Gracias por contactarnos. Nuestro equipo se pondrá en contacto contigo muy pronto.";
        formValues = { ...initialValues };
      } else {
        submissionStatus = "error";
        submissionMessage = lang === "en"
          ? "There was a problem sending your message. Please try again later."
          : "Ocurrió un problema al enviar tu mensaje. Inténtalo nuevamente más tarde.";
      }
    } catch (error) {
      console.error("Error al procesar el formulario de contacto:", error);
      submissionStatus = "error";
      submissionMessage = lang === "en"
        ? "There was a problem sending your message. Please try again later."
        : "Ocurrió un problema al enviar tu mensaje. Inténtalo nuevamente más tarde.";
    }
  }
}
---

<div class="bg-background py-24 sm:py-32">
  <div class="mx-auto max-w-7xl px-6 lg:px-8">
    <div class="mx-auto max-w-2xl lg:text-center">
      <h2 class="text-3xl font-semibold tracking-tight text-foreground sm:text-4xl">
        {t('services.requestSection.title')}
      </h2>
      <p class="mt-6 text-lg/8 text-muted-foreground whitespace-pre-line">
        {t('services.requestSection.description')}
      </p>
    </div>

    <div class="mx-auto mt-16 max-w-2xl lg:mt-24 lg:max-w-4xl">
      <div class="grid gap-16 lg:grid-cols-[1.05fr_1fr]">
        <div class="space-y-6">
          <div class="rounded-2xl border border-border/60 bg-muted/40 p-6 sm:p-8">
            <dl class="space-y-6 text-base text-foreground">
              <div>
                <dt class="text-sm font-semibold uppercase tracking-wide text-primary">
                  {lang === "en" ? "Locations" : "Ubicaciones"}
                </dt>
                <dd class="mt-2 text-lg text-foreground">{t('services.requestSection.locations')}</dd>
              </div>
              <div>
                <dt class="text-sm font-semibold uppercase tracking-wide text-primary">
                  {lang === "en" ? "Phones" : "Teléfonos"}
                </dt>
                <dd class="mt-2 space-y-1 text-lg text-foreground">
                  <p>
                    <a class="hover:text-primary" href="tel:+523338987991">+52 33 3898 7991</a>
                  </p>
                  <p>
                    <a class="hover:text-primary" href="tel:+525550870287">+52 55 5087 0287</a>
                  </p>
                </dd>
              </div>
              <div>
                <dt class="text-sm font-semibold uppercase tracking-wide text-primary">
                  {lang === "en" ? "Email" : "Correo electrónico"}
                </dt>
                <dd class="mt-2 text-lg text-foreground">
                  <a class="hover:text-primary" href={`mailto:${t('services.requestSection.email')}`}>
                    {t('services.requestSection.email')}
                  </a>
                </dd>
              </div>
            </dl>
          </div>
        </div>

        <div class="rounded-2xl border border-border/60 bg-muted/20 p-8 shadow-sm">
          <h3 class="text-2xl font-semibold text-foreground">{t('services.requestSection.formTitle')}</h3>
          <p class="mt-2 text-sm text-muted-foreground">
            {t('services.requestSection.formDescription')}
          </p>

          {submissionStatus && (
            <div class={`mt-6 rounded-lg border px-4 py-3 text-sm ${alertStyles[submissionStatus]}`}>
              {submissionMessage}
            </div>
          )}

          <form method="post" class="mt-8 space-y-6">
            <div class="grid gap-6 sm:grid-cols-2">
              <div>
                <label for="name" class="block text-sm font-medium text-foreground">
                  {t('services.requestSection.fields.name')}
                </label>
                <input
                  id="name"
                  name="name"
                  type="text"
                  required
                  autocomplete="name"
                  value={formValues.name}
                  class="mt-2 block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary"
                />
              </div>
              <div>
                <label for="city" class="block text-sm font-medium text-foreground">
                  {t('services.requestSection.fields.city')}
                </label>
                <input
                  id="city"
                  name="city"
                  type="text"
                  required
                  autocomplete="address-level2"
                  value={formValues.city}
                  class="mt-2 block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary"
                />
              </div>
            </div>

            <div class="grid gap-6 sm:grid-cols-2">
              <div>
                <label for="email" class="block text-sm font-medium text-foreground">
                  {t('services.requestSection.fields.email')}
                </label>
                <input
                  id="email"
                  name="email"
                  type="email"
                  required
                  autocomplete="email"
                  value={formValues.email}
                  class="mt-2 block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary"
                />
              </div>
              <div>
                <label for="phone" class="block text-sm font-medium text-foreground">
                  {t('services.requestSection.fields.phone')}
                </label>
                <input
                  id="phone"
                  name="phone"
                  type="tel"
                  required
                  autocomplete="tel"
                  value={formValues.phone}
                  class="mt-2 block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary"
                />
              </div>
            </div>

            <div>
              <label for="company" class="block text-sm font-medium text-foreground">
                {t('services.requestSection.fields.company')}
              </label>
              <input
                id="company"
                name="company"
                type="text"
                autocomplete="organization"
                value={formValues.company}
                class="mt-2 block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary"
              />
            </div>

            <div>
              <label for="message" class="block text-sm font-medium text-foreground">
                {t('services.requestSection.fields.message')}
              </label>
              <textarea
                id="message"
                name="message"
                required
                rows={5}
                class="mt-2 block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary"
              >{formValues.message}</textarea>
            </div>

            <button
              type="submit"
              class="inline-flex w-full items-center justify-center rounded-md bg-primary px-4 py-2.5 text-sm font-semibold text-primary-foreground shadow-xs transition hover:bg-primary/90 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
            >
              {t('services.requestSection.submitButton')}
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

