---
interface Props {
  id: string;
  name: string;
  initialSizes?: Array<{
    nominal_size: string;
    real_size: string;
    price: number;
    bind_code: string;
  }>;
}

const { id, name, initialSizes = [] } = Astro.props;
---

<div class="space-y-4">
  <div class="flex items-center justify-between">
    <label class="block text-sm font-medium text-gray-700">
      Tamaños/Variantes
    </label>
    <button
      type="button"
      id={`${id}-add-row`}
      class="inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500"
    >
      <svg class="-ml-0.5 mr-1.5 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      Agregar Tamaño
    </button>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            Medida Nominal
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            Medida Real
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            Precio (MXN)
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            Código Bind
          </th>
          <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            Acción
          </th>
        </tr>
      </thead>
      <tbody id={`${id}-tbody`} class="bg-white divide-y divide-gray-200">
        {initialSizes.length > 0 ? (
          initialSizes.map((size, index) => (
            <tr data-row-index={index} class="hover:bg-gray-50">
              <td class="px-4 py-3 whitespace-nowrap">
                <input
                  type="text"
                  name={`${name}[${index}][nominal_size]`}
                  value={size.nominal_size}
                  placeholder='Ej: 9.125" x 9.125" x 3"'
                  class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
              </td>
              <td class="px-4 py-3 whitespace-nowrap">
                <input
                  type="text"
                  name={`${name}[${index}][real_size]`}
                  value={size.real_size}
                  placeholder="Ej: 231 x 231 x 75 mm"
                  class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
              </td>
              <td class="px-4 py-3 whitespace-nowrap">
                <div class="relative">
                  <span class="absolute left-2 top-2 text-gray-500 text-sm">$</span>
                  <input
                    type="number"
                    name={`${name}[${index}][price]`}
                    value={size.price}
                    min="0"
                    step="0.01"
                    placeholder="0.00"
                    class="w-full rounded-md border border-gray-300 pl-6 pr-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  />
                </div>
              </td>
              <td class="px-4 py-3 whitespace-nowrap">
                <input
                  type="text"
                  name={`${name}[${index}][bind_code]`}
                  value={size.bind_code}
                  placeholder="Ej: HGD1"
                  class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-center">
                <button
                  type="button"
                  data-remove-row={index}
                  class="inline-flex items-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white hover:bg-red-700"
                >
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </td>
            </tr>
          ))
        ) : (
          <tr id={`${id}-empty-row`}>
            <td colspan="5" class="px-4 py-8 text-center text-sm text-gray-500">
              No hay tamaños agregados. Haz clic en "Agregar Tamaño" para comenzar.
            </td>
          </tr>
        )}
      </tbody>
    </table>
  </div>

  <!-- Campo hidden para almacenar el JSON de los tamaños -->
  <input
    type="hidden"
    id={`${id}-json`}
    name={name}
    value={JSON.stringify(initialSizes)}
  />
</div>

<script define:vars={{ tableId: id, fieldName: name }}>
  document.addEventListener('DOMContentLoaded', function() {
    const addButton = document.getElementById(`${tableId}-add-row`);
    const tbody = document.getElementById(`${tableId}-tbody`);
    const jsonInput = document.getElementById(`${tableId}-json`);
    let emptyRow = document.getElementById(`${tableId}-empty-row`);

    console.log('ProductSizesTable init:', { addButton: !!addButton, tbody: !!tbody, jsonInput: !!jsonInput });

    if (!addButton || !tbody || !jsonInput) {
      console.error('ProductSizesTable: elementos no encontrados', { addButton, tbody, jsonInput });
      return;
    }

    function updateJson() {
      const rows = tbody.querySelectorAll('tr[data-row-index]');
      const sizes: Array<{nominal_size: string; real_size: string; price: number; bind_code: string}> = [];
      
      rows.forEach((row) => {
        const index = row.getAttribute('data-row-index');
        if (index === null) return;
        
        const nominalInput = row.querySelector(`input[name="${fieldName}[${index}][nominal_size]"]`) as HTMLInputElement;
        const realInput = row.querySelector(`input[name="${fieldName}[${index}][real_size]"]`) as HTMLInputElement;
        const priceInput = row.querySelector(`input[name="${fieldName}[${index}][price]"]`) as HTMLInputElement;
        const bindCodeInput = row.querySelector(`input[name="${fieldName}[${index}][bind_code]"]`) as HTMLInputElement;
        
        if (nominalInput && realInput && priceInput && bindCodeInput) {
          sizes.push({
            nominal_size: nominalInput.value || '',
            real_size: realInput.value || '',
            price: parseFloat(priceInput.value) || 0,
            bind_code: bindCodeInput.value || ''
          });
        }
      });
      
      jsonInput.value = JSON.stringify(sizes);
    }

    function addRow() {
      // Remover fila vacía si existe
      const currentEmptyRow = document.getElementById(`${tableId}-empty-row`);
      if (currentEmptyRow) {
        currentEmptyRow.remove();
      }

      const rows = tbody.querySelectorAll('tr[data-row-index]');
      const newIndex = rows.length;

      const newRow = document.createElement('tr');
      newRow.className = 'hover:bg-gray-50';
      newRow.setAttribute('data-row-index', newIndex.toString());

      newRow.innerHTML = `
        <td class="px-4 py-3 whitespace-nowrap">
          <input
            type="text"
            name="${fieldName}[${newIndex}][nominal_size]"
            placeholder='Ej: 9.125" x 9.125" x 3"'
            class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
          />
        </td>
        <td class="px-4 py-3 whitespace-nowrap">
          <input
            type="text"
            name="${fieldName}[${newIndex}][real_size]"
            placeholder="Ej: 231 x 231 x 75 mm"
            class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
          />
        </td>
        <td class="px-4 py-3 whitespace-nowrap">
          <div class="relative">
            <span class="absolute left-2 top-2 text-gray-500 text-sm">$</span>
            <input
              type="number"
              name="${fieldName}[${newIndex}][price]"
              min="0"
              step="0.01"
              placeholder="0.00"
              class="w-full rounded-md border border-gray-300 pl-6 pr-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
          </div>
        </td>
        <td class="px-4 py-3 whitespace-nowrap">
          <input
            type="text"
            name="${fieldName}[${newIndex}][bind_code]"
            placeholder="Ej: HGD1"
            class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
          />
        </td>
        <td class="px-4 py-3 whitespace-nowrap text-center">
          <button
            type="button"
            data-remove-row="${newIndex}"
            class="inline-flex items-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white hover:bg-red-700"
          >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </td>
      `;

      tbody.appendChild(newRow);

      // Agregar listener al botón de eliminar
      const removeBtn = newRow.querySelector(`[data-remove-row="${newIndex}"]`);
      if (removeBtn) {
        removeBtn.addEventListener('click', () => {
          newRow.remove();
          updateJson();
          // Si no hay más filas, mostrar el mensaje vacío
          if (tbody.querySelectorAll('tr[data-row-index]').length === 0) {
            const emptyRowNew = document.createElement('tr');
            emptyRowNew.id = `${tableId}-empty-row`;
            emptyRowNew.innerHTML = `
              <td colspan="5" class="px-4 py-8 text-center text-sm text-gray-500">
                No hay tamaños agregados. Haz clic en "Agregar Tamaño" para comenzar.
              </td>
            `;
            tbody.appendChild(emptyRowNew);
          }
        });
      }

      // Agregar listeners a los inputs para actualizar JSON
      const inputs = newRow.querySelectorAll('input');
      inputs.forEach(input => {
        input.addEventListener('input', updateJson);
      });

      updateJson();

      // Enfocar el primer input
      const firstInput = newRow.querySelector('input') as HTMLInputElement;
      if (firstInput) firstInput.focus();
    }

    // Agregar listener al botón de agregar
    addButton.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('Botón agregar clickeado');
      addRow();
    });

    // Agregar listeners a los botones de eliminar existentes
    const removeButtons = tbody.querySelectorAll('[data-remove-row]');
    removeButtons.forEach((btn) => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const row = (e.currentTarget as HTMLElement).closest('tr[data-row-index]');
        if (row) {
          row.remove();
          updateJson();
          // Si no hay más filas, mostrar el mensaje vacío
          if (tbody.querySelectorAll('tr[data-row-index]').length === 0) {
            const emptyRowNew = document.createElement('tr');
            emptyRowNew.id = `${tableId}-empty-row`;
            emptyRowNew.innerHTML = `
              <td colspan="5" class="px-4 py-8 text-center text-sm text-gray-500">
                No hay tamaños agregados. Haz clic en "Agregar Tamaño" para comenzar.
              </td>
            `;
            tbody.appendChild(emptyRowNew);
          }
        }
      });
    });

    // Agregar listeners a los inputs existentes
    const existingInputs = tbody.querySelectorAll('input');
    existingInputs.forEach(input => {
      input.addEventListener('input', updateJson);
    });

    // Inicializar JSON
    updateJson();
    console.log('ProductSizesTable: inicializado correctamente');
  });
</script>
