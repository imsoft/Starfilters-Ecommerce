---
interface Props {
  id: string;
  name: string;
  initialSizes?: Array<{
    nominal_size: string;
    real_size: string;
    price: number;
    currency: 'MXN' | 'USD';
    bind_code: string;
  }>;
}

const { id, name, initialSizes = [] } = Astro.props;

// Asegurar que todos los tamaños tengan currency (para datos antiguos)
const normalizedSizes = initialSizes.map(size => ({
  ...size,
  currency: size.currency || 'MXN'
}));
---

<div class="space-y-4" data-sizes-table data-table-id={id} data-field-name={name}>
  <div class="flex items-center justify-between">
    <label class="block text-sm font-medium text-gray-700">
      Tamaños/Variantes
    </label>
    <button
      type="button"
      data-add-size-btn
      class="inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500"
    >
      <svg class="-ml-0.5 mr-1.5 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      Agregar Tamaño
    </button>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            Medida Nominal
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            Medida Real
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            Precio
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            Moneda
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            ID BIND
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            Stock
          </th>
          <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
            Acción
          </th>
        </tr>
      </thead>
      <tbody data-sizes-tbody class="bg-white divide-y divide-gray-200">
        {normalizedSizes.length > 0 ? (
          normalizedSizes.map((size, index) => (
            <tr data-row-index={index} class="hover:bg-gray-50">
              <td class="px-4 py-3 whitespace-nowrap">
                <input
                  type="text"
                  data-field="nominal_size"
                  value={size.nominal_size}
                  placeholder='Ej: 9.125" x 9.125" x 3"'
                  class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
              </td>
              <td class="px-4 py-3 whitespace-nowrap">
                <input
                  type="text"
                  data-field="real_size"
                  value={size.real_size}
                  placeholder="Ej: 231 x 231 x 75 mm"
                  class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
              </td>
              <td class="px-4 py-3 whitespace-nowrap">
                <div class="relative">
                  <span class="absolute left-2 top-2 text-gray-500 text-sm">$</span>
                  <input
                    type="number"
                    data-field="price"
                    value={size.price}
                    min="0"
                    step="0.01"
                    placeholder="0.00"
                    class="w-full rounded-md border border-gray-300 pl-6 pr-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  />
                </div>
              </td>
              <td class="px-4 py-3 whitespace-nowrap">
                <select
                  data-field="currency"
                  class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                >
                  <option value="MXN" selected={size.currency === 'MXN'}>MXN</option>
                  <option value="USD" selected={size.currency === 'USD'}>USD</option>
                </select>
              </td>
              <td class="px-4 py-3 whitespace-nowrap">
                <input
                  type="text"
                  data-field="bind_code"
                  value={size.bind_code}
                  placeholder="Ej: HGD1"
                  class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
              </td>
              <td class="px-4 py-3 whitespace-nowrap">
                <div class="flex items-center gap-2">
                  <span data-field="stock" class="text-sm font-medium text-gray-700 min-w-[60px]">
                    —
                  </span>
                  <button
                    type="button"
                    data-refresh-stock
                    class="inline-flex items-center rounded-md bg-gray-100 px-2 py-1 text-xs font-medium text-gray-700 hover:bg-gray-200"
                    title="Actualizar stock desde Bind"
                  >
                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                  </button>
                </div>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-center">
                <button
                  type="button"
                  data-remove-row
                  class="inline-flex items-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white hover:bg-red-700"
                >
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </td>
            </tr>
          ))
        ) : (
          <tr data-empty-row>
            <td colspan="7" class="px-4 py-8 text-center text-sm text-gray-500">
              No hay tamaños agregados. Haz clic en "Agregar Tamaño" para comenzar.
            </td>
          </tr>
        )}
      </tbody>
    </table>
  </div>

  <!-- Campo hidden para almacenar el JSON de los tamaños -->
  <input
    type="hidden"
    data-sizes-json
    name={name}
    value={JSON.stringify(normalizedSizes)}
  />
</div>

<script>
  function initSizesTable() {
    const tables = document.querySelectorAll('[data-sizes-table]');
    
    tables.forEach(function(container) {
      const tableId = container.getAttribute('data-table-id');
      const fieldName = container.getAttribute('data-field-name');
      const addButton = container.querySelector('[data-add-size-btn]');
      const tbody = container.querySelector('[data-sizes-tbody]');
      const jsonInput = container.querySelector('[data-sizes-json]');

      if (!addButton || !tbody || !jsonInput) {
        console.error('ProductSizesTable: elementos no encontrados para tabla:', tableId);
        return;
      }

      function updateJson() {
        var rows = tbody.querySelectorAll('tr[data-row-index]');
        var sizes = [];

        rows.forEach(function(row) {
          var nominalInput = row.querySelector('[data-field="nominal_size"]');
          var realInput = row.querySelector('[data-field="real_size"]');
          var priceInput = row.querySelector('[data-field="price"]');
          var currencySelect = row.querySelector('[data-field="currency"]');
          var bindCodeInput = row.querySelector('[data-field="bind_code"]');

          // Incluir todas las filas, incluso si algunos campos están vacíos (excepto bind_code que es requerido para guardar)
          if (nominalInput && realInput && priceInput && currencySelect && bindCodeInput) {
            sizes.push({
              nominal_size: nominalInput.value || '',
              real_size: realInput.value || '',
              price: parseFloat(priceInput.value) || 0,
              currency: currencySelect.value || 'MXN',
              bind_code: bindCodeInput.value || ''
            });
          }
        });

        jsonInput.value = JSON.stringify(sizes);
      }

      function showEmptyRow() {
        if (tbody.querySelectorAll('tr[data-row-index]').length === 0) {
          var emptyRow = document.createElement('tr');
          emptyRow.setAttribute('data-empty-row', '');
          emptyRow.innerHTML = '<td colspan="7" class="px-4 py-8 text-center text-sm text-gray-500">No hay tamaños agregados. Haz clic en "Agregar Tamaño" para comenzar.</td>';
          tbody.appendChild(emptyRow);
        }
      }
      
      // Función para buscar stock desde Bind
      async function fetchStockFromBind(bindCode, stockElement, refreshButton) {
        if (!bindCode || !bindCode.trim()) {
          stockElement.textContent = '—';
          return;
        }
        
        // Mostrar estado de carga
        stockElement.textContent = '...';
        refreshButton.disabled = true;
        
        try {
          const response = await fetch(`/api/bind/search-by-code?code=${encodeURIComponent(bindCode.trim())}`);
          const result = await response.json();
          
          if (result.success && result.data && result.data.inventory !== undefined) {
            stockElement.textContent = result.data.inventory.toString();
            stockElement.className = 'text-sm font-medium text-gray-700 min-w-[60px]';
          } else {
            stockElement.textContent = 'N/A';
            stockElement.className = 'text-sm font-medium text-gray-400 min-w-[60px]';
          }
        } catch (error) {
          console.error('Error al obtener stock de Bind:', error);
          stockElement.textContent = 'Error';
          stockElement.className = 'text-sm font-medium text-red-500 min-w-[60px]';
        } finally {
          refreshButton.disabled = false;
        }
      }

      function removeRow(row) {
        row.remove();
        updateJson();
        showEmptyRow();
      }

      function addRow() {
        // Remover fila vacía si existe
        var emptyRow = container.querySelector('[data-empty-row]');
        if (emptyRow) {
          emptyRow.remove();
        }

        var rows = tbody.querySelectorAll('tr[data-row-index]');
        var newIndex = rows.length;

        var newRow = document.createElement('tr');
        newRow.className = 'hover:bg-gray-50';
        newRow.setAttribute('data-row-index', newIndex.toString());

        newRow.innerHTML =
          '<td class="px-4 py-3 whitespace-nowrap">' +
            '<input type="text" data-field="nominal_size" placeholder=\'Ej: 9.125" x 9.125" x 3"\' class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />' +
          '</td>' +
          '<td class="px-4 py-3 whitespace-nowrap">' +
            '<input type="text" data-field="real_size" placeholder="Ej: 231 x 231 x 75 mm" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />' +
          '</td>' +
          '<td class="px-4 py-3 whitespace-nowrap">' +
            '<div class="relative">' +
              '<span class="absolute left-2 top-2 text-gray-500 text-sm">$</span>' +
              '<input type="number" data-field="price" min="0" step="0.01" placeholder="0.00" class="w-full rounded-md border border-gray-300 pl-6 pr-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />' +
            '</div>' +
          '</td>' +
          '<td class="px-4 py-3 whitespace-nowrap">' +
            '<select data-field="currency" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">' +
              '<option value="MXN" selected>MXN</option>' +
              '<option value="USD">USD</option>' +
            '</select>' +
          '</td>' +
          '<td class="px-4 py-3 whitespace-nowrap">' +
            '<input type="text" data-field="bind_code" placeholder="Ej: HGD1" class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />' +
          '</td>' +
          '<td class="px-4 py-3 whitespace-nowrap">' +
            '<div class="flex items-center gap-2">' +
              '<span data-field="stock" class="text-sm font-medium text-gray-700 min-w-[60px]">—</span>' +
              '<button type="button" data-refresh-stock class="inline-flex items-center rounded-md bg-gray-100 px-2 py-1 text-xs font-medium text-gray-700 hover:bg-gray-200" title="Actualizar stock desde Bind">' +
                '<svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                  '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />' +
                '</svg>' +
              '</button>' +
            '</div>' +
          '</td>' +
          '<td class="px-4 py-3 whitespace-nowrap text-center">' +
            '<button type="button" data-remove-row class="inline-flex items-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white hover:bg-red-700">' +
              '<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />' +
              '</svg>' +
            '</button>' +
          '</td>';

        tbody.appendChild(newRow);

        // Agregar listener al botón de eliminar
        var removeBtn = newRow.querySelector('[data-remove-row]');
        if (removeBtn) {
          removeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            removeRow(newRow);
          });
        }

        // Agregar listeners a los inputs y selects para actualizar JSON
        var inputs = newRow.querySelectorAll('input, select');
        inputs.forEach(function(input) {
          input.addEventListener('input', updateJson);
          input.addEventListener('change', updateJson);
        });
        
        // Agregar listener al input de bind_code para buscar stock automáticamente
        var bindCodeInput = newRow.querySelector('[data-field="bind_code"]');
        var stockElement = newRow.querySelector('[data-field="stock"]');
        var refreshButton = newRow.querySelector('[data-refresh-stock]');
        
        if (bindCodeInput && stockElement && refreshButton) {
          // Buscar stock cuando se ingresa o cambia el código (con debounce)
          var stockTimeout;
          bindCodeInput.addEventListener('input', function() {
            clearTimeout(stockTimeout);
            stockTimeout = setTimeout(function() {
              var bindCode = bindCodeInput.value.trim();
              if (bindCode) {
                fetchStockFromBind(bindCode, stockElement, refreshButton);
              } else {
                stockElement.textContent = '—';
              }
            }, 500); // Esperar 500ms después de que el usuario deje de escribir
          });
          
          // Buscar stock cuando se hace clic en el botón de actualizar
          refreshButton.addEventListener('click', function(e) {
            e.preventDefault();
            var bindCode = bindCodeInput.value.trim();
            if (bindCode) {
              fetchStockFromBind(bindCode, stockElement, refreshButton);
            }
          });
        }

        updateJson();

        // Enfocar el primer input
        var firstInput = newRow.querySelector('input');
        if (firstInput) firstInput.focus();
      }

      // Agregar listener al botón de agregar
      addButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        addRow();
      });

      // Agregar listeners a los botones de eliminar existentes
      var removeButtons = tbody.querySelectorAll('[data-remove-row]');
      removeButtons.forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          var row = e.currentTarget.closest('tr[data-row-index]');
          if (row) {
            removeRow(row);
          }
        });
      });

      // Agregar listeners a los inputs y selects existentes
      var existingInputs = tbody.querySelectorAll('input, select');
      existingInputs.forEach(function(input) {
        input.addEventListener('input', updateJson);
        input.addEventListener('change', updateJson);
      });
      
      // Agregar listeners para buscar stock en filas existentes
      var existingRows = tbody.querySelectorAll('tr[data-row-index]');
      existingRows.forEach(function(row) {
        var bindCodeInput = row.querySelector('[data-field="bind_code"]');
        var stockElement = row.querySelector('[data-field="stock"]');
        var refreshButton = row.querySelector('[data-refresh-stock]');
        
        if (bindCodeInput && stockElement && refreshButton) {
          // Buscar stock automáticamente si ya hay un código
          var bindCode = bindCodeInput.value.trim();
          if (bindCode) {
            fetchStockFromBind(bindCode, stockElement, refreshButton);
          }
          
          // Buscar stock cuando se ingresa o cambia el código (con debounce)
          var stockTimeout;
          bindCodeInput.addEventListener('input', function() {
            clearTimeout(stockTimeout);
            stockTimeout = setTimeout(function() {
              var bindCode = bindCodeInput.value.trim();
              if (bindCode) {
                fetchStockFromBind(bindCode, stockElement, refreshButton);
              } else {
                stockElement.textContent = '—';
              }
            }, 500);
          });
          
          // Buscar stock cuando se hace clic en el botón de actualizar
          refreshButton.addEventListener('click', function(e) {
            e.preventDefault();
            var bindCode = bindCodeInput.value.trim();
            if (bindCode) {
              fetchStockFromBind(bindCode, stockElement, refreshButton);
            }
          });
        }
      });

      // Inicializar JSON
      updateJson();
    });
  }

  // Ejecutar cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSizesTable);
  } else {
    initSizesTable();
  }
</script>
