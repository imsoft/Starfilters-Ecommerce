---
// Componente simplificado para la creaci√≥n de categor√≠as/productos
// Guarda las im√°genes temporalmente hasta que se cree el registro
---

<div class="space-y-8">
  <!-- Imagen Principal -->
  <div class="rounded-lg border border-gray-200 bg-white p-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Imagen Principal</h3>
    <p class="text-sm text-gray-600 mb-4">
      Esta imagen se mostrar√° como la imagen principal.
    </p>
    
    <div class="space-y-4">
      <!-- Preview de imagen principal -->
      <div id="primary-image-preview" class="hidden">
        <div class="relative inline-block">
          <img
            id="primary-image-preview-img"
            src=""
            alt="Vista previa imagen principal"
            class="h-48 w-48 rounded-lg border border-gray-300 object-cover"
          />
          <button
            type="button"
            id="remove-primary-image"
            class="absolute -top-2 -right-2 rounded-full bg-red-500 p-1 text-white hover:bg-red-600"
            title="Eliminar imagen"
          >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Campo hidden para la imagen principal procesada -->
      <input type="hidden" id="pending_primary_image" name="pending_primary_image" value="" />
      <input type="hidden" id="pending_primary_image_name" name="pending_primary_image_name" value="" />

      <!-- Uploader de imagen principal -->
      <div>
        <label
          for="primary-image-input"
          class="flex cursor-pointer items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 px-4 py-6 hover:border-gray-400"
        >
          <div class="text-center">
            <svg
              class="mx-auto h-12 w-12 text-gray-400"
              stroke="currentColor"
              fill="none"
              viewBox="0 0 48 48"
            >
              <path
                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <p class="mt-2 text-sm text-gray-600">
              <span class="font-semibold">Click para subir</span> o arrastra y suelta
            </p>
            <p class="text-xs text-gray-500">PNG, JPG, GIF hasta 10MB</p>
          </div>
          <input
            type="file"
            id="primary-image-input"
            accept="image/*"
            class="hidden"
          />
        </label>
        <div id="primary-image-upload-status" class="mt-2 text-sm"></div>
      </div>
    </div>
  </div>

  <!-- Im√°genes de Carrusel -->
  <div class="rounded-lg border border-gray-200 bg-white p-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="text-lg font-semibold text-gray-900">Im√°genes de Carrusel</h3>
        <p class="text-sm text-gray-600 mt-1">
          Puedes agregar hasta 4 im√°genes adicionales para el carrusel.
        </p>
      </div>
      <span class="text-sm text-gray-500" id="carousel-count">
        0/4
      </span>
    </div>

    <!-- Galer√≠a de im√°genes de carrusel -->
    <div id="carousel-images-preview" class="mb-6 grid grid-cols-2 gap-4 md:grid-cols-4 hidden">
      <!-- Las im√°genes se mostrar√°n aqu√≠ din√°micamente -->
    </div>

    <!-- Campo hidden para las im√°genes de carrusel procesadas -->
    <input type="hidden" id="pending_carousel_images" name="pending_carousel_images" value="" />

    <!-- Uploader de im√°genes de carrusel -->
    <div>
      <label
        for="carousel-image-input"
        class="flex cursor-pointer items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 px-4 py-6 hover:border-gray-400"
      >
        <div class="text-center">
          <svg
            class="mx-auto h-12 w-12 text-gray-400"
            stroke="currentColor"
            fill="none"
            viewBox="0 0 48 48"
          >
            <path
              d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <p class="mt-2 text-sm text-gray-600">
            <span class="font-semibold">Click para agregar</span> im√°genes al carrusel
          </p>
          <p class="text-xs text-gray-500">PNG, JPG, GIF hasta 10MB</p>
        </div>
        <input
          type="file"
          id="carousel-image-input"
          accept="image/*"
          multiple
          class="hidden"
        />
      </label>
      <div id="carousel-image-upload-status" class="mt-2 text-sm"></div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    console.log('üñºÔ∏è CategoryImageManagerCreate: Inicializando...');
    
    // Variables para almacenar las im√°genes como base64 (ya procesadas)
    let primaryImageBase64 = '';
    let primaryImageName = '';
    const carouselImagesData = [];
    const maxCarouselImages = 4;

    // ===== ELEMENTOS DEL DOM =====
    const primaryImageInput = document.getElementById('primary-image-input');
    const primaryImagePreview = document.getElementById('primary-image-preview');
    const primaryImagePreviewImg = document.getElementById('primary-image-preview-img');
    const removePrimaryImageBtn = document.getElementById('remove-primary-image');
    const primaryImageUploadStatus = document.getElementById('primary-image-upload-status');
    const pendingPrimaryImageField = document.getElementById('pending_primary_image');
    const pendingPrimaryImageNameField = document.getElementById('pending_primary_image_name');

    const carouselImageInput = document.getElementById('carousel-image-input');
    const carouselImageUploadStatus = document.getElementById('carousel-image-upload-status');
    const carouselImagesPreview = document.getElementById('carousel-images-preview');
    const carouselCount = document.getElementById('carousel-count');
    const pendingCarouselImagesField = document.getElementById('pending_carousel_images');

    // ===== FUNCIONES HELPER =====
    function updateCarouselCount() {
      if (carouselCount) {
        carouselCount.textContent = `${carouselImagesData.length}/${maxCarouselImages}`;
      }
    }

    function updateHiddenFields() {
      // Actualizar campos hidden con los datos procesados
      if (pendingPrimaryImageField) {
        pendingPrimaryImageField.value = primaryImageBase64;
      }
      if (pendingPrimaryImageNameField) {
        pendingPrimaryImageNameField.value = primaryImageName;
      }
      if (pendingCarouselImagesField) {
        pendingCarouselImagesField.value = carouselImagesData.length > 0 
          ? JSON.stringify(carouselImagesData) 
          : '';
      }
      
      console.log('üñºÔ∏è Campos hidden actualizados:', {
        primaryImage: primaryImageBase64 ? 'S√≠' : 'No',
        carouselImages: carouselImagesData.length
      });
    }

    function renderCarouselPreviews() {
      if (!carouselImagesPreview) return;

      if (carouselImagesData.length === 0) {
        carouselImagesPreview.classList.add('hidden');
        return;
      }

      carouselImagesPreview.classList.remove('hidden');
      carouselImagesPreview.innerHTML = '';

      carouselImagesData.forEach((imageData, index) => {
        const div = document.createElement('div');
        div.className = 'relative group';
        div.innerHTML = `
          <img
            src="${imageData.data}"
            alt="Carrusel ${index + 1}"
            class="h-32 w-full rounded-lg border border-gray-300 object-cover"
          />
          <button
            type="button"
            data-carousel-index="${index}"
            class="remove-carousel-btn absolute -top-2 -right-2 hidden rounded-full bg-red-500 p-1 text-white hover:bg-red-600 group-hover:block"
            title="Eliminar imagen"
          >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
          <span class="absolute bottom-1 left-1 bg-black/50 text-white text-xs px-2 py-0.5 rounded">${imageData.name}</span>
        `;
        carouselImagesPreview.appendChild(div);

        // Agregar listener para eliminar
        const removeBtn = div.querySelector('.remove-carousel-btn');
        if (removeBtn) {
          removeBtn.addEventListener('click', () => {
            carouselImagesData.splice(index, 1);
            renderCarouselPreviews();
            updateCarouselCount();
            updateHiddenFields();
            
            if (carouselImageUploadStatus) {
              carouselImageUploadStatus.textContent = `‚úÖ Imagen eliminada. ${carouselImagesData.length} imagen(es) en cola.`;
              carouselImageUploadStatus.className = 'mt-2 text-sm text-green-600';
            }
          });
        }
      });
    }

    // ===== IMAGEN PRINCIPAL =====
    if (primaryImageInput) {
      primaryImageInput.addEventListener('change', async (e) => {
        const target = e.target;
        const file = target && target.files ? target.files[0] : null;
        if (!file) return;

        console.log('üñºÔ∏è Procesando imagen principal:', file.name);

        // Validar tama√±o (10MB)
        if (file.size > 10 * 1024 * 1024) {
          if (primaryImageUploadStatus) {
            primaryImageUploadStatus.textContent = '‚ùå La imagen debe ser menor a 10MB';
            primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
          }
          return;
        }

        // Validar tipo
        if (!file.type.startsWith('image/')) {
          if (primaryImageUploadStatus) {
            primaryImageUploadStatus.textContent = '‚ùå El archivo debe ser una imagen';
            primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
          }
          return;
        }

        try {
          // Convertir a base64 inmediatamente
          const base64 = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });

          primaryImageBase64 = base64;
          primaryImageName = file.name;

          // Mostrar preview
          if (primaryImagePreviewImg) {
            primaryImagePreviewImg.src = base64;
          }
          if (primaryImagePreview) {
            primaryImagePreview.classList.remove('hidden');
          }
          if (primaryImageUploadStatus) {
            primaryImageUploadStatus.textContent = '‚úÖ Imagen lista para subir';
            primaryImageUploadStatus.className = 'mt-2 text-sm text-green-600';
          }

          // Actualizar campos hidden
          updateHiddenFields();
          
          console.log('‚úÖ Imagen principal procesada:', file.name);
        } catch (err) {
          console.error('‚ùå Error procesando imagen principal:', err);
          if (primaryImageUploadStatus) {
            primaryImageUploadStatus.textContent = '‚ùå Error al procesar la imagen';
            primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
          }
        }
      });
    }

    if (removePrimaryImageBtn) {
      removePrimaryImageBtn.addEventListener('click', () => {
        primaryImageBase64 = '';
        primaryImageName = '';
        
        if (primaryImagePreview) {
          primaryImagePreview.classList.add('hidden');
        }
        if (primaryImageInput) {
          primaryImageInput.value = '';
        }
        if (primaryImageUploadStatus) {
          primaryImageUploadStatus.textContent = '';
        }

        updateHiddenFields();
        console.log('üñºÔ∏è Imagen principal eliminada');
      });
    }

    // ===== IM√ÅGENES DE CARRUSEL =====
    if (carouselImageInput) {
      carouselImageInput.addEventListener('change', async (e) => {
        const target = e.target;
        const files = target && target.files ? Array.from(target.files) : [];
        if (files.length === 0) return;

        console.log('üñºÔ∏è Procesando im√°genes de carrusel:', files.length);

        const availableSlots = maxCarouselImages - carouselImagesData.length;
        const filesToAdd = files.slice(0, availableSlots);

        if (files.length > availableSlots) {
          if (carouselImageUploadStatus) {
            carouselImageUploadStatus.textContent = `‚ö†Ô∏è Solo se agregar√°n ${availableSlots} imagen(es) (m√°ximo 4)`;
            carouselImageUploadStatus.className = 'mt-2 text-sm text-yellow-600';
          }
        }

        let addedCount = 0;
        for (const file of filesToAdd) {
          // Validar tama√±o (10MB)
          if (file.size > 10 * 1024 * 1024) {
            console.warn(`‚ö†Ô∏è ${file.name} es muy grande, saltando...`);
            continue;
          }

          // Validar tipo
          if (!file.type.startsWith('image/')) {
            console.warn(`‚ö†Ô∏è ${file.name} no es una imagen, saltando...`);
            continue;
          }

          try {
            // Convertir a base64 inmediatamente
            const base64 = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });

            carouselImagesData.push({
              name: file.name,
              data: base64
            });
            addedCount++;
            console.log(`‚úÖ Imagen de carrusel procesada: ${file.name}`);
          } catch (err) {
            console.error(`‚ùå Error procesando ${file.name}:`, err);
          }
        }

        renderCarouselPreviews();
        updateCarouselCount();
        updateHiddenFields();

        if (carouselImageUploadStatus && addedCount > 0) {
          carouselImageUploadStatus.textContent = `‚úÖ ${addedCount} imagen(es) lista(s) para subir. Total: ${carouselImagesData.length}`;
          carouselImageUploadStatus.className = 'mt-2 text-sm text-green-600';
        }

        // Limpiar input
        carouselImageInput.value = '';
      });
    }

    console.log('üñºÔ∏è CategoryImageManagerCreate: Inicializado correctamente');
  });
</script>
