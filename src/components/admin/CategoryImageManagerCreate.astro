---
// Componente simplificado para la creaci√≥n de categor√≠as/productos
// Guarda las im√°genes temporalmente hasta que se cree el registro
---

<div class="space-y-8">
  <!-- Imagen Principal -->
  <div class="rounded-lg border border-gray-200 bg-white p-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Imagen Principal</h3>
    <p class="text-sm text-gray-600 mb-4">
      Esta imagen se mostrar√° como la imagen principal de la categor√≠a.
    </p>
    
    <div class="space-y-4">
      <!-- Preview de imagen principal -->
      <div id="primary-image-preview" class="hidden">
        <div class="relative inline-block">
          <img
            id="primary-image-preview-img"
            src=""
            alt="Vista previa imagen principal"
            class="h-48 w-48 rounded-lg border border-gray-300 object-cover"
          />
          <button
            type="button"
            id="remove-primary-image"
            class="absolute -top-2 -right-2 rounded-full bg-red-500 p-1 text-white hover:bg-red-600"
            title="Eliminar imagen"
          >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Campo hidden para la imagen principal procesada -->
      <input type="hidden" id="pending_primary_image" name="pending_primary_image" value="" />
      <input type="hidden" id="pending_primary_image_name" name="pending_primary_image_name" value="" />

      <!-- Uploader de imagen principal -->
      <div>
        <label
          for="primary-image-input"
          class="flex cursor-pointer items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 px-4 py-6 hover:border-gray-400"
        >
          <div class="text-center">
            <svg
              class="mx-auto h-12 w-12 text-gray-400"
              stroke="currentColor"
              fill="none"
              viewBox="0 0 48 48"
            >
              <path
                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <p class="mt-2 text-sm text-gray-600">
              <span class="font-semibold">Click para subir</span> o arrastra y suelta
            </p>
            <p class="text-xs text-gray-500">PNG, JPG, GIF hasta 10MB</p>
          </div>
          <input
            type="file"
            id="primary-image-input"
            accept="image/*"
            class="hidden"
          />
        </label>
        <div id="primary-image-upload-status" class="mt-2 text-sm"></div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    console.log('üñºÔ∏è CategoryImageManagerCreate: Inicializando...');
    
    // Variables para almacenar la imagen principal como base64
    let primaryImageBase64 = '';
    let primaryImageName = '';

    // ===== ELEMENTOS DEL DOM =====
    const primaryImageInput = document.getElementById('primary-image-input');
    const primaryImagePreview = document.getElementById('primary-image-preview');
    const primaryImagePreviewImg = document.getElementById('primary-image-preview-img');
    const removePrimaryImageBtn = document.getElementById('remove-primary-image');
    const primaryImageUploadStatus = document.getElementById('primary-image-upload-status');
    const pendingPrimaryImageField = document.getElementById('pending_primary_image');
    const pendingPrimaryImageNameField = document.getElementById('pending_primary_image_name');

    // ===== FUNCIONES HELPER =====
    function updateHiddenFields() {
      // Actualizar campos hidden con los datos procesados
      if (pendingPrimaryImageField) {
        pendingPrimaryImageField.value = primaryImageBase64;
      }
      if (pendingPrimaryImageNameField) {
        pendingPrimaryImageNameField.value = primaryImageName;
      }
      
      console.log('üñºÔ∏è Campo pending_primary_image actualizado:', {
        hasImage: !!primaryImageBase64,
        imageName: primaryImageName
      });
    }
    
    // Asegurar que los campos se actualicen antes de enviar el formulario
    const form = document.querySelector('form');
    if (form) {
      // Actualizar campos ANTES de enviar
      form.addEventListener('submit', (e) => {
        updateHiddenFields();
        
        // Asegurar imagen principal
        if (primaryImageBase64) {
          if (pendingPrimaryImageField) {
            pendingPrimaryImageField.value = primaryImageBase64;
          }
          if (pendingPrimaryImageNameField) {
            pendingPrimaryImageNameField.value = primaryImageName;
          }
        }
      });
      
      // Actualizar campos peri√≥dicamente (cada 500ms) para asegurar que siempre est√©n sincronizados
      setInterval(() => {
        updateHiddenFields();
      }, 500);
    }

    // ===== IMAGEN PRINCIPAL =====
    if (primaryImageInput) {
      primaryImageInput.addEventListener('change', async (e) => {
        const target = e.target;
        const file = target && target.files ? target.files[0] : null;
        if (!file) return;

        console.log('üñºÔ∏è Procesando imagen principal:', file.name);

        // Validar tama√±o (10MB)
        if (file.size > 10 * 1024 * 1024) {
          if (primaryImageUploadStatus) {
            primaryImageUploadStatus.textContent = '‚ùå La imagen debe ser menor a 10MB';
            primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
          }
          return;
        }

        // Validar tipo
        if (!file.type.startsWith('image/')) {
          if (primaryImageUploadStatus) {
            primaryImageUploadStatus.textContent = '‚ùå El archivo debe ser una imagen';
            primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
          }
          return;
        }

        try {
          // Convertir a base64 inmediatamente
          const base64 = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });

          primaryImageBase64 = base64;
          primaryImageName = file.name;

          // Mostrar preview
          if (primaryImagePreviewImg) {
            primaryImagePreviewImg.src = base64;
          }
          if (primaryImagePreview) {
            primaryImagePreview.classList.remove('hidden');
          }
          if (primaryImageUploadStatus) {
            primaryImageUploadStatus.textContent = '‚úÖ Imagen lista para subir';
            primaryImageUploadStatus.className = 'mt-2 text-sm text-green-600';
          }

          // Actualizar campos hidden
          updateHiddenFields();
          
          console.log('‚úÖ Imagen principal procesada:', file.name);
        } catch (err) {
          console.error('‚ùå Error procesando imagen principal:', err);
          if (primaryImageUploadStatus) {
            primaryImageUploadStatus.textContent = '‚ùå Error al procesar la imagen';
            primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
          }
        }
      });
    }

    if (removePrimaryImageBtn) {
      removePrimaryImageBtn.addEventListener('click', () => {
        primaryImageBase64 = '';
        primaryImageName = '';
        
        if (primaryImagePreview) {
          primaryImagePreview.classList.add('hidden');
        }
        if (primaryImageInput) {
          primaryImageInput.value = '';
        }
        if (primaryImageUploadStatus) {
          primaryImageUploadStatus.textContent = '';
        }

        updateHiddenFields();
        console.log('üñºÔ∏è Imagen principal eliminada');
      });
    }

    console.log('üñºÔ∏è CategoryImageManagerCreate: Inicializado correctamente');
  });
</script>
