---
// Componente simplificado para la creaci√≥n de categor√≠as
// Guarda las im√°genes temporalmente hasta que se cree la categor√≠a
---

<div class="space-y-8">
  <!-- Imagen Principal -->
  <div class="rounded-lg border border-gray-200 bg-white p-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Imagen Principal</h3>
    <p class="text-sm text-gray-600 mb-4">
      Esta imagen se mostrar√° como la imagen principal de la categor√≠a.
    </p>
    
    <div class="space-y-4">
      <!-- Preview de imagen principal -->
      <div id="primary-image-preview" class="hidden">
        <div class="relative inline-block">
          <img
            id="primary-image-preview-img"
            src=""
            alt="Vista previa imagen principal"
            class="h-48 w-48 rounded-lg border border-gray-300 object-cover"
          />
          <button
            type="button"
            id="remove-primary-image"
            class="absolute -top-2 -right-2 rounded-full bg-red-500 p-1 text-white hover:bg-red-600"
            title="Eliminar imagen"
          >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <input type="hidden" id="primary-image-url" name="main_image" value="" />
      </div>

      <!-- Uploader de imagen principal -->
      <div>
        <label
          for="primary-image-input"
          class="flex cursor-pointer items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 px-4 py-6 hover:border-gray-400"
        >
          <div class="text-center">
            <svg
              class="mx-auto h-12 w-12 text-gray-400"
              stroke="currentColor"
              fill="none"
              viewBox="0 0 48 48"
            >
              <path
                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <p class="mt-2 text-sm text-gray-600">
              <span class="font-semibold">Click para subir</span> o arrastra y suelta
            </p>
            <p class="text-xs text-gray-500">PNG, JPG, GIF hasta 10MB</p>
          </div>
          <input
            type="file"
            id="primary-image-input"
            accept="image/*"
            class="hidden"
          />
        </label>
        <div id="primary-image-upload-status" class="mt-2 text-sm"></div>
        <p class="mt-2 text-xs text-gray-500">
          La imagen se subir√° a Cloudinary despu√©s de crear la categor√≠a.
        </p>
      </div>
    </div>
  </div>

  <!-- Im√°genes de Carrusel -->
  <div class="rounded-lg border border-gray-200 bg-white p-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="text-lg font-semibold text-gray-900">Im√°genes de Carrusel</h3>
        <p class="text-sm text-gray-600 mt-1">
          Puedes agregar hasta 4 im√°genes adicionales para el carrusel.
        </p>
      </div>
      <span class="text-sm text-gray-500" id="carousel-count">
        0/4
      </span>
    </div>

    <!-- Galer√≠a de im√°genes de carrusel -->
    <div id="carousel-images-preview" class="mb-6 grid grid-cols-2 gap-4 md:grid-cols-4 hidden">
      <!-- Las im√°genes se mostrar√°n aqu√≠ din√°micamente -->
    </div>

    <!-- Uploader de im√°genes de carrusel -->
    <div>
      <label
        for="carousel-image-input"
        class="flex cursor-pointer items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 px-4 py-6 hover:border-gray-400"
      >
        <div class="text-center">
          <svg
            class="mx-auto h-12 w-12 text-gray-400"
            stroke="currentColor"
            fill="none"
            viewBox="0 0 48 48"
          >
            <path
              d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <p class="mt-2 text-sm text-gray-600">
            <span class="font-semibold">Click para subir</span> o arrastra y suelta
          </p>
          <p class="text-xs text-gray-500">PNG, JPG, GIF hasta 10MB</p>
        </div>
        <input
          type="file"
          id="carousel-image-input"
          accept="image/*"
          multiple
          class="hidden"
        />
      </label>
      <div id="carousel-image-upload-status" class="mt-2 text-sm"></div>
      <p class="mt-2 text-xs text-gray-500">
        Las im√°genes se subir√°n a Cloudinary despu√©s de crear la categor√≠a.
      </p>
    </div>
  </div>
</div>

<script>
  // Almacenar im√°genes temporalmente
  let primaryImageFile: File | null = null;
  const carouselImageFiles: File[] = [];

  // ===== IMAGEN PRINCIPAL =====
  const primaryImageInput = document.getElementById('primary-image-input');
  const primaryImagePreview = document.getElementById('primary-image-preview');
  const primaryImagePreviewImg = document.getElementById('primary-image-preview-img');
  const primaryImageUrl = document.getElementById('primary-image-url') as HTMLInputElement;
  const removePrimaryImageBtn = document.getElementById('remove-primary-image');
  const primaryImageUploadStatus = document.getElementById('primary-image-upload-status');

  if (primaryImageInput) {
    primaryImageInput.addEventListener('change', (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (!file) return;

      // Validar tama√±o (10MB)
      if (file.size > 10 * 1024 * 1024) {
        if (primaryImageUploadStatus) {
          primaryImageUploadStatus.textContent = '‚ùå La imagen debe ser menor a 10MB';
          primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
        }
        return;
      }

      // Validar tipo
      if (!file.type.startsWith('image/')) {
        if (primaryImageUploadStatus) {
          primaryImageUploadStatus.textContent = '‚ùå El archivo debe ser una imagen';
          primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
        }
        return;
      }

      // Guardar archivo temporalmente
      primaryImageFile = file;

      // Mostrar preview
      const reader = new FileReader();
      reader.onload = (e) => {
        if (primaryImagePreviewImg && e.target?.result) {
          primaryImagePreviewImg.src = e.target.result as string;
        }
        if (primaryImagePreview) {
          primaryImagePreview.classList.remove('hidden');
        }
        if (primaryImageUploadStatus) {
          primaryImageUploadStatus.textContent = '‚úÖ Imagen seleccionada (se subir√° al crear la categor√≠a)';
          primaryImageUploadStatus.className = 'mt-2 text-sm text-green-600';
        }
      };
      reader.readAsDataURL(file);
    });
  }

  if (removePrimaryImageBtn) {
    removePrimaryImageBtn.addEventListener('click', () => {
      primaryImageFile = null;
      if (primaryImagePreview) {
        primaryImagePreview.classList.add('hidden');
      }
      if (primaryImageInput) {
        (primaryImageInput as HTMLInputElement).value = '';
      }
      if (primaryImageUploadStatus) {
        primaryImageUploadStatus.textContent = '';
      }
    });
  }

  // ===== IM√ÅGENES DE CARRUSEL =====
  const carouselImageInput = document.getElementById('carousel-image-input');
  const carouselImageUploadStatus = document.getElementById('carousel-image-upload-status');
  const carouselImagesPreview = document.getElementById('carousel-images-preview');
  const carouselCount = document.getElementById('carousel-count');
  const maxCarouselImages = 4;

  function updateCarouselCount() {
    if (carouselCount) {
      carouselCount.textContent = `${carouselImageFiles.length}/${maxCarouselImages}`;
    }
  }

  function renderCarouselPreviews() {
    if (!carouselImagesPreview) return;

    if (carouselImageFiles.length === 0) {
      carouselImagesPreview.classList.add('hidden');
      return;
    }

    carouselImagesPreview.classList.remove('hidden');
    carouselImagesPreview.innerHTML = '';

    carouselImageFiles.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const div = document.createElement('div');
        div.className = 'relative group';
        div.innerHTML = `
          <img
            src="${e.target?.result}"
            alt="Carrusel ${index + 1}"
            class="h-32 w-full rounded-lg border border-gray-300 object-cover"
          />
          <button
            type="button"
            data-index="${index}"
            class="remove-carousel-image absolute -top-2 -right-2 hidden rounded-full bg-red-500 p-1 text-white hover:bg-red-600 group-hover:block"
            title="Eliminar imagen"
          >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        `;
        carouselImagesPreview.appendChild(div);

        // Agregar listener para eliminar
        const removeBtn = div.querySelector('.remove-carousel-image');
        if (removeBtn) {
          removeBtn.addEventListener('click', () => {
            carouselImageFiles.splice(index, 1);
            renderCarouselPreviews();
            updateCarouselCount();
          });
        }
      };
      reader.readAsDataURL(file);
    });
  }

  if (carouselImageInput) {
    carouselImageInput.addEventListener('change', (e) => {
      const files = Array.from((e.target as HTMLInputElement).files || []);
      if (files.length === 0) return;

      const availableSlots = maxCarouselImages - carouselImageFiles.length;
      const filesToAdd = files.slice(0, availableSlots);

      if (files.length > availableSlots) {
        if (carouselImageUploadStatus) {
          carouselImageUploadStatus.textContent = `‚ö†Ô∏è Solo se agregaron ${availableSlots} imagen(es) (m√°ximo 4)`;
          carouselImageUploadStatus.className = 'mt-2 text-sm text-yellow-600';
        }
      }

      for (const file of filesToAdd) {
        // Validar tama√±o (10MB)
        if (file.size > 10 * 1024 * 1024) {
          continue;
        }

        // Validar tipo
        if (!file.type.startsWith('image/')) {
          continue;
        }

        carouselImageFiles.push(file);
      }

      renderCarouselPreviews();
      updateCarouselCount();

      if (carouselImageUploadStatus) {
        carouselImageUploadStatus.textContent = `‚úÖ ${filesToAdd.length} imagen(es) seleccionada(s) (se subir√°n al crear la categor√≠a)`;
        carouselImageUploadStatus.className = 'mt-2 text-sm text-green-600';
      }

      // Limpiar input
      if (carouselImageInput) {
        (carouselImageInput as HTMLInputElement).value = '';
      }
    });
  }

  // Interceptar el env√≠o del formulario para agregar im√°genes al formulario
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', async (e) => {
      // Prevenir el env√≠o para procesar las im√°genes primero
      e.preventDefault();

      console.log('üì∑ Procesando im√°genes antes de enviar...');
      console.log('üì∑ Imagen principal:', primaryImageFile?.name || 'ninguna');
      console.log('üì∑ Im√°genes carrusel:', carouselImageFiles.length);

      // Procesar imagen principal
      if (primaryImageFile) {
        try {
          const base64 = await new Promise<string>((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result as string);
            reader.onerror = reject;
            reader.readAsDataURL(primaryImageFile);
          });
          
          // Agregar campos hidden al formulario
          let input1 = form.querySelector('input[name="pending_primary_image"]') as HTMLInputElement;
          if (!input1) {
            input1 = document.createElement('input');
            input1.type = 'hidden';
            input1.name = 'pending_primary_image';
            form.appendChild(input1);
          }
          input1.value = base64;

          let input2 = form.querySelector('input[name="pending_primary_image_name"]') as HTMLInputElement;
          if (!input2) {
            input2 = document.createElement('input');
            input2.type = 'hidden';
            input2.name = 'pending_primary_image_name';
            form.appendChild(input2);
          }
          input2.value = primaryImageFile.name;
          
          console.log('‚úÖ Imagen principal procesada');
        } catch (err) {
          console.error('‚ùå Error procesando imagen principal:', err);
        }
      }

      // Procesar im√°genes de carrusel
      if (carouselImageFiles.length > 0) {
        try {
          const carouselData: Array<{ name: string; data: string }> = [];
          
          for (const file of carouselImageFiles) {
            const base64 = await new Promise<string>((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result as string);
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
            
            carouselData.push({
              name: file.name,
              data: base64,
            });
          }
          
          let input = form.querySelector('input[name="pending_carousel_images"]') as HTMLInputElement;
          if (!input) {
            input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'pending_carousel_images';
            form.appendChild(input);
          }
          input.value = JSON.stringify(carouselData);
          
          console.log('‚úÖ Im√°genes de carrusel procesadas:', carouselData.length);
        } catch (err) {
          console.error('‚ùå Error procesando im√°genes de carrusel:', err);
        }
      }

      console.log('üìù Enviando formulario...');
      // Ahora s√≠ enviar el formulario
      form.submit();
    });
  }
</script>

