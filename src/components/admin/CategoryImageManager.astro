---
interface Props {
  categoryId: number;
  categoryName: string;
  mainImageUrl?: string | null;
}

const { categoryId, categoryName, mainImageUrl } = Astro.props;
---

<div class="space-y-8">
  <!-- Imagen Principal -->
  <div class="rounded-lg border border-gray-200 bg-white p-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Imagen Principal</h3>
    <p class="text-sm text-gray-600 mb-4">
      Esta imagen se mostrar√° como la imagen principal de la categor√≠a.
    </p>
    
    <div class="space-y-4">
      <!-- Preview de imagen principal (nueva) -->
      <div id="primary-image-preview" class="hidden">
        <div class="relative inline-block">
          <img
            id="primary-image-preview-img"
            src=""
            alt="Vista previa imagen principal"
            class="h-48 w-48 rounded-lg border border-gray-300 object-cover"
          />
          <button
            type="button"
            id="remove-primary-image"
            class="absolute -top-2 -right-2 rounded-full bg-red-500 p-1 text-white hover:bg-red-600"
            title="Eliminar imagen"
          >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <input type="hidden" id="primary-image-url-new" name="main_image" value="" />
      </div>

      <!-- Imagen principal existente -->
      {mainImageUrl ? (
        <div id="existing-primary-image" class="relative inline-block mb-4">
          <img
            src={mainImageUrl}
            alt="Imagen principal actual"
            class="h-48 w-48 rounded-lg border border-gray-300 object-cover"
            onerror="console.error('‚ùå Error cargando imagen principal:', this.src); this.parentElement.innerHTML='<div class=\'text-red-600 text-sm\'>Error al cargar la imagen: ' + this.src.substring(0, 50) + '...</div>';"
          />
          <button
            type="button"
            id="remove-existing-primary-image"
            class="absolute -top-2 -right-2 z-50 rounded-full bg-red-500 p-1.5 text-white hover:bg-red-600 cursor-pointer pointer-events-auto"
            title="Eliminar imagen"
          >
            <svg class="h-4 w-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
          <input type="hidden" id="primary-image-url-existing" name="main_image" value={mainImageUrl} />
        </div>
      ) : (
        <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <p class="text-sm text-yellow-800">
            ‚ö†Ô∏è No hay imagen principal configurada. Sube una imagen para establecerla como principal.
          </p>
        </div>
      )}

      <!-- Uploader de imagen principal -->
      <div>
        <label
          for="primary-image-input"
          class="flex cursor-pointer items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 px-4 py-6 hover:border-gray-400"
        >
          <div class="text-center">
            <svg
              class="mx-auto h-12 w-12 text-gray-400"
              stroke="currentColor"
              fill="none"
              viewBox="0 0 48 48"
            >
              <path
                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <p class="mt-2 text-sm text-gray-600">
              <span class="font-semibold">Click para subir</span> o arrastra y suelta
            </p>
            <p class="text-xs text-gray-500">PNG, JPG, GIF hasta 10MB</p>
          </div>
          <input
            type="file"
            id="primary-image-input"
            accept="image/*"
            class="hidden"
            name=""
          />
        </label>
        <div id="primary-image-upload-status" class="mt-2 text-sm"></div>
      </div>
    </div>
  </div>
</div>

<script is:inline define:vars={{ categoryId }}>
  console.log('üñºÔ∏è [CategoryImageManager] Script iniciado, categoryId:', categoryId);
  
  let isImageOperationInProgress = false;
  
  // Funci√≥n para eliminar imagen principal
  async function deletePrimaryImage() {
    console.log('üóëÔ∏è deletePrimaryImage llamada');
    const categoryIdNum = parseInt(String(categoryId));
    
    if (!confirm('¬øEst√°s seguro de que quieres eliminar la imagen principal?')) {
      return;
    }

    isImageOperationInProgress = true;
    try {
      console.log('üóëÔ∏è Eliminando imagen principal, categoryId:', categoryIdNum);
      const response = await fetch(`/api/filter-categories/${categoryIdNum}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ main_image: '' }),
        credentials: 'include',
      });

      let result;
      try {
        const text = await response.text();
        console.log('üì° Respuesta texto (eliminar principal):', text);
        result = text ? JSON.parse(text) : { success: false, message: 'Respuesta vac√≠a' };
      } catch (parseError) {
        console.error('‚ùå Error parseando respuesta:', parseError);
        result = { success: false, message: 'Error al procesar la respuesta del servidor' };
      }
      
      console.log('üì° Resultado del servidor:', result);
      
      if (response.status === 401) {
        alert('Error: No autorizado. Por favor, recarga la p√°gina e inicia sesi√≥n nuevamente.');
        return;
      }
      
      if (response.ok && result.success) {
        alert('Imagen eliminada correctamente');
        window.location.reload();
      } else {
        const errorMsg = result.message || result.error || 'Error desconocido';
        console.error('‚ùå Error eliminando imagen principal:', errorMsg);
        alert('Error: ' + errorMsg);
      }
    } catch (error) {
      console.error('‚ùå Error:', error);
      alert('Error al eliminar la imagen: ' + (error instanceof Error ? error.message : 'Error desconocido'));
    } finally {
      isImageOperationInProgress = false;
    }
  }
  
  function initImageButtons() {
    console.log('üñºÔ∏è [CategoryImageManager] Inicializando botones...');
    const categoryIdNum = parseInt(String(categoryId));

    // ===== IMAGEN PRINCIPAL =====
    const primaryImageInput = document.getElementById('primary-image-input');
    const primaryImagePreview = document.getElementById('primary-image-preview');
    const primaryImagePreviewImg = document.getElementById('primary-image-preview-img');
    const primaryImageUrlNew = document.getElementById('primary-image-url-new');
    const existingPrimaryImage = document.getElementById('existing-primary-image');
    const removePrimaryImageBtn = document.getElementById('remove-primary-image');
    const removeExistingPrimaryImageBtn = document.getElementById('remove-existing-primary-image');
    const primaryImageUploadStatus = document.getElementById('primary-image-upload-status');

    // Agregar event listener para bot√≥n de eliminar imagen principal existente
    if (removeExistingPrimaryImageBtn) {
      console.log('‚úÖ Bot√≥n de eliminar imagen principal encontrado');
      removeExistingPrimaryImageBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üñ±Ô∏è Click en bot√≥n eliminar imagen principal');
        deletePrimaryImage();
      });
    }

    if (primaryImageInput) {
      console.log('‚úÖ Input de imagen principal encontrado, agregando listener');
      primaryImageInput.addEventListener('change', async (e) => {
        console.log('üì§ Evento change en input de imagen principal');
        const target = e.target;
        const file = target && target.files ? target.files[0] : null;
        console.log('üì§ Archivo seleccionado:', file ? file.name : 'ninguno');
        if (!file) {
          console.log('‚ö†Ô∏è No se seleccion√≥ archivo');
          return;
        }

        // Validar tama√±o (10MB)
        if (file.size > 10 * 1024 * 1024) {
          primaryImageUploadStatus.textContent = '‚ùå La imagen debe ser menor a 10MB';
          primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
          return;
        }

        // Validar tipo
        if (!file.type.startsWith('image/')) {
          primaryImageUploadStatus.textContent = '‚ùå El archivo debe ser una imagen';
          primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
          return;
        }

        primaryImageUploadStatus.textContent = '‚è≥ Subiendo imagen...';
        primaryImageUploadStatus.className = 'mt-2 text-sm text-blue-600';
        isImageOperationInProgress = true;

        try {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('categoryId', categoryIdNum.toString());
          formData.append('imageType', 'primary');

          console.log('üì§ Subiendo imagen principal...');
          const response = await fetch('/api/filter-categories/upload-image', {
            method: 'POST',
            body: formData,
            credentials: 'include',
          });

          console.log('üì° Respuesta HTTP:', response.status, response.statusText);
          
          let result;
          try {
            const text = await response.text();
            result = text ? JSON.parse(text) : { success: false, error: 'Respuesta vac√≠a' };
          } catch (parseError) {
            console.error('‚ùå Error parseando respuesta:', parseError);
            result = { success: false, error: 'Error al procesar la respuesta del servidor' };
          }

          console.log('üì° Resultado:', result);

          if (response.status === 401) {
            primaryImageUploadStatus.textContent = '‚ùå Error: No autorizado. Por favor, recarga la p√°gina e inicia sesi√≥n nuevamente.';
            primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
            alert('Error: No autorizado. Por favor, recarga la p√°gina e inicia sesi√≥n nuevamente.');
            return;
          }

          if (response.ok && result.success && result.url) {
            // Ocultar imagen existente si hay una
            if (existingPrimaryImage) {
              existingPrimaryImage.classList.add('hidden');
            }
            
            // Mostrar preview de nueva imagen
            primaryImagePreviewImg.src = result.url;
            primaryImagePreview.classList.remove('hidden');
            if (primaryImageUrlNew) {
              primaryImageUrlNew.value = result.url;
            }
            
            // Guardar la URL en la BD actualizando la categor√≠a
            const saveResponse = await fetch('/api/filter-categories/' + categoryIdNum, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ main_image: result.url }),
              credentials: 'include',
            });

            let saveResult;
            try {
              const saveText = await saveResponse.text();
              saveResult = saveText ? JSON.parse(saveText) : { success: false, message: 'Respuesta vac√≠a' };
            } catch (e) {
              saveResult = { success: false, message: 'Error al procesar respuesta' };
            }
            console.log('üì° Resultado de guardar en BD:', saveResult);

            if (saveResult.success) {
              primaryImageUploadStatus.textContent = '‚úÖ Imagen subida y guardada correctamente';
              primaryImageUploadStatus.className = 'mt-2 text-sm text-green-600';
              
              // Recargar despu√©s de un momento para mostrar la imagen como principal
              setTimeout(function() {
                window.location.reload();
              }, 1000);
            } else {
              primaryImageUploadStatus.textContent = '‚ö†Ô∏è Imagen subida pero error al guardar en BD: ' + (saveResult.message || 'Error desconocido');
              primaryImageUploadStatus.className = 'mt-2 text-sm text-yellow-600';
            }
          } else {
            const errorMsg = result.error || result.message || 'Error desconocido';
            console.error('‚ùå Error subiendo imagen principal:', errorMsg);
            primaryImageUploadStatus.textContent = `‚ùå Error: ${errorMsg}`;
            primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
          }
        } catch (error) {
          console.error('Error subiendo imagen principal:', error);
          primaryImageUploadStatus.textContent = '‚ùå Error al subir la imagen';
          primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
        } finally {
          isImageOperationInProgress = false;
        }
      });
    }

    if (removePrimaryImageBtn) {
      removePrimaryImageBtn.addEventListener('click', function() {
        if (primaryImagePreview) {
          primaryImagePreview.classList.add('hidden');
        }
        if (primaryImageUrlNew) {
          primaryImageUrlNew.value = '';
        }
        if (primaryImageInput) {
          primaryImageInput.value = '';
        }
        if (primaryImageUploadStatus) {
          primaryImageUploadStatus.textContent = '';
        }
      });
    }

    // Prevenir que el formulario se env√≠e durante upload/delete
    const categoryForm = document.getElementById('category-form');
    if (categoryForm) {
      categoryForm.addEventListener('submit', function(e) {
        if (isImageOperationInProgress) {
          e.preventDefault();
          e.stopPropagation();
          console.log('üö´ Prevenido env√≠o: operaci√≥n de imagen en curso');
          return false;
        }
        const activeElement = document.activeElement;
        if (activeElement && (activeElement.id === 'remove-existing-primary-image' || activeElement.id === 'remove-primary-image')) {
          e.preventDefault();
          e.stopPropagation();
          console.log('üö´ Prevenido env√≠o de formulario por bot√≥n de eliminar');
          return false;
        }
      });
      
      // Prevenir que los inputs de archivo y labels causen problemas
      const fileInputs = categoryForm.querySelectorAll('input[type="file"]');
      fileInputs.forEach(input => {
        input.addEventListener('click', function(e) {
          e.stopPropagation();
        });
        input.addEventListener('change', function(e) {
          e.stopPropagation();
        });
      });
      
      // Prevenir que los labels de archivo env√≠en el formulario
      const fileLabels = categoryForm.querySelectorAll('label[for*="image-input"]');
      fileLabels.forEach(label => {
        label.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      });
    }

    console.log('üñºÔ∏è [CategoryImageManager] Inicializado correctamente');
  }
  
  // Ejecutar cuando el DOM est√© listo
  function initializeComponent() {
    console.log('üöÄ Inicializando CategoryImageManager...');
    try {
      initImageButtons();
      console.log('‚úÖ CategoryImageManager inicializado correctamente');
    } catch (error) {
      console.error('‚ùå Error inicializando CategoryImageManager:', error);
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeComponent);
  } else {
    setTimeout(initializeComponent, 100);
  }
</script>
