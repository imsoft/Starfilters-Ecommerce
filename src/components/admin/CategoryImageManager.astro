---
import { getCategoryImages } from '@/lib/filter-category-service';

interface Props {
  categoryId: number;
  categoryName: string;
  mainImageUrl?: string | null;
}

const { categoryId, categoryName, mainImageUrl } = Astro.props;

// Obtener todas las im√°genes de la categor√≠a
const allImages = await getCategoryImages(categoryId);
console.log('üñºÔ∏è [CategoryImageManager] Im√°genes obtenidas de BD:', allImages.length);
console.log('üñºÔ∏è [CategoryImageManager] mainImageUrl recibido:', mainImageUrl);

// Filtrar im√°genes de carrusel (no principales)
const carouselImagesFiltered = allImages.filter(img => !img.is_primary);
console.log('üñºÔ∏è [CategoryImageManager] Im√°genes de carrusel filtradas:', carouselImagesFiltered.length);
---

<div class="space-y-8">
  <!-- Imagen Principal -->
  <div class="rounded-lg border border-gray-200 bg-white p-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Imagen Principal</h3>
    <p class="text-sm text-gray-600 mb-4">
      Esta imagen se mostrar√° como la imagen principal de la categor√≠a.
    </p>
    
    <div class="space-y-4">
      <!-- Preview de imagen principal (nueva) -->
      <div id="primary-image-preview" class="hidden">
        <div class="relative inline-block">
          <img
            id="primary-image-preview-img"
            src=""
            alt="Vista previa imagen principal"
            class="h-48 w-48 rounded-lg border border-gray-300 object-cover"
          />
          <button
            type="button"
            id="remove-primary-image"
            class="absolute -top-2 -right-2 rounded-full bg-red-500 p-1 text-white hover:bg-red-600"
            title="Eliminar imagen"
          >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <input type="hidden" id="primary-image-url-new" name="main_image" value="" />
      </div>

      <!-- Imagen principal existente -->
      {mainImageUrl ? (
        <div id="existing-primary-image" class="relative inline-block mb-4">
          <img
            src={mainImageUrl}
            alt="Imagen principal actual"
            class="h-48 w-48 rounded-lg border border-gray-300 object-cover"
            onerror="console.error('‚ùå Error cargando imagen principal:', this.src); this.parentElement.innerHTML='<div class=\'text-red-600 text-sm\'>Error al cargar la imagen: ' + this.src.substring(0, 50) + '...</div>';"
          />
          <button
            type="button"
            id="remove-existing-primary-image"
            class="absolute -top-2 -right-2 z-50 rounded-full bg-red-500 p-1.5 text-white hover:bg-red-600 cursor-pointer pointer-events-auto"
            title="Eliminar imagen"
          >
            <svg class="h-4 w-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
          <input type="hidden" id="primary-image-url-existing" name="main_image" value={mainImageUrl} />
        </div>
      ) : (
        <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <p class="text-sm text-yellow-800">
            ‚ö†Ô∏è No hay imagen principal configurada. Sube una imagen para establecerla como principal.
          </p>
        </div>
      )}

      <!-- Uploader de imagen principal -->
      <div>
        <label
          for="primary-image-input"
          class="flex cursor-pointer items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 px-4 py-6 hover:border-gray-400"
        >
          <div class="text-center">
            <svg
              class="mx-auto h-12 w-12 text-gray-400"
              stroke="currentColor"
              fill="none"
              viewBox="0 0 48 48"
            >
              <path
                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <p class="mt-2 text-sm text-gray-600">
              <span class="font-semibold">Click para subir</span> o arrastra y suelta
            </p>
            <p class="text-xs text-gray-500">PNG, JPG, GIF hasta 10MB</p>
          </div>
          <input
            type="file"
            id="primary-image-input"
            accept="image/*"
            class="hidden"
            name=""
          />
        </label>
        <div id="primary-image-upload-status" class="mt-2 text-sm"></div>
      </div>
    </div>
  </div>

  <!-- Im√°genes de Carrusel -->
  <div class="rounded-lg border border-gray-200 bg-white p-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="text-lg font-semibold text-gray-900">Im√°genes de Carrusel</h3>
        <p class="text-sm text-gray-600 mt-1">
          Puedes agregar hasta 4 im√°genes adicionales para el carrusel.
        </p>
      </div>
      <span class="text-sm text-gray-500">
        {carouselImagesFiltered.length}/4
      </span>
    </div>

    <!-- Galer√≠a de im√°genes de carrusel existentes -->
    <div class="mb-6 grid grid-cols-2 gap-4 md:grid-cols-4" id="carousel-images-container" style={carouselImagesFiltered.length === 0 ? 'display: none;' : ''}>
      {carouselImagesFiltered.map((image) => (
        <div class="relative group" data-image-id={image.id} data-image-url={image.image_url}>
          <img
            src={image.image_url}
            alt={image.alt_text || categoryName}
            class="h-32 w-full rounded-lg border border-gray-300 object-cover"
            onerror="console.error('‚ùå Error cargando imagen:', this.src);"
          />
          <button
            type="button"
            class="delete-carousel-btn absolute -top-2 -right-2 z-50 rounded-full bg-red-500 p-1.5 text-white hover:bg-red-600 cursor-pointer pointer-events-auto shadow-lg opacity-90 hover:opacity-100"
            data-image-id={image.id}
            title="Eliminar imagen"
            style="pointer-events: auto; min-width: 32px; min-height: 32px;"
          >
            <svg class="h-4 w-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      ))}
    </div>

    <!-- Uploader de im√°genes de carrusel -->
    <div id="carousel-uploader-container">
    {carouselImagesFiltered.length < 4 && (
      <div>
        <label
          for="carousel-image-input"
          class="flex cursor-pointer items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 px-4 py-6 hover:border-gray-400"
        >
          <div class="text-center">
            <svg
              class="mx-auto h-12 w-12 text-gray-400"
              stroke="currentColor"
              fill="none"
              viewBox="0 0 48 48"
            >
              <path
                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <p class="mt-2 text-sm text-gray-600">
              <span class="font-semibold">Click para subir</span> o arrastra y suelta
            </p>
            <p class="text-xs text-gray-500">PNG, JPG, GIF hasta 10MB</p>
          </div>
          <input
            type="file"
            id="carousel-image-input"
            accept="image/*"
            multiple
            class="hidden"
            name=""
          />
        </label>
        <div id="carousel-image-upload-status" class="mt-2 text-sm"></div>
      </div>
    )}

    {carouselImagesFiltered.length >= 4 && (
      <p class="text-sm text-gray-500 text-center py-4">
        Has alcanzado el l√≠mite de 4 im√°genes de carrusel.
      </p>
    )}
    </div>
  </div>
</div>

<script is:inline define:vars={{ categoryId }}>
  console.log('üñºÔ∏è [CategoryImageManager] Script iniciado, categoryId:', categoryId);
  
  let isImageOperationInProgress = false;
  
  // Funci√≥n para eliminar imagen principal
  async function deletePrimaryImage() {
    console.log('üóëÔ∏è deletePrimaryImage llamada');
    const categoryIdNum = parseInt(String(categoryId));
    console.log('üóëÔ∏è categoryIdNum:', categoryIdNum);
    
    if (!confirm('¬øEst√°s seguro de que quieres eliminar la imagen principal?')) {
      return;
    }

    isImageOperationInProgress = true;
    try {
      console.log('üóëÔ∏è Eliminando imagen principal, categoryId:', categoryIdNum);
      const response = await fetch(`/api/filter-categories/${categoryIdNum}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ main_image: '' }),
        credentials: 'include',
      });

      let result;
      try {
        const text = await response.text();
        console.log('üì° Respuesta texto (eliminar principal):', text);
        result = text ? JSON.parse(text) : { success: false, message: 'Respuesta vac√≠a' };
      } catch (parseError) {
        console.error('‚ùå Error parseando respuesta (eliminar principal):', parseError);
        result = { success: false, message: 'Error al procesar la respuesta del servidor' };
      }
      
      console.log('üì° Resultado del servidor (eliminar principal):', result);
      
      if (response.ok && result.success) {
        alert('Imagen eliminada correctamente');
        window.location.reload();
      } else {
        const errorMsg = result.message || result.error || 'Error desconocido';
        console.error('‚ùå Error eliminando imagen principal:', errorMsg, 'Status:', response.status);
        alert('Error: ' + errorMsg + (response.status === 401 ? ' (No autorizado - verifica que est√©s logueado)' : ''));
      }
    } catch (error) {
      console.error('‚ùå Error:', error);
      alert('Error al eliminar la imagen: ' + (error instanceof Error ? error.message : 'Error desconocido'));
    } finally {
      isImageOperationInProgress = false;
    }
  }

  // Funci√≥n para eliminar imagen de carrusel
  async function deleteCarouselImage(imageId) {
    console.log('üóëÔ∏è deleteCarouselImage llamada, imageId:', imageId);
    
    if (!imageId || imageId === 0) {
      console.error('‚ùå ID de imagen inv√°lido:', imageId);
      alert('Error: ID de imagen inv√°lido');
      return;
    }
    
    if (!confirm('¬øEst√°s seguro de que quieres eliminar esta imagen?')) {
      console.log('‚ùå Usuario cancel√≥ la eliminaci√≥n');
      return;
    }

    isImageOperationInProgress = true;
    try {
      console.log('üóëÔ∏è Eliminando imagen de carrusel ID:', imageId);
      const url = '/api/filter-categories/images/' + imageId;
      console.log('üì° URL de eliminaci√≥n:', url);
      
      const response = await fetch(url, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include',
      });

      console.log('üì° Respuesta HTTP:', response.status, response.statusText);
      
      let result;
      try {
        const text = await response.text();
        console.log('üì° Respuesta texto:', text);
        result = text ? JSON.parse(text) : { success: false, message: 'Respuesta vac√≠a' };
      } catch (parseError) {
        console.error('‚ùå Error parseando respuesta:', parseError);
        result = { success: false, message: 'Error al procesar la respuesta del servidor' };
      }
      
      console.log('üì° Resultado de eliminaci√≥n:', result);

      if (response.status === 401) {
        alert('Error: No autorizado. Por favor, recarga la p√°gina e inicia sesi√≥n nuevamente.');
        console.error('‚ùå Error 401: No autorizado');
        return;
      }

      if (response.ok && result.success) {
        console.log('‚úÖ Imagen eliminada correctamente');
        
        // Remover la imagen del DOM inmediatamente
        const imageElement = document.querySelector(`[data-image-id="${imageId}"]`);
        if (imageElement) {
          imageElement.remove();
          console.log('‚úÖ Imagen removida del DOM');
        }
        
        // Actualizar el contador y mostrar/ocultar uploader
        const carouselContainer = document.getElementById('carousel-images-container');
        if (carouselContainer) {
          const remainingImages = carouselContainer.querySelectorAll('img').length;
          console.log('üìä Im√°genes restantes:', remainingImages);
          
          // Si no quedan im√°genes, ocultar el contenedor
          if (remainingImages === 0) {
            carouselContainer.style.display = 'none';
          }
          
          // Mostrar el uploader si hay espacio disponible
          const uploaderContainer = document.getElementById('carousel-uploader-container');
          if (uploaderContainer && remainingImages < 4) {
            uploaderContainer.style.display = '';
            const uploaderInput = document.getElementById('carousel-image-input');
            if (uploaderInput && uploaderInput.parentElement) {
              uploaderInput.parentElement.style.display = '';
            }
          }
        }
        
        alert('Imagen eliminada correctamente');
        // Recargar despu√©s de un breve delay para asegurar que todo se actualice
        setTimeout(() => {
          window.location.reload();
        }, 500);
      } else {
        const errorMsg = result.message || result.error || 'Error desconocido';
        console.error('‚ùå Error eliminando imagen:', errorMsg, 'Status:', response.status);
        alert('Error al eliminar la imagen: ' + errorMsg);
      }
    } catch (error) {
      console.error('‚ùå Error eliminando imagen:', error);
      const errorMsg = error instanceof Error ? error.message : 'Error desconocido';
      alert('Error al eliminar la imagen: ' + errorMsg);
    } finally {
      isImageOperationInProgress = false;
    }
  }
  
  function initImageButtons() {
    console.log('üñºÔ∏è [CategoryImageManager] Inicializando botones...');
    const categoryIdNum = parseInt(String(categoryId));
    console.log('üñºÔ∏è [CategoryImageManager] categoryIdNum:', categoryIdNum);

  // ===== IMAGEN PRINCIPAL =====
  const primaryImageInput = document.getElementById('primary-image-input');
  const primaryImagePreview = document.getElementById('primary-image-preview');
  const primaryImagePreviewImg = document.getElementById('primary-image-preview-img');
  const primaryImageUrlNew = document.getElementById('primary-image-url-new');
  const primaryImageUrlExisting = document.getElementById('primary-image-url-existing');
    const existingPrimaryImage = document.getElementById('existing-primary-image');
    const removePrimaryImageBtn = document.getElementById('remove-primary-image');
    const removeExistingPrimaryImageBtn = document.getElementById('remove-existing-primary-image');
    const primaryImageUploadStatus = document.getElementById('primary-image-upload-status');

    // Agregar event listener para bot√≥n de eliminar imagen principal existente
    if (removeExistingPrimaryImageBtn) {
      console.log('‚úÖ Bot√≥n de eliminar imagen principal encontrado');
      removeExistingPrimaryImageBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üñ±Ô∏è Click en bot√≥n eliminar imagen principal');
        deletePrimaryImage();
      });
    } else {
      console.warn('‚ö†Ô∏è No se encontr√≥ el bot√≥n de eliminar imagen principal');
    }

    // Agregar event listeners para botones de eliminar carrusel usando event delegation
    const carouselContainer = document.getElementById('carousel-images-container');
    if (carouselContainer) {
      console.log('‚úÖ Contenedor de im√°genes de carrusel encontrado, usando event delegation');
      carouselContainer.addEventListener('click', function(e) {
        const target = e.target.closest('.delete-carousel-btn');
        if (target) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          const imageId = target.getAttribute('data-image-id');
          console.log('üñ±Ô∏è Click detectado en bot√≥n eliminar carrusel (delegation), imageId:', imageId);
          const id = parseInt(imageId || '0');
          if (id) {
            deleteCarouselImage(id);
          } else {
            console.error('‚ùå No se pudo obtener imageId del bot√≥n');
            alert('Error: No se pudo obtener el ID de la imagen');
          }
          return false;
        }
      });
    } else {
      console.warn('‚ö†Ô∏è No se encontr√≥ el contenedor de im√°genes de carrusel');
    }
    
    // Tambi√©n agregar listeners directos como respaldo
    const deleteCarouselButtons = document.querySelectorAll('.delete-carousel-btn');
    console.log('üîç Botones de eliminar carrusel encontrados:', deleteCarouselButtons.length);
    
    deleteCarouselButtons.forEach(function(btn) {
      const imageId = btn.getAttribute('data-image-id');
      console.log('üîç Configurando bot√≥n directo con imageId:', imageId);
      
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        console.log('üñ±Ô∏è Click detectado en bot√≥n eliminar carrusel (directo), imageId:', imageId);
        const id = parseInt(imageId || '0');
        if (id) {
          deleteCarouselImage(id);
        } else {
          console.error('‚ùå No se pudo obtener imageId del bot√≥n');
          alert('Error: No se pudo obtener el ID de la imagen');
        }
        return false;
      });
    });

  if (primaryImageInput) {
    console.log('‚úÖ Input de imagen principal encontrado, agregando listener');
    primaryImageInput.addEventListener('change', async (e) => {
      console.log('üì§ Evento change en input de imagen principal');
      const target = e.target;
      const file = target && target.files ? target.files[0] : null;
      console.log('üì§ Archivo seleccionado:', file ? file.name : 'ninguno');
      if (!file) {
        console.log('‚ö†Ô∏è No se seleccion√≥ archivo');
        return;
      }

      // Validar tama√±o (10MB)
      if (file.size > 10 * 1024 * 1024) {
        primaryImageUploadStatus.textContent = '‚ùå La imagen debe ser menor a 10MB';
        primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
        return;
      }

      // Validar tipo
      if (!file.type.startsWith('image/')) {
        primaryImageUploadStatus.textContent = '‚ùå El archivo debe ser una imagen';
        primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
        return;
      }

      primaryImageUploadStatus.textContent = '‚è≥ Subiendo imagen...';
      primaryImageUploadStatus.className = 'mt-2 text-sm text-blue-600';
      isImageOperationInProgress = true;

      try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('categoryId', categoryIdNum.toString());
        formData.append('imageType', 'primary');

        console.log('üì§ Subiendo imagen principal...');
        const response = await fetch('/api/filter-categories/upload-image', {
          method: 'POST',
          body: formData,
          credentials: 'include',
        });

        console.log('üì° Respuesta HTTP:', response.status, response.statusText);
        
        let result;
        try {
          const text = await response.text();
          result = text ? JSON.parse(text) : { success: false, error: 'Respuesta vac√≠a' };
        } catch (parseError) {
          console.error('‚ùå Error parseando respuesta:', parseError);
          result = { success: false, error: 'Error al procesar la respuesta del servidor' };
        }

        console.log('üì° Resultado:', result);

        if (response.status === 401) {
          primaryImageUploadStatus.textContent = '‚ùå Error: No autorizado. Por favor, recarga la p√°gina e inicia sesi√≥n nuevamente.';
          primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
          alert('Error: No autorizado. Por favor, recarga la p√°gina e inicia sesi√≥n nuevamente.');
          return;
        }

        if (response.ok && result.success && result.url) {
          // Ocultar imagen existente si hay una
          if (existingPrimaryImage) {
            existingPrimaryImage.classList.add('hidden');
          }
          
          // Mostrar preview de nueva imagen
          primaryImagePreviewImg.src = result.url;
          primaryImagePreview.classList.remove('hidden');
          if (primaryImageUrlNew) {
            primaryImageUrlNew.value = result.url;
          }
          
          // Guardar la URL en la BD actualizando la categor√≠a
          const saveResponse = await fetch('/api/filter-categories/' + categoryIdNum, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ main_image: result.url }),
            credentials: 'include',
          });

          let saveResult;
          try {
            const saveText = await saveResponse.text();
            saveResult = saveText ? JSON.parse(saveText) : { success: false, message: 'Respuesta vac√≠a' };
          } catch (e) {
            saveResult = { success: false, message: 'Error al procesar respuesta' };
          }
          console.log('üì° Resultado de guardar en BD:', saveResult);

          if (saveResult.success) {
            primaryImageUploadStatus.textContent = '‚úÖ Imagen subida y guardada correctamente';
            primaryImageUploadStatus.className = 'mt-2 text-sm text-green-600';
            
            // Recargar despu√©s de un momento para mostrar la imagen como principal
            setTimeout(function() {
              window.location.reload();
            }, 1000);
          } else {
            primaryImageUploadStatus.textContent = '‚ö†Ô∏è Imagen subida pero error al guardar en BD: ' + (saveResult.message || 'Error desconocido');
            primaryImageUploadStatus.className = 'mt-2 text-sm text-yellow-600';
          }
        } else {
          const errorMsg = result.error || result.message || 'Error desconocido';
          console.error('‚ùå Error subiendo imagen principal:', errorMsg);
          primaryImageUploadStatus.textContent = `‚ùå Error: ${errorMsg}`;
          primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
        }
      } catch (error) {
        console.error('Error subiendo imagen principal:', error);
        primaryImageUploadStatus.textContent = '‚ùå Error al subir la imagen';
        primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
      } finally {
        isImageOperationInProgress = false;
      }
    });
  }

  if (removePrimaryImageBtn) {
    removePrimaryImageBtn.addEventListener('click', function() {
      if (primaryImagePreview) {
        primaryImagePreview.classList.add('hidden');
      }
      if (primaryImageUrlNew) {
        primaryImageUrlNew.value = '';
      }
      if (primaryImageInput) {
        primaryImageInput.value = '';
      }
      if (primaryImageUploadStatus) {
        primaryImageUploadStatus.textContent = '';
      }
    });
  }


  // ===== IM√ÅGENES DE CARRUSEL =====
  const carouselImageInput = document.getElementById('carousel-image-input');
  const carouselImageUploadStatus = document.getElementById('carousel-image-upload-status');
  const maxCarouselImages = 4;

  if (carouselImageInput) {
    console.log('‚úÖ Input de carrusel encontrado, agregando listener');
    carouselImageInput.addEventListener('change', async (e) => {
      console.log('üì§ Evento change en input de carrusel');
      const target = e.target;
      const files = target && target.files ? Array.from(target.files) : [];
      console.log('üì§ Archivos seleccionados:', files.length);
      if (files.length === 0) {
        console.log('‚ö†Ô∏è No se seleccionaron archivos');
        return;
      }

      // Obtener n√∫mero actual de im√°genes de carrusel
      // Contar las im√°genes en el contenedor de carrusel
      const carouselContainer = document.getElementById('carousel-images-container');
      const currentCarouselCount = carouselContainer ? carouselContainer.querySelectorAll('img').length : 0;
      const availableSlots = maxCarouselImages - currentCarouselCount;
      
      console.log('üìä Im√°genes de carrusel actuales:', currentCarouselCount);
      console.log('üìä Espacios disponibles:', availableSlots);

      if (files.length > availableSlots) {
        carouselImageUploadStatus.textContent = `‚ùå Solo puedes agregar ${availableSlots} imagen(es) m√°s`;
        carouselImageUploadStatus.className = 'mt-2 text-sm text-red-600';
        return;
      }

      carouselImageUploadStatus.textContent = `‚è≥ Subiendo ${files.length} imagen(es)...`;
      carouselImageUploadStatus.className = 'mt-2 text-sm text-blue-600';
      isImageOperationInProgress = true;

      let successCount = 0;
      let errorCount = 0;

      for (const file of files) {
        // Validar tama√±o (10MB)
        if (file.size > 10 * 1024 * 1024) {
          errorCount++;
          continue;
        }

        // Validar tipo
        if (!file.type.startsWith('image/')) {
          errorCount++;
          continue;
        }

        try {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('categoryId', categoryIdNum.toString());
          formData.append('imageType', 'carousel');

          console.log(`üì§ Subiendo imagen ${file.name}...`);
          const response = await fetch('/api/filter-categories/upload-image', {
            method: 'POST',
            body: formData,
            credentials: 'include',
          });

          console.log(`üì° Respuesta HTTP para ${file.name}:`, response.status, response.statusText);
          
          let result;
          try {
            const text = await response.text();
            result = text ? JSON.parse(text) : { success: false, error: 'Respuesta vac√≠a' };
          } catch (parseError) {
            console.error('‚ùå Error parseando respuesta:', parseError);
            result = { success: false, error: 'Error al procesar la respuesta del servidor' };
          }

          console.log(`üì° Resultado para ${file.name}:`, result);

          if (response.ok && result.success && result.url) {
            // Guardar la imagen en la BD
            const saved = await saveCarouselImageToDB(result.url);
            if (saved) {
              console.log(`‚úÖ Imagen ${file.name} subida y guardada correctamente`);
              successCount++;
              
              // Agregar la imagen al DOM inmediatamente
              addImageToCarousel(result.url, file.name);
            } else {
              console.error(`‚ùå Error guardando ${file.name} en BD`);
              errorCount++;
            }
          } else {
            const errorMsg = result.error || result.message || 'Error desconocido';
            console.error(`‚ùå Error subiendo ${file.name}:`, errorMsg, 'Status:', response.status);
            if (response.status === 401) {
              alert(`Error: No autorizado. Por favor, recarga la p√°gina e inicia sesi√≥n nuevamente.`);
              errorCount++;
              break; // Salir del loop si hay error de autenticaci√≥n
            }
            errorCount++;
          }
        } catch (error) {
          console.error('Error subiendo imagen de carrusel:', error);
          errorCount++;
        }
      }

      if (successCount > 0) {
        carouselImageUploadStatus.textContent = `‚úÖ ${successCount} imagen(es) subida(s) correctamente${errorCount > 0 ? `, ${errorCount} fallaron` : ''}`;
        carouselImageUploadStatus.className = 'mt-2 text-sm text-green-600';
        
        // Mostrar mensaje de √©xito
        console.log(`‚úÖ ${successCount} imagen(es) subida(s) exitosamente`);
        
        // Recargar la p√°gina para sincronizar con la BD y obtener los IDs reales
        setTimeout(() => {
          window.location.reload();
        }, 800);
      } else {
        carouselImageUploadStatus.textContent = `‚ùå Error al subir las im√°genes${errorCount > 0 ? ` (${errorCount} error(es))` : ''}`;
        carouselImageUploadStatus.className = 'mt-2 text-sm text-red-600';
        alert(`Error al subir las im√°genes${errorCount > 0 ? ` (${errorCount} error(es))` : ''}`);
      }

      isImageOperationInProgress = false;

      // Limpiar input
      if (carouselImageInput) {
        carouselImageInput.value = '';
      }
    });
  }


  // Funci√≥n para agregar imagen al carrusel en el DOM
  function addImageToCarousel(imageUrl: string, imageName: string) {
    const carouselContainer = document.getElementById('carousel-images-container');
    if (!carouselContainer) {
      console.warn('‚ö†Ô∏è No se encontr√≥ el contenedor de carrusel');
      return;
    }
    
    // Mostrar el contenedor si estaba oculto
    carouselContainer.style.display = '';
    
    // Crear el elemento de imagen
    const imageDiv = document.createElement('div');
    imageDiv.className = 'relative group';
    imageDiv.setAttribute('data-image-url', imageUrl);
    imageDiv.innerHTML = `
      <img
        src="${imageUrl}"
        alt="${imageName}"
        class="h-32 w-full rounded-lg border border-gray-300 object-cover"
      />
      <button
        type="button"
        class="delete-carousel-btn absolute -top-2 -right-2 z-50 rounded-full bg-red-500 p-1.5 text-white hover:bg-red-600 cursor-pointer pointer-events-auto shadow-lg opacity-90 hover:opacity-100"
        data-image-id="temp-${Date.now()}"
        title="Eliminar imagen"
        style="pointer-events: auto; min-width: 32px; min-height: 32px;"
      >
        <svg class="h-4 w-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    `;
    
    carouselContainer.appendChild(imageDiv);
    console.log('‚úÖ Imagen agregada al DOM:', imageUrl);
    
    // Ocultar el uploader si se alcanza el l√≠mite
    const currentCount = carouselContainer.querySelectorAll('img').length;
    const uploaderContainer = document.getElementById('carousel-uploader-container');
    if (currentCount >= 4 && uploaderContainer) {
      uploaderContainer.style.display = 'none';
    }
  }

  // Funci√≥n para guardar imagen de carrusel en la BD
  async function saveCarouselImageToDB(imageUrl: string) {
    try {
      console.log('üíæ Guardando imagen en BD, categoryId:', categoryIdNum, 'imageUrl:', imageUrl);
      const response = await fetch(`/api/filter-categories/images`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          categoryId: categoryIdNum,
          imageUrl: imageUrl,
          isPrimary: false,
        }),
        credentials: 'include',
      });

      console.log('üì° Respuesta HTTP guardar en BD:', response.status, response.statusText);
      
      let result;
      try {
        const text = await response.text();
        result = text ? JSON.parse(text) : { success: false, message: 'Respuesta vac√≠a' };
      } catch (parseError) {
        console.error('‚ùå Error parseando respuesta de guardado:', parseError);
        result = { success: false, message: 'Error al procesar la respuesta del servidor' };
      }

      console.log('üì° Resultado de guardado en BD:', result);
      
      if (response.ok && result.success) {
        console.log('‚úÖ Imagen guardada en BD con ID:', result.imageId);
        return true;
      } else {
        const errorMsg = result.message || 'Error desconocido';
        console.error('‚ùå Error guardando en BD:', errorMsg);
        return false;
      }
    } catch (error) {
      console.error('‚ùå Error guardando imagen en BD:', error);
      return false;
    }
  }

    // Prevenir que el formulario se env√≠e durante upload/delete o al usar botones/inputs de imagen
    const categoryForm = document.getElementById('category-form');
    if (categoryForm) {
      categoryForm.addEventListener('submit', function(e) {
        if (isImageOperationInProgress) {
          e.preventDefault();
          e.stopPropagation();
          console.log('üö´ Prevenido env√≠o: operaci√≥n de imagen en curso');
          return false;
        }
        const activeElement = document.activeElement;
        if (activeElement && (activeElement.classList.contains('delete-carousel-btn') || activeElement.id === 'remove-existing-primary-image' || activeElement.id === 'remove-primary-image')) {
          e.preventDefault();
          e.stopPropagation();
          console.log('üö´ Prevenido env√≠o de formulario por bot√≥n de eliminar');
          return false;
        }
      });
      
      // Prevenir que los inputs de archivo y labels causen problemas
      const fileInputs = categoryForm.querySelectorAll('input[type="file"]');
      fileInputs.forEach(input => {
        input.addEventListener('click', function(e) {
          e.stopPropagation();
        });
        input.addEventListener('change', function(e) {
          e.stopPropagation();
        });
      });
      
      // Prevenir que los labels de archivo env√≠en el formulario
      const fileLabels = categoryForm.querySelectorAll('label[for*="image-input"]');
      fileLabels.forEach(label => {
        label.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      });
    }

    console.log('üñºÔ∏è [CategoryImageManager] Inicializado correctamente');
  }
  
  // Ejecutar cuando el DOM est√© listo
  function initializeComponent() {
    console.log('üöÄ Inicializando CategoryImageManager...');
    try {
      initImageButtons();
      console.log('‚úÖ CategoryImageManager inicializado correctamente');
    } catch (error) {
      console.error('‚ùå Error inicializando CategoryImageManager:', error);
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeComponent);
  } else {
    // DOM ya est√° listo, pero esperar un poco para asegurar que todo est√© cargado
    setTimeout(initializeComponent, 100);
  }
</script>

