---
import { getCategoryImages } from '@/lib/filter-category-service';

interface Props {
  categoryId: number;
  categoryName: string;
  mainImageUrl?: string | null;
}

const { categoryId, categoryName, mainImageUrl } = Astro.props;

// Obtener todas las im√°genes de la categor√≠a
const allImages = await getCategoryImages(categoryId);
console.log('üñºÔ∏è [CategoryImageManager] Im√°genes obtenidas de BD:', allImages.length);
console.log('üñºÔ∏è [CategoryImageManager] mainImageUrl recibido:', mainImageUrl);

// Filtrar im√°genes de carrusel (no principales)
const carouselImagesFiltered = allImages.filter(img => !img.is_primary);
console.log('üñºÔ∏è [CategoryImageManager] Im√°genes de carrusel filtradas:', carouselImagesFiltered.length);
---

<div class="space-y-8">
  <!-- Imagen Principal -->
  <div class="rounded-lg border border-gray-200 bg-white p-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Imagen Principal</h3>
    <p class="text-sm text-gray-600 mb-4">
      Esta imagen se mostrar√° como la imagen principal de la categor√≠a.
    </p>
    
    <div class="space-y-4">
      <!-- Preview de imagen principal (nueva) -->
      <div id="primary-image-preview" class="hidden">
        <div class="relative inline-block">
          <img
            id="primary-image-preview-img"
            src=""
            alt="Vista previa imagen principal"
            class="h-48 w-48 rounded-lg border border-gray-300 object-cover"
          />
          <button
            type="button"
            id="remove-primary-image"
            class="absolute -top-2 -right-2 rounded-full bg-red-500 p-1 text-white hover:bg-red-600"
            title="Eliminar imagen"
          >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <input type="hidden" id="primary-image-url-new" name="main_image" value="" />
      </div>

      <!-- Imagen principal existente -->
      {mainImageUrl ? (
        <div id="existing-primary-image" class="relative inline-block mb-4">
          <img
            src={mainImageUrl}
            alt="Imagen principal actual"
            class="h-48 w-48 rounded-lg border border-gray-300 object-cover"
            onerror="console.error('‚ùå Error cargando imagen principal:', this.src); this.parentElement.innerHTML='<div class=\'text-red-600 text-sm\'>Error al cargar la imagen: ' + this.src.substring(0, 50) + '...</div>';"
          />
          <button
            type="button"
            id="remove-existing-primary-image"
            class="absolute -top-2 -right-2 rounded-full bg-red-500 p-1 text-white hover:bg-red-600 z-10 cursor-pointer"
            title="Eliminar imagen"
          >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
          <input type="hidden" id="primary-image-url-existing" name="main_image" value={mainImageUrl} />
        </div>
      ) : (
        <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <p class="text-sm text-yellow-800">
            ‚ö†Ô∏è No hay imagen principal configurada. Sube una imagen para establecerla como principal.
          </p>
        </div>
      )}

      <!-- Uploader de imagen principal -->
      <div>
        <label
          for="primary-image-input"
          class="flex cursor-pointer items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 px-4 py-6 hover:border-gray-400"
        >
          <div class="text-center">
            <svg
              class="mx-auto h-12 w-12 text-gray-400"
              stroke="currentColor"
              fill="none"
              viewBox="0 0 48 48"
            >
              <path
                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <p class="mt-2 text-sm text-gray-600">
              <span class="font-semibold">Click para subir</span> o arrastra y suelta
            </p>
            <p class="text-xs text-gray-500">PNG, JPG, GIF hasta 10MB</p>
          </div>
          <input
            type="file"
            id="primary-image-input"
            accept="image/*"
            class="hidden"
          />
        </label>
        <div id="primary-image-upload-status" class="mt-2 text-sm"></div>
      </div>
    </div>
  </div>

  <!-- Im√°genes de Carrusel -->
  <div class="rounded-lg border border-gray-200 bg-white p-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="text-lg font-semibold text-gray-900">Im√°genes de Carrusel</h3>
        <p class="text-sm text-gray-600 mt-1">
          Puedes agregar hasta 4 im√°genes adicionales para el carrusel.
        </p>
      </div>
      <span class="text-sm text-gray-500">
        {carouselImagesFiltered.length}/4
      </span>
    </div>

    <!-- Galer√≠a de im√°genes de carrusel existentes -->
    {carouselImagesFiltered.length > 0 && (
      <div class="mb-6 grid grid-cols-2 gap-4 md:grid-cols-4" id="carousel-images-container">
        {carouselImagesFiltered.map((image) => (
          <div class="relative group" data-image-id={image.id}>
            <img
              src={image.image_url}
              alt={image.alt_text || categoryName}
              class="h-32 w-full rounded-lg border border-gray-300 object-cover"
            />
            <button
              type="button"
              data-delete-image-id={image.id}
              class="delete-carousel-image-btn absolute -top-2 -right-2 hidden rounded-full bg-red-500 p-1 text-white hover:bg-red-600 group-hover:block cursor-pointer z-10"
              title="Eliminar imagen"
            >
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        ))}
      </div>
    )}

    <!-- Uploader de im√°genes de carrusel -->
    {carouselImagesFiltered.length < 4 && (
      <div>
        <label
          for="carousel-image-input"
          class="flex cursor-pointer items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 px-4 py-6 hover:border-gray-400"
        >
          <div class="text-center">
            <svg
              class="mx-auto h-12 w-12 text-gray-400"
              stroke="currentColor"
              fill="none"
              viewBox="0 0 48 48"
            >
              <path
                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <p class="mt-2 text-sm text-gray-600">
              <span class="font-semibold">Click para subir</span> o arrastra y suelta
            </p>
            <p class="text-xs text-gray-500">PNG, JPG, GIF hasta 10MB</p>
          </div>
          <input
            type="file"
            id="carousel-image-input"
            accept="image/*"
            multiple
            class="hidden"
          />
        </label>
        <div id="carousel-image-upload-status" class="mt-2 text-sm"></div>
      </div>
    )}

    {carouselImagesFiltered.length >= 4 && (
      <p class="text-sm text-gray-500 text-center py-4">
        Has alcanzado el l√≠mite de 4 im√°genes de carrusel.
      </p>
    )}
  </div>
</div>

<script define:vars={{ categoryId }}>
  const categoryIdNum = parseInt(categoryId);

  // ===== IMAGEN PRINCIPAL =====
  const primaryImageInput = document.getElementById('primary-image-input');
  const primaryImagePreview = document.getElementById('primary-image-preview');
  const primaryImagePreviewImg = document.getElementById('primary-image-preview-img');
  const primaryImageUrlNew = document.getElementById('primary-image-url-new');
  const primaryImageUrlExisting = document.getElementById('primary-image-url-existing');
  const existingPrimaryImage = document.getElementById('existing-primary-image');
  const removePrimaryImageBtn = document.getElementById('remove-primary-image');
  const removeExistingPrimaryImageBtn = document.getElementById('remove-existing-primary-image');
  const primaryImageUploadStatus = document.getElementById('primary-image-upload-status');

  if (primaryImageInput) {
    primaryImageInput.addEventListener('change', async (e) => {
      const target = e.target;
      const file = target && target.files ? target.files[0] : null;
      if (!file) return;

      // Validar tama√±o (10MB)
      if (file.size > 10 * 1024 * 1024) {
        primaryImageUploadStatus.textContent = '‚ùå La imagen debe ser menor a 10MB';
        primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
        return;
      }

      // Validar tipo
      if (!file.type.startsWith('image/')) {
        primaryImageUploadStatus.textContent = '‚ùå El archivo debe ser una imagen';
        primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
        return;
      }

      primaryImageUploadStatus.textContent = '‚è≥ Subiendo imagen...';
      primaryImageUploadStatus.className = 'mt-2 text-sm text-blue-600';

      try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('categoryId', categoryIdNum.toString());
        formData.append('imageType', 'primary');

        const response = await fetch('/api/filter-categories/upload-image', {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (result.success && result.url) {
          // Ocultar imagen existente si hay una
          if (existingPrimaryImage) {
            existingPrimaryImage.classList.add('hidden');
          }
          
          // Mostrar preview de nueva imagen
          primaryImagePreviewImg.src = result.url;
          primaryImagePreview.classList.remove('hidden');
          if (primaryImageUrlNew) {
            primaryImageUrlNew.value = result.url;
          }
          
          // Guardar la URL en la BD actualizando la categor√≠a
          await savePrimaryImageToDB(result.url);
          
          primaryImageUploadStatus.textContent = '‚úÖ Imagen subida y guardada correctamente';
          primaryImageUploadStatus.className = 'mt-2 text-sm text-green-600';
        } else {
          primaryImageUploadStatus.textContent = `‚ùå Error: ${result.error || 'Error desconocido'}`;
          primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
        }
      } catch (error) {
        console.error('Error subiendo imagen principal:', error);
        primaryImageUploadStatus.textContent = '‚ùå Error al subir la imagen';
        primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
      }
    });
  }

  if (removePrimaryImageBtn) {
    removePrimaryImageBtn.addEventListener('click', async () => {
      if (!confirm('¬øEst√°s seguro de que quieres eliminar la imagen principal?')) {
        return;
      }

      // Eliminar de la BD
      await savePrimaryImageToDB('');

      if (primaryImagePreview) {
        primaryImagePreview.classList.add('hidden');
      }
      if (primaryImageUrlNew) {
        primaryImageUrlNew.value = '';
      }
      if (primaryImageInput) {
        primaryImageInput.value = '';
      }

      // Recargar para actualizar la vista
      setTimeout(() => {
        window.location.reload();
      }, 500);
    });
  }

  // Manejar eliminaci√≥n de imagen principal existente
  if (removeExistingPrimaryImageBtn) {
    console.log('‚úÖ Bot√≥n remove-existing-primary-image encontrado, agregando listener');
    removeExistingPrimaryImageBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('üóëÔ∏è Bot√≥n eliminar imagen principal clickeado');
      
      if (!confirm('¬øEst√°s seguro de que quieres eliminar la imagen principal?')) {
        console.log('‚ùå Usuario cancel√≥ la eliminaci√≥n');
        return;
      }

      try {
        console.log('üóëÔ∏è Eliminando imagen principal de la BD...');
        const success = await savePrimaryImageToDB('');
        
        if (success) {
          console.log('‚úÖ Imagen principal eliminada correctamente');
          alert('Imagen principal eliminada correctamente');
          // Recargar para actualizar la vista
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } else {
          console.error('‚ùå Error al eliminar imagen principal - savePrimaryImageToDB retorn√≥ false');
          alert('Error al eliminar la imagen principal');
        }
      } catch (error) {
        console.error('‚ùå Error eliminando imagen principal:', error);
        alert('Error al eliminar la imagen principal: ' + (error instanceof Error ? error.message : 'Error desconocido'));
      }
    });
  } else {
    console.warn('‚ö†Ô∏è Bot√≥n remove-existing-primary-image NO encontrado en el DOM');
  }

  // ===== IM√ÅGENES DE CARRUSEL =====
  const carouselImageInput = document.getElementById('carousel-image-input');
  const carouselImageUploadStatus = document.getElementById('carousel-image-upload-status');
  const maxCarouselImages = 4;

  if (carouselImageInput) {
    carouselImageInput.addEventListener('change', async (e) => {
      const target = e.target;
      const files = target && target.files ? Array.from(target.files) : [];
      if (files.length === 0) return;

      // Obtener n√∫mero actual de im√°genes de carrusel
      const currentCarouselCount = document.querySelectorAll('[data-carousel-image]').length;
      const availableSlots = maxCarouselImages - currentCarouselCount;

      if (files.length > availableSlots) {
        carouselImageUploadStatus.textContent = `‚ùå Solo puedes agregar ${availableSlots} imagen(es) m√°s`;
        carouselImageUploadStatus.className = 'mt-2 text-sm text-red-600';
        return;
      }

      carouselImageUploadStatus.textContent = `‚è≥ Subiendo ${files.length} imagen(es)...`;
      carouselImageUploadStatus.className = 'mt-2 text-sm text-blue-600';

      let successCount = 0;
      let errorCount = 0;

      for (const file of files) {
        // Validar tama√±o (10MB)
        if (file.size > 10 * 1024 * 1024) {
          errorCount++;
          continue;
        }

        // Validar tipo
        if (!file.type.startsWith('image/')) {
          errorCount++;
          continue;
        }

        try {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('categoryId', categoryIdNum.toString());
          formData.append('imageType', 'carousel');

          const response = await fetch('/api/filter-categories/upload-image', {
            method: 'POST',
            body: formData,
          });

          const result = await response.json();

          if (result.success && result.url) {
            // Guardar la imagen en la BD
            await saveCarouselImageToDB(result.url);
            successCount++;
          } else {
            errorCount++;
          }
        } catch (error) {
          console.error('Error subiendo imagen de carrusel:', error);
          errorCount++;
        }
      }

      if (successCount > 0) {
        carouselImageUploadStatus.textContent = `‚úÖ ${successCount} imagen(es) subida(s) correctamente`;
        carouselImageUploadStatus.className = 'mt-2 text-sm text-green-600';
        // Recargar la p√°gina para mostrar las nuevas im√°genes
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } else {
        carouselImageUploadStatus.textContent = `‚ùå Error al subir las im√°genes`;
        carouselImageUploadStatus.className = 'mt-2 text-sm text-red-600';
      }

      // Limpiar input
      if (carouselImageInput) {
        carouselImageInput.value = '';
      }
    });
  }

  // Funci√≥n para guardar imagen principal en la BD
  async function savePrimaryImageToDB(imageUrl: string) {
    try {
      const response = await fetch(`/api/filter-categories/${categoryIdNum}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          main_image: imageUrl,
        }),
      });

      const result = await response.json();
      return result.success;
    } catch (error) {
      console.error('Error guardando imagen principal en BD:', error);
      return false;
    }
  }

  // Funci√≥n para guardar imagen de carrusel en la BD
  async function saveCarouselImageToDB(imageUrl: string) {
    try {
      const response = await fetch(`/api/filter-categories/images`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          categoryId: categoryIdNum,
          imageUrl: imageUrl,
          isPrimary: false,
        }),
      });

      const result = await response.json();
      return result.success;
    } catch (error) {
      console.error('Error guardando imagen en BD:', error);
      return false;
    }
  }

  // Funci√≥n para eliminar imagen de carrusel
  async function deleteCarouselImage(imageId) {
    if (!confirm('¬øEst√°s seguro de que quieres eliminar esta imagen?')) {
      return;
    }

    try {
      console.log('üóëÔ∏è Eliminando imagen de carrusel ID:', imageId);
      const response = await fetch(`/api/filter-categories/images/${imageId}`, {
        method: 'DELETE',
      });

      const result = await response.json();

      if (response.ok && result.success) {
        console.log('‚úÖ Imagen eliminada correctamente');
        alert('Imagen eliminada correctamente');
        window.location.reload();
      } else {
        console.error('‚ùå Error eliminando imagen:', result.message || 'Error desconocido');
        alert('Error al eliminar la imagen: ' + (result.message || 'Error desconocido'));
      }
    } catch (error) {
      console.error('‚ùå Error eliminando imagen:', error);
      alert('Error al eliminar la imagen');
    }
  }

  // Agregar event listeners a todos los botones de eliminar carrusel usando event delegation
  const carouselImagesContainer = document.getElementById('carousel-images-container');
  if (carouselImagesContainer) {
    console.log('‚úÖ Contenedor de im√°genes de carrusel encontrado');
    
    // Usar delegaci√≥n de eventos para manejar clicks en los botones
    carouselImagesContainer.addEventListener('click', (e) => {
      const deleteBtn = e.target.closest('.delete-carousel-image-btn');
      if (deleteBtn) {
        e.preventDefault();
        e.stopPropagation();
        
        const imageId = deleteBtn.getAttribute('data-delete-image-id');
        if (imageId) {
          console.log('üóëÔ∏è Bot√≥n eliminar clickeado para imagen ID:', imageId);
          deleteCarouselImage(parseInt(imageId));
        } else {
          console.error('‚ùå No se encontr√≥ data-delete-image-id en el bot√≥n');
        }
      }
    });
  } else {
    console.warn('‚ö†Ô∏è Contenedor carousel-images-container no encontrado');
  }
</script>

