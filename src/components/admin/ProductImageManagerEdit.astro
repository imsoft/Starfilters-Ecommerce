---
import { getProductImages } from '@/lib/database';

interface Props {
  productId: number;
  productName: string;
}

const { productId, productName } = Astro.props;

// Obtener todas las im√°genes del producto
const allImages = await getProductImages(productId);
console.log('üñºÔ∏è [ProductImageManagerEdit] Im√°genes obtenidas de BD:', allImages.length);

// Separar imagen principal y carrusel
const primaryImage = allImages.find(img => img.is_primary);
const carouselImages = allImages.filter(img => !img.is_primary);
console.log('üñºÔ∏è [ProductImageManagerEdit] Imagen principal:', primaryImage ? 'S√≠' : 'No');
console.log('üñºÔ∏è [ProductImageManagerEdit] Im√°genes de carrusel:', carouselImages.length);
---

<div class="space-y-8">
  <!-- Imagen Principal -->
  <div class="rounded-lg border border-gray-200 bg-white p-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Imagen Principal</h3>
    <p class="text-sm text-gray-600 mb-4">
      Esta imagen se mostrar√° como la imagen principal del producto.
    </p>
    
    <div class="space-y-4">
      <!-- Preview de imagen principal (nueva) -->
      <div id="primary-image-preview" class="hidden">
        <div class="relative inline-block">
          <img
            id="primary-image-preview-img"
            src=""
            alt="Vista previa imagen principal"
            class="h-48 w-48 rounded-lg border border-gray-300 object-cover"
          />
          <button
            type="button"
            id="remove-primary-image"
            class="absolute -top-2 -right-2 rounded-full bg-red-500 p-1 text-white hover:bg-red-600"
            title="Eliminar imagen"
          >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Imagen principal existente -->
      {primaryImage ? (
        <div id="existing-primary-image" class="relative inline-block mb-4">
          <img
            src={primaryImage.image_url}
            alt={primaryImage.alt_text || productName}
            class="h-48 w-48 rounded-lg border border-gray-300 object-cover"
            onerror="console.error('‚ùå Error cargando imagen principal:', this.src); this.parentElement.innerHTML='<div class=\'text-red-600 text-sm\'>Error al cargar la imagen</div>';"
          />
          <button
            type="button"
            id="remove-existing-primary-image"
            class="absolute -top-2 -right-2 rounded-full bg-red-500 p-1 text-white hover:bg-red-600 z-10 cursor-pointer"
            title="Eliminar imagen"
          >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      ) : (
        <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <p class="text-sm text-yellow-800">
            ‚ö†Ô∏è No hay imagen principal configurada. Sube una imagen para establecerla como principal.
          </p>
        </div>
      )}

      <!-- Uploader de imagen principal -->
      <div>
        <label
          for="primary-image-input"
          class="flex cursor-pointer items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 px-4 py-6 hover:border-gray-400"
        >
          <div class="text-center">
            <svg
              class="mx-auto h-12 w-12 text-gray-400"
              stroke="currentColor"
              fill="none"
              viewBox="0 0 48 48"
            >
              <path
                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <p class="mt-2 text-sm text-gray-600">
              <span class="font-semibold">Click para subir</span> o arrastra y suelta
            </p>
            <p class="text-xs text-gray-500">PNG, JPG, GIF hasta 10MB</p>
          </div>
          <input
            type="file"
            id="primary-image-input"
            accept="image/*"
            class="hidden"
          />
        </label>
        <div id="primary-image-upload-status" class="mt-2 text-sm"></div>
      </div>
    </div>
  </div>

  <!-- Im√°genes de Carrusel -->
  <div class="rounded-lg border border-gray-200 bg-white p-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="text-lg font-semibold text-gray-900">Im√°genes de Carrusel</h3>
        <p class="text-sm text-gray-600 mt-1">
          Puedes agregar hasta 4 im√°genes adicionales para el carrusel.
        </p>
      </div>
      <span class="text-sm text-gray-500" id="carousel-count">
        {carouselImages.length}/4
      </span>
    </div>

    <!-- Galer√≠a de im√°genes de carrusel existentes -->
    {carouselImages.length > 0 && (
      <div class="mb-6 grid grid-cols-2 gap-4 md:grid-cols-4" id="carousel-images-container">
        {carouselImages.map((image) => (
          <div class="relative group" data-image-id={image.id}>
            <img
              src={image.image_url}
              alt={image.alt_text || productName}
              class="h-32 w-full rounded-lg border border-gray-300 object-cover"
            />
            <button
              type="button"
              class="delete-carousel-btn absolute -top-2 -right-2 hidden rounded-full bg-red-500 p-1 text-white hover:bg-red-600 group-hover:block cursor-pointer z-10"
              data-image-id={image.id}
              title="Eliminar imagen"
            >
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        ))}
      </div>
    )}

    <!-- Uploader de im√°genes de carrusel -->
    {carouselImages.length < 4 && (
      <div>
        <label
          for="carousel-image-input"
          class="flex cursor-pointer items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 px-4 py-6 hover:border-gray-400"
        >
          <div class="text-center">
            <svg
              class="mx-auto h-12 w-12 text-gray-400"
              stroke="currentColor"
              fill="none"
              viewBox="0 0 48 48"
            >
              <path
                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <p class="mt-2 text-sm text-gray-600">
              <span class="font-semibold">Click para agregar</span> im√°genes al carrusel
            </p>
            <p class="text-xs text-gray-500">PNG, JPG, GIF hasta 10MB</p>
          </div>
          <input
            type="file"
            id="carousel-image-input"
            accept="image/*"
            multiple
            class="hidden"
          />
        </label>
        <div id="carousel-image-upload-status" class="mt-2 text-sm"></div>
      </div>
    )}

    {carouselImages.length >= 4 && (
      <p class="text-sm text-gray-500 text-center py-4">
        Has alcanzado el l√≠mite de 4 im√°genes de carrusel.
      </p>
    )}
  </div>
</div>

<script define:vars={{ productId }}>
  console.log('üñºÔ∏è [ProductImageManagerEdit] Script cargado, productId:', productId);
  
  // Funci√≥n para eliminar imagen principal
  async function deletePrimaryImage() {
    console.log('üóëÔ∏è deletePrimaryImage llamada');
    const productIdNum = parseInt(productId);
    
    if (!confirm('¬øEst√°s seguro de que quieres eliminar la imagen principal?')) {
      return;
    }

    try {
      console.log('üóëÔ∏è Eliminando imagen principal, productId:', productIdNum);
      
      // Obtener todas las im√°genes para encontrar la principal
      const response = await fetch(`/api/products/${productIdNum}/images`);
      const result = await response.json();
      
      if (result.success && result.images) {
        const primaryImage = result.images.find((img: any) => img.isPrimary);
        if (primaryImage) {
          const deleteResponse = await fetch('/api/products/delete-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ imageId: primaryImage.id, productId: productIdNum }),
          });

          const deleteResult = await deleteResponse.json();
          if (deleteResult.success) {
            alert('Imagen eliminada correctamente');
            window.location.reload();
          } else {
            alert('Error: ' + (deleteResult.message || 'Error desconocido'));
          }
        } else {
          alert('No se encontr√≥ la imagen principal');
        }
      } else {
        alert('Error al obtener las im√°genes del producto');
      }
    } catch (error) {
      console.error('‚ùå Error:', error);
      alert('Error al eliminar la imagen: ' + (error instanceof Error ? error.message : 'Error desconocido'));
    }
  }

  // Funci√≥n para eliminar imagen de carrusel
  async function deleteCarouselImage(imageId: number) {
    console.log('üóëÔ∏è deleteCarouselImage llamada, imageId:', imageId);
    const productIdNum = parseInt(productId);
    
    if (!confirm('¬øEst√°s seguro de que quieres eliminar esta imagen?')) {
      return;
    }

    try {
      const response = await fetch('/api/products/delete-image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ imageId, productId: productIdNum }),
      });

      const result = await response.json();
      if (result.success) {
        alert('Imagen eliminada correctamente');
        window.location.reload();
      } else {
        alert('Error: ' + (result.message || 'Error desconocido'));
      }
    } catch (error) {
      console.error('‚ùå Error:', error);
      alert('Error al eliminar la imagen: ' + (error instanceof Error ? error.message : 'Error desconocido'));
    }
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    console.log('üñºÔ∏è [ProductImageManagerEdit] DOMContentLoaded ejecutado, inicializando...');
    const productIdNum = parseInt(productId);
    console.log('üñºÔ∏è [ProductImageManagerEdit] productIdNum:', productIdNum);

    // ===== ELEMENTOS DEL DOM =====
    const primaryImageInput = document.getElementById('primary-image-input');
    const primaryImagePreview = document.getElementById('primary-image-preview');
    const primaryImagePreviewImg = document.getElementById('primary-image-preview-img');
    const removePrimaryImageBtn = document.getElementById('remove-primary-image');
    const removeExistingPrimaryImageBtn = document.getElementById('remove-existing-primary-image');
    const primaryImageUploadStatus = document.getElementById('primary-image-upload-status');
    const existingPrimaryImage = document.getElementById('existing-primary-image');

    const carouselImageInput = document.getElementById('carousel-image-input');
    const carouselImageUploadStatus = document.getElementById('carousel-image-upload-status');
    const carouselCount = document.getElementById('carousel-count');

    // Agregar event listeners para botones de eliminar carrusel
    const deleteCarouselButtons = document.querySelectorAll('.delete-carousel-btn');
    console.log('üîç Botones de eliminar carrusel encontrados:', deleteCarouselButtons.length);
    deleteCarouselButtons.forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const imageId = parseInt(this.getAttribute('data-image-id') || '0');
        console.log('üñ±Ô∏è Click en bot√≥n eliminar carrusel, imageId:', imageId);
        if (imageId) {
          deleteCarouselImage(imageId);
        }
      });
    });

    // Agregar event listener para bot√≥n de eliminar imagen principal existente
    if (removeExistingPrimaryImageBtn) {
      console.log('‚úÖ Bot√≥n de eliminar imagen principal encontrado');
      removeExistingPrimaryImageBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üñ±Ô∏è Click en bot√≥n eliminar imagen principal');
        deletePrimaryImage();
      });
    } else {
      console.warn('‚ö†Ô∏è No se encontr√≥ el bot√≥n de eliminar imagen principal');
    }

    // Funci√≥n para actualizar contador de carrusel
    function updateCarouselCount() {
      if (carouselCount) {
        const carouselImages = document.querySelectorAll('#carousel-images-container [data-image-id]');
        carouselCount.textContent = `${carouselImages.length}/4`;
      }
    }

    // ===== IMAGEN PRINCIPAL =====
    if (primaryImageInput) {
      primaryImageInput.addEventListener('change', async (e) => {
        const target = e.target;
        const file = target && target.files ? target.files[0] : null;
        if (!file) return;

        console.log('üñºÔ∏è Procesando imagen principal:', file.name);

        // Validar tama√±o (10MB)
        if (file.size > 10 * 1024 * 1024) {
          if (primaryImageUploadStatus) {
            primaryImageUploadStatus.textContent = '‚ùå La imagen debe ser menor a 10MB';
            primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
          }
          return;
        }

        // Validar tipo
        if (!file.type.startsWith('image/')) {
          if (primaryImageUploadStatus) {
            primaryImageUploadStatus.textContent = '‚ùå El archivo debe ser una imagen';
            primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
          }
          return;
        }

        if (primaryImageUploadStatus) {
          primaryImageUploadStatus.textContent = '‚è≥ Subiendo imagen...';
          primaryImageUploadStatus.className = 'mt-2 text-sm text-blue-600';
        }

        try {
          const formData = new FormData();
          formData.append('image', file);
          formData.append('productId', productIdNum.toString());

          const response = await fetch('/api/products/upload-image', {
            method: 'POST',
            body: formData,
          });

          const result = await response.json();

          if (result.success && result.url) {
            // Ocultar imagen existente si hay una
            if (existingPrimaryImage) {
              existingPrimaryImage.classList.add('hidden');
            }
            
            // Mostrar preview de nueva imagen
            if (primaryImagePreviewImg) {
              primaryImagePreviewImg.src = result.url;
            }
            if (primaryImagePreview) {
              primaryImagePreview.classList.remove('hidden');
            }
            
            if (primaryImageUploadStatus) {
              primaryImageUploadStatus.textContent = '‚úÖ Imagen subida y guardada correctamente';
              primaryImageUploadStatus.className = 'mt-2 text-sm text-green-600';
            }
            
            // Recargar despu√©s de un momento para mostrar la imagen como principal
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } else {
            if (primaryImageUploadStatus) {
              primaryImageUploadStatus.textContent = `‚ùå Error: ${result.message || 'Error desconocido'}`;
              primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
            }
          }
        } catch (error) {
          console.error('Error subiendo imagen principal:', error);
          if (primaryImageUploadStatus) {
            primaryImageUploadStatus.textContent = '‚ùå Error al subir la imagen';
            primaryImageUploadStatus.className = 'mt-2 text-sm text-red-600';
          }
        }
      });
    }

    if (removePrimaryImageBtn) {
      removePrimaryImageBtn.addEventListener('click', async () => {
        if (primaryImagePreview) {
          primaryImagePreview.classList.add('hidden');
        }
        if (primaryImageInput) {
          primaryImageInput.value = '';
        }
        if (primaryImageUploadStatus) {
          primaryImageUploadStatus.textContent = '';
        }
      });
    }

    // ===== IM√ÅGENES DE CARRUSEL =====
    if (carouselImageInput) {
      carouselImageInput.addEventListener('change', async (e) => {
        const target = e.target;
        const files = target && target.files ? Array.from(target.files) : [];
        if (files.length === 0) return;

        console.log('üñºÔ∏è Procesando im√°genes de carrusel:', files.length);

        // Contar im√°genes existentes
        const existingCarouselCount = document.querySelectorAll('#carousel-images-container [data-image-id]').length;
        const availableSlots = 4 - existingCarouselCount;
        const filesToAdd = files.slice(0, availableSlots);

        if (files.length > availableSlots) {
          if (carouselImageUploadStatus) {
            carouselImageUploadStatus.textContent = `‚ö†Ô∏è Solo se agregar√°n ${availableSlots} imagen(es) (m√°ximo 4)`;
            carouselImageUploadStatus.className = 'mt-2 text-sm text-yellow-600';
          }
        }

        let successCount = 0;
        let errorCount = 0;

        for (const file of filesToAdd) {
          // Validar tama√±o (10MB)
          if (file.size > 10 * 1024 * 1024) {
            console.warn(`‚ö†Ô∏è ${file.name} es muy grande, saltando...`);
            errorCount++;
            continue;
          }

          // Validar tipo
          if (!file.type.startsWith('image/')) {
            console.warn(`‚ö†Ô∏è ${file.name} no es una imagen, saltando...`);
            errorCount++;
            continue;
          }

          try {
            const formData = new FormData();
            formData.append('image', file);
            formData.append('productId', productIdNum.toString());

            const response = await fetch('/api/products/upload-image', {
              method: 'POST',
              body: formData,
            });

            const result = await response.json();

            if (result.success && result.url) {
              successCount++;
              console.log(`‚úÖ Imagen de carrusel subida: ${file.name}`);
            } else {
              errorCount++;
              console.error(`‚ùå Error subiendo ${file.name}:`, result.message);
            }
          } catch (error) {
            console.error(`‚ùå Error procesando ${file.name}:`, error);
            errorCount++;
          }
        }

        if (carouselImageUploadStatus) {
          if (successCount > 0) {
            carouselImageUploadStatus.textContent = `‚úÖ ${successCount} imagen(es) subida(s) correctamente`;
            carouselImageUploadStatus.className = 'mt-2 text-sm text-green-600';
            // Recargar despu√©s de un momento para mostrar las nuevas im√°genes
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } else {
            carouselImageUploadStatus.textContent = `‚ùå Error al subir las im√°genes`;
            carouselImageUploadStatus.className = 'mt-2 text-sm text-red-600';
          }
        }

        // Limpiar input
        if (carouselImageInput) {
          carouselImageInput.value = '';
        }
      });
    }

    console.log('üñºÔ∏è [ProductImageManagerEdit] Inicializado correctamente');
  });
</script>
