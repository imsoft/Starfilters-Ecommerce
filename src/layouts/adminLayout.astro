---
import "../styles/global.css";
import { getAuthenticatedUser } from "@/lib/auth-utils";
import { getAdminUserByEmail } from "@/lib/database";
import { AdminSidebarWrapper } from "@/components/admin/AdminSidebarWrapper";
import { SidebarTrigger } from "@/components/ui/sidebar";

export interface Props {
  title: string;
}

const { title } = Astro.props;

// Obtener usuario autenticado
const user = getAuthenticatedUser(Astro.cookies);
let adminUser = null;

if (user) {
  try {
    adminUser = await getAdminUserByEmail(user.email);
  } catch (error) {
    console.error('Error obteniendo admin user:', error);
    // Continuar sin adminUser si hay error
  }
}

// Función para obtener iniciales
const getInitials = (fullName: string | null, username: string): string => {
  if (fullName) {
    const names = fullName.split(' ');
    if (names.length >= 2) {
      return `${names[0].charAt(0)}${names[1].charAt(0)}`.toUpperCase();
    }
    return fullName.substring(0, 2).toUpperCase();
  }
  return username.substring(0, 2).toUpperCase();
};

const displayName = adminUser?.full_name || adminUser?.username || 'Admin User';
const initials = adminUser ? getInitials(adminUser.full_name, adminUser.username) : 'AU';

// Obtener la ruta actual para resaltar el enlace activo
const currentPath = Astro.url.pathname;
---

<!DOCTYPE html>
<html lang="es" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Panel de administración - Star Filters" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title} - Admin Panel</title>
  </head>
  <body class="h-full bg-background text-foreground">
    <AdminSidebarWrapper 
      client:load
      currentPath={currentPath}
      adminUser={adminUser || null}
    >
      <!-- Top bar -->
      <div class="sticky top-0 z-40 flex h-16 shrink-0 items-center gap-x-4 border-b border-border bg-background px-4 shadow-sm sm:gap-x-6 sm:px-6 lg:px-8">
        <SidebarTrigger client:load />
        
        <div class="flex flex-1 gap-x-4 self-stretch lg:gap-x-6">
          <div class="flex flex-1"></div>
          <div class="flex items-center gap-x-4 lg:gap-x-6">
            <!-- Perfil -->
            <div class="relative">
              <button
                type="button"
                class="-m-1.5 flex items-center p-1.5"
                id="user-menu-button"
                aria-expanded="false"
                aria-haspopup="true"
              >
                <span class="sr-only">Abrir menú de usuario</span>
                {adminUser?.profile_image ? (
                  <img
                    class="h-8 w-8 rounded-full bg-muted object-cover"
                    src={adminUser.profile_image}
                    alt={displayName}
                  />
                ) : (
                  <div class="h-8 w-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-xs font-bold">
                    {initials}
                  </div>
                )}
                <span class="hidden lg:flex lg:items-center">
                  <span class="ml-4 text-sm font-semibold leading-6 text-foreground" aria-hidden="true">
                    {displayName}
                  </span>
                  <svg class="ml-2 h-5 w-5 text-muted-foreground" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path>
                  </svg>
                </span>
              </button>

              <!-- Menú desplegable del perfil -->
              <div
                class="absolute right-0 z-10 mt-2.5 w-32 origin-top-right rounded-md bg-background py-2 shadow-lg ring-1 ring-border focus:outline-none hidden"
                id="user-menu"
                role="menu"
                aria-orientation="vertical"
                aria-labelledby="user-menu-button"
                tabindex="-1"
              >
                <a
                  href="/admin/profile"
                  class="block px-3 py-1 text-sm leading-6 text-foreground hover:bg-muted"
                  role="menuitem"
                  tabindex="-1"
                >
                  Mi Perfil
                </a>
                <a
                  href="/logout"
                  class="block px-3 py-1 text-sm leading-6 text-foreground hover:bg-muted"
                  role="menuitem"
                  tabindex="-1"
                >
                  Cerrar Sesión
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Page content -->
      <main class="py-10">
        <slot />
      </main>
    </AdminSidebarWrapper>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Menú desplegable del perfil
        const userMenuButton = document.getElementById("user-menu-button");
        const userMenu = document.getElementById("user-menu");

        userMenuButton?.addEventListener("click", (e) => {
          e.stopPropagation();
          const isHidden = userMenu?.classList.contains("hidden");
          
          if (isHidden) {
            userMenu?.classList.remove("hidden");
            userMenuButton?.setAttribute("aria-expanded", "true");
          } else {
            userMenu?.classList.add("hidden");
            userMenuButton?.setAttribute("aria-expanded", "false");
          }
        });

        // Cerrar menú del perfil al hacer clic fuera
        document.addEventListener("click", (e) => {
          if (!userMenuButton?.contains(e.target as Node) && !userMenu?.contains(e.target as Node)) {
            userMenu?.classList.add("hidden");
            userMenuButton?.setAttribute("aria-expanded", "false");
          }
        });

        // Cerrar menú del perfil con tecla Escape
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            userMenu?.classList.add("hidden");
            userMenuButton?.setAttribute("aria-expanded", "false");
          }
        });
      });
    </script>
  </body>
</html>
