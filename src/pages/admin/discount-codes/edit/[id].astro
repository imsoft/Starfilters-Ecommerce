---
import AdminLayout from '@/layouts/adminLayout.astro';
import { getAuthenticatedUser } from '@/lib/auth-utils';
import { isUserAdmin } from '@/lib/database';
import { getDiscountCodeById, updateDiscountCode } from '@/lib/discount-codes';

export const prerender = false;

const user = getAuthenticatedUser(Astro.cookies);

if (!user) {
  return Astro.redirect('/login');
}

const userIsAdmin = await isUserAdmin(user.id);

if (!userIsAdmin) {
  return Astro.redirect('/');
}

const { id } = Astro.params;
const discountId = parseInt(id || '0');

let discountCode = await getDiscountCodeById(discountId);

if (!discountCode) {
  return Astro.redirect('/admin/discount-codes');
}

let errorMessage = '';
let successMessage = '';

if (Astro.request.method === 'POST') {
  const data = await Astro.request.formData();

  const formData = {
    code: data.get('code')?.toString() || '',
    description: data.get('description')?.toString() || '',
    discount_type: data.get('discount_type')?.toString() as 'percentage' | 'fixed',
    discount_value: data.get('discount_value')?.toString() || '',
    min_purchase_amount: data.get('min_purchase_amount')?.toString() || '',
    max_discount_amount: data.get('max_discount_amount')?.toString() || '',
    usage_limit: data.get('usage_limit')?.toString() || '',
    start_date: data.get('start_date')?.toString() || '',
    end_date: data.get('end_date')?.toString() || '',
    is_active: data.get('is_active') === 'on',
  };

  // Validaciones
  if (!formData.code.trim()) {
    errorMessage = 'El código es requerido';
  } else if (!formData.discount_value || parseFloat(formData.discount_value) <= 0) {
    errorMessage = 'El valor del descuento debe ser mayor a 0';
  } else if (
    formData.discount_type === 'percentage' &&
    parseFloat(formData.discount_value) > 100
  ) {
    errorMessage = 'El porcentaje de descuento no puede ser mayor a 100';
  } else {
    try {
      await updateDiscountCode(discountId, {
        code: formData.code.trim(),
        description: formData.description.trim() || undefined,
        discount_type: formData.discount_type,
        discount_value: parseFloat(formData.discount_value),
        min_purchase_amount: formData.min_purchase_amount
          ? parseFloat(formData.min_purchase_amount)
          : undefined,
        max_discount_amount: formData.max_discount_amount
          ? parseFloat(formData.max_discount_amount)
          : undefined,
        usage_limit: formData.usage_limit ? parseInt(formData.usage_limit) : undefined,
        start_date: formData.start_date || undefined,
        end_date: formData.end_date || undefined,
        is_active: formData.is_active,
      });

      successMessage = 'Código actualizado exitosamente';
      // Recargar el código actualizado
      discountCode = await getDiscountCodeById(discountId);
    } catch (error: any) {
      console.error('Error updating discount code:', error);
      if (error.code === 'ER_DUP_ENTRY') {
        errorMessage = 'Ya existe un código con ese nombre';
      } else {
        errorMessage = 'Error al actualizar el código de descuento';
      }
    }
  }
}

// Formatear fechas para el input datetime-local
function formatDateForInput(date: Date | null): string {
  if (!date) return '';
  const d = new Date(date);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  const hours = String(d.getHours()).padStart(2, '0');
  const minutes = String(d.getMinutes()).padStart(2, '0');
  return `${year}-${month}-${day}T${hours}:${minutes}`;
}
---

<AdminLayout title={`Editar: ${discountCode.code}`}>
  <div class="px-4 sm:px-6 lg:px-8">
    <div class="mb-8">
      <a
        href="/admin/discount-codes"
        class="text-sm font-medium text-primary hover:text-primary/80"
      >
        ← Volver a códigos de descuento
      </a>
    </div>

    <div class="md:flex md:items-center md:justify-between">
      <div class="min-w-0 flex-1">
        <h2 class="text-2xl font-bold text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">
          Editar Código: {discountCode.code}
        </h2>
      </div>
    </div>

    {errorMessage && (
      <div class="mt-4 rounded-md bg-red-50 p-4">
        <p class="text-sm font-medium text-red-800">{errorMessage}</p>
      </div>
    )}

    {successMessage && (
      <div class="mt-4 rounded-md bg-green-50 p-4">
        <p class="text-sm font-medium text-green-800">{successMessage}</p>
      </div>
    )}

    <form method="POST" class="mt-8 space-y-8">
      <div class="grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
        <!-- Código -->
        <div class="sm:col-span-3">
          <label for="code" class="block text-sm font-medium text-gray-900">
            Código *
          </label>
          <input
            type="text"
            name="code"
            id="code"
            required
            value={discountCode.code}
            class="mt-2 block w-full rounded-md border-0 px-3 py-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm"
            placeholder="VERANO2025"
          />
          <p class="mt-1 text-sm text-gray-500">
            El código se convertirá a mayúsculas automáticamente
          </p>
        </div>

        <!-- Tipo de descuento -->
        <div class="sm:col-span-3">
          <label for="discount_type" class="block text-sm font-medium text-gray-900">
            Tipo de descuento *
          </label>
          <select
            name="discount_type"
            id="discount_type"
            required
            class="mt-2 block w-full rounded-md border-0 px-3 py-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm"
          >
            <option value="percentage" selected={discountCode.discount_type === 'percentage'}>
              Porcentaje (%)
            </option>
            <option value="fixed" selected={discountCode.discount_type === 'fixed'}>
              Monto fijo ($)
            </option>
          </select>
        </div>

        <!-- Valor del descuento -->
        <div class="sm:col-span-3">
          <label for="discount_value" class="block text-sm font-medium text-gray-900">
            Valor del descuento *
          </label>
          <input
            type="number"
            name="discount_value"
            id="discount_value"
            required
            min="0"
            step="0.01"
            value={discountCode.discount_value}
            class="mt-2 block w-full rounded-md border-0 px-3 py-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm"
            placeholder="10.00"
          />
        </div>

        <!-- Monto mínimo de compra -->
        <div class="sm:col-span-3">
          <label for="min_purchase_amount" class="block text-sm font-medium text-gray-900">
            Monto mínimo de compra ($)
          </label>
          <input
            type="number"
            name="min_purchase_amount"
            id="min_purchase_amount"
            min="0"
            step="0.01"
            value={discountCode.min_purchase_amount || ''}
            class="mt-2 block w-full rounded-md border-0 px-3 py-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm"
            placeholder="500.00"
          />
          <p class="mt-1 text-sm text-gray-500">
            Opcional: Compra mínima requerida para aplicar el código
          </p>
        </div>

        <!-- Descuento máximo -->
        <div class="sm:col-span-3">
          <label for="max_discount_amount" class="block text-sm font-medium text-gray-900">
            Descuento máximo ($)
          </label>
          <input
            type="number"
            name="max_discount_amount"
            id="max_discount_amount"
            min="0"
            step="0.01"
            value={discountCode.max_discount_amount || ''}
            class="mt-2 block w-full rounded-md border-0 px-3 py-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm"
            placeholder="1000.00"
          />
          <p class="mt-1 text-sm text-gray-500">
            Opcional: Aplica solo para descuentos de porcentaje
          </p>
        </div>

        <!-- Límite de uso -->
        <div class="sm:col-span-3">
          <label for="usage_limit" class="block text-sm font-medium text-gray-900">
            Límite de uso
          </label>
          <input
            type="number"
            name="usage_limit"
            id="usage_limit"
            min="1"
            value={discountCode.usage_limit || ''}
            class="mt-2 block w-full rounded-md border-0 px-3 py-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm"
            placeholder="100"
          />
          <p class="mt-1 text-sm text-gray-500">
            Opcional: Número máximo de veces que se puede usar
          </p>
        </div>

        <!-- Contador de uso (solo lectura) -->
        <div class="sm:col-span-3">
          <label class="block text-sm font-medium text-gray-900">
            Veces usado
          </label>
          <div class="mt-2 block w-full rounded-md border-0 px-3 py-2 bg-gray-50 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 sm:text-sm">
            {discountCode.usage_count} veces
          </div>
          <p class="mt-1 text-sm text-gray-500">
            Este valor no se puede editar manualmente
          </p>
        </div>

        <!-- Descripción -->
        <div class="sm:col-span-6">
          <label for="description" class="block text-sm font-medium text-gray-900">
            Descripción
          </label>
          <textarea
            name="description"
            id="description"
            rows={3}
            class="mt-2 block w-full rounded-md border-0 px-3 py-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm"
            placeholder="Descripción interna del código de descuento"
          >{discountCode.description || ''}</textarea>
        </div>

        <!-- Fecha de inicio -->
        <div class="sm:col-span-3">
          <label for="start_date" class="block text-sm font-medium text-gray-900">
            Fecha de inicio
          </label>
          <input
            type="datetime-local"
            name="start_date"
            id="start_date"
            value={formatDateForInput(discountCode.start_date)}
            class="mt-2 block w-full rounded-md border-0 px-3 py-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm"
          />
          <p class="mt-1 text-sm text-gray-500">
            Opcional: Deja en blanco para que sea válido desde ahora
          </p>
        </div>

        <!-- Fecha de fin -->
        <div class="sm:col-span-3">
          <label for="end_date" class="block text-sm font-medium text-gray-900">
            Fecha de expiración
          </label>
          <input
            type="datetime-local"
            name="end_date"
            id="end_date"
            value={formatDateForInput(discountCode.end_date)}
            class="mt-2 block w-full rounded-md border-0 px-3 py-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm"
          />
          <p class="mt-1 text-sm text-gray-500">
            Opcional: Deja en blanco para que no expire
          </p>
        </div>

        <!-- Estado activo -->
        <div class="sm:col-span-6">
          <div class="flex items-center">
            <input
              type="checkbox"
              name="is_active"
              id="is_active"
              checked={discountCode.is_active}
              class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
            />
            <label for="is_active" class="ml-2 block text-sm text-gray-900">
              Código activo
            </label>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-end gap-x-6 border-t border-gray-900/10 pt-6">
        <a
          href="/admin/discount-codes"
          class="text-sm font-semibold text-gray-900"
        >
          Cancelar
        </a>
        <button
          type="submit"
          class="rounded-md bg-primary px-3 py-2 text-sm font-semibold text-primary-foreground shadow-sm hover:bg-primary/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
        >
          Guardar cambios
        </button>
      </div>
    </form>
  </div>
</AdminLayout>
