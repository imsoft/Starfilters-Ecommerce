---
import AdminLayout from "@/layouts/adminLayout.astro";
import { Button } from "@/components/ui/button";
import AdminFilters from "@/components/shared/AdminFilters.astro";
import { getAllProducts } from "@/lib/product-service";
import { requireAdmin } from "@/lib/auth-utils";
import type { Product } from "@/lib/database";

// Verificar que el usuario es administrador
const { redirect } = await requireAdmin(Astro.cookies);
if (redirect) {
  return Astro.redirect(redirect);
}

// Obtener par√°metros de la URL
const url = new URL(Astro.request.url);
const success = url.searchParams.get('success');
const error = url.searchParams.get('error');
const currentPage = parseInt(url.searchParams.get('page') || '1');
const itemsPerPage = parseInt(url.searchParams.get('perPage') || '10');

// Obtener todos los productos desde Bind ERP (fuente √∫nica)
// getAllProducts itera autom√°ticamente todas las p√°ginas de Bind
let allProducts: Product[] = [];

try {
  allProducts = await getAllProducts(); // Obtiene TODOS los productos iterando p√°ginas
  console.log('üì¶ Total productos cargados:', allProducts.length);
} catch (error) {
  console.error('‚ùå Error obteniendo productos de Bind:', error);
  allProducts = [];
}

// Obtener im√°genes principales para todos los productos
import { query } from '@/config/database';
import type { ProductImage } from '@/lib/database';

interface ProductWithImage extends Product {
  primary_image_url?: string | null;
}

let productsWithImages: ProductWithImage[] = [];

try {
  if (allProducts.length > 0) {
    const productIds = allProducts.map(p => p.id);
    const placeholders = productIds.map(() => '?').join(',');
    
    const primaryImages = await query(
      `SELECT product_id, image_url 
       FROM product_images 
       WHERE product_id IN (${placeholders}) AND is_primary = 1`,
      productIds
    ) as Array<{ product_id: number; image_url: string }>;
    
    // Crear un mapa de product_id -> image_url
    const imageMap = new Map<number, string>();
    primaryImages.forEach(img => {
      imageMap.set(img.product_id, img.image_url);
    });
    
    // Agregar imagen principal a cada producto
    productsWithImages = allProducts.map(product => ({
      ...product,
      primary_image_url: imageMap.get(product.id) || null
    }));
  } else {
    productsWithImages = allProducts;
  }
} catch (error) {
  console.error('‚ùå Error obteniendo im√°genes principales:', error);
  productsWithImages = allProducts.map(p => ({ ...p, primary_image_url: null }));
}

// Estad√≠sticas (calculadas sobre TODOS los productos, no solo la p√°gina actual)
const totalProducts = productsWithImages.length;
const activeProducts = productsWithImages.filter(product => product.status === 'active').length;
const inactiveProducts = productsWithImages.filter(product => product.status === 'inactive').length;
const draftProducts = productsWithImages.filter(product => product.status === 'draft').length;

// Calcular paginaci√≥n
const totalPages = Math.ceil(totalProducts / itemsPerPage);
const startIndex = (currentPage - 1) * itemsPerPage;
const endIndex = startIndex + itemsPerPage;
const paginatedProducts = productsWithImages.slice(startIndex, endIndex);

// Calcular n√∫meros de p√°gina a mostrar (evitar operadores < > en JSX)
const pageNumbers: number[] = [];
const pagesToShow = Math.min(5, totalPages);
for (let i = 0; i < pagesToShow; i++) {
  let pageNum;
  if (totalPages <= 5) {
    pageNum = i + 1;
  } else if (currentPage <= 3) {
    pageNum = i + 1;
  } else if (currentPage >= totalPages - 2) {
    pageNum = totalPages - 4 + i;
  } else {
    pageNum = currentPage - 2 + i;
  }
  pageNumbers.push(pageNum);
}

// Funci√≥n para formatear moneda
function formatCurrency(amount: number): string {
  return new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN'
  }).format(amount);
}
---

<AdminLayout title="Gesti√≥n de Productos">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="mt-10 mb-8">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold tracking-tight text-foreground">Gesti√≥n de Productos</h1>
            <p class="mt-2 text-muted-foreground">
              Administra todos los productos de tu tienda
            </p>
          </div>
          <div class="flex items-center gap-3">
            <a href="/admin/products/import">
              <Button className="bg-green-600 text-white hover:bg-green-700 border-0">
                <svg class="mr-2 h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
                Importar Excel
              </Button>
            </a>
            <a href="/admin/products/add">
              <Button className="bg-primary text-primary-foreground hover:bg-primary/90">
                <svg class="mr-2 h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                </svg>
                Agregar Producto
              </Button>
            </a>
          </div>
        </div>
      </div>

      <!-- Estad√≠sticas de productos -->
      <div class="mb-8 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
        <div class="rounded-lg border border-border bg-background p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-8 w-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                <path d="M7 4V2C7 1.45 7.45 1 8 1H16C16.55 1 17 1.45 17 2V4H20C20.55 4 21 4.45 21 5V19C21 19.55 20.55 20 20 20H4C3.45 20 3 19.55 3 19V5C3 4.45 3.45 4 4 4H7ZM9 3V4H15V3H9ZM5 6V18H19V6H5Z"/>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-muted-foreground">Total Productos</p>
              <p class="text-2xl font-semibold text-foreground">{totalProducts}</p>
            </div>
          </div>
        </div>

        <div class="rounded-lg border border-border bg-background p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-8 w-8 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                <path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-muted-foreground">Activos</p>
              <p class="text-2xl font-semibold text-foreground">{activeProducts}</p>
            </div>
          </div>
        </div>

        <div class="rounded-lg border border-border bg-background p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-8 w-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-muted-foreground">Borradores</p>
              <p class="text-2xl font-semibold text-foreground">{draftProducts}</p>
            </div>
          </div>
        </div>

        <div class="rounded-lg border border-border bg-background p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-8 w-8 text-red-600" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-muted-foreground">Inactivos</p>
              <p class="text-2xl font-semibold text-foreground">{inactiveProducts}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensajes de √©xito -->
      {success === 'created' && (
        <div class="mb-6 rounded-md bg-green-50 border border-green-200 p-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-green-800">Producto creado</h3>
              <div class="mt-2 text-sm text-green-700">
                <p>El producto se ha creado exitosamente.</p>
              </div>
            </div>
          </div>
        </div>
      )}

      {success === 'draft_saved' && (
        <div class="mb-6 rounded-md bg-blue-50 border border-blue-200 p-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-blue-800">Borrador guardado</h3>
              <div class="mt-2 text-sm text-blue-700">
                <p>El producto se ha guardado como borrador.</p>
              </div>
            </div>
          </div>
        </div>
      )}

      {success === 'updated' && (
        <div class="mb-6 rounded-md bg-green-50 border border-green-200 p-4" id="success-message">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div class="ml-3 flex-1">
              <h3 class="text-sm font-medium text-green-800">Producto actualizado</h3>
              <div class="mt-2 text-sm text-green-700">
                <p>El producto se ha actualizado exitosamente.</p>
              </div>
            </div>
            <div class="ml-auto pl-3">
              <button
                type="button"
                class="inline-flex rounded-md bg-green-50 text-green-400 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
                onclick="closeSuccessMessage()"
              >
                <span class="sr-only">Cerrar</span>
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      )}

      {error === 'product_not_found' && (
        <div class="mb-6 rounded-md bg-red-50 border border-red-200 p-4" id="error-message">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div class="ml-3 flex-1">
              <h3 class="text-sm font-medium text-red-800">Producto no encontrado</h3>
              <div class="mt-2 text-sm text-red-700">
                <p>El producto que intentas editar no existe.</p>
              </div>
            </div>
            <div class="ml-auto pl-3">
              <button
                type="button"
                class="inline-flex rounded-md bg-red-50 text-red-400 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
                onclick="closeErrorMessage()"
              >
                <span class="sr-only">Cerrar</span>
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      )}

      {error === 'invalid_id' && (
        <div class="mb-6 rounded-md bg-red-50 border border-red-200 p-4" id="error-message">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div class="ml-3 flex-1">
              <h3 class="text-sm font-medium text-red-800">ID inv√°lido</h3>
              <div class="mt-2 text-sm text-red-700">
                <p>El ID del producto no es v√°lido.</p>
              </div>
            </div>
            <div class="ml-auto pl-3">
              <button
                type="button"
                class="inline-flex rounded-md bg-red-50 text-red-400 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
                onclick="closeErrorMessage()"
              >
                <span class="sr-only">Cerrar</span>
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      )}

      <!-- Filtros y b√∫squeda -->
      <AdminFilters
        searchPlaceholder="Buscar productos..."
        searchId="search-products"
        filters={[
          {
            id: "category-filter",
            label: "Todas las categor√≠as",
            options: [
              { value: "filtros", label: "Filtros" },
              { value: "cuartos-limpios", label: "Cuartos Limpios" },
              { value: "accesorios", label: "Accesorios" },
              { value: "servicios", label: "Servicios" }
            ]
          },
          {
            id: "stock-filter",
            label: "Filtrar por stock",
            options: [
              { value: "all", label: "Todo el stock" },
              { value: "out", label: "Sin stock (0)" },
              { value: "low", label: "Bajo stock (1-10)" },
              { value: "medium", label: "Stock medio (11-50)" },
              { value: "high", label: "Stock alto (50+)" }
            ]
          }
        ]}
      />

      <!-- Selector de items por p√°gina -->
      <div class="mb-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <label for="items-per-page" class="text-sm font-medium text-foreground">
            Mostrar:
          </label>
          <select
            id="items-per-page"
            class="rounded-md border border-border bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
          >
            <option value="10" selected={itemsPerPage === 10}>10</option>
            <option value="25" selected={itemsPerPage === 25}>25</option>
            <option value="50" selected={itemsPerPage === 50}>50</option>
            <option value="100" selected={itemsPerPage === 100}>100</option>
          </select>
          <span class="text-sm text-muted-foreground">productos por p√°gina</span>
        </div>
        <div class="text-sm text-muted-foreground">
          Mostrando <span class="font-medium text-foreground">{startIndex + 1}</span> a <span class="font-medium text-foreground">{Math.min(endIndex, totalProducts)}</span> de <span class="font-medium text-foreground">{totalProducts}</span> productos
        </div>
      </div>

      <!-- Tabla de productos -->
      <div class="rounded-lg border border-border bg-background">
        {paginatedProducts.length === 0 ? (
          <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-foreground">No hay productos</h3>
            <p class="mt-1 text-sm text-muted-foreground">Comienza agregando tu primer producto.</p>
            <div class="mt-6">
              <a href="/admin/products/add">
                <Button className="bg-primary text-primary-foreground hover:bg-primary/90">
                  <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                  </svg>
                  Agregar Producto
                </Button>
              </a>
            </div>
          </div>
        ) : (
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-muted">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Imagen</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Producto</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Precio</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Stock</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Acciones</th>
                </tr>
              </thead>
              <tbody id="products-table-body" class="divide-y divide-border">
                {paginatedProducts.map((product) => (
                  <tr class="hover:bg-muted/50">
                    <td class="px-6 py-4 whitespace-nowrap">
                      {product.primary_image_url ? (
                        <img
                          src={product.primary_image_url}
                          alt={product.name}
                          class="h-20 w-20 rounded-lg object-cover border border-gray-200"
                          onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'80\'%3E%3Crect fill=\'%23f3f4f6\' width=\'80\' height=\'80\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\' font-family=\'sans-serif\' font-size=\'12\'%3ESin imagen%3C/text%3E%3C/svg%3E';"
                        />
                      ) : (
                        <div class="flex h-20 w-20 items-center justify-center rounded-lg bg-muted border border-gray-200">
                          <svg
                            class="h-8 w-8 text-muted-foreground"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                            />
                          </svg>
                        </div>
                      )}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-foreground">{product.name}</div>
                        <div class="text-sm text-muted-foreground capitalize">{product.category?.replace('-', ' ') || 'Sin categor√≠a'}</div>
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-foreground">
                      {formatCurrency(product.price || 0)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                        product.stock === 0
                          ? 'bg-red-100 text-red-800'
                          : product.stock < 10
                          ? 'bg-yellow-100 text-yellow-800'
                          : 'bg-green-100 text-green-800'
                      }`}>
                        {product.stock} unidades
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                      <div class="flex space-x-2">
                        <a href={`/admin/products/edit/${product.id}`}>
                          <Button variant="outline" size="sm" className="border-border text-foreground hover:bg-muted">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                          </Button>
                        </a>
                        <a href={`/product/${product.uuid}`}>
                          <Button variant="outline" size="sm" className="border-border text-foreground hover:bg-muted">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                          </Button>
                        </a>
                        <button 
                          type="button"
                          class="inline-flex items-center justify-center rounded-md border border-border bg-background px-3 py-1.5 text-sm font-medium text-red-600 hover:bg-red-50 transition-colors"
                          data-product-id={product.id}
                          data-delete-product
                        >
                          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                          </svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}

        <!-- Paginaci√≥n -->
        {totalPages > 1 && (
          <div class="px-6 py-4 border-t border-border">
            <div class="flex items-center justify-between">
              <div class="text-sm text-muted-foreground">
                P√°gina <span class="font-medium text-foreground">{currentPage}</span> de <span class="font-medium text-foreground">{totalPages}</span>
              </div>
              <div class="flex items-center gap-2">
                {/* Bot√≥n Primera P√°gina */}
                <a
                  href={`/admin/products?page=1&perPage=${itemsPerPage}`}
                  class={`inline-flex items-center px-3 py-2 text-sm font-medium rounded-md ${
                    currentPage === 1
                      ? 'bg-muted text-muted-foreground cursor-not-allowed'
                      : 'bg-background border border-border text-foreground hover:bg-muted'
                  }`}
                  aria-disabled={currentPage === 1}
                >
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                  </svg>
                </a>

                {/* Bot√≥n Anterior */}
                <a
                  href={`/admin/products?page=${Math.max(1, currentPage - 1)}&perPage=${itemsPerPage}`}
                  class={`inline-flex items-center px-3 py-2 text-sm font-medium rounded-md ${
                    currentPage === 1
                      ? 'bg-muted text-muted-foreground cursor-not-allowed'
                      : 'bg-background border border-border text-foreground hover:bg-muted'
                  }`}
                  aria-disabled={currentPage === 1}
                >
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                  Anterior
                </a>

                {/* N√∫meros de p√°gina */}
                {pageNumbers.map((pageNum) => (
                  <a
                    href={`/admin/products?page=${pageNum}&perPage=${itemsPerPage}`}
                    class={`inline-flex items-center px-4 py-2 text-sm font-medium rounded-md ${
                      currentPage === pageNum
                        ? 'bg-primary text-primary-foreground'
                        : 'bg-background border border-border text-foreground hover:bg-muted'
                    }`}
                  >
                    {pageNum}
                  </a>
                ))}

                {/* Bot√≥n Siguiente */}
                <a
                  href={`/admin/products?page=${Math.min(totalPages, currentPage + 1)}&perPage=${itemsPerPage}`}
                  class={`inline-flex items-center px-3 py-2 text-sm font-medium rounded-md ${
                    currentPage === totalPages
                      ? 'bg-muted text-muted-foreground cursor-not-allowed'
                      : 'bg-background border border-border text-foreground hover:bg-muted'
                  }`}
                  aria-disabled={currentPage === totalPages}
                >
                  Siguiente
                  <svg class="h-4 w-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </a>

                {/* Bot√≥n √öltima P√°gina */}
                <a
                  href={`/admin/products?page=${totalPages}&perPage=${itemsPerPage}`}
                  class={`inline-flex items-center px-3 py-2 text-sm font-medium rounded-md ${
                    currentPage === totalPages
                      ? 'bg-muted text-muted-foreground cursor-not-allowed'
                      : 'bg-background border border-border text-foreground hover:bg-muted'
                  }`}
                  aria-disabled={currentPage === totalPages}
                >
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                  </svg>
                </a>
              </div>
            </div>
          </div>
        )}
      </div>
  </div>
</AdminLayout>

<script>
  // Funci√≥n para cerrar mensajes de error (debe estar en scope global)
  window.closeErrorMessage = function() {
    const errorMessage = document.getElementById('error-message');
    if (errorMessage) {
      errorMessage.remove();
    }
    // Limpiar par√°metros de error de la URL
    const url = new URL(window.location.href);
    url.searchParams.delete('error');
    window.history.replaceState({}, '', url);
  };

  // Funci√≥n para cerrar mensajes de √©xito (debe estar en scope global)
  window.closeSuccessMessage = function() {
    const successMessage = document.getElementById('success-message');
    if (successMessage) {
      successMessage.remove();
    }
    // Limpiar par√°metros de √©xito de la URL
    const url = new URL(window.location.href);
    url.searchParams.delete('success');
    window.history.replaceState({}, '', url);
  };

  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-products');
    const categoryFilter = document.getElementById('category-filter');
    const stockFilter = document.getElementById('stock-filter');
    const tableBody = document.getElementById('products-table-body');
    const itemsPerPageSelect = document.getElementById('items-per-page');

    // Manejar cambio de items por p√°gina
    itemsPerPageSelect?.addEventListener('change', (e) => {
      const target = e.target as HTMLSelectElement;
      const perPage = target.value;
      const url = new URL(window.location.href);
      url.searchParams.set('perPage', perPage);
      url.searchParams.set('page', '1'); // Resetear a p√°gina 1 al cambiar items por p√°gina
      window.location.href = url.toString();
    });

    // Funci√≥n para filtrar productos
    function filterProducts() {
      const searchTerm = (searchInput as HTMLInputElement)?.value.toLowerCase() || '';
      const selectedCategory = (categoryFilter as HTMLSelectElement)?.value || '';
      const selectedStockRange = (stockFilter as HTMLSelectElement)?.value || '';

      console.log('üîç Filtros aplicados:', { searchTerm, selectedCategory, selectedStockRange });

      if (!tableBody) return;

      const rows = tableBody.querySelectorAll('tr');
      let visibleCount = 0;

      rows.forEach((row) => {
        const productName = row.querySelector('td:nth-child(2) .text-sm.font-medium')?.textContent?.toLowerCase() || '';
        const productCategory = row.querySelector('td:nth-child(2) .text-muted-foreground')?.textContent?.toLowerCase() || '';
        const stockBadge = row.querySelector('td:nth-child(4) span');
        const stockText = stockBadge?.textContent?.toLowerCase() || '';

        // Extraer n√∫mero de stock del texto "X unidades"
        const stockMatch = stockText.match(/(\d+)/);
        const stock = stockMatch ? parseInt(stockMatch[1]) : 0;

        // Aplicar filtro de stock
        let matchesStock = true;
        if (selectedStockRange && selectedStockRange !== 'all') {
          if (selectedStockRange === 'out') {
            matchesStock = stock === 0;
          } else if (selectedStockRange === 'low') {
            matchesStock = stock >= 1 && stock <= 10;
          } else if (selectedStockRange === 'medium') {
            matchesStock = stock >= 11 && stock <= 50;
          } else if (selectedStockRange === 'high') {
            matchesStock = stock > 50;
          }
        }

        // Aplicar filtros
        const matchesSearch = productName.includes(searchTerm);
        const matchesCategory = !selectedCategory || productCategory.includes(selectedCategory);

        if (matchesSearch && matchesCategory && matchesStock) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });

      console.log(`‚úÖ ${visibleCount} productos mostrados despu√©s del filtrado`);
    }

    // Event listeners para filtros
    searchInput?.addEventListener('input', filterProducts);
    categoryFilter?.addEventListener('change', filterProducts);
    stockFilter?.addEventListener('change', filterProducts);

    // Event listeners para botones de eliminar
    const deleteButtons = document.querySelectorAll('[data-delete-product]');
    deleteButtons.forEach(button => {
      button.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const productId = button.getAttribute('data-product-id');
        if (!productId) {
          console.error('‚ùå No se encontr√≥ el ID del producto');
          return;
        }

        const confirmed = confirm('¬øEst√°s seguro de eliminar este producto? Esta acci√≥n no se puede deshacer.');
        if (!confirmed) {
          return;
        }

        try {
          button.disabled = true;
          button.classList.add('opacity-50', 'cursor-not-allowed');

          const response = await fetch(`/api/products/${productId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          const data = await response.json();

          if (data.success) {
            console.log('‚úÖ Producto eliminado exitosamente');
            // Recargar la p√°gina para actualizar la lista
            window.location.reload();
          } else {
            alert(`Error al eliminar el producto: ${data.message || 'Error desconocido'}`);
            button.disabled = false;
            button.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        } catch (error) {
          console.error('‚ùå Error eliminando producto:', error);
          alert('Error al eliminar el producto. Por favor, intenta de nuevo.');
          button.disabled = false;
          button.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      });
    });

    console.log('üéØ Filtros de productos inicializados');
    console.log(`üóëÔ∏è ${deleteButtons.length} botones de eliminar configurados`);
  });
</script>