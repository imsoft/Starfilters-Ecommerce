---
import AdminLayout from "@/layouts/adminLayout.astro";
import { getAuthenticatedUser } from '@/lib/auth-utils';
import { isUserAdmin } from '@/lib/database';

export const prerender = false;

const user = getAuthenticatedUser(Astro.cookies);

if (!user) {
  return Astro.redirect('/login');
}

const userIsAdmin = await isUserAdmin(user.id);

if (!userIsAdmin) {
  return Astro.redirect('/');
}
---

<AdminLayout>
  <div class="mx-auto max-w-4xl px-4 py-8">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-foreground">Importar Productos desde Excel</h1>
      <p class="mt-2 text-muted-foreground">
        Sube un archivo Excel (.xlsx) con tus productos para importarlos masivamente.
      </p>
    </div>

    <div class="rounded-lg border border-border bg-card p-6 shadow-sm">
      <form id="import-form" enctype="multipart/form-data">
        <div class="space-y-6">
          <!-- Zona de carga estilo imagen -->
          <div>
            <label
              for="excel-file"
              id="excel-dropzone"
              class="flex cursor-pointer flex-col items-center justify-center rounded-lg border-2 border-dashed border-border bg-muted/30 px-4 py-12 transition-colors hover:border-primary/50 hover:bg-muted/50"
            >
              <div class="text-center">
                <!-- √çcono de Excel/Documento -->
                <svg
                  class="mx-auto h-16 w-16 text-green-600"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                  <path d="M8 13h8M8 17h8M8 9h4" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                <p class="mt-4 text-sm font-medium text-foreground">
                  <span class="font-semibold">Click para subir</span> o arrastra y suelta
                </p>
                <p class="mt-1 text-xs text-muted-foreground">
                  XLSX, XLS hasta 10MB
                </p>
                <p id="file-name" class="mt-2 text-sm font-medium text-primary hidden"></p>
              </div>
              <input
                type="file"
                id="excel-file"
                name="excel-file"
                accept=".xlsx,.xls"
                required
                class="hidden"
              />
            </label>
            <p class="mt-3 text-xs text-muted-foreground">
              El archivo debe tener las columnas: nombre, descripci√≥n, precio, categor√≠a, stock, status, etc.
            </p>
          </div>

          <div class="flex items-center gap-4">
            <button
              type="submit"
              id="import-btn"
              disabled
              class="rounded-md bg-primary px-4 py-2 text-sm font-semibold text-primary-foreground shadow-xs hover:bg-primary/90 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Importar Productos
            </button>
            <a
              href="/templates/productos-template.xlsx"
              download="productos-template.xlsx"
              class="rounded-md border border-border bg-background px-4 py-2 text-sm font-semibold text-foreground shadow-xs hover:bg-muted"
            >
              Descargar Plantilla
            </a>
          </div>
        </div>
      </form>

      <div id="import-status" class="mt-6 hidden">
        <div class="rounded-md bg-muted p-4">
          <div class="flex items-center gap-2">
            <div id="status-icon" class="text-lg">‚è≥</div>
            <div class="flex-1">
              <p id="status-message" class="text-sm font-medium text-foreground">Procesando...</p>
              <div id="status-details" class="mt-2 text-xs text-muted-foreground"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="import-results" class="mt-6 hidden">
        <div class="rounded-md border border-border bg-card p-4">
          <h3 class="text-lg font-semibold text-foreground mb-4">Resultados de la Importaci√≥n</h3>
          <div id="results-content" class="space-y-2"></div>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  const form = document.getElementById('import-form');
  const fileInput = document.getElementById('excel-file');
  const dropzone = document.getElementById('excel-dropzone');
  const fileName = document.getElementById('file-name');
  const importBtn = document.getElementById('import-btn');
  const statusDiv = document.getElementById('import-status');
  const statusMessage = document.getElementById('status-message');
  const statusDetails = document.getElementById('status-details');
  const statusIcon = document.getElementById('status-icon');
  const resultsDiv = document.getElementById('import-results');
  const resultsContent = document.getElementById('results-content');

  // Manejar drag and drop
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropzone.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    dropzone.addEventListener(eventName, () => {
      dropzone.classList.add('border-primary', 'bg-primary/10');
    }, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropzone.addEventListener(eventName, () => {
      dropzone.classList.remove('border-primary', 'bg-primary/10');
    }, false);
  });

  dropzone.addEventListener('drop', (e) => {
    const dt = e.dataTransfer;
    const files = dt.files;
    if (files.length > 0) {
      fileInput.files = files;
      updateFileName();
    }
  }, false);

  fileInput.addEventListener('change', updateFileName);

  function updateFileName() {
    if (fileInput.files && fileInput.files.length > 0) {
      fileName.textContent = `üìÑ ${fileInput.files[0].name}`;
      fileName.classList.remove('hidden');
      importBtn.disabled = false;
    } else {
      fileName.classList.add('hidden');
      importBtn.disabled = true;
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const file = fileInput.files?.[0];
    if (!file) {
      alert('Por favor selecciona un archivo Excel');
      return;
    }

    // Validar extensi√≥n
    if (!file.name.match(/\.(xlsx|xls)$/i)) {
      alert('Por favor selecciona un archivo Excel (.xlsx o .xls)');
      return;
    }

    // Mostrar estado de carga
    importBtn.disabled = true;
    importBtn.textContent = 'Importando...';
    statusDiv.classList.remove('hidden');
    statusMessage.textContent = 'Subiendo y procesando archivo...';
    statusIcon.textContent = '‚è≥';
    statusDetails.textContent = '';
    resultsDiv.classList.add('hidden');

    try {
      const formData = new FormData();
      formData.append('file', file);

      const response = await fetch('/api/products/import-excel', {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();

      if (result.success) {
        statusIcon.textContent = '‚úÖ';
        statusMessage.textContent = 'Importaci√≥n completada';
        statusDetails.innerHTML = `
          <p>‚úÖ Productos importados exitosamente: ${result.successCount || 0}</p>
          ${result.errorCount > 0 ? `<p>‚ùå Errores: ${result.errorCount}</p>` : ''}
        `;

        // Mostrar resultados detallados
        if (result.results) {
          resultsDiv.classList.remove('hidden');
          let html = '';
          
          if (result.results.success && result.results.success.length > 0) {
            html += '<div class="mb-4"><h4 class="font-semibold text-green-600 mb-2">‚úÖ Productos Importados:</h4><ul class="list-disc list-inside space-y-1 text-sm">';
            result.results.success.forEach((item: any) => {
              html += `<li>${item.name || 'Sin nombre'} (ID: ${item.id})</li>`;
            });
            html += '</ul></div>';
          }

          if (result.results.errors && result.results.errors.length > 0) {
            html += '<div><h4 class="font-semibold text-red-600 mb-2">‚ùå Errores:</h4><ul class="list-disc list-inside space-y-1 text-sm">';
            result.results.errors.forEach((error: any) => {
              html += `<li>Fila ${error.row}: ${error.message}</li>`;
            });
            html += '</ul></div>';
          }

          resultsContent.innerHTML = html;
        }

        // Limpiar formulario
        form.reset();
        updateFileName();
      } else {
        statusIcon.textContent = '‚ùå';
        statusMessage.textContent = 'Error en la importaci√≥n';
        statusDetails.textContent = result.message || 'Error desconocido';
      }
    } catch (error) {
      console.error('Error:', error);
      statusIcon.textContent = '‚ùå';
      statusMessage.textContent = 'Error al procesar el archivo';
      statusDetails.textContent = error instanceof Error ? error.message : 'Error desconocido';
    } finally {
      importBtn.disabled = false;
      importBtn.textContent = 'Importar Productos';
    }
  });
</script>
