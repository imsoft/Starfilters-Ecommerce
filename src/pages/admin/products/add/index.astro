---
import AdminLayout from "@/layouts/adminLayout.astro";
import { Button } from "@/components/ui/button";
import { createProduct } from "@/lib/product-service";
import { getAllCategories } from "@/lib/filter-category-service";
import { requireAdmin } from "@/lib/auth-utils";
import { generateUUID } from "@/lib/database";

// Verificar que el usuario es administrador
const { redirect } = await requireAdmin(Astro.cookies);
if (redirect) {
  return Astro.redirect(redirect);
}

// Obtener categor√≠as de filtros para el dropdown
let filterCategories: any[] = [];
try {
  filterCategories = await getAllCategories();
} catch (error) {
  console.error('Error obteniendo categor√≠as:', error);
}

// Manejar env√≠o del formulario
let errorMessage = '';

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();

    const filterCategoryId = formData.get('filter_category_id')?.toString();
    const productData = {
      uuid: generateUUID(),
      filter_category_id: filterCategoryId ? parseInt(filterCategoryId) : null,
      bind_code: formData.get('bind_code')?.toString() || null,
      name: formData.get('name')?.toString() || '',
      description: formData.get('description')?.toString() || '',
      nominal_size: formData.get('nominal_size')?.toString() || null,
      real_size: formData.get('real_size')?.toString() || null,
      price: parseFloat(formData.get('price')?.toString() || '0'),
      currency: (formData.get('currency') as 'MXN' | 'USD') || 'MXN',
      price_usd: formData.get('price_usd') ? parseFloat(formData.get('price_usd')?.toString() || '0') : null,
      category: formData.get('category')?.toString() || '',
      stock: parseInt(formData.get('stock')?.toString() || '0'),
      weight: formData.get('weight')?.toString() || undefined,
      tags: formData.get('tags')?.toString() || undefined,
      status: 'active' as const
    };

    console.log('üìù Creando producto con datos:', productData);

    // Validar datos requeridos
    if (!productData.name || !productData.description || productData.price <= 0) {
      throw new Error('Nombre, descripci√≥n y precio son campos requeridos');
    }

    // Crear el producto en la base de datos local
    console.log('‚ú® Creando producto en la base de datos...');
    const productId = await createProduct(productData);

    if (productId) {
      console.log('‚úÖ Producto creado con ID:', productId);
      return Astro.redirect(`/admin/products?success=created`);
    } else {
      errorMessage = 'Error al crear el producto';
    }
  } catch (error) {
    console.error('Error creando producto:', error);
    errorMessage = error instanceof Error ? error.message : 'Error al crear el producto';
  }
}
---

<AdminLayout title="Agregar Producto">
  <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="mt-10 mb-8">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold tracking-tight text-foreground">Agregar Producto</h1>
            <p class="mt-2 text-muted-foreground">
              Completa la informaci√≥n del nuevo producto (variante de categor√≠a de filtro)
            </p>
          </div>
          <a href="/admin/products">
            <Button variant="outline" className="border-border text-foreground hover:bg-muted">
              <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
              </svg>
              Volver
            </Button>
          </a>
        </div>
      </div>

      <!-- Mensajes de error -->
      {errorMessage && (
        <div class="mb-6 rounded-md bg-red-50 border border-red-200 p-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">Error</h3>
              <div class="mt-2 text-sm text-red-700">
                <p>{errorMessage}</p>
              </div>
            </div>
          </div>
        </div>
      )}

      <!-- Formulario -->
      <form method="POST" class="space-y-8">
        <div class="rounded-lg border border-border bg-background p-6">
          <h2 class="text-lg font-semibold text-foreground mb-6">Informaci√≥n B√°sica</h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Nombre del Producto (Title en Bind) -->
            <div class="md:col-span-2">
              <label for="name" class="block text-sm font-medium text-foreground mb-2">
                Nombre del Producto <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="Ej: Filtro HEPA H13 para Cuarto Limpio"
              />
            </div>

            <!-- Categor√≠a de Filtro -->
            <div>
              <label for="filter_category_id" class="block text-sm font-medium text-foreground mb-2">
                Categor√≠a de Filtro
              </label>
              <select
                id="filter_category_id"
                name="filter_category_id"
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
              >
                <option value="">Sin categor√≠a de filtro</option>
                {filterCategories.map(cat => (
                  <option value={cat.id}>{cat.name}</option>
                ))}
              </select>
              <p class="mt-1 text-sm text-muted-foreground">Selecciona la categor√≠a de filtro a la que pertenece este producto</p>
            </div>

            <!-- C√≥digo Bind -->
            <div>
              <label for="bind_code" class="block text-sm font-medium text-foreground mb-2">
                C√≥digo Bind
              </label>
              <input
                type="text"
                id="bind_code"
                name="bind_code"
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="Ej: HGD1"
              />
              <p class="mt-1 text-sm text-muted-foreground">C√≥digo del producto en Bind ERP</p>
            </div>

            <!-- Categor√≠a General -->
            <div>
              <label for="category" class="block text-sm font-medium text-foreground mb-2">
                Categor√≠a General
              </label>
              <input
                type="text"
                id="category"
                name="category"
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="Ej: Filtros de Aire"
              />
              <p class="mt-1 text-sm text-muted-foreground">Categor√≠a general del producto</p>
            </div>

            <!-- Precio MXN -->
            <div>
              <label for="price" class="block text-sm font-medium text-foreground mb-2">
                Precio (MXN) <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <span class="absolute left-3 top-2 text-muted-foreground">$</span>
                <input
                  type="number"
                  id="price"
                  name="price"
                  required
                  min="0"
                  step="0.01"
                  class="w-full rounded-md border border-border bg-background pl-7 pr-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                  placeholder="0.00"
                />
              </div>
            </div>

            <!-- Precio USD -->
            <div>
              <label for="price_usd" class="block text-sm font-medium text-foreground mb-2">
                Precio (USD)
              </label>
              <div class="relative">
                <span class="absolute left-3 top-2 text-muted-foreground">$</span>
                <input
                  type="number"
                  id="price_usd"
                  name="price_usd"
                  min="0"
                  step="0.01"
                  class="w-full rounded-md border border-border bg-background pl-7 pr-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                  placeholder="0.00"
                />
              </div>
            </div>

            <!-- Moneda -->
            <div>
              <label for="currency" class="block text-sm font-medium text-foreground mb-2">
                Moneda Principal
              </label>
              <select
                id="currency"
                name="currency"
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
              >
                <option value="MXN">MXN - Pesos Mexicanos</option>
                <option value="USD">USD - D√≥lares Americanos</option>
              </select>
            </div>

            <!-- Stock/Inventario -->
            <div>
              <label for="stock" class="block text-sm font-medium text-foreground mb-2">
                Stock/Inventario
              </label>
              <input
                type="number"
                id="stock"
                name="stock"
                min="0"
                value="0"
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="0"
              />
              <p class="mt-1 text-sm text-muted-foreground">Cantidad disponible en inventario</p>
            </div>

            <!-- Medida Nominal -->
            <div>
              <label for="nominal_size" class="block text-sm font-medium text-foreground mb-2">
                Medida Nominal
              </label>
              <input
                type="text"
                id="nominal_size"
                name="nominal_size"
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder='Ej: 9.125" x 9.125" x 3"'
              />
            </div>

            <!-- Medida Real -->
            <div>
              <label for="real_size" class="block text-sm font-medium text-foreground mb-2">
                Medida Real
              </label>
              <input
                type="text"
                id="real_size"
                name="real_size"
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="Ej: 231 x 231 x 75 mm"
              />
            </div>

            <!-- Descripci√≥n -->
            <div class="md:col-span-2">
              <label for="description" class="block text-sm font-medium text-foreground mb-2">
                Descripci√≥n <span class="text-red-500">*</span>
              </label>
              <textarea
                id="description"
                name="description"
                required
                rows="4"
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="Describe las caracter√≠sticas y beneficios del producto..."
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Informaci√≥n Adicional -->
        <div class="rounded-lg border border-border bg-background p-6">
          <h2 class="text-lg font-semibold text-foreground mb-6">Informaci√≥n Adicional</h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Peso -->
            <div>
              <label for="weight" class="block text-sm font-medium text-foreground mb-2">
                Peso
              </label>
              <input
                type="text"
                id="weight"
                name="weight"
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="Ej: 2.5 kg"
              />
            </div>

            <!-- Tags/Etiquetas -->
            <div>
              <label for="tags" class="block text-sm font-medium text-foreground mb-2">
                Etiquetas
              </label>
              <input
                type="text"
                id="tags"
                name="tags"
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="Ej: hepa, filtro, h13"
              />
              <p class="mt-1 text-sm text-muted-foreground">Separadas por comas</p>
            </div>
          </div>
        </div>

        <!-- Botones de acci√≥n -->
        <div class="flex items-center justify-end gap-4 pb-8">
          <a href="/admin/products">
            <Button type="button" variant="outline" className="border-border text-foreground hover:bg-muted">
              Cancelar
            </Button>
          </a>
          <Button type="submit" className="bg-primary text-primary-foreground hover:bg-primary/90">
            <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Crear Producto
          </Button>
        </div>
      </form>
  </div>
</AdminLayout>
