---
import AdminLayout from "@/layouts/adminLayout.astro";
import {
  createProduct,
} from "@/lib/product-service";
import { getActiveCategories } from "@/lib/filter-category-service";
import { getAuthenticatedUser } from '@/lib/auth-utils';
import { isUserAdmin } from '@/lib/database';
import { generateUUID } from "@/lib/database";
import ProductImageManagerCreate from "@/components/admin/ProductImageManagerCreate.astro";
import DynamicListInput from "@/components/admin/DynamicListInput.astro";
import ProductSizesTable from "@/components/admin/ProductSizesTable.astro";
import FormPersistence from "@/components/admin/FormPersistence.astro";

export const prerender = false;

const user = getAuthenticatedUser(Astro.cookies);

if (!user) {
  return Astro.redirect('/login');
}

const userIsAdmin = await isUserAdmin(user.id);

if (!userIsAdmin) {
  return Astro.redirect('/');
}

let error: string | null = null;
let success = false;

// Obtener categor√≠as de filtro para el selector
const filterCategories = await getActiveCategories();

// Procesar formulario
if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();

    // Crear UUID para el producto
    const uuid = generateUUID();

    // Procesar listas (eficiencia, caracter√≠sticas, aplicaciones, beneficios)
    // Pueden venir como JSON string o como array
    const processListField = (field: string | FormDataEntryValue | null): string | null => {
      if (!field) return null;
      if (typeof field === 'string') {
        try {
          const parsed = JSON.parse(field);
          if (Array.isArray(parsed)) {
            return parsed.filter(item => item && item.trim()).join('\n');
          }
          return field;
        } catch {
          return field;
        }
      }
      return null;
    };

    const efficiency = processListField(formData.get("efficiency"));
    const efficiencyEn = processListField(formData.get("efficiency_en"));
    const characteristics = processListField(formData.get("characteristics"));
    const characteristicsEn = processListField(formData.get("characteristics_en"));
    
    const typicalInstallation = formData.get("typical_installation") as string || null;
    const typicalInstallationEn = formData.get("typical_installation_en") as string || null;
    const applications = processListField(formData.get("applications"));
    const applicationsEn = processListField(formData.get("applications_en"));
    const benefits = processListField(formData.get("benefits"));
    const benefitsEn = processListField(formData.get("benefits_en"));
    
    // Procesar tabla de tama√±os
    const sizesJson = formData.get("product_sizes") as string;
    let sizes: Array<{nominal_size: string; real_size: string; price: number; bind_code: string}> = [];
    if (sizesJson) {
      try {
        sizes = JSON.parse(sizesJson);
      } catch (error) {
        console.error('Error parseando tama√±os:', error);
      }
    }
    
    // Procesar informaci√≥n b√°sica del producto
    const category = formData.get("category") as string || "Filtros de Aire";
    const filterCategoryIdStr = formData.get("filter_category_id") as string;
    const filterCategoryId = filterCategoryIdStr ? parseInt(filterCategoryIdStr) : null;

    // Si hay tama√±os, crear un producto por cada tama√±o
    // Si no hay tama√±os, crear un solo producto
    let productId: number | null = null;
    
    if (sizes.length > 0) {
      // Crear un producto por cada tama√±o
      for (const size of sizes) {
        const sizeUuid = generateUUID();
        const sizeProductId = await createProduct({
          uuid: sizeUuid,
          filter_category_id: filterCategoryId,
          bind_code: size.bind_code || null,
          name: formData.get("name") as string,
          name_en: (formData.get("name_en") as string) || undefined,
          description: (formData.get("description") as string) || undefined,
          description_en: (formData.get("description_en") as string) || undefined,
          price: size.price || 0,
          currency: "MXN",
          price_usd: null,
          nominal_size: size.nominal_size || null,
          real_size: size.real_size || null,
          category: category,
          stock: 0,
          status: (formData.get("status") as "active" | "inactive" | "draft") || "active",
          // Campos t√©cnicos (compartidos entre todas las variantes)
          efficiency: efficiency,
          efficiency_en: efficiencyEn,
          efficiency_class: null,
          characteristics: characteristics,
          characteristics_en: characteristicsEn,
          frame_material: null,
          max_temperature: null,
          typical_installation: typicalInstallation,
          typical_installation_en: typicalInstallationEn,
          applications: applications,
          applications_en: applicationsEn,
          benefits: benefits,
          benefits_en: benefitsEn,
        });
        
        // Guardar el ID del primer producto creado
        if (!productId) {
          productId = sizeProductId;
        }
      }
    } else {
      // Crear un solo producto sin tama√±o espec√≠fico
      productId = await createProduct({
        uuid: uuid,
        filter_category_id: filterCategoryId,
        bind_code: null,
        name: formData.get("name") as string,
        name_en: (formData.get("name_en") as string) || undefined,
        description: (formData.get("description") as string) || undefined,
        description_en: (formData.get("description_en") as string) || undefined,
        price: 0,
        currency: "MXN",
        price_usd: null,
        nominal_size: null,
        real_size: null,
        category: category,
        stock: 0,
        status: (formData.get("status") as "active" | "inactive" | "draft") || "active",
        // Campos t√©cnicos
        efficiency: efficiency,
        efficiency_en: efficiencyEn,
        efficiency_class: null,
        characteristics: characteristics,
        characteristics_en: characteristicsEn,
        frame_material: null,
        max_temperature: null,
        typical_installation: typicalInstallation,
        typical_installation_en: typicalInstallationEn,
        applications: applications,
        applications_en: applicationsEn,
        benefits: benefits,
        benefits_en: benefitsEn,
      });
    }

    if (!productId) {
      error = "Error al crear el producto";
    } else {
      // Procesar im√°genes pendientes desde localStorage
      try {
        // Procesar imagen principal
        const pendingPrimaryImage = formData.get("pending_primary_image") as string;
        const pendingPrimaryImageName = formData.get("pending_primary_image_name") as string;
        
        console.log('üì∑ Procesando imagen principal:', {
          hasImage: !!pendingPrimaryImage,
          hasName: !!pendingPrimaryImageName,
          imageLength: pendingPrimaryImage?.length || 0,
          imagePreview: pendingPrimaryImage?.substring(0, 50) || '',
          fileName: pendingPrimaryImageName
        });
        
        if (pendingPrimaryImage && pendingPrimaryImageName) {
          // Convertir base64 a buffer y subir
          // El formato puede ser "data:image/jpeg;base64,/9j/4AAQ..." o solo "/9j/4AAQ..."
          let base64Data: string;
          if (pendingPrimaryImage.includes(',')) {
            base64Data = pendingPrimaryImage.split(',')[1];
          } else if (pendingPrimaryImage.startsWith('data:')) {
            // Si tiene "data:" pero no tiene coma, tomar todo despu√©s de base64,
            const base64Index = pendingPrimaryImage.indexOf('base64,');
            if (base64Index !== -1) {
              base64Data = pendingPrimaryImage.substring(base64Index + 7);
            } else {
              base64Data = pendingPrimaryImage;
            }
          } else {
            base64Data = pendingPrimaryImage;
          }
          
          if (!base64Data || base64Data.trim().length === 0) {
            console.error('‚ùå Error: Los datos base64 de la imagen principal est√°n vac√≠os');
          } else {
            console.log('üì∑ Extrayendo datos base64:', {
              originalLength: pendingPrimaryImage.length,
              extractedLength: base64Data.length,
              preview: base64Data.substring(0, 50)
            });
            
            const buffer = Buffer.from(base64Data, 'base64');
            
            if (buffer.length === 0) {
              console.error('‚ùå Error: El buffer de la imagen principal est√° vac√≠o');
            } else {
              console.log('üì∑ Buffer creado correctamente:', {
                bufferLength: buffer.length,
                fileName: pendingPrimaryImageName
              });
              
              const { uploadProductImage } = await import('@/lib/cloudinary');
              const imageUrl = await uploadProductImage(buffer, productId.toString(), pendingPrimaryImageName);
              
              console.log('üì∑ Imagen subida a Cloudinary:', imageUrl);
              
              // Agregar imagen principal al producto
              const { addProductImage, setPrimaryImage } = await import('@/lib/database');
              const imageId = await addProductImage({
                product_id: productId,
                image_url: imageUrl,
                alt_text: pendingPrimaryImageName,
                is_primary: true,
                sort_order: 0,
              });
              
              if (imageId) {
                console.log(`‚úÖ Imagen principal guardada en BD con ID: ${imageId}`);
                await setPrimaryImage(productId, imageId);
              } else {
                console.error(`‚ùå Error: No se pudo guardar la imagen principal en la BD - imageId es null/undefined`);
              }
            }
          }
        } else {
          console.log('‚ö†Ô∏è No hay imagen principal para procesar:', {
            hasImage: !!pendingPrimaryImage,
            hasName: !!pendingPrimaryImageName
          });
        }

        // Procesar im√°genes de carrusel - SOLUCI√ìN M√ÅS ROBUSTA
        let pendingCarouselImages = formData.get("pending_carousel_images") as string;
        
        console.log('üì∑ Procesando im√°genes de carrusel:', {
          hasData: !!pendingCarouselImages,
          dataLength: pendingCarouselImages?.length || 0,
          dataPreview: pendingCarouselImages?.substring(0, 100) || ''
        });
        
        // Si est√° vac√≠o, intentar buscar con diferentes nombres
        if (!pendingCarouselImages || pendingCarouselImages.trim().length === 0) {
          // Intentar con diferentes variaciones del nombre del campo
          pendingCarouselImages = formData.get("pending_carousel_images") as string || 
                                  formData.get("carousel_images") as string || 
                                  formData.get("pendingCarouselImages") as string || 
                                  '';
        }
        
        if (pendingCarouselImages && pendingCarouselImages.trim().length > 0) {
          try {
            let carouselData: Array<{ name: string; data: string }>;
            
            // Intentar parsear JSON
            try {
              carouselData = JSON.parse(pendingCarouselImages) as Array<{ name: string; data: string }>;
            } catch (parseErr) {
              // Si falla, intentar sin espacios al inicio/final
              try {
                carouselData = JSON.parse(pendingCarouselImages.trim()) as Array<{ name: string; data: string }>;
              } catch (parseErr2) {
                console.error('‚ùå Error parseando JSON de carrusel:', parseErr2);
                throw new Error(`Error parseando JSON de carrusel: ${parseErr2 instanceof Error ? parseErr2.message : 'Error desconocido'}`);
              }
            }
            
            // Validar que sea un array
            if (!Array.isArray(carouselData)) {
              console.error('‚ùå Error: Los datos de carrusel no son un array v√°lido:', typeof carouselData);
              throw new Error('Los datos de carrusel no son un array v√°lido');
            }
            
            console.log('üì∑ Im√°genes de carrusel parseadas:', {
              count: carouselData.length,
              items: carouselData.map(item => ({ name: item.name, hasData: !!item.data, dataLength: item.data?.length || 0 }))
            });
            
            // Solo procesar si hay im√°genes
            if (carouselData.length > 0) {
              const { uploadProductImage } = await import('@/lib/cloudinary');
              const { addProductImage } = await import('@/lib/database');
              
              // Obtener el n√∫mero actual de im√°genes para calcular sort_order correctamente
              const { getProductImages } = await import('@/lib/database');
              const existingImages = await getProductImages(productId);
              const currentSortOrder = existingImages.length > 0 
                ? Math.max(...existingImages.map(img => img.sort_order || 0)) + 1
                : 1;
              
              for (let i = 0; i < carouselData.length && i < 4; i++) {
                const { name, data } = carouselData[i];
                
                console.log(`üì∑ Procesando imagen de carrusel ${i + 1}:`, {
                  name,
                  hasData: !!data,
                  dataLength: data?.length || 0
                });
                
                // Validar que tenga datos
                if (!data || !name) {
                  console.warn(`‚ö†Ô∏è Imagen ${i + 1} de carrusel omitida: falta name o data`);
                  continue;
                }
                
                // Extraer base64
                let base64Data: string;
                if (data.includes(',')) {
                  base64Data = data.split(',')[1];
                } else if (data.startsWith('data:')) {
                  // Si tiene "data:" pero no tiene coma, tomar todo despu√©s de base64,
                  const base64Index = data.indexOf('base64,');
                  if (base64Index !== -1) {
                    base64Data = data.substring(base64Index + 7);
                  } else {
                    base64Data = data;
                  }
                } else {
                  base64Data = data;
                }
                
                if (!base64Data || base64Data.trim().length === 0) {
                  console.warn(`‚ö†Ô∏è Imagen ${i + 1} de carrusel omitida: datos base64 vac√≠os`);
                  continue;
                }
                
                try {
                  const buffer = Buffer.from(base64Data, 'base64');
                  
                  if (buffer.length === 0) {
                    console.error(`‚ùå Error: Buffer de imagen ${i + 1} de carrusel est√° vac√≠o`);
                    continue;
                  }
                  
                  console.log(`üì∑ Subiendo imagen ${i + 1} de carrusel a Cloudinary...`);
                  
                  // Subir a Cloudinary
                  const imageUrl = await uploadProductImage(buffer, productId.toString(), name);
                  
                  console.log(`‚úÖ Imagen ${i + 1} de carrusel subida:`, imageUrl);
                  
                  // Guardar en BD
                  const imageId = await addProductImage({
                    product_id: productId,
                    image_url: imageUrl,
                    alt_text: `${name} - Carrusel ${i + 1}`,
                    is_primary: false,
                    sort_order: currentSortOrder + i,
                  });
                  
                  if (!imageId) {
                    console.error(`‚ùå Error: No se pudo guardar la imagen ${i + 1} en la BD`);
                    throw new Error(`No se pudo guardar la imagen ${i + 1} en la BD`);
                  }
                  
                  console.log(`‚úÖ Imagen ${i + 1} de carrusel guardada en BD con ID: ${imageId}`);
                } catch (imgErr) {
                  console.error(`‚ùå Error procesando imagen ${i + 1} de carrusel:`, imgErr);
                  // Continuar con la siguiente imagen si esta falla
                  continue;
                }
              }
            } else {
              console.log('üì∑ No hay im√°genes de carrusel para procesar (array vac√≠o)');
            }
          } catch (carouselErr) {
            // Log error pero no fallar la creaci√≥n del producto
            console.error("‚ùå Error procesando im√°genes de carrusel:", carouselErr);
          }
        } else {
          console.log('üì∑ No hay im√°genes de carrusel para procesar (campo vac√≠o o nulo)');
        }
      } catch (err) {
        console.error("Error procesando im√°genes:", err);
        // No fallar la creaci√≥n si hay error con las im√°genes
      }

      success = true;
      
      // Verificar una √∫ltima vez que las im√°genes est√©n guardadas antes de redirigir
      const { getProductImages } = await import('@/lib/database');
      const finalImages = await getProductImages(productId);
      console.log(`üì∑ Im√°genes finales en BD antes de redirigir: ${finalImages.length}`);
      
      // Redirigir a la p√°gina de edici√≥n despu√©s de crear
      return Astro.redirect(`/admin/products/edit/${productId}`);
    }
  } catch (err) {
    console.error("Error creando producto:", err);
    // Mostrar mensaje de error m√°s detallado
    if (err instanceof Error) {
      error = `Error: ${err.message}`;
      // Si es un error de SQL, mostrar m√°s detalles
      if ('code' in err) {
        error += ` (C√≥digo: ${(err as any).code})`;
      }
      if ('sqlMessage' in err) {
        error += ` - ${(err as any).sqlMessage}`;
      }
    } else {
      error = "Error desconocido al crear el producto";
    }
  }
}
---

<AdminLayout title="Nuevo Producto">
  <div class="container mx-auto px-4 py-8">
    <!-- Persistencia de formulario -->
    <FormPersistence 
      formId="product-add" 
      excludeFields={["pending_primary_image", "pending_carousel_images"]}
    />
    
      <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center gap-4">
        <a
          href="/admin/products"
          class="text-gray-600 hover:text-gray-900"
        >
          <svg
            class="h-6 w-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
        </a>
          <div>
          <h1 class="text-3xl font-bold text-gray-900">
            Nuevo Producto
          </h1>
          <p class="mt-2 text-gray-600">
            Crea un nuevo producto con sus caracter√≠sticas
          </p>
        </div>
      </div>
    </div>

    <!-- Mensajes -->
    {error && (
      <div class="mb-6 rounded-lg border border-red-300 bg-red-50 p-4">
        <div class="flex">
          <svg
            class="h-5 w-5 text-red-400"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
              clip-rule="evenodd"
            />
          </svg>
          <div class="ml-3">
            <p class="text-sm font-medium text-red-800">{error}</p>
            <p class="mt-2 text-xs text-red-600">
              Los datos del formulario se han guardado autom√°ticamente. Recarga la p√°gina para recuperarlos.
            </p>
          </div>
        </div>
      </div>
    )}

    {success && (
      <div class="mb-6 rounded-lg border border-green-300 bg-green-50 p-4">
          <div class="flex">
          <svg
            class="h-5 w-5 text-green-400"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
              clip-rule="evenodd"
            />
              </svg>
            <div class="ml-3">
            <p class="text-sm font-medium text-green-800">
              Producto creado exitosamente
            </p>
            </div>
          </div>
        </div>
      )}

      <!-- Formulario -->
      <form method="POST" class="space-y-8">
      <!-- Informaci√≥n B√°sica -->
      <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <div class="mb-6 flex items-center gap-3 border-b border-gray-200 pb-4">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100">
            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div>
            <h2 class="text-xl font-bold text-gray-900">
              Informaci√≥n B√°sica
            </h2>
            <p class="mt-1 text-sm text-gray-500">
              Nombre y descripci√≥n del producto en espa√±ol e ingl√©s
            </p>
          </div>
        </div>

        <div class="grid gap-6 md:grid-cols-2">
          <div>
            <label for="name" class="mb-2 flex items-center gap-2 text-sm font-semibold text-gray-700">
              <span>Nombre (Espa√±ol)</span>
              <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
              placeholder="Ej: Mini pleat sello gel downstream"
              class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
              />
            <p class="mt-1.5 text-xs text-gray-500">
              Nombre principal del producto en espa√±ol
            </p>
            </div>

            <div>
            <label
              for="name_en"
              class="mb-2 block text-sm font-semibold text-gray-700"
            >
              Nombre (Ingl√©s)
              </label>
              <input
                type="text"
              id="name_en"
              name="name_en"
              placeholder="Ej: Mini pleat gel seal downstream"
              class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
            />
            <p class="mt-1.5 text-xs text-gray-500">
              Nombre del producto en ingl√©s (opcional)
            </p>
              </div>
            </div>

        <div class="mt-6 grid gap-6 md:grid-cols-2">
            <div>
            <label
              for="description"
              class="mb-2 block text-sm font-semibold text-gray-700"
            >
              Descripci√≥n (Espa√±ol)
              </label>
              <textarea
                id="description"
                name="description"
              rows="5"
              placeholder="Describe el producto, su funci√≥n, caracter√≠sticas principales y uso t√≠pico..."
              class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
            ></textarea>
            <p class="mt-1.5 text-xs text-gray-500">
              Descripci√≥n detallada del producto en espa√±ol
            </p>
          </div>

          <div>
            <label
              for="description_en"
              class="mb-2 block text-sm font-semibold text-gray-700"
            >
              Descripci√≥n (Ingl√©s)
            </label>
            <textarea
              id="description_en"
              name="description_en"
              rows="5"
              placeholder="Describe the product, its function, main characteristics and typical use..."
              class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
              ></textarea>
            <p class="mt-1.5 text-xs text-gray-500">
              Descripci√≥n detallada del producto en ingl√©s (opcional)
            </p>
          </div>
        </div>
      </div>

      <!-- Categor√≠a de Filtro -->
      <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <div class="mb-6 flex items-center gap-3 border-b border-gray-200 pb-4">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-amber-100">
            <svg class="h-6 w-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
            </svg>
          </div>
          <div>
            <h2 class="text-xl font-bold text-gray-900">
              Categor√≠a de Filtro
            </h2>
            <p class="mt-1 text-sm text-gray-500">
              Asigna este producto a una categor√≠a de filtro
            </p>
          </div>
        </div>

        <div>
          <label for="filter_category_id" class="mb-2 block text-sm font-semibold text-gray-700">
            Categor√≠a
          </label>
          <select
            id="filter_category_id"
            name="filter_category_id"
            class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
          >
            <option value="">Sin categor√≠a</option>
            {filterCategories.map((cat) => (
              <option value={cat.id}>{cat.name}</option>
            ))}
          </select>
          <p class="mt-1.5 text-xs text-gray-500">
            Selecciona la categor√≠a de filtro a la que pertenece este producto
          </p>
        </div>
      </div>

      <!-- Especificaciones T√©cnicas -->
      <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <div class="mb-6 flex items-center gap-3 border-b border-gray-200 pb-4">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-purple-100">
            <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            </div>
          <div>
            <h2 class="text-xl font-bold text-gray-900">
              Especificaciones T√©cnicas
            </h2>
            <p class="mt-1 text-sm text-gray-500">
              Eficiencia, caracter√≠sticas y especificaciones t√©cnicas del producto
            </p>
          </div>
        </div>

        <div class="grid gap-6 md:grid-cols-2">
          <div>
            <DynamicListInput
              id="efficiency"
              name="efficiency"
              label="Eficiencia (Espa√±ol)"
              placeholder="Ej: 99.997%"
              helpText="Agrega valores de eficiencia (uno por l√≠nea)"
            />
          </div>

          <div>
            <DynamicListInput
              id="efficiency_en"
              name="efficiency_en"
              label="Eficiencia (Ingl√©s)"
              placeholder="Ej: 99.997%"
              helpText="Add efficiency values (one per line)"
            />
          </div>

        </div>

        <div class="mt-6 grid gap-6 md:grid-cols-2">
          <div>
            <DynamicListInput
              id="characteristics"
              name="characteristics"
              label="Caracter√≠sticas (Espa√±ol)"
              placeholder="Ej: Marco de aluminio"
              helpText="Una caracter√≠stica por l√≠nea"
            />
          </div>

          <div>
            <DynamicListInput
              id="characteristics_en"
              name="characteristics_en"
              label="Caracter√≠sticas (Ingl√©s)"
              placeholder="Ej: Aluminum frame"
              helpText="One characteristic per line"
            />
          </div>
        </div>
      </div>

      <!-- Instalaci√≥n T√≠pica -->
      <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <div class="mb-6 flex items-center gap-3 border-b border-gray-200 pb-4">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-yellow-100">
            <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
          </div>
          <div>
            <h2 class="text-xl font-bold text-gray-900">
              Instalaci√≥n T√≠pica
            </h2>
            <p class="mt-1 text-sm text-gray-500">
              Describe d√≥nde y c√≥mo se instala t√≠picamente este producto
            </p>
          </div>
        </div>

        <div class="grid gap-6 md:grid-cols-2">
          <div>
            <label for="typical_installation" class="mb-2 block text-sm font-semibold text-gray-700">
              Instalaci√≥n T√≠pica (Espa√±ol)
            </label>
            <textarea
              id="typical_installation"
              name="typical_installation"
              rows="4"
              placeholder="Ej: En techos de cuartos limpios donde el aire fluye hacia abajo..."
              class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
            ></textarea>
          </div>

            <div>
            <label for="typical_installation_en" class="mb-2 block text-sm font-semibold text-gray-700">
              Instalaci√≥n T√≠pica (Ingl√©s)
              </label>
            <textarea
              id="typical_installation_en"
              name="typical_installation_en"
              rows="4"
              placeholder="Ej: In cleanroom ceilings where air flows downward..."
              class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- Aplicaciones -->
      <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <div class="mb-6 flex items-center gap-3 border-b border-gray-200 pb-4">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-indigo-100">
            <svg class="h-6 w-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
          </div>
          <div>
            <h2 class="text-xl font-bold text-gray-900">
              Aplicaciones
            </h2>
            <p class="mt-1 text-sm text-gray-500">
              Describe los usos y aplicaciones t√≠picas del producto
            </p>
          </div>
        </div>

        <div class="grid gap-6 md:grid-cols-2">
          <div>
            <DynamicListInput
              id="applications"
              name="applications"
              label="Aplicaciones (Espa√±ol)"
              placeholder="Ej: Cuartos limpios ISO"
              helpText="Una aplicaci√≥n por l√≠nea"
            />
          </div>

          <div>
            <DynamicListInput
              id="applications_en"
              name="applications_en"
              label="Aplicaciones (Ingl√©s)"
              placeholder="Ej: ISO cleanrooms"
              helpText="One application per line"
            />
          </div>
        </div>
      </div>

      <!-- Beneficios -->
      <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <div class="mb-6 flex items-center gap-3 border-b border-gray-200 pb-4">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-emerald-100">
            <svg class="h-6 w-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div>
            <h2 class="text-xl font-bold text-gray-900">
              Beneficios
            </h2>
            <p class="mt-1 text-sm text-gray-500">
              Lista los beneficios principales del producto
            </p>
          </div>
        </div>

        <div class="grid gap-6 md:grid-cols-2">
          <div>
            <DynamicListInput
              id="benefits"
              name="benefits"
              label="Beneficios (Espa√±ol)"
              placeholder="Ej: Compacto y liviano"
              helpText="Un beneficio por l√≠nea"
              />
            </div>

            <div>
            <DynamicListInput
              id="benefits_en"
              name="benefits_en"
              label="Beneficios (Ingl√©s)"
              placeholder="Ej: Compact and lightweight"
              helpText="One benefit per line"
            />
          </div>
        </div>
      </div>

      <!-- Tabla de Tama√±os -->
      <div class="mt-12 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <div class="mb-6 flex items-center gap-3 border-b border-gray-200 pb-4">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-teal-100">
            <svg class="h-6 w-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
            </svg>
            </div>
          <div>
            <h2 class="text-xl font-bold text-gray-900">
              Tama√±os/Variantes
            </h2>
            <p class="mt-1 text-sm text-gray-500">
              Agrega los diferentes tama√±os disponibles para este producto. Si agregas tama√±os, se crear√°n productos separados para cada uno.
            </p>
          </div>
        </div>

        <ProductSizesTable
          id="product-sizes"
          name="product_sizes"
        />
      </div>

      <!-- Im√°genes -->
      <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <div class="mb-6 flex items-center gap-3 border-b border-gray-200 pb-4">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-pink-100">
            <svg class="h-6 w-6 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
          <div>
            <h2 class="text-xl font-bold text-gray-900">
              Im√°genes
            </h2>
            <p class="mt-1 text-sm text-gray-500">
              Imagen principal y hasta 4 im√°genes de carrusel
            </p>
          </div>
        </div>
        <ProductImageManagerCreate />
      </div>


      <!-- Estado -->
      <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <div class="mb-4 flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-gray-100">
            <svg class="h-6 w-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div>
            <h2 class="text-lg font-bold text-gray-900">
              Estado de Publicaci√≥n
            </h2>
            <p class="mt-1 text-sm text-gray-500">
              Define si el producto estar√° visible para los usuarios
            </p>
          </div>
        </div>
        <div>
          <label for="status" class="mb-2 flex items-center gap-2 text-sm font-semibold text-gray-700">
            <span>Estado</span>
            <span class="text-red-500">*</span>
          </label>
          <select
            id="status"
            name="status"
            required
            class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
          >
            <option value="active">Activo - Visible para usuarios</option>
            <option value="draft">Borrador - Solo visible en admin</option>
            <option value="inactive">Inactivo - No visible</option>
          </select>
          <p class="mt-1.5 text-xs text-gray-500">
            Los productos activos aparecer√°n en la p√°gina de productos
          </p>
        </div>
      </div>

      <!-- Botones -->
      <div class="flex items-center justify-end gap-4 border-t border-gray-200 pt-6">
        <a
          href="/admin/products"
          class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-6 py-3 font-semibold text-gray-700 transition-colors hover:bg-gray-50"
        >
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
              Cancelar
        </a>
        <button
          type="submit"
          class="flex items-center gap-2 rounded-lg bg-blue-600 px-6 py-3 font-semibold text-white transition-colors hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
        >
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Crear Producto
        </button>
        </div>
      </form>
  </div>
</AdminLayout>

<script>
  // Script simplificado - las variantes ahora se gestionan como productos en la secci√≥n de productos
</script>
