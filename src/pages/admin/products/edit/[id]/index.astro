---
import AdminLayout from "@/layouts/adminLayout.astro";
import { Button } from "@/components/ui/button";
import { getProductByBindId, updateProduct as updateProductService } from "@/lib/product-service";
import { requireAdmin } from "@/lib/auth-utils";
import type { Product } from "@/lib/database";

// Agregar headers para evitar cach√© del navegador
Astro.response.headers.set('Cache-Control', 'no-cache, no-store, must-revalidate');
Astro.response.headers.set('Pragma', 'no-cache');
Astro.response.headers.set('Expires', '0');

// Verificar que el usuario es administrador
const { redirect } = await requireAdmin(Astro.cookies);
if (redirect) {
  return Astro.redirect(redirect);
}

const { id: bindId } = Astro.params;

// Obtener el producto por Bind ID
let product: Product | null = null;
let errorMessage = '';

if (bindId) {
  product = await getProductByBindId(bindId);
  if (!product) {
    return Astro.redirect('/admin/products?error=product_not_found');
  }
} else {
  return Astro.redirect('/admin/products?error=invalid_id');
}

// Manejar env√≠o del formulario
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();

    const updatedData = {
      name: formData.get('name')?.toString() || '',
      description: formData.get('description')?.toString() || '',
      uuid: formData.get('code')?.toString() || '', // SKU/C√≥digo
      price: parseFloat(formData.get('price')?.toString() || '0'),
      category: formData.get('category')?.toString() || '',
      stock: parseInt(formData.get('stock')?.toString() || '0'),
      weight: formData.get('weight')?.toString() || undefined,
      tags: formData.get('tags')?.toString() || undefined,
      status: 'active' as const
    };

    console.log('üìù Actualizando producto en Bind:', bindId, updatedData);

    // Validar datos requeridos
    if (!updatedData.name || !updatedData.description || updatedData.price <= 0) {
      throw new Error('Nombre, descripci√≥n y precio son campos requeridos');
    }

    // Actualizar el producto en Bind ERP
    const success = await updateProductService(bindId, updatedData);

    if (success) {
      console.log('‚úÖ Producto actualizado en Bind');
      return Astro.redirect(`/admin/products?success=updated`);
    } else {
      errorMessage = 'Error al actualizar el producto en Bind ERP';
    }
  } catch (error) {
    console.error('Error actualizando producto:', error);
    errorMessage = error instanceof Error ? error.message : 'Error al actualizar el producto';
  }
}
---

<AdminLayout title={`Editar: ${product.name}`}>
  <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="mt-10 mb-8">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold tracking-tight text-foreground">Editar Producto</h1>
            <p class="mt-2 text-muted-foreground">
              Actualiza la informaci√≥n del producto en Bind ERP
            </p>
          </div>
          <a href="/admin/products">
            <Button variant="outline" className="border-border text-foreground hover:bg-muted">
              <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
              </svg>
              Volver
            </Button>
          </a>
        </div>
      </div>

      <!-- Mensajes de error -->
      {errorMessage && (
        <div class="mb-6 rounded-md bg-red-50 border border-red-200 p-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">Error</h3>
              <div class="mt-2 text-sm text-red-700">
                <p>{errorMessage}</p>
              </div>
            </div>
          </div>
        </div>
      )}

      <!-- Info del Bind ID -->
      <div class="mb-6 rounded-lg bg-blue-50 border border-blue-200 p-4">
        <div class="flex items-center">
          <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <p class="ml-3 text-sm text-blue-700">
            <span class="font-medium">Bind ID:</span> {product.bind_id || 'N/A'}
          </p>
        </div>
      </div>

      <!-- Formulario -->
      <form method="POST" class="space-y-8">
        <div class="rounded-lg border border-border bg-background p-6">
          <h2 class="text-lg font-semibold text-foreground mb-6">Informaci√≥n B√°sica</h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Nombre del Producto -->
            <div class="md:col-span-2">
              <label for="name" class="block text-sm font-medium text-foreground mb-2">
                Nombre del Producto <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                value={product.name}
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="Ej: Filtro HEPA H13 para Cuarto Limpio"
              />
            </div>

            <!-- C√≥digo/SKU -->
            <div>
              <label for="code" class="block text-sm font-medium text-foreground mb-2">
                C√≥digo/SKU
              </label>
              <input
                type="text"
                id="code"
                name="code"
                value={product.uuid || ''}
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="Ej: FLT-H13-001"
              />
              <p class="mt-1 text-sm text-muted-foreground">C√≥digo √∫nico del producto</p>
            </div>

            <!-- Categor√≠a -->
            <div>
              <label for="category" class="block text-sm font-medium text-foreground mb-2">
                Categor√≠a
              </label>
              <select
                id="category"
                name="category"
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
              >
                <option value="">Seleccionar categor√≠a</option>
                <option value="filtros" selected={product.category === 'filtros'}>Filtros</option>
                <option value="cuartos-limpios" selected={product.category === 'cuartos-limpios'}>Cuartos Limpios</option>
                <option value="accesorios" selected={product.category === 'accesorios'}>Accesorios</option>
                <option value="servicios" selected={product.category === 'servicios'}>Servicios</option>
              </select>
            </div>

            <!-- Precio -->
            <div>
              <label for="price" class="block text-sm font-medium text-foreground mb-2">
                Precio (MXN) <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <span class="absolute left-3 top-2 text-muted-foreground">$</span>
                <input
                  type="number"
                  id="price"
                  name="price"
                  required
                  min="0"
                  step="0.01"
                  value={product.price}
                  class="w-full rounded-md border border-border bg-background pl-7 pr-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                  placeholder="0.00"
                />
              </div>
            </div>

            <!-- Stock/Inventario -->
            <div>
              <label for="stock" class="block text-sm font-medium text-foreground mb-2">
                Stock/Inventario
              </label>
              <input
                type="number"
                id="stock"
                name="stock"
                min="0"
                value={product.stock}
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="0"
              />
              <p class="mt-1 text-sm text-muted-foreground">Cantidad disponible en inventario</p>
            </div>

            <!-- Descripci√≥n -->
            <div class="md:col-span-2">
              <label for="description" class="block text-sm font-medium text-foreground mb-2">
                Descripci√≥n <span class="text-red-500">*</span>
              </label>
              <textarea
                id="description"
                name="description"
                required
                rows="4"
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="Describe las caracter√≠sticas y beneficios del producto..."
              >{product.description}</textarea>
            </div>
          </div>
        </div>

        <!-- Informaci√≥n Adicional -->
        <div class="rounded-lg border border-border bg-background p-6">
          <h2 class="text-lg font-semibold text-foreground mb-6">Informaci√≥n Adicional</h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Peso -->
            <div>
              <label for="weight" class="block text-sm font-medium text-foreground mb-2">
                Peso
              </label>
              <input
                type="text"
                id="weight"
                name="weight"
                value={product.weight || ''}
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="Ej: 2.5 kg"
              />
            </div>

            <!-- Tags/Etiquetas -->
            <div>
              <label for="tags" class="block text-sm font-medium text-foreground mb-2">
                Etiquetas
              </label>
              <input
                type="text"
                id="tags"
                name="tags"
                value={product.tags || ''}
                class="w-full rounded-md border border-border bg-background px-3 py-2 text-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="Ej: hepa, filtro, h13"
              />
              <p class="mt-1 text-sm text-muted-foreground">Separadas por comas</p>
            </div>
          </div>
        </div>

        <!-- Botones de acci√≥n -->
        <div class="flex items-center justify-end gap-4 pb-8">
          <a href="/admin/products">
            <Button type="button" variant="outline" className="border-border text-foreground hover:bg-muted">
              Cancelar
            </Button>
          </a>
          <Button type="submit" className="bg-primary text-primary-foreground hover:bg-primary/90">
            <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Actualizar Producto
          </Button>
        </div>
      </form>
  </div>
</AdminLayout>
