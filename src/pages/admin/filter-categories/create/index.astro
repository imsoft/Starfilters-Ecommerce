---
import AdminLayout from "@/layouts/adminLayout.astro";
import {
  createCategory,
  addCategoryImage,
  addCategoryVariant,
  updateCategory,
} from "@/lib/filter-category-service";
import { getAuthenticatedUser } from '@/lib/auth-utils';
import { isUserAdmin } from '@/lib/database';
import CategoryImageManagerCreate from "@/components/admin/CategoryImageManagerCreate.astro";
import DynamicListInput from "@/components/admin/DynamicListInput.astro";

export const prerender = false;

const user = getAuthenticatedUser(Astro.cookies);

if (!user) {
  return Astro.redirect('/login');
}

const userIsAdmin = await isUserAdmin(user.id);

if (!userIsAdmin) {
  return Astro.redirect('/');
}

let error: string | null = null;
let success = false;

// Procesar formulario
if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();

    // Crear slug desde el nombre
    const name = formData.get("name") as string;
    const slug = name
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/^-+|-+$/g, "");

    // Crear la categor√≠a
    const categoryId = await createCategory({
      name: formData.get("name") as string,
      name_en: formData.get("name_en") as string || null,
      slug: slug,
      description: formData.get("description") as string || null,
      description_en: formData.get("description_en") as string || null,
      main_image: null, // Se agregar√° despu√©s en la p√°gina de edici√≥n
      // Convertir listas JSON a texto separado por saltos de l√≠nea
      efficiency: (() => {
        const efficiencyJson = formData.get("efficiency") as string;
        if (efficiencyJson) {
          try {
            const efficiency = JSON.parse(efficiencyJson) as string[];
            return efficiency.length > 0 ? efficiency.join('\n') : null;
          } catch {
            return efficiencyJson; // Si no es JSON, usar como est√°
          }
        }
        return null;
      })(),
      efficiency_en: (() => {
        const efficiencyJson = formData.get("efficiency_en") as string;
        if (efficiencyJson) {
          try {
            const efficiency = JSON.parse(efficiencyJson) as string[];
            return efficiency.length > 0 ? efficiency.join('\n') : null;
          } catch {
            return efficiencyJson;
          }
        }
        return null;
      })(),
      efficiency_class: formData.get("efficiency_class") as string || null,
      // Convertir listas JSON a texto separado por saltos de l√≠nea
      characteristics: (() => {
        const charsJson = formData.get("characteristics") as string;
        if (charsJson) {
          try {
            const chars = JSON.parse(charsJson) as string[];
            return chars.length > 0 ? chars.join('\n') : null;
          } catch {
            return charsJson; // Si no es JSON, usar como est√°
          }
        }
        return null;
      })(),
      characteristics_en: (() => {
        const charsJson = formData.get("characteristics_en") as string;
        if (charsJson) {
          try {
            const chars = JSON.parse(charsJson) as string[];
            return chars.length > 0 ? chars.join('\n') : null;
          } catch {
            return charsJson;
          }
        }
        return null;
      })(),
      typical_installation: formData.get("typical_installation") as string || null,
      typical_installation_en: formData.get("typical_installation_en") as string || null,
      applications: formData.get("applications") as string || null,
      applications_en: formData.get("applications_en") as string || null,
      benefits: (() => {
        const benefitsJson = formData.get("benefits") as string;
        if (benefitsJson) {
          try {
            const benefits = JSON.parse(benefitsJson) as string[];
            return benefits.length > 0 ? benefits.join('\n') : null;
          } catch {
            return benefitsJson;
          }
        }
        return null;
      })(),
      benefits_en: (() => {
        const benefitsJson = formData.get("benefits_en") as string;
        if (benefitsJson) {
          try {
            const benefits = JSON.parse(benefitsJson) as string[];
            return benefits.length > 0 ? benefits.join('\n') : null;
          } catch {
            return benefitsJson;
          }
        }
        return null;
      })(),
      max_temperature: formData.get("max_temperature") as string || null,
      frame_material: formData.get("frame_material") as string || null,
      status: formData.get("status") as "active" | "inactive" | "draft",
    });

    if (!categoryId) {
      error = "Error al crear la categor√≠a";
    } else {
      // Procesar im√°genes pendientes desde localStorage
      try {
        // Procesar imagen principal
        const pendingPrimaryImage = formData.get("pending_primary_image") as string;
        const pendingPrimaryImageName = formData.get("pending_primary_image_name") as string;
        
        if (pendingPrimaryImage && pendingPrimaryImageName) {
          // Convertir base64 a buffer y subir
          const base64Data = pendingPrimaryImage.split(',')[1];
          const buffer = Buffer.from(base64Data, 'base64');
          
          const { uploadCategoryPrimaryImage } = await import('@/lib/cloudinary');
          const imageUrl = await uploadCategoryPrimaryImage(buffer, categoryId, pendingPrimaryImageName);
          
          await updateCategory(categoryId, {
            main_image: imageUrl,
          });
        }

        // Procesar im√°genes de carrusel
        const pendingCarouselImages = formData.get("pending_carousel_images") as string;
        if (pendingCarouselImages) {
          const carouselData = JSON.parse(pendingCarouselImages) as Array<{ name: string; data: string }>;
          const { uploadCategoryCarouselImage } = await import('@/lib/cloudinary');
          
          for (let i = 0; i < carouselData.length && i < 4; i++) {
            const { name, data } = carouselData[i];
            const base64Data = data.split(',')[1];
            const buffer = Buffer.from(base64Data, 'base64');
            
            const imageUrl = await uploadCategoryCarouselImage(buffer, categoryId, name);
            
            await addCategoryImage({
              category_id: categoryId,
              image_url: imageUrl,
              alt_text: `${name} - Carrusel ${i + 1}`,
              is_primary: false,
              sort_order: i + 1,
            });
          }
        }
      } catch (err) {
        console.error("Error procesando im√°genes:", err);
        // No fallar la creaci√≥n si hay error con las im√°genes
      }

      // Agregar variantes desde los campos individuales
      let variantIndex = 0;
      while (true) {
        const bindCode = formData.get(`variant_bind_code_${variantIndex}`) as string;
        if (!bindCode) break;

        const nominalSize = formData.get(`variant_nominal_size_${variantIndex}`) as string;
        const realSize = formData.get(`variant_real_size_${variantIndex}`) as string;
        const priceStr = formData.get(`variant_price_${variantIndex}`) as string;
        const price = parseFloat(priceStr);

        if (bindCode && nominalSize && realSize && !isNaN(price)) {
          await addCategoryVariant({
            category_id: categoryId,
            bind_code: bindCode,
            nominal_size: nominalSize,
            real_size: realSize,
            price: price,
            stock: 0,
            is_active: true,
          });
        }

        variantIndex++;
      }

      success = true;
      // Redirigir a la p√°gina de edici√≥n despu√©s de crear
      return Astro.redirect(`/admin/filter-categories/edit/${categoryId}`);
    }
  } catch (err) {
    console.error("Error creando categor√≠a:", err);
    error = err instanceof Error ? err.message : "Error desconocido";
  }
}
---

<AdminLayout title="Nueva Categor√≠a de Filtros">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center gap-4">
        <a
          href="/admin/filter-categories"
          class="text-gray-600 hover:text-gray-900"
        >
          <svg
            class="h-6 w-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
        </a>
        <div>
          <h1 class="text-3xl font-bold text-gray-900">
            Nueva Categor√≠a de Filtros
          </h1>
          <p class="mt-2 text-gray-600">
            Crea una nueva categor√≠a con sus caracter√≠sticas y variantes
          </p>
        </div>
      </div>
    </div>

    <!-- Mensajes -->
    {error && (
      <div class="mb-6 rounded-lg border border-red-300 bg-red-50 p-4">
        <div class="flex">
          <svg
            class="h-5 w-5 text-red-400"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
              clip-rule="evenodd"
            />
          </svg>
          <div class="ml-3">
            <p class="text-sm font-medium text-red-800">{error}</p>
          </div>
        </div>
      </div>
    )}

    {success && (
      <div class="mb-6 rounded-lg border border-green-300 bg-green-50 p-4">
        <div class="flex">
          <svg
            class="h-5 w-5 text-green-400"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
              clip-rule="evenodd"
            />
          </svg>
          <div class="ml-3">
            <p class="text-sm font-medium text-green-800">
              Categor√≠a creada exitosamente
            </p>
          </div>
        </div>
      </div>
    )}

    <!-- Formulario -->
    <form method="POST" class="space-y-8">
      <!-- Informaci√≥n B√°sica -->
      <div class="rounded-lg border border-gray-200 bg-white p-6">
        <h2 class="mb-4 text-xl font-bold text-gray-900">
          Informaci√≥n B√°sica
        </h2>

        <div class="grid gap-6 md:grid-cols-2">
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700">
              Nombre (Espa√±ol) *
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
          </div>

          <div>
            <label
              for="name_en"
              class="block text-sm font-medium text-gray-700"
            >
              Nombre (Ingl√©s)
            </label>
            <input
              type="text"
              id="name_en"
              name="name_en"
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
          </div>

          <div class="md:col-span-2">
            <p class="text-sm text-gray-600">
              Las im√°genes se pueden agregar en la secci√≥n de im√°genes m√°s abajo.
            </p>
          </div>

          <div>
            <label for="status" class="block text-sm font-medium text-gray-700">
              Estado *
            </label>
            <select
              id="status"
              name="status"
              required
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            >
              <option value="active">Activo</option>
              <option value="inactive">Inactivo</option>
              <option value="draft">Borrador</option>
            </select>
          </div>
        </div>

        <div class="mt-6 grid gap-6 md:grid-cols-2">
          <div>
            <label
              for="description"
              class="block text-sm font-medium text-gray-700"
            >
              Descripci√≥n (Espa√±ol)
            </label>
            <textarea
              id="description"
              name="description"
              rows="4"
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            ></textarea>
          </div>

          <div>
            <label
              for="description_en"
              class="block text-sm font-medium text-gray-700"
            >
              Descripci√≥n (Ingl√©s)
            </label>
            <textarea
              id="description_en"
              name="description_en"
              rows="4"
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- Especificaciones T√©cnicas -->
      <div class="rounded-lg border border-gray-200 bg-white p-6">
        <h2 class="mb-4 text-xl font-bold text-gray-900">
          Especificaciones T√©cnicas
        </h2>

        <div class="grid gap-6 md:grid-cols-3">
          <div>
            <label
              for="efficiency_class"
              class="block text-sm font-medium text-gray-700"
            >
              Clase de Eficiencia
            </label>
            <input
              type="text"
              id="efficiency_class"
              name="efficiency_class"
              placeholder="EN1822 Clase: H14"
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
          </div>

          <div>
            <label
              for="max_temperature"
              class="block text-sm font-medium text-gray-700"
            >
              Temperatura M√°xima
            </label>
            <input
              type="text"
              id="max_temperature"
              name="max_temperature"
              placeholder="70¬∫C"
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
          </div>

          <div>
            <label
              for="frame_material"
              class="block text-sm font-medium text-gray-700"
            >
              Material del Marco
            </label>
            <input
              type="text"
              id="frame_material"
              name="frame_material"
              placeholder="Aluminio"
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
          </div>
        </div>

        <div class="mt-6 grid gap-6 md:grid-cols-2">
          <DynamicListInput
            id="efficiency"
            name="efficiency"
            label="Eficiencia (Espa√±ol)"
            placeholder="Ej: 99.997%"
            helpText="Agrega cada valor de eficiencia como un elemento de la lista"
          />
          <DynamicListInput
            id="efficiency_en"
            name="efficiency_en"
            label="Eficiencia (Ingl√©s)"
            placeholder="Ej: 99.997%"
            helpText="Agrega cada valor de eficiencia como un elemento de la lista"
          />
        </div>

        <div class="mt-6 grid gap-6 md:grid-cols-2">
          <DynamicListInput
            id="characteristics"
            name="characteristics"
            label="Caracter√≠sticas (Espa√±ol)"
            placeholder="Ej: Marco de aluminio"
            helpText="Agrega cada caracter√≠stica como un elemento de la lista"
          />
          <DynamicListInput
            id="characteristics_en"
            name="characteristics_en"
            label="Caracter√≠sticas (Ingl√©s)"
            placeholder="Ej: Aluminum frame"
            helpText="Agrega cada caracter√≠stica como un elemento de la lista"
          />
        </div>
      </div>

      <!-- Informaci√≥n Adicional -->
      <div class="rounded-lg border border-gray-200 bg-white p-6">
        <h2 class="mb-4 text-xl font-bold text-gray-900">
          Informaci√≥n Adicional
        </h2>

        <div class="space-y-6">
          <div class="grid gap-6 md:grid-cols-2">
            <div>
              <label
                for="typical_installation"
                class="block text-sm font-medium text-gray-700"
              >
                Instalaci√≥n T√≠pica (Espa√±ol)
              </label>
              <textarea
                id="typical_installation"
                name="typical_installation"
                rows="3"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              ></textarea>
            </div>

            <div>
              <label
                for="typical_installation_en"
                class="block text-sm font-medium text-gray-700"
              >
                Instalaci√≥n T√≠pica (Ingl√©s)
              </label>
              <textarea
                id="typical_installation_en"
                name="typical_installation_en"
                rows="3"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              ></textarea>
            </div>
          </div>

          <div class="grid gap-6 md:grid-cols-2">
            <div>
              <label
                for="applications"
                class="block text-sm font-medium text-gray-700"
              >
                Aplicaciones (Espa√±ol)
              </label>
              <textarea
                id="applications"
                name="applications"
                rows="3"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              ></textarea>
            </div>

            <div>
              <label
                for="applications_en"
                class="block text-sm font-medium text-gray-700"
              >
                Aplicaciones (Ingl√©s)
              </label>
              <textarea
                id="applications_en"
                name="applications_en"
                rows="3"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              ></textarea>
            </div>
          </div>

          <div class="grid gap-6 md:grid-cols-2">
            <DynamicListInput
              id="benefits"
              name="benefits"
              label="Beneficios (Espa√±ol)"
              placeholder="Ej: Compacto y liviano"
              helpText="Agrega cada beneficio como un elemento de la lista"
            />
            <DynamicListInput
              id="benefits_en"
              name="benefits_en"
              label="Beneficios (Ingl√©s)"
              placeholder="Ej: Compact and lightweight"
              helpText="Agrega cada beneficio como un elemento de la lista"
            />
          </div>
        </div>
      </div>

      <!-- Im√°genes -->
      <div class="rounded-lg border border-gray-200 bg-white p-6">
        <h2 class="mb-4 text-xl font-bold text-gray-900">
          Im√°genes
        </h2>
        <p class="mb-4 text-sm text-gray-600">
          Puedes subir una imagen principal y hasta 4 im√°genes de carrusel. Las im√°genes se procesar√°n autom√°ticamente despu√©s de crear la categor√≠a.
        </p>
        <CategoryImageManagerCreate />
      </div>

      <!-- Variantes/Tama√±os -->
      <div class="rounded-lg border border-gray-200 bg-white p-6">
        <h2 class="mb-4 text-xl font-bold text-gray-900">
          Variantes/Tama√±os
        </h2>

        <div id="variants-container" class="space-y-4">
          <!-- Los campos de variante se agregar√°n aqu√≠ din√°micamente -->
        </div>

        <button
          type="button"
          id="add-variant-btn"
          class="mt-4 rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700"
        >
          + Agregar Variante
        </button>
      </div>

      <!-- Botones -->
      <div class="flex items-center justify-end gap-4">
        <a
          href="/admin/filter-categories"
          class="rounded-lg border border-gray-300 bg-white px-6 py-3 font-medium text-gray-700 transition-colors hover:bg-gray-50"
        >
          Cancelar
        </a>
        <button
          type="submit"
          class="rounded-lg bg-blue-600 px-6 py-3 font-medium text-white transition-colors hover:bg-blue-700"
        >
          Crear Categor√≠a
        </button>
      </div>
    </form>
  </div>
</AdminLayout>

<script>
  let variantCounter = 0;

  function createVariantRow() {
    const container = document.getElementById('variants-container');
    if (!container) return;

    const variantIndex = variantCounter++;
    const variantDiv = document.createElement('div');
    variantDiv.className = 'rounded-lg border border-gray-200 bg-gray-50 p-4';
    variantDiv.setAttribute('data-variant-index', variantIndex.toString());

    variantDiv.innerHTML = `
      <div class="mb-3 flex items-center justify-between">
        <h3 class="text-sm font-medium text-gray-700">Variante ${variantIndex + 1}</h3>
        <button
          type="button"
          class="remove-variant-btn rounded-md bg-red-500 px-2 py-1 text-xs text-white hover:bg-red-600"
          data-variant-index="${variantIndex}"
        >
          Eliminar
        </button>
      </div>
      <div class="grid grid-cols-4 gap-4">
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">
            C√≥digo Bind *
          </label>
          <input
            type="text"
            name="variant_bind_code_${variantIndex}"
            id="bind_code_${variantIndex}"
            class="bind-code-input block w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            placeholder="Ej: HGD1"
            required
          />
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">
            Medida Nominal
          </label>
          <input
            type="text"
            name="variant_nominal_size_${variantIndex}"
            id="nominal_size_${variantIndex}"
            class="block w-full rounded-md border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-600"
            placeholder="Ej: 9.125&quot; x 9.125&quot; x 3&quot;"
            disabled
          />
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">
            Medida Real
          </label>
          <input
            type="text"
            name="variant_real_size_${variantIndex}"
            id="real_size_${variantIndex}"
            class="block w-full rounded-md border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-600"
            placeholder="Ej: 231 x 231 x 75 mm"
            disabled
          />
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">
            Precio
          </label>
          <input
            type="number"
            name="variant_price_${variantIndex}"
            id="price_${variantIndex}"
            step="0.01"
            min="0"
            class="block w-full rounded-md border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-600"
            placeholder="0.00"
            disabled
          />
        </div>
      </div>
      <div id="bind_search_status_${variantIndex}" class="mt-2 text-xs"></div>
    `;

    container.appendChild(variantDiv);

    // Agregar listener al input de c√≥digo Bind
    const bindCodeInput = variantDiv.querySelector(`#bind_code_${variantIndex}`) as HTMLInputElement;
    if (bindCodeInput) {
      let searchTimeout: ReturnType<typeof setTimeout>;
      
      bindCodeInput.addEventListener('input', function() {
        const code = this.value.trim();
        
        // Limpiar timeout anterior
        clearTimeout(searchTimeout);
        
        // Limpiar campos si el c√≥digo est√° vac√≠o
        if (!code) {
          clearVariantFields(variantIndex);
          return;
        }

        // Esperar 500ms despu√©s de que el usuario deje de escribir
        searchTimeout = setTimeout(() => {
          searchBindProduct(code, variantIndex);
        }, 500);
      });
    }

    // Agregar listener al bot√≥n de eliminar
    const removeBtn = variantDiv.querySelector('.remove-variant-btn');
    if (removeBtn) {
      removeBtn.addEventListener('click', function() {
        variantDiv.remove();
      });
    }
  }

  async function searchBindProduct(code: string, variantIndex: number) {
    const statusDiv = document.getElementById(`bind_search_status_${variantIndex}`);
    const nominalInput = document.getElementById(`nominal_size_${variantIndex}`) as HTMLInputElement;
    const realInput = document.getElementById(`real_size_${variantIndex}`) as HTMLInputElement;
    const priceInput = document.getElementById(`price_${variantIndex}`) as HTMLInputElement;

    if (!statusDiv || !nominalInput || !realInput || !priceInput) return;

    // Mostrar estado de b√∫squeda
    statusDiv.innerHTML = '<span class="text-blue-600">üîç Buscando...</span>';
    statusDiv.className = 'mt-2 text-xs';

    try {
      const response = await fetch(`/api/bind/search-by-code?code=${encodeURIComponent(code)}`);
      const result = await response.json();

      if (result.success && result.data) {
        // Llenar los campos con los datos obtenidos
        nominalInput.value = result.data.nominalSize || '';
        realInput.value = result.data.realSize || '';
        priceInput.value = result.data.price || '';

        // Habilitar los campos
        nominalInput.disabled = false;
        nominalInput.classList.remove('bg-gray-100', 'text-gray-600');
        nominalInput.classList.add('bg-white', 'text-gray-900');

        realInput.disabled = false;
        realInput.classList.remove('bg-gray-100', 'text-gray-600');
        realInput.classList.add('bg-white', 'text-gray-900');

        priceInput.disabled = false;
        priceInput.classList.remove('bg-gray-100', 'text-gray-600');
        priceInput.classList.add('bg-white', 'text-gray-900');

        // Mostrar √©xito
        statusDiv.innerHTML = '<span class="text-green-600">‚úÖ Producto encontrado</span>';
        statusDiv.className = 'mt-2 text-xs';
      } else {
        // Producto no encontrado
        clearVariantFields(variantIndex);
        statusDiv.innerHTML = '<span class="text-yellow-600">‚ö†Ô∏è Producto no encontrado en Bind. Puedes ingresar los datos manualmente.</span>';
        statusDiv.className = 'mt-2 text-xs';
        
        // Habilitar campos para entrada manual
        enableManualInput(variantIndex);
      }
    } catch (error) {
      console.error('Error al buscar producto:', error);
      clearVariantFields(variantIndex);
      statusDiv.innerHTML = '<span class="text-red-600">‚ùå Error al buscar. Puedes ingresar los datos manualmente.</span>';
      statusDiv.className = 'mt-2 text-xs';
      
      // Habilitar campos para entrada manual
      enableManualInput(variantIndex);
    }
  }

  function clearVariantFields(variantIndex: number) {
    const nominalInput = document.getElementById(`nominal_size_${variantIndex}`) as HTMLInputElement;
    const realInput = document.getElementById(`real_size_${variantIndex}`) as HTMLInputElement;
    const priceInput = document.getElementById(`price_${variantIndex}`) as HTMLInputElement;

    if (nominalInput) {
      nominalInput.value = '';
      nominalInput.disabled = true;
      nominalInput.classList.remove('bg-white', 'text-gray-900');
      nominalInput.classList.add('bg-gray-100', 'text-gray-600');
    }
    if (realInput) {
      realInput.value = '';
      realInput.disabled = true;
      realInput.classList.remove('bg-white', 'text-gray-900');
      realInput.classList.add('bg-gray-100', 'text-gray-600');
    }
    if (priceInput) {
      priceInput.value = '';
      priceInput.disabled = true;
      priceInput.classList.remove('bg-white', 'text-gray-900');
      priceInput.classList.add('bg-gray-100', 'text-gray-600');
    }
  }

  function enableManualInput(variantIndex: number) {
    const nominalInput = document.getElementById(`nominal_size_${variantIndex}`) as HTMLInputElement;
    const realInput = document.getElementById(`real_size_${variantIndex}`) as HTMLInputElement;
    const priceInput = document.getElementById(`price_${variantIndex}`) as HTMLInputElement;

    if (nominalInput) {
      nominalInput.disabled = false;
      nominalInput.classList.remove('bg-gray-100', 'text-gray-600');
      nominalInput.classList.add('bg-white', 'text-gray-900');
    }
    if (realInput) {
      realInput.disabled = false;
      realInput.classList.remove('bg-gray-100', 'text-gray-600');
      realInput.classList.add('bg-white', 'text-gray-900');
    }
    if (priceInput) {
      priceInput.disabled = false;
      priceInput.classList.remove('bg-gray-100', 'text-gray-600');
      priceInput.classList.add('bg-white', 'text-gray-900');
    }
  }

  // Inicializar cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', () => {
    const addVariantBtn = document.getElementById('add-variant-btn');
    if (addVariantBtn) {
      addVariantBtn.addEventListener('click', createVariantRow);
    }
  });
</script>
