---
import AdminLayout from "@/layouts/adminLayout.astro";
import {
  getCategoryById,
  updateCategory,
  getCategoryImages,
  addCategoryImage,
  deleteCategoryImage,
} from "@/lib/filter-category-service";
import { getAuthenticatedUser } from '@/lib/auth-utils';
import { isUserAdmin } from '@/lib/database';
import CategoryImageManager from "@/components/admin/CategoryImageManager.astro";

export const prerender = false;

const user = getAuthenticatedUser(Astro.cookies);

if (!user) {
  return Astro.redirect('/login');
}

const userIsAdmin = await isUserAdmin(user.id);

if (!userIsAdmin) {
  return Astro.redirect('/');
}

const { id } = Astro.params;
const categoryId = parseInt(id || "0");

let category = await getCategoryById(categoryId);
if (!category) {
  return Astro.redirect("/admin/filter-categories");
}

let images = await getCategoryImages(categoryId);

// Log para diagn√≥stico
console.log('üîç [Edit Category] Categor√≠a cargada:', {
  id: category.id,
  name: category.name,
  main_image: category.main_image
});
console.log('üîç [Edit Category] Im√°genes obtenidas:', images.length);
images.forEach((img, idx) => {
  console.log(`  Imagen ${idx + 1}:`, {
    id: img.id,
    is_primary: img.is_primary,
    image_url: img.image_url?.substring(0, 50) + '...'
  });
});

// Si no hay main_image en category pero hay una imagen marcada como principal en filter_category_images, usarla
let mainImageUrl = category.main_image;
if (!mainImageUrl) {
  const primaryImage = images.find(img => img.is_primary);
  if (primaryImage) {
    console.log('‚ö†Ô∏è [Edit Category] No hay main_image en category, usando imagen principal de filter_category_images');
    mainImageUrl = primaryImage.image_url;
    // Actualizar category.main_image para futuras cargas
    await updateCategory(categoryId, {
      main_image: primaryImage.image_url,
    });
  } else {
    console.log('‚ö†Ô∏è [Edit Category] No hay imagen principal ni en category.main_image ni en filter_category_images');
  }
} else {
  console.log('‚úÖ [Edit Category] Imagen principal encontrada en category.main_image:', mainImageUrl);
}

let error: string | null = null;
let success: string | null = null;

// Helper para formatear precio (MySQL devuelve DECIMAL como string)
function formatPrice(price: number | string): string {
  const numPrice = typeof price === 'string' ? parseFloat(price) : price;
  return numPrice.toFixed(2);
}

// Procesar formulario
if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get("action") as string;

    if (action === "update_category") {
      // Actualizar la categor√≠a
      const slug = (formData.get("name") as string)
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");

      const updated = await updateCategory(categoryId, {
        name: formData.get("name") as string,
        name_en: (formData.get("name_en") as string) || null,
        slug: slug,
        description: (formData.get("description") as string) || null,
        description_en: (formData.get("description_en") as string) || null,
        main_image: (formData.get("main_image") as string) || category.main_image || null,
        status: (formData.get("status") as "active" | "inactive" | "draft") || "active",
      });

      // Actualizar imagen principal si viene del componente
      const mainImageFromComponent = formData.get("main_image") as string;
      if (mainImageFromComponent && mainImageFromComponent !== category.main_image) {
        await updateCategory(categoryId, {
          main_image: mainImageFromComponent,
        });
      }

      if (updated) {
        return Astro.redirect("/admin/filter-categories");
      } else {
        error = "Error al actualizar la categor√≠a";
      }
    }
  } catch (err) {
    console.error("Error procesando formulario:", err);
    error = err instanceof Error ? err.message : "Error desconocido";
  }
}
---

<AdminLayout title={`Editar: ${category.name}`}>
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center gap-4">
        <a
          href="/admin/filter-categories"
          class="text-gray-600 hover:text-gray-900"
        >
          <svg
            class="h-6 w-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
        </a>
        <div>
          <h1 class="text-3xl font-bold text-gray-900">
            Editar: {category.name}
          </h1>
          <p class="mt-2 text-gray-600">ID: {category.id} | Slug: {category.slug}</p>
        </div>
      </div>
    </div>

    <!-- Mensajes -->
    {
      error && (
        <div class="mb-6 rounded-lg border border-red-300 bg-red-50 p-4">
          <div class="flex">
            <svg
              class="h-5 w-5 text-red-400"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                clip-rule="evenodd"
              />
            </svg>
            <div class="ml-3">
              <p class="text-sm font-medium text-red-800">{error}</p>
            </div>
          </div>
        </div>
      )
    }

    {
      success && (
        <div class="mb-6 rounded-lg border border-green-300 bg-green-50 p-4">
          <div class="flex">
            <svg
              class="h-5 w-5 text-green-400"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                clip-rule="evenodd"
              />
            </svg>
            <div class="ml-3">
              <p class="text-sm font-medium text-green-800">{success}</p>
            </div>
          </div>
        </div>
      )
    }

    <!-- Contenido completo sin tabs -->
    <div class="space-y-8">
      <form method="POST" id="category-form" class="space-y-8">
        <input type="hidden" name="action" value="update_category" />

        <!-- Informaci√≥n B√°sica -->
        <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
          <div class="mb-6 flex items-center gap-3 border-b border-gray-200 pb-4">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100">
              <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <h2 class="text-xl font-bold text-gray-900">
                Informaci√≥n B√°sica
              </h2>
              <p class="mt-1 text-sm text-gray-500">
                Nombre y descripci√≥n del filtro en espa√±ol e ingl√©s
              </p>
            </div>
          </div>

          <div class="grid gap-6 md:grid-cols-2">
            <div>
              <label for="name" class="mb-2 flex items-center gap-2 text-sm font-semibold text-gray-700">
                <span>Nombre (Espa√±ol)</span>
                <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="name"
                name="name"
                value={category.name}
                required
                placeholder="Ej: Mini pleat sello gel downstream"
                class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
              />
              <p class="mt-1.5 text-xs text-gray-500">
                Nombre principal del filtro en espa√±ol
              </p>
            </div>

            <div>
              <label
                for="name_en"
                class="mb-2 block text-sm font-semibold text-gray-700"
              >
                Nombre (Ingl√©s)
              </label>
              <input
                type="text"
                id="name_en"
                name="name_en"
                value={category.name_en || ""}
                placeholder="Ej: Mini pleat gel seal downstream"
                class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
              />
              <p class="mt-1.5 text-xs text-gray-500">
                Nombre del filtro en ingl√©s (opcional)
              </p>
            </div>
          </div>

          <div class="mt-6 grid gap-6 md:grid-cols-2">
            <div>
              <label
                for="description"
                class="mb-2 block text-sm font-semibold text-gray-700"
              >
                Descripci√≥n (Espa√±ol)
              </label>
              <textarea
                id="description"
                name="description"
                rows="5"
                placeholder="Describe el filtro, su funci√≥n, caracter√≠sticas principales y uso t√≠pico..."
                class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
              >{category.description || ""}</textarea>
              <p class="mt-1.5 text-xs text-gray-500">
                Descripci√≥n detallada del filtro en espa√±ol
              </p>
            </div>

            <div>
              <label
                for="description_en"
                class="mb-2 block text-sm font-semibold text-gray-700"
              >
                Descripci√≥n (Ingl√©s)
              </label>
              <textarea
                id="description_en"
                name="description_en"
                rows="5"
                placeholder="Describe the filter, its function, main characteristics and typical use..."
                class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
              >{category.description_en || ""}</textarea>
              <p class="mt-1.5 text-xs text-gray-500">
                Descripci√≥n detallada del filtro en ingl√©s (opcional)
              </p>
            </div>
          </div>
        </div>

      <!-- Secci√≥n: Im√°genes -->
      <div class="mt-12 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
        <div class="mb-6 flex items-center gap-3 border-b border-gray-200 pb-4">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-pink-100">
            <svg class="h-6 w-6 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
          <div>
            <h2 class="text-xl font-bold text-gray-900">
              Im√°genes ({mainImageUrl ? 1 : 0 + images.filter(img => !img.is_primary).length})
            </h2>
            <p class="mt-1 text-sm text-gray-500">
              Imagen principal y hasta 4 im√°genes de carrusel
            </p>
          </div>
        </div>
        <CategoryImageManager
          categoryId={categoryId}
          categoryName={category.name}
          mainImageUrl={mainImageUrl}
        />
      </div>

        <!-- Estado -->
        <div class="mt-12 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
          <div class="mb-4 flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-gray-100">
              <svg class="h-6 w-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <h2 class="text-lg font-bold text-gray-900">
                Estado de Publicaci√≥n
              </h2>
              <p class="mt-1 text-sm text-gray-500">
                Define si la categor√≠a estar√° visible para los usuarios
              </p>
            </div>
          </div>
          <div>
            <label
              for="status"
              class="mb-2 flex items-center gap-2 text-sm font-semibold text-gray-700"
            >
              <span>Estado</span>
              <span class="text-red-500">*</span>
            </label>
            <select
              id="status"
              name="status"
              required
              class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
            >
              <option value="active" selected={category.status === "active"}>
                Activo - Visible para usuarios
              </option>
              <option value="draft" selected={category.status === "draft"}>
                Borrador - Solo visible en admin
              </option>
              <option
                value="inactive"
                selected={category.status === "inactive"}
              >
                Inactivo - No visible
              </option>
            </select>
            <p class="mt-1.5 text-xs text-gray-500">
              Las categor√≠as activas aparecer√°n en la p√°gina de filtros
            </p>
          </div>
        </div>

        <!-- Botones -->
        <div class="mt-6 flex items-center justify-end gap-4 border-t border-gray-200 pt-6">
          <a
            href="/admin/filter-categories"
            class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-6 py-3 font-semibold text-gray-700 transition-colors hover:bg-gray-50"
          >
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
            Cancelar
          </a>
          <button
            type="submit"
            id="save-category-btn"
            class="flex items-center gap-2 rounded-lg bg-blue-600 px-6 py-3 font-semibold text-white transition-colors hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
          >
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<script is:inline define:vars={{ categoryId }}>
  // Delete image
  async function deleteImage(id, filename) {
    if (!confirm(`¬øEliminar imagen "${filename}"?`)) return;

    try {
      const response = await fetch(`/api/filter-categories/images/${id}`, {
        method: "DELETE",
      });

      if (response.ok) {
        alert("Imagen eliminada");
        window.location.reload();
      } else {
        alert("Error al eliminar la imagen");
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Error al eliminar la imagen");
    }
  }

  // Delete variant
  async function deleteVariant(id, bindCode) {
    console.log('üóëÔ∏è Eliminando variante:', id, bindCode);
    if (!confirm(`¬øEliminar variante "${bindCode}"?`)) return;

    try {
      const response = await fetch(`/api/filter-categories/variants/${id}`, {
        method: "DELETE",
      });

      if (response.ok) {
        alert("Variante eliminada");
        window.location.reload();
      } else {
        alert("Error al eliminar la variante");
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Error al eliminar la variante");
    }
  }

  // Edit variant - populate form with variant data
  function editVariant(button) {
    console.log('‚úèÔ∏è Editando variante, bot√≥n:', button);
    const variantId = button.getAttribute('data-variant-id');
    const bindCode = button.getAttribute('data-bind-code');
    const nominalSize = button.getAttribute('data-nominal-size');
    const realSize = button.getAttribute('data-real-size');
    const currency = button.getAttribute('data-currency') || 'MXN';
    const priceUSD = button.getAttribute('data-price-usd');
    const price = button.getAttribute('data-price');
    const stock = button.getAttribute('data-stock');
    const isActive = button.getAttribute('data-is-active') === 'true';

    console.log('üìã Datos de variante:', { variantId, bindCode, nominalSize, realSize, currency, priceUSD, price, stock, isActive });

    // Find the form to add variant
    const actionInputs = document.querySelectorAll('input[name="action"]');
    let addVariantForm = null;
    actionInputs.forEach((input) => {
      if (input.value === 'add_variant') {
        addVariantForm = input.closest('form');
      }
    });
    
    console.log('üìù Formulario encontrado:', !!addVariantForm);
    
    if (!addVariantForm) {
      console.log('‚ö†Ô∏è Formulario no encontrado, creando uno nuevo');
      // If form not found, create a new form for editing
      const form = document.createElement("form");
      form.method = "POST";
      form.innerHTML = `
        <input type="hidden" name="action" value="update_variant">
        <input type="hidden" name="variant_id" value="${variantId}">
        <input type="hidden" name="bind_code" value="${bindCode}">
        <input type="hidden" name="nominal_size" value="${nominalSize}">
        <input type="hidden" name="real_size" value="${realSize}">
        <input type="hidden" name="currency" value="${currency}">
        <input type="hidden" name="price_usd" value="${priceUSD || ''}">
        <input type="hidden" name="price" value="${price}">
        <input type="hidden" name="stock" value="${stock}">
        ${isActive ? '<input type="hidden" name="is_active" value="on">' : ""}
      `;
      document.body.appendChild(form);
      form.submit();
      return;
    }

    // Populate the form fields
    const bindCodeInput = addVariantForm.querySelector('input[name="bind_code"]');
    const nominalSizeInput = addVariantForm.querySelector('input[name="nominal_size"]');
    const realSizeInput = addVariantForm.querySelector('input[name="real_size"]');
    const currencySelect = addVariantForm.querySelector('select[name="currency"]');
    const priceUSDInput = addVariantForm.querySelector('input[name="price_usd"]');
    const priceInput = addVariantForm.querySelector('input[name="price"]');
    const stockInput = addVariantForm.querySelector('input[name="stock"]');
    const isActiveCheckbox = addVariantForm.querySelector('input[name="is_active"]');
    const actionInput = addVariantForm.querySelector('input[name="action"]');
    let variantIdInput = addVariantForm.querySelector('input[name="variant_id"]');

    if (bindCodeInput) bindCodeInput.value = bindCode || '';
    if (nominalSizeInput) nominalSizeInput.value = nominalSize || '';
    if (realSizeInput) realSizeInput.value = realSize || '';
    if (currencySelect) currencySelect.value = currency || 'MXN';
    if (priceUSDInput) priceUSDInput.value = priceUSD || '';
    if (priceInput) priceInput.value = price || '';
    if (stockInput) stockInput.value = stock || '';
    if (isActiveCheckbox) isActiveCheckbox.checked = isActive;

    // Change action to update
    if (actionInput) actionInput.value = 'update_variant';
    
    // Add or update variant_id hidden input
    if (!variantIdInput) {
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = 'variant_id';
      hiddenInput.value = variantId || '';
      addVariantForm.appendChild(hiddenInput);
      variantIdInput = hiddenInput;
    } else {
      variantIdInput.value = variantId || '';
    }

    // Change button text
    const submitButton = addVariantForm.querySelector('button[type="submit"]');
    if (submitButton) {
      submitButton.textContent = 'Actualizar Variante';
    }

    console.log('‚úÖ Formulario poblado correctamente');
    
    // Scroll to form
    addVariantForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    // Focus on first input
    if (bindCodeInput) bindCodeInput.focus();
  }

  // Initialize buttons when DOM is ready
  function initializeVariantButtons() {
    console.log('üîß Inicializando botones de variantes...');
    
    // Use event delegation for variant buttons only
    // Attach to a specific container to avoid interfering with other forms
    const variantsContainer = document.querySelector('.mt-12.space-y-8');
    if (!variantsContainer) {
      console.error('‚ùå No se encontr√≥ el contenedor de variantes');
      return;
    }
    
    variantsContainer.addEventListener('click', function(e) {
      var target = e.target;
      
      // Skip if clicking on the main form or its elements
      var categoryForm = document.getElementById('category-form');
      if (categoryForm && categoryForm.contains(target)) {
        return; // Don't interfere with main form
      }
      
      // Handle edit button
      var editButton = target.closest('.edit-variant-btn');
      if (editButton) {
        console.log('üñ±Ô∏è Click en bot√≥n Editar');
        e.preventDefault();
        e.stopPropagation();
        editVariant(editButton);
        return;
      }
      
      // Handle delete button
      var deleteButton = target.closest('.delete-variant-btn');
      if (deleteButton) {
        console.log('üñ±Ô∏è Click en bot√≥n Eliminar');
        e.preventDefault();
        e.stopPropagation();
        var variantId = deleteButton.getAttribute('data-variant-id');
        var bindCode = deleteButton.getAttribute('data-bind-code');
        console.log('üìã Datos:', { variantId: variantId, bindCode: bindCode });
        if (variantId && bindCode) {
          deleteVariant(parseInt(variantId), bindCode);
        } else {
          console.error('‚ùå Faltan datos:', { variantId: variantId, bindCode: bindCode });
        }
        return;
      }
    });
    
    console.log('‚úÖ Event listeners agregados para variantes');
  }

  // Make functions global
  window.deleteImage = deleteImage;
  window.deleteVariant = deleteVariant;
  window.editVariant = editVariant;

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      initializeVariantButtons();
      
      // Ensure form submission works
      var categoryForm = document.getElementById('category-form');
      var saveButton = document.getElementById('save-category-btn');
      
      if (categoryForm && saveButton) {
        console.log('‚úÖ Formulario y bot√≥n encontrados');
        
        // Add submit listener to form
        categoryForm.addEventListener('submit', function(e) {
          console.log('üìù Formulario envi√°ndose...');
          // Let it submit naturally
        });
        
        // Add click listener to button as backup
        saveButton.addEventListener('click', function(e) {
          console.log('üñ±Ô∏è Click en Guardar Cambios');
          // Force form submission if it doesn't happen naturally
          setTimeout(function() {
            if (categoryForm) {
              console.log('üìù Forzando env√≠o del formulario...');
              categoryForm.submit();
            }
          }, 100);
        });
      } else {
        console.error('‚ùå No se encontr√≥ el formulario o el bot√≥n:', {
          form: !!categoryForm,
          button: !!saveButton
        });
      }
    });
  } else {
    initializeVariantButtons();
    
    // Ensure form submission works
    var categoryForm = document.getElementById('category-form');
    var saveButton = document.getElementById('save-category-btn');
    
    if (categoryForm && saveButton) {
      console.log('‚úÖ Formulario y bot√≥n encontrados');
      
      // Add submit listener to form
      categoryForm.addEventListener('submit', function(e) {
        console.log('üìù Formulario envi√°ndose...');
        // Let it submit naturally
      });
      
      // Add click listener to button as backup
      saveButton.addEventListener('click', function(e) {
        console.log('üñ±Ô∏è Click en Guardar Cambios');
        // Force form submission if it doesn't happen naturally
        setTimeout(function() {
          if (categoryForm) {
            console.log('üìù Forzando env√≠o del formulario...');
            categoryForm.submit();
          }
        }, 100);
      });
    } else {
      console.error('‚ùå No se encontr√≥ el formulario o el bot√≥n:', {
        form: !!categoryForm,
        button: !!saveButton
      });
    }
  }
</script>
