---
import AdminLayout from "@/layouts/adminLayout.astro";
import {
  getCategoryById,
  updateCategory,
  getCategoryImages,
  getCategoryVariants,
  addCategoryImage,
  deleteCategoryImage,
  addCategoryVariant,
  updateCategoryVariant,
  deleteCategoryVariant,
} from "@/lib/filter-category-service";
import { getAuthenticatedUser } from '@/lib/auth-utils';
import { isUserAdmin } from '@/lib/database';
import CategoryImageManager from "@/components/admin/CategoryImageManager.astro";
import DynamicListInput from "@/components/admin/DynamicListInput.astro";

export const prerender = false;

const user = getAuthenticatedUser(Astro.cookies);

if (!user) {
  return Astro.redirect('/login');
}

const userIsAdmin = await isUserAdmin(user.id);

if (!userIsAdmin) {
  return Astro.redirect('/');
}

const { id } = Astro.params;
const categoryId = parseInt(id || "0");

let category = await getCategoryById(categoryId);
if (!category) {
  return Astro.redirect("/admin/filter-categories");
}

let images = await getCategoryImages(categoryId);
let variants = await getCategoryVariants(categoryId);

let error: string | null = null;
let success: string | null = null;

// Helper para formatear precio (MySQL devuelve DECIMAL como string)
function formatPrice(price: number | string): string {
  const numPrice = typeof price === 'string' ? parseFloat(price) : price;
  return numPrice.toFixed(2);
}

// Procesar formulario
if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get("action") as string;

    if (action === "update_category") {
      // Actualizar la categor√≠a
      const slug = (formData.get("name") as string)
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");

      const updated = await updateCategory(categoryId, {
        name: formData.get("name") as string,
        name_en: (formData.get("name_en") as string) || null,
        slug: slug,
        description: (formData.get("description") as string) || null,
        description_en: (formData.get("description_en") as string) || null,
        main_image: (formData.get("main_image") as string) || category.main_image || null,
        // Convertir listas JSON a texto separado por saltos de l√≠nea
        efficiency: (() => {
          const efficiencyJson = formData.get("efficiency") as string;
          if (efficiencyJson) {
            try {
              const efficiency = JSON.parse(efficiencyJson) as string[];
              return efficiency.length > 0 ? efficiency.join('\n') : null;
            } catch {
              return efficiencyJson; // Si no es JSON, usar como est√°
            }
          }
          return null;
        })(),
        efficiency_en: (() => {
          const efficiencyJson = formData.get("efficiency_en") as string;
          if (efficiencyJson) {
            try {
              const efficiency = JSON.parse(efficiencyJson) as string[];
              return efficiency.length > 0 ? efficiency.join('\n') : null;
            } catch {
              return efficiencyJson;
            }
          }
          return null;
        })(),
        efficiency_class: (formData.get("efficiency_class") as string) || null,
        // Convertir listas JSON a texto separado por saltos de l√≠nea
        characteristics: (() => {
          const charsJson = formData.get("characteristics") as string;
          if (charsJson) {
            try {
              const chars = JSON.parse(charsJson) as string[];
              return chars.length > 0 ? chars.join('\n') : null;
            } catch {
              return charsJson; // Si no es JSON, usar como est√°
            }
          }
          return null;
        })(),
        characteristics_en: (() => {
          const charsJson = formData.get("characteristics_en") as string;
          if (charsJson) {
            try {
              const chars = JSON.parse(charsJson) as string[];
              return chars.length > 0 ? chars.join('\n') : null;
            } catch {
              return charsJson;
            }
          }
          return null;
        })(),
        typical_installation:
          (formData.get("typical_installation") as string) || null,
        typical_installation_en:
          (formData.get("typical_installation_en") as string) || null,
        applications: (formData.get("applications") as string) || null,
        applications_en: (formData.get("applications_en") as string) || null,
        benefits: (() => {
          const benefitsJson = formData.get("benefits") as string;
          if (benefitsJson) {
            try {
              const benefits = JSON.parse(benefitsJson) as string[];
              return benefits.length > 0 ? benefits.join('\n') : null;
            } catch {
              return benefitsJson;
            }
          }
          return null;
        })(),
        benefits_en: (() => {
          const benefitsJson = formData.get("benefits_en") as string;
          if (benefitsJson) {
            try {
              const benefits = JSON.parse(benefitsJson) as string[];
              return benefits.length > 0 ? benefits.join('\n') : null;
            } catch {
              return benefitsJson;
            }
          }
          return null;
        })(),
        max_temperature: (formData.get("max_temperature") as string) || null,
        frame_material: (formData.get("frame_material") as string) || null,
        status: formData.get("status") as "active" | "inactive" | "draft",
      });

      // Actualizar imagen principal si viene del componente
      const mainImageFromComponent = formData.get("main_image") as string;
      if (mainImageFromComponent && mainImageFromComponent !== category.main_image) {
        await updateCategory(categoryId, {
          main_image: mainImageFromComponent,
        });
      }

      if (updated) {
        return Astro.redirect("/admin/filter-categories");
      } else {
        error = "Error al actualizar la categor√≠a";
      }
    } else if (action === "add_variant") {
      // Agregar variante
      const bindCode = formData.get("bind_code") as string;
      const nominalSize = formData.get("nominal_size") as string;
      const realSize = formData.get("real_size") as string;
      const price = parseFloat(formData.get("price") as string);
      const stock = parseInt(formData.get("stock") as string) || 0;
      const isActive = formData.get("is_active") === "on";

      if (bindCode && nominalSize && realSize && !isNaN(price)) {
        const variantId = await addCategoryVariant({
          category_id: categoryId,
          bind_code: bindCode,
          nominal_size: nominalSize,
          real_size: realSize,
          price: price,
          stock: stock,
          is_active: isActive,
        });

        if (variantId) {
          success = "Variante agregada exitosamente";
          variants = await getCategoryVariants(categoryId);
        } else {
          error = "Error al agregar la variante (¬øc√≥digo duplicado?)";
        }
      }
    } else if (action === "update_variant") {
      // Actualizar variante
      const variantId = parseInt(formData.get("variant_id") as string);
      const bindCode = formData.get("bind_code") as string;
      const nominalSize = formData.get("nominal_size") as string;
      const realSize = formData.get("real_size") as string;
      const price = parseFloat(formData.get("price") as string);
      const stock = parseInt(formData.get("stock") as string) || 0;
      const isActive = formData.get("is_active") === "on";

      if (bindCode && nominalSize && realSize && !isNaN(price)) {
        const updated = await updateCategoryVariant(variantId, {
          bind_code: bindCode,
          nominal_size: nominalSize,
          real_size: realSize,
          price: price,
          stock: stock,
          is_active: isActive,
        });

        if (updated) {
          success = "Variante actualizada exitosamente";
          variants = await getCategoryVariants(categoryId);
        } else {
          error = "Error al actualizar la variante";
        }
      }
    }
  } catch (err) {
    console.error("Error procesando formulario:", err);
    error = err instanceof Error ? err.message : "Error desconocido";
  }
}
---

<AdminLayout title={`Editar: ${category.name}`}>
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center gap-4">
        <a
          href="/admin/filter-categories"
          class="text-gray-600 hover:text-gray-900"
        >
          <svg
            class="h-6 w-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
        </a>
        <div>
          <h1 class="text-3xl font-bold text-gray-900">
            Editar: {category.name}
          </h1>
          <p class="mt-2 text-gray-600">ID: {category.id} | Slug: {category.slug}</p>
        </div>
      </div>
    </div>

    <!-- Mensajes -->
    {
      error && (
        <div class="mb-6 rounded-lg border border-red-300 bg-red-50 p-4">
          <div class="flex">
            <svg
              class="h-5 w-5 text-red-400"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                clip-rule="evenodd"
              />
            </svg>
            <div class="ml-3">
              <p class="text-sm font-medium text-red-800">{error}</p>
            </div>
          </div>
        </div>
      )
    }

    {
      success && (
        <div class="mb-6 rounded-lg border border-green-300 bg-green-50 p-4">
          <div class="flex">
            <svg
              class="h-5 w-5 text-green-400"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                clip-rule="evenodd"
              />
            </svg>
            <div class="ml-3">
              <p class="text-sm font-medium text-green-800">{success}</p>
            </div>
          </div>
        </div>
      )
    }

    <!-- Contenido completo sin tabs -->
    <div class="space-y-8">
      <form method="POST" id="category-form" class="space-y-8">
        <input type="hidden" name="action" value="update_category" />

        <!-- Informaci√≥n B√°sica -->
        <div class="rounded-lg border border-gray-200 bg-white p-6">
          <h2 class="mb-4 text-xl font-bold text-gray-900">
            Informaci√≥n B√°sica
          </h2>

          <div class="grid gap-6 md:grid-cols-2">
            <div>
              <label for="name" class="block text-sm font-medium text-gray-700">
                Nombre (Espa√±ol) *
              </label>
              <input
                type="text"
                id="name"
                name="name"
                value={category.name}
                required
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              />
            </div>

            <div>
              <label
                for="name_en"
                class="block text-sm font-medium text-gray-700"
              >
                Nombre (Ingl√©s)
              </label>
              <input
                type="text"
                id="name_en"
                name="name_en"
                value={category.name_en || ""}
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              />
            </div>

            <div class="md:col-span-2">
              <p class="text-sm text-gray-600">
                La imagen principal se gestiona en la secci√≥n "Im√°genes" m√°s abajo.
              </p>
            </div>
          </div>

          <div class="mt-6 grid gap-6 md:grid-cols-2">
            <div>
              <label
                for="description"
                class="block text-sm font-medium text-gray-700"
              >
                Descripci√≥n (Espa√±ol)
              </label>
              <textarea
                id="description"
                name="description"
                rows="4"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              >{category.description || ""}</textarea>
            </div>

            <div>
              <label
                for="description_en"
                class="block text-sm font-medium text-gray-700"
              >
                Descripci√≥n (Ingl√©s)
              </label>
              <textarea
                id="description_en"
                name="description_en"
                rows="4"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              >{category.description_en || ""}</textarea>
            </div>
          </div>
        </div>

        <!-- Especificaciones T√©cnicas -->
        <div class="rounded-lg border border-gray-200 bg-white p-6">
          <h2 class="mb-4 text-xl font-bold text-gray-900">
            Especificaciones T√©cnicas
          </h2>

          <div class="grid gap-6 md:grid-cols-3">
            <div>
              <label
                for="efficiency_class"
                class="block text-sm font-medium text-gray-700"
              >
                Clase de Eficiencia
              </label>
              <input
                type="text"
                id="efficiency_class"
                name="efficiency_class"
                value={category.efficiency_class || ""}
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              />
            </div>

            <div>
              <label
                for="max_temperature"
                class="block text-sm font-medium text-gray-700"
              >
                Temperatura M√°xima
              </label>
              <input
                type="text"
                id="max_temperature"
                name="max_temperature"
                value={category.max_temperature || ""}
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              />
            </div>

            <div>
              <label
                for="frame_material"
                class="block text-sm font-medium text-gray-700"
              >
                Material del Marco
              </label>
              <input
                type="text"
                id="frame_material"
                name="frame_material"
                value={category.frame_material || ""}
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              />
            </div>
          </div>

          <div class="mt-6 grid gap-6 md:grid-cols-2">
            <DynamicListInput
              id="efficiency"
              name="efficiency"
              label="Eficiencia (Espa√±ol)"
              placeholder="Ej: 99.997%"
              helpText="Agrega cada valor de eficiencia como un elemento de la lista"
              initialItems={category.efficiency ? category.efficiency.split('\n').filter(item => item.trim()) : []}
            />
            <DynamicListInput
              id="efficiency_en"
              name="efficiency_en"
              label="Eficiencia (Ingl√©s)"
              placeholder="Ej: 99.997%"
              helpText="Agrega cada valor de eficiencia como un elemento de la lista"
              initialItems={category.efficiency_en ? category.efficiency_en.split('\n').filter(item => item.trim()) : []}
            />
          </div>

          <div class="mt-6 grid gap-6 md:grid-cols-2">
            <DynamicListInput
              id="characteristics"
              name="characteristics"
              label="Caracter√≠sticas (Espa√±ol)"
              placeholder="Ej: Marco de aluminio"
              helpText="Agrega cada caracter√≠stica como un elemento de la lista"
              initialItems={category.characteristics ? category.characteristics.split('\n').filter(item => item.trim()) : []}
            />
            <DynamicListInput
              id="characteristics_en"
              name="characteristics_en"
              label="Caracter√≠sticas (Ingl√©s)"
              placeholder="Ej: Aluminum frame"
              helpText="Agrega cada caracter√≠stica como un elemento de la lista"
              initialItems={category.characteristics_en ? category.characteristics_en.split('\n').filter(item => item.trim()) : []}
            />
          </div>
        </div>

        <!-- Informaci√≥n Adicional -->
        <div class="rounded-lg border border-gray-200 bg-white p-6">
          <h2 class="mb-4 text-xl font-bold text-gray-900">
            Informaci√≥n Adicional
          </h2>

          <div class="space-y-6">
            <div class="grid gap-6 md:grid-cols-2">
              <div>
                <label
                  for="typical_installation"
                  class="block text-sm font-medium text-gray-700"
                >
                  Instalaci√≥n T√≠pica (Espa√±ol)
                </label>
                <textarea
                  id="typical_installation"
                  name="typical_installation"
                  rows="3"
                  class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                >{category.typical_installation || ""}</textarea>
              </div>

              <div>
                <label
                  for="typical_installation_en"
                  class="block text-sm font-medium text-gray-700"
                >
                  Instalaci√≥n T√≠pica (Ingl√©s)
                </label>
                <textarea
                  id="typical_installation_en"
                  name="typical_installation_en"
                  rows="3"
                  class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                >{category.typical_installation_en || ""}</textarea>
              </div>
            </div>

            <div class="grid gap-6 md:grid-cols-2">
              <div>
                <label
                  for="applications"
                  class="block text-sm font-medium text-gray-700"
                >
                  Aplicaciones (Espa√±ol)
                </label>
                <textarea
                  id="applications"
                  name="applications"
                  rows="3"
                  class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                >{category.applications || ""}</textarea>
              </div>

              <div>
                <label
                  for="applications_en"
                  class="block text-sm font-medium text-gray-700"
                >
                  Aplicaciones (Ingl√©s)
                </label>
                <textarea
                  id="applications_en"
                  name="applications_en"
                  rows="3"
                  class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                >{category.applications_en || ""}</textarea>
              </div>
            </div>

            <div class="grid gap-6 md:grid-cols-2">
              <DynamicListInput
                id="benefits"
                name="benefits"
                label="Beneficios (Espa√±ol)"
                placeholder="Ej: Compacto y liviano"
                helpText="Agrega cada beneficio como un elemento de la lista"
                initialItems={category.benefits ? category.benefits.split('\n').filter(item => item.trim()) : []}
              />
              <DynamicListInput
                id="benefits_en"
                name="benefits_en"
                label="Beneficios (Ingl√©s)"
                placeholder="Ej: Compact and lightweight"
                helpText="Agrega cada beneficio como un elemento de la lista"
                initialItems={category.benefits_en ? category.benefits_en.split('\n').filter(item => item.trim()) : []}
              />
            </div>
          </div>
        </div>

      <!-- Secci√≥n: Im√°genes -->
      <div class="mt-12 rounded-lg border border-gray-200 bg-white p-6">
        <h2 class="mb-4 text-xl font-bold text-gray-900">
          Im√°genes ({images.length})
        </h2>
        <CategoryImageManager
          categoryId={categoryId}
          categoryName={category.name}
          mainImageUrl={category.main_image}
        />
      </div>

      <!-- Secci√≥n: Variantes -->
      <div class="mt-12 space-y-8">
        <!-- Agregar Variante -->
        <div class="rounded-lg border border-gray-200 bg-white p-6">
          <h2 class="mb-4 text-xl font-bold text-gray-900">
            Agregar Variante
          </h2>

          <form method="POST" class="space-y-4">
            <input type="hidden" name="action" value="add_variant" />

            <div class="grid gap-4 md:grid-cols-5">
              <div>
                <label
                  for="bind_code"
                  class="block text-sm font-medium text-gray-700"
                >
                  C√≥digo BIND *
                </label>
                <input
                  type="text"
                  id="bind_code"
                  name="bind_code"
                  required
                  placeholder="HGD1"
                  class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
              </div>

              <div>
                <label
                  for="nominal_size"
                  class="block text-sm font-medium text-gray-700"
                >
                  Medida Nominal *
                </label>
                <input
                  type="text"
                  id="nominal_size"
                  name="nominal_size"
                  required
                  placeholder='9.125" x 9.125" x 3"'
                  class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
              </div>

              <div>
                <label
                  for="real_size"
                  class="block text-sm font-medium text-gray-700"
                >
                  Medida Real *
                </label>
                <input
                  type="text"
                  id="real_size"
                  name="real_size"
                  required
                  placeholder="231 x 231 x 75 mm"
                  class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
              </div>

              <div>
                <label
                  for="price"
                  class="block text-sm font-medium text-gray-700"
                >
                  Precio *
                </label>
                <input
                  type="number"
                  id="price"
                  name="price"
                  required
                  step="0.01"
                  placeholder="158.00"
                  class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
              </div>

              <div>
                <label
                  for="stock"
                  class="block text-sm font-medium text-gray-700"
                >
                  Stock
                </label>
                <input
                  type="number"
                  id="stock"
                  name="stock"
                  value="0"
                  class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
              </div>
            </div>

            <div class="flex items-center mt-6 mb-4">
              <input
                type="checkbox"
                id="is_active"
                name="is_active"
                checked
                class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <label for="is_active" class="ml-2 text-sm text-gray-700">
                Activo
              </label>
            </div>

            <button
              type="submit"
              class="rounded-lg bg-blue-600 px-4 py-2 font-medium text-white transition-colors hover:bg-blue-700"
            >
              + Agregar Variante
            </button>
          </form>
        </div>

        <!-- Lista de Variantes -->
        <div class="mt-8 rounded-lg border border-gray-200 bg-white p-6">
          <h2 class="mb-4 text-xl font-bold text-gray-900">
            Variantes ({variants.length})
          </h2>

          {
            variants.length === 0 ? (
              <p class="text-center text-gray-500">
                No hay variantes. Agrega una arriba.
              </p>
            ) : (
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">
                        C√≥digo BIND
                      </th>
                      <th class="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">
                        Medida Nominal
                      </th>
                      <th class="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">
                        Medida Real
                      </th>
                      <th class="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">
                        Precio
                      </th>
                      <th class="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">
                        Stock
                      </th>
                      <th class="px-4 py-3 text-left text-xs font-medium uppercase text-gray-500">
                        Estado
                      </th>
                      <th class="px-4 py-3 text-right text-xs font-medium uppercase text-gray-500">
                        Acciones
                      </th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200 bg-white">
                    {variants.map((variant) => (
                      <tr class="hover:bg-gray-50">
                        <td class="whitespace-nowrap px-4 py-3 text-sm font-medium text-gray-900">
                          {variant.bind_code}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                          {variant.nominal_size}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                          {variant.real_size}
                        </td>
                        <td class="whitespace-nowrap px-4 py-3 text-sm text-gray-900">
                          ${formatPrice(variant.price)}
                        </td>
                        <td class="whitespace-nowrap px-4 py-3 text-sm text-gray-900">
                          {variant.stock}
                        </td>
                        <td class="whitespace-nowrap px-4 py-3">
                          {variant.is_active ? (
                            <span class="inline-flex rounded-full bg-green-100 px-2 text-xs font-semibold text-green-800">
                              Activo
                            </span>
                          ) : (
                            <span class="inline-flex rounded-full bg-red-100 px-2 text-xs font-semibold text-red-800">
                              Inactivo
                            </span>
                          )}
                        </td>
                        <td class="whitespace-nowrap px-4 py-3 text-right text-sm">
                          <button
                            type="button"
                            data-variant-id={String(variant.id)}
                            data-bind-code={String(variant.bind_code || '')}
                            data-nominal-size={String(variant.nominal_size || '')}
                            data-real-size={String(variant.real_size || '')}
                            data-price={String(variant.price)}
                            data-stock={String(variant.stock || 0)}
                            data-is-active={variant.is_active ? 'true' : 'false'}
                            class="edit-variant-btn mr-2 inline-flex items-center justify-center rounded-md p-2 text-blue-600 hover:bg-blue-50 hover:text-blue-900 transition-colors"
                            title="Editar variante"
                          >
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                          </button>
                          <button
                            type="button"
                            data-variant-id={String(variant.id)}
                            data-bind-code={String(variant.bind_code || '')}
                            class="delete-variant-btn inline-flex items-center justify-center rounded-md p-2 text-red-600 hover:bg-red-50 hover:text-red-900 transition-colors"
                            title="Eliminar variante"
                          >
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )
          }
        </div>
      </div>

        <!-- Estado -->
        <div class="mt-12 rounded-lg border border-gray-200 bg-white p-6">
          <div>
            <label
              for="status"
              class="block text-sm font-medium text-gray-700"
            >
              Estado *
            </label>
            <select
              id="status"
              name="status"
              required
              class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            >
              <option value="active" selected={category.status === "active"}>
                Activo
              </option>
              <option
                value="inactive"
                selected={category.status === "inactive"}
              >
                Inactivo
              </option>
              <option value="draft" selected={category.status === "draft"}>
                Borrador
              </option>
            </select>
          </div>
        </div>

        <!-- Botones -->
        <div class="mt-6 flex items-center justify-end gap-4">
          <a
            href="/admin/filter-categories"
            class="rounded-lg border border-gray-300 bg-white px-6 py-3 font-medium text-gray-700 transition-colors hover:bg-gray-50"
          >
            Cancelar
          </a>
          <button
            type="submit"
            id="save-category-btn"
            class="rounded-lg bg-blue-600 px-6 py-3 font-medium text-white transition-colors hover:bg-blue-700"
          >
            Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<script is:inline define:vars={{ categoryId }}>
  // Delete image
  async function deleteImage(id, filename) {
    if (!confirm(`¬øEliminar imagen "${filename}"?`)) return;

    try {
      const response = await fetch(`/api/filter-categories/images/${id}`, {
        method: "DELETE",
      });

      if (response.ok) {
        alert("Imagen eliminada");
        window.location.reload();
      } else {
        alert("Error al eliminar la imagen");
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Error al eliminar la imagen");
    }
  }

  // Delete variant
  async function deleteVariant(id, bindCode) {
    console.log('üóëÔ∏è Eliminando variante:', id, bindCode);
    if (!confirm(`¬øEliminar variante "${bindCode}"?`)) return;

    try {
      const response = await fetch(`/api/filter-categories/variants/${id}`, {
        method: "DELETE",
      });

      if (response.ok) {
        alert("Variante eliminada");
        window.location.reload();
      } else {
        alert("Error al eliminar la variante");
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Error al eliminar la variante");
    }
  }

  // Edit variant - populate form with variant data
  function editVariant(button) {
    console.log('‚úèÔ∏è Editando variante, bot√≥n:', button);
    const variantId = button.getAttribute('data-variant-id');
    const bindCode = button.getAttribute('data-bind-code');
    const nominalSize = button.getAttribute('data-nominal-size');
    const realSize = button.getAttribute('data-real-size');
    const price = button.getAttribute('data-price');
    const stock = button.getAttribute('data-stock');
    const isActive = button.getAttribute('data-is-active') === 'true';

    console.log('üìã Datos de variante:', { variantId, bindCode, nominalSize, realSize, price, stock, isActive });

    // Find the form to add variant
    const actionInputs = document.querySelectorAll('input[name="action"]');
    let addVariantForm = null;
    actionInputs.forEach((input) => {
      if (input.value === 'add_variant') {
        addVariantForm = input.closest('form');
      }
    });
    
    console.log('üìù Formulario encontrado:', !!addVariantForm);
    
    if (!addVariantForm) {
      console.log('‚ö†Ô∏è Formulario no encontrado, creando uno nuevo');
      // If form not found, create a new form for editing
      const form = document.createElement("form");
      form.method = "POST";
      form.innerHTML = `
        <input type="hidden" name="action" value="update_variant">
        <input type="hidden" name="variant_id" value="${variantId}">
        <input type="hidden" name="bind_code" value="${bindCode}">
        <input type="hidden" name="nominal_size" value="${nominalSize}">
        <input type="hidden" name="real_size" value="${realSize}">
        <input type="hidden" name="price" value="${price}">
        <input type="hidden" name="stock" value="${stock}">
        ${isActive ? '<input type="hidden" name="is_active" value="on">' : ""}
      `;
      document.body.appendChild(form);
      form.submit();
      return;
    }

    // Populate the form fields
    const bindCodeInput = addVariantForm.querySelector('input[name="bind_code"]');
    const nominalSizeInput = addVariantForm.querySelector('input[name="nominal_size"]');
    const realSizeInput = addVariantForm.querySelector('input[name="real_size"]');
    const priceInput = addVariantForm.querySelector('input[name="price"]');
    const stockInput = addVariantForm.querySelector('input[name="stock"]');
    const isActiveCheckbox = addVariantForm.querySelector('input[name="is_active"]');
    const actionInput = addVariantForm.querySelector('input[name="action"]');
    let variantIdInput = addVariantForm.querySelector('input[name="variant_id"]');

    if (bindCodeInput) bindCodeInput.value = bindCode || '';
    if (nominalSizeInput) nominalSizeInput.value = nominalSize || '';
    if (realSizeInput) realSizeInput.value = realSize || '';
    if (priceInput) priceInput.value = price || '';
    if (stockInput) stockInput.value = stock || '';
    if (isActiveCheckbox) isActiveCheckbox.checked = isActive;

    // Change action to update
    if (actionInput) actionInput.value = 'update_variant';
    
    // Add or update variant_id hidden input
    if (!variantIdInput) {
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = 'variant_id';
      hiddenInput.value = variantId || '';
      addVariantForm.appendChild(hiddenInput);
      variantIdInput = hiddenInput;
    } else {
      variantIdInput.value = variantId || '';
    }

    // Change button text
    const submitButton = addVariantForm.querySelector('button[type="submit"]');
    if (submitButton) {
      submitButton.textContent = 'Actualizar Variante';
    }

    console.log('‚úÖ Formulario poblado correctamente');
    
    // Scroll to form
    addVariantForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    // Focus on first input
    if (bindCodeInput) bindCodeInput.focus();
  }

  // Initialize buttons when DOM is ready
  function initializeVariantButtons() {
    console.log('üîß Inicializando botones de variantes...');
    
    // Use event delegation for variant buttons only
    // Attach to a specific container to avoid interfering with other forms
    const variantsContainer = document.querySelector('.mt-12.space-y-8');
    if (!variantsContainer) {
      console.error('‚ùå No se encontr√≥ el contenedor de variantes');
      return;
    }
    
    variantsContainer.addEventListener('click', function(e) {
      var target = e.target;
      
      // Skip if clicking on the main form or its elements
      var categoryForm = document.getElementById('category-form');
      if (categoryForm && categoryForm.contains(target)) {
        return; // Don't interfere with main form
      }
      
      // Handle edit button
      var editButton = target.closest('.edit-variant-btn');
      if (editButton) {
        console.log('üñ±Ô∏è Click en bot√≥n Editar');
        e.preventDefault();
        e.stopPropagation();
        editVariant(editButton);
        return;
      }
      
      // Handle delete button
      var deleteButton = target.closest('.delete-variant-btn');
      if (deleteButton) {
        console.log('üñ±Ô∏è Click en bot√≥n Eliminar');
        e.preventDefault();
        e.stopPropagation();
        var variantId = deleteButton.getAttribute('data-variant-id');
        var bindCode = deleteButton.getAttribute('data-bind-code');
        console.log('üìã Datos:', { variantId: variantId, bindCode: bindCode });
        if (variantId && bindCode) {
          deleteVariant(parseInt(variantId), bindCode);
        } else {
          console.error('‚ùå Faltan datos:', { variantId: variantId, bindCode: bindCode });
        }
        return;
      }
    });
    
    console.log('‚úÖ Event listeners agregados para variantes');
  }

  // Make functions global
  window.deleteImage = deleteImage;
  window.deleteVariant = deleteVariant;
  window.editVariant = editVariant;

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      initializeVariantButtons();
      
      // Ensure form submission works
      var categoryForm = document.getElementById('category-form');
      var saveButton = document.getElementById('save-category-btn');
      
      if (categoryForm && saveButton) {
        console.log('‚úÖ Formulario y bot√≥n encontrados');
        
        // Add submit listener to form
        categoryForm.addEventListener('submit', function(e) {
          console.log('üìù Formulario envi√°ndose...');
          // Let it submit naturally
        });
        
        // Add click listener to button as backup
        saveButton.addEventListener('click', function(e) {
          console.log('üñ±Ô∏è Click en Guardar Cambios');
          // Force form submission if it doesn't happen naturally
          setTimeout(function() {
            if (categoryForm) {
              console.log('üìù Forzando env√≠o del formulario...');
              categoryForm.submit();
            }
          }, 100);
        });
      } else {
        console.error('‚ùå No se encontr√≥ el formulario o el bot√≥n:', {
          form: !!categoryForm,
          button: !!saveButton
        });
      }
    });
  } else {
    initializeVariantButtons();
    
    // Ensure form submission works
    var categoryForm = document.getElementById('category-form');
    var saveButton = document.getElementById('save-category-btn');
    
    if (categoryForm && saveButton) {
      console.log('‚úÖ Formulario y bot√≥n encontrados');
      
      // Add submit listener to form
      categoryForm.addEventListener('submit', function(e) {
        console.log('üìù Formulario envi√°ndose...');
        // Let it submit naturally
      });
      
      // Add click listener to button as backup
      saveButton.addEventListener('click', function(e) {
        console.log('üñ±Ô∏è Click en Guardar Cambios');
        // Force form submission if it doesn't happen naturally
        setTimeout(function() {
          if (categoryForm) {
            console.log('üìù Forzando env√≠o del formulario...');
            categoryForm.submit();
          }
        }, 100);
      });
    } else {
      console.error('‚ùå No se encontr√≥ el formulario o el bot√≥n:', {
        form: !!categoryForm,
        button: !!saveButton
      });
    }
  }
</script>
