---
import AdminLayout from "@/layouts/adminLayout.astro";
import { Button } from "@/components/ui/button";
import { 
  getDashboardStats, 
  getRecentProducts, 
  getSalesStats, 
  getTopProducts, 
  getUserStats, 
  getConversionFunnel 
} from "@/lib/database";

// Obtener datos del dashboard con manejo de errores
let stats = {
  totalProducts: 0,
  totalOrders: 0,
  pendingOrders: 0,
  totalBlogPosts: 0,
  totalUsers: 0,
  monthlySales: 0
};

let recentProducts: any[] = [];
let salesStats: any = { today: 0, week: 0, month: 0, trend: 'stable' };
let topProducts: any[] = [];
let userStats: any = { total: 0, active: 0, newThisMonth: 0 };
let conversionFunnel: any = { visitors: 0, cartAdds: 0, checkouts: 0, completed: 0 };

try {
  console.log('🔍 Obteniendo estadísticas del dashboard...');
  stats = await getDashboardStats();
  console.log('📊 Estadísticas obtenidas:', stats);
} catch (error) {
  console.error('❌ Error obteniendo estadísticas:', error);
}

try {
  console.log('🔍 Obteniendo productos recientes...');
  recentProducts = await getRecentProducts(3);
  console.log('📦 Productos recientes obtenidos:', recentProducts);
} catch (error) {
  console.error('❌ Error obteniendo productos recientes:', error);
}

try {
  console.log('🔍 Obteniendo estadísticas de ventas...');
  salesStats = await getSalesStats();
  console.log('💰 Estadísticas de ventas obtenidas:', salesStats);
} catch (error) {
  console.error('❌ Error obteniendo estadísticas de ventas:', error);
}

try {
  console.log('🔍 Obteniendo productos más vendidos...');
  topProducts = await getTopProducts(5);
  console.log('🏆 Productos más vendidos obtenidos:', topProducts);
} catch (error) {
  console.error('❌ Error obteniendo productos más vendidos:', error);
}

try {
  console.log('🔍 Obteniendo estadísticas de usuarios...');
  userStats = await getUserStats();
  console.log('👥 Estadísticas de usuarios obtenidas:', userStats);
} catch (error) {
  console.error('❌ Error obteniendo estadísticas de usuarios:', error);
}

try {
  console.log('🔍 Obteniendo embudo de conversión...');
  conversionFunnel = await getConversionFunnel();
  console.log('🎯 Embudo de conversión obtenido:', conversionFunnel);
} catch (error) {
  console.error('❌ Error obteniendo embudo de conversión:', error);
}

// Función para formatear moneda
const formatCurrency = (amount: number): string => {
  return new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN'
  }).format(amount);
};

// Función para obtener estado del producto basado en stock
const getProductStatus = (stock: number) => {
  if (stock === 0) return { label: 'Sin Stock', class: 'bg-red-100 text-red-800' };
  if (stock < 10) return { label: 'Bajo Stock', class: 'bg-yellow-100 text-yellow-800' };
  return { label: 'Activo', class: 'bg-green-100 text-green-800' };
};
---

<AdminLayout title="Dashboard Administrador">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <!-- Header del dashboard -->
      <div class="mt-10 mb-8">
        <h1 class="text-3xl font-bold tracking-tight text-foreground">Dashboard Administrador</h1>
        <p class="mt-2 text-muted-foreground">
          Gestiona productos, pedidos y configuraciones de tu tienda
        </p>
        
        <!-- Indicador de datos -->
        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <h3 class="text-sm font-medium text-blue-800">📊 Estado de los datos:</h3>
          <div class="mt-2 text-sm text-blue-600">
            <p>• Total productos: {stats.totalProducts}</p>
            <p>• Total órdenes: {stats.totalOrders}</p>
            <p>• Usuarios activos: {stats.totalUsers}</p>
            <p>• Productos recientes cargados: {recentProducts.length}</p>
          </div>
        </div>
      </div>

      <!-- Estadísticas rápidas -->
      <div class="mb-8 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
        <div class="rounded-lg border border-border bg-background p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-8 w-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                <path d="M7 4V2C7 1.45 7.45 1 8 1H16C16.55 1 17 1.45 17 2V4H20C20.55 4 21 4.45 21 5V19C21 19.55 20.55 20 20 20H4C3.45 20 3 19.55 3 19V5C3 4.45 3.45 4 4 4H7ZM9 3V4H15V3H9ZM5 6V18H19V6H5Z"/>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-muted-foreground">Total Productos</p>
              <p class="text-2xl font-semibold text-foreground">{stats.totalProducts}</p>
            </div>
          </div>
        </div>

        <div class="rounded-lg border border-border bg-background p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-8 w-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-muted-foreground">Pedidos Pendientes</p>
              <p class="text-2xl font-semibold text-foreground">{stats.pendingOrders}</p>
            </div>
          </div>
        </div>

        <div class="rounded-lg border border-border bg-background p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-8 w-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-muted-foreground">Ventas del Mes</p>
              <p class="text-2xl font-semibold text-foreground">{formatCurrency(stats.monthlySales)}</p>
            </div>
          </div>
        </div>

        <div class="rounded-lg border border-border bg-background p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-8 w-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                <path d="M16,4C18.2,4 20,5.8 20,8C20,10.2 18.2,12 16,12C13.8,12 12,10.2 12,8C12,5.8 13.8,4 16,4M16,14C20.4,14 24,15.8 24,18V20H8V18C8,15.8 11.6,14 16,14M8,4C10.2,4 12,5.8 12,8C12,10.2 10.2,12 8,12C5.8,12 4,10.2 4,8C4,5.8 5.8,4 8,4M8,14C12.4,14 16,15.8 16,18V20H0V18C0,15.8 3.6,14 8,14Z"/>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-muted-foreground">Clientes Activos</p>
              <p class="text-2xl font-semibold text-foreground">{stats.totalUsers}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Acciones principales -->
      <div class="mb-8">
        <h2 class="text-xl font-semibold text-foreground mb-4">Acciones Rápidas</h2>
        <div class="flex flex-wrap gap-4">
          <a href="/admin/products/add">
            <Button className="bg-primary text-primary-foreground hover:bg-primary/90">
              <svg class="mr-2 h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
              </svg>
              Agregar Producto
            </Button>
          </a>
          <a href="/admin/orders">
            <Button variant="outline" className="border-border text-foreground hover:bg-muted">
              <svg class="mr-2 h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
              </svg>
              Ver Pedidos
            </Button>
          </a>
          <a href="/admin/blog">
            <Button variant="outline" className="border-border text-foreground hover:bg-muted">
              <svg class="mr-2 h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,5V19H5V5H19M17,17H7V15H17M17,13H7V11H17M17,9H7V7H17Z"/>
              </svg>
              Gestionar Blog
            </Button>
          </a>
        </div>
      </div>

      <!-- Tabla de productos recientes -->
      <div class="rounded-lg border border-border bg-background">
        <div class="px-6 py-4 border-b border-border">
          <h2 class="text-lg font-semibold text-foreground">Productos Recientes</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-muted">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Producto</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Precio</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Stock</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Estado</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border">
              {recentProducts.length > 0 ? (
                recentProducts.map((product) => {
                  const status = getProductStatus(product.stock);
                  return (
                    <tr>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                          <div class="h-10 w-10 flex-shrink-0">
                            {product.image_url ? (
                              <img class="h-10 w-10 rounded-md object-cover" src={product.image_url} alt={product.name}>
                            ) : (
                              <div class="h-10 w-10 rounded-md bg-muted flex items-center justify-center">
                                <svg class="h-6 w-6 text-muted-foreground" fill="currentColor" viewBox="0 0 24 24">
                                  <path d="M8.5,13.5L11,16.5L14.5,12L19,18H5M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19Z"/>
                                </svg>
                              </div>
                            )}
                          </div>
                          <div class="ml-4">
                            <div class="text-sm font-medium text-foreground">{product.name}</div>
                            <div class="text-sm text-muted-foreground">{product.category}</div>
                          </div>
                        </div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-foreground">{formatCurrency(product.price)}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-foreground">{product.stock}</td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${status.class}`}>
                          {status.label}
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                          <a href={`/admin/products/edit/${product.uuid}`}>
                            <Button variant="outline" size="sm" className="border-border text-foreground hover:bg-muted">
                              Editar
                            </Button>
                          </a>
                          <a href={`/product/${product.uuid}`}>
                            <Button variant="outline" size="sm" className="border-border text-foreground hover:bg-muted">
                              Ver
                            </Button>
                          </a>
                        </div>
                      </td>
                    </tr>
                  );
                })
              ) : (
                <tr>
                  <td colspan="5" class="px-6 py-8 text-center text-muted-foreground">
                    No hay productos registrados aún
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
        <div class="px-6 py-4 border-t border-border">
          <a href="/admin/products">
            <Button variant="outline" className="border-border text-foreground hover:bg-muted">
              Ver todos los productos
            </Button>
          </a>
        </div>
      </div>

      <!-- Sección de Analytics -->
      <div class="mt-8">
        <h2 class="text-2xl font-bold text-foreground mb-6">📊 Analytics</h2>

        <!-- Estadísticas de Ventas -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-foreground mb-4">Ventas por Período</h3>
          <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
            <div class="rounded-lg border border-border bg-background p-6">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-muted-foreground">Ventas de Hoy</p>
                  <p class="text-2xl font-bold text-foreground mt-1">{formatCurrency(salesStats.today)}</p>
                </div>
                <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
            </div>
            <div class="rounded-lg border border-border bg-background p-6">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-muted-foreground">Ventas de Esta Semana</p>
                  <p class="text-2xl font-bold text-foreground mt-1">{formatCurrency(salesStats.week)}</p>
                </div>
                <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
              </div>
            </div>
            <div class="rounded-lg border border-border bg-background p-6">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-muted-foreground">Ventas del Mes</p>
                  <p class="text-2xl font-bold text-foreground mt-1">{formatCurrency(salesStats.month)}</p>
                  {salesStats.trend === 'up' && (
                    <span class="inline-flex items-center text-xs text-green-600 mt-1">
                      <svg class="h-3 w-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                      </svg>
                      Subiendo
                    </span>
                  )}
                  {salesStats.trend === 'down' && (
                    <span class="inline-flex items-center text-xs text-red-600 mt-1">
                      <svg class="h-3 w-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                      </svg>
                      Bajando
                    </span>
                  )}
                </div>
                <svg class="h-8 w-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Productos Más Vendidos -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-foreground mb-4">Productos Más Vendidos</h3>
          <div class="rounded-lg border border-border bg-background overflow-hidden">
            {topProducts.length > 0 ? (
              <table class="w-full">
                <thead class="bg-muted">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">#</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Producto</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Cantidad Vendida</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Ingresos</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  {topProducts.map((product, index) => (
                    <tr>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                          <span class="font-bold text-lg text-primary">{index + 1}</span>
                        </div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-foreground">{product.product_name}</div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-foreground">{product.total_sold} unidades</div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-semibold text-foreground">{formatCurrency(product.total_revenue)}</div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            ) : (
              <div class="p-8 text-center text-muted-foreground">
                No hay datos de productos vendidos aún
              </div>
            )}
          </div>
        </div>

        <!-- Estadísticas de Usuarios -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-foreground mb-4">Usuarios</h3>
          <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
            <div class="rounded-lg border border-border bg-background p-6">
              <p class="text-sm text-muted-foreground">Total Usuarios</p>
              <p class="text-3xl font-bold text-foreground mt-2">{userStats.total}</p>
            </div>
            <div class="rounded-lg border border-border bg-background p-6">
              <p class="text-sm text-muted-foreground">Usuarios Activos</p>
              <p class="text-3xl font-bold text-foreground mt-2">{userStats.active}</p>
            </div>
            <div class="rounded-lg border border-border bg-background p-6">
              <p class="text-sm text-muted-foreground">Nuevos Este Mes</p>
              <p class="text-3xl font-bold text-foreground mt-2">{userStats.newThisMonth}</p>
            </div>
          </div>
        </div>

        <!-- Embudo de Conversión -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-foreground mb-4">Embudo de Conversión (Últimos 30 días)</h3>
          <div class="rounded-lg border border-border bg-background p-6">
            <div class="space-y-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                    <span class="text-blue-600 font-bold">{conversionFunnel.visitors}</span>
                  </div>
                  <div>
                    <p class="font-medium text-foreground">Visitantes</p>
                    <p class="text-sm text-muted-foreground">Personas que visitaron el sitio</p>
                  </div>
                </div>
                <span class="text-sm text-muted-foreground">100%</span>
              </div>
              <div class="flex justify-center">
                <svg class="h-6 w-6 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                </svg>
              </div>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                    <span class="text-green-600 font-bold">{conversionFunnel.cartAdds}</span>
                  </div>
                  <div>
                    <p class="font-medium text-foreground">Agregados al Carrito</p>
                    <p class="text-sm text-muted-foreground">Productos agregados al carrito</p>
                  </div>
                </div>
                <span class="text-sm text-muted-foreground">
                  {conversionFunnel.visitors > 0 ? Math.round((conversionFunnel.cartAdds / conversionFunnel.visitors) * 100) : 0}%
                </span>
              </div>
              <div class="flex justify-center">
                <svg class="h-6 w-6 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                </svg>
              </div>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center">
                    <span class="text-yellow-600 font-bold">{conversionFunnel.checkouts}</span>
                  </div>
                  <div>
                    <p class="font-medium text-foreground">Iniciaron Checkout</p>
                    <p class="text-sm text-muted-foreground">Llegaron al checkout</p>
                  </div>
                </div>
                <span class="text-sm text-muted-foreground">
                  {conversionFunnel.visitors > 0 ? Math.round((conversionFunnel.checkouts / conversionFunnel.visitors) * 100) : 0}%
                </span>
              </div>
              <div class="flex justify-center">
                <svg class="h-6 w-6 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                </svg>
              </div>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center">
                    <span class="text-purple-600 font-bold">{conversionFunnel.completed}</span>
                  </div>
                  <div>
                    <p class="font-medium text-foreground">Compras Completadas</p>
                    <p class="text-sm text-muted-foreground">Pedidos finalizados</p>
                  </div>
                </div>
                <span class="text-sm font-semibold text-primary">
                  {conversionFunnel.visitors > 0 ? Math.round((conversionFunnel.completed / conversionFunnel.visitors) * 100) : 0}%
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>
