---
import AdminLayout from "@/layouts/adminLayout.astro";
import { Button } from "@/components/ui/button";
import { getDashboardStats, getRecentProducts } from "@/lib/database";

// Obtener datos del dashboard con manejo de errores
let stats = {
  totalProducts: 0,
  totalOrders: 0,
  pendingOrders: 0,
  totalBlogPosts: 0,
  totalUsers: 0,
  monthlySales: 0
};

let recentProducts: any[] = [];

try {
  console.log('ðŸ” Obteniendo estadÃ­sticas del dashboard...');
  stats = await getDashboardStats();
  console.log('ðŸ“Š EstadÃ­sticas obtenidas:', stats);
} catch (error) {
  console.error('âŒ Error obteniendo estadÃ­sticas:', error);
}

try {
  console.log('ðŸ” Obteniendo productos recientes...');
  recentProducts = await getRecentProducts(3);
  console.log('ðŸ“¦ Productos recientes obtenidos:', recentProducts);
} catch (error) {
  console.error('âŒ Error obteniendo productos recientes:', error);
}

// FunciÃ³n para formatear moneda
const formatCurrency = (amount: number): string => {
  return new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN'
  }).format(amount);
};

// FunciÃ³n para obtener estado del producto basado en stock
const getProductStatus = (stock: number) => {
  if (stock === 0) return { label: 'Sin Stock', class: 'bg-red-100 text-red-800' };
  if (stock < 10) return { label: 'Bajo Stock', class: 'bg-yellow-100 text-yellow-800' };
  return { label: 'Activo', class: 'bg-green-100 text-green-800' };
};
---

<AdminLayout title="Dashboard Administrador">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <!-- Header del dashboard -->
      <div class="mt-10 mb-8">
        <h1 class="text-3xl font-bold tracking-tight text-foreground">Dashboard Administrador</h1>
        <p class="mt-2 text-muted-foreground">
          Gestiona productos, pedidos y configuraciones de tu tienda
        </p>
        
        <!-- Indicador de datos -->
        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <h3 class="text-sm font-medium text-blue-800">ðŸ“Š Estado de los datos:</h3>
          <div class="mt-2 text-sm text-blue-600">
            <p>â€¢ Total productos: {stats.totalProducts}</p>
            <p>â€¢ Total Ã³rdenes: {stats.totalOrders}</p>
            <p>â€¢ Usuarios activos: {stats.totalUsers}</p>
            <p>â€¢ Productos recientes cargados: {recentProducts.length}</p>
          </div>
        </div>
      </div>

      <!-- EstadÃ­sticas rÃ¡pidas -->
      <div class="mb-8 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
        <div class="rounded-lg border border-border bg-background p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-8 w-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                <path d="M7 4V2C7 1.45 7.45 1 8 1H16C16.55 1 17 1.45 17 2V4H20C20.55 4 21 4.45 21 5V19C21 19.55 20.55 20 20 20H4C3.45 20 3 19.55 3 19V5C3 4.45 3.45 4 4 4H7ZM9 3V4H15V3H9ZM5 6V18H19V6H5Z"/>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-muted-foreground">Total Productos</p>
              <p class="text-2xl font-semibold text-foreground">{stats.totalProducts}</p>
            </div>
          </div>
        </div>

        <div class="rounded-lg border border-border bg-background p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-8 w-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-muted-foreground">Pedidos Pendientes</p>
              <p class="text-2xl font-semibold text-foreground">{stats.pendingOrders}</p>
            </div>
          </div>
        </div>

        <div class="rounded-lg border border-border bg-background p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-8 w-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-muted-foreground">Ventas del Mes</p>
              <p class="text-2xl font-semibold text-foreground">{formatCurrency(stats.monthlySales)}</p>
            </div>
          </div>
        </div>

        <div class="rounded-lg border border-border bg-background p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-8 w-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                <path d="M16,4C18.2,4 20,5.8 20,8C20,10.2 18.2,12 16,12C13.8,12 12,10.2 12,8C12,5.8 13.8,4 16,4M16,14C20.4,14 24,15.8 24,18V20H8V18C8,15.8 11.6,14 16,14M8,4C10.2,4 12,5.8 12,8C12,10.2 10.2,12 8,12C5.8,12 4,10.2 4,8C4,5.8 5.8,4 8,4M8,14C12.4,14 16,15.8 16,18V20H0V18C0,15.8 3.6,14 8,14Z"/>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-muted-foreground">Clientes Activos</p>
              <p class="text-2xl font-semibold text-foreground">{stats.totalUsers}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Acciones principales -->
      <div class="mb-8">
        <h2 class="text-xl font-semibold text-foreground mb-4">Acciones RÃ¡pidas</h2>
        <div class="flex flex-wrap gap-4">
          <a href="/admin/products/add">
            <Button className="bg-primary text-primary-foreground hover:bg-primary/90">
              <svg class="mr-2 h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
              </svg>
              Agregar Producto
            </Button>
          </a>
          <a href="/admin/orders">
            <Button variant="outline" className="border-border text-foreground hover:bg-muted">
              <svg class="mr-2 h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
              </svg>
              Ver Pedidos
            </Button>
          </a>
          <a href="/admin/blog">
            <Button variant="outline" className="border-border text-foreground hover:bg-muted">
              <svg class="mr-2 h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,5V19H5V5H19M17,17H7V15H17M17,13H7V11H17M17,9H7V7H17Z"/>
              </svg>
              Gestionar Blog
            </Button>
          </a>
        </div>
      </div>

      <!-- Tabla de productos recientes -->
      <div class="rounded-lg border border-border bg-background">
        <div class="px-6 py-4 border-b border-border">
          <h2 class="text-lg font-semibold text-foreground">Productos Recientes</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-muted">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Producto</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Precio</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Stock</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Estado</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border">
              {recentProducts.length > 0 ? (
                recentProducts.map((product) => {
                  const status = getProductStatus(product.stock);
                  return (
                    <tr>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                          <div class="h-10 w-10 flex-shrink-0">
                            {product.image_url ? (
                              <img class="h-10 w-10 rounded-md object-cover" src={product.image_url} alt={product.name}>
                            ) : (
                              <div class="h-10 w-10 rounded-md bg-muted flex items-center justify-center">
                                <svg class="h-6 w-6 text-muted-foreground" fill="currentColor" viewBox="0 0 24 24">
                                  <path d="M8.5,13.5L11,16.5L14.5,12L19,18H5M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19Z"/>
                                </svg>
                              </div>
                            )}
                          </div>
                          <div class="ml-4">
                            <div class="text-sm font-medium text-foreground">{product.name}</div>
                            <div class="text-sm text-muted-foreground">{product.category}</div>
                          </div>
                        </div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-foreground">{formatCurrency(product.price)}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-foreground">{product.stock}</td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${status.class}`}>
                          {status.label}
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                          <a href={`/admin/products/edit/${product.uuid}`}>
                            <Button variant="outline" size="sm" className="border-border text-foreground hover:bg-muted">
                              Editar
                            </Button>
                          </a>
                          <a href={`/product/${product.uuid}`}>
                            <Button variant="outline" size="sm" className="border-border text-foreground hover:bg-muted">
                              Ver
                            </Button>
                          </a>
                        </div>
                      </td>
                    </tr>
                  );
                })
              ) : (
                <tr>
                  <td colspan="5" class="px-6 py-8 text-center text-muted-foreground">
                    No hay productos registrados aÃºn
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
        <div class="px-6 py-4 border-t border-border">
          <a href="/admin/products">
            <Button variant="outline" className="border-border text-foreground hover:bg-muted">
              Ver todos los productos
            </Button>
          </a>
        </div>
      </div>
  </div>
</AdminLayout>
