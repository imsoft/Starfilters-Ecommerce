---
import AdminLayout from "@/layouts/adminLayout.astro";
import { getAuthenticatedUser } from '@/lib/auth-utils';
import { isUserAdmin } from '@/lib/database';
import { getHeroImage, updateHeroImage } from '@/lib/site-settings-service';
import { uploadImage, deleteImage, getPublicIdFromUrl } from '@/lib/cloudinary';

export const prerender = false;

const user = getAuthenticatedUser(Astro.cookies);

if (!user) {
  return Astro.redirect('/login');
}

const userIsAdmin = await isUserAdmin(user.id);

if (!userIsAdmin) {
  return Astro.redirect('/');
}

let heroImage = await getHeroImage();
let error: string | null = null;
let success: string | null = null;

// Procesar formulario
if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get("action") as string;

    if (action === "update_hero_image") {
      const imageFile = formData.get("hero_image") as File;

      if (imageFile && imageFile.size > 0) {
        // Eliminar imagen anterior de Cloudinary si existe y no es la default
        if (heroImage && !heroImage.includes('hero-default')) {
          const publicId = getPublicIdFromUrl(heroImage);
          if (publicId) {
            await deleteImage(publicId);
          }
        }

        // Subir nueva imagen a Cloudinary
        const buffer = await imageFile.arrayBuffer();
        const imageUrl = await uploadImage(
          Buffer.from(buffer),
          'starfilters-ecommerce/hero',
          `hero-${Date.now()}`
        );

        // Actualizar en base de datos
        const updated = await updateHeroImage(imageUrl);

        if (updated) {
          heroImage = imageUrl;
          success = "Imagen del Hero actualizada exitosamente";
        } else {
          error = "Error al actualizar la imagen en la base de datos";
        }
      } else {
        error = "Por favor selecciona una imagen";
      }
    } else if (action === "update_hero_url") {
      const imageUrl = formData.get("hero_image_url") as string;

      if (imageUrl) {
        const updated = await updateHeroImage(imageUrl);

        if (updated) {
          heroImage = imageUrl;
          success = "URL de imagen del Hero actualizada exitosamente";
        } else {
          error = "Error al actualizar la URL en la base de datos";
        }
      } else {
        error = "Por favor ingresa una URL";
      }
    }
  } catch (err) {
    console.error("Error procesando formulario:", err);
    error = err instanceof Error ? err.message : "Error desconocido";
  }
}
---

<AdminLayout title="Configuraci贸n del Hero">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Configuraci贸n del Hero</h1>
      <p class="mt-2 text-gray-600">Personaliza la imagen principal de la secci贸n Hero de tu sitio web</p>
    </div>

    <!-- Mensajes -->
    {error && (
      <div class="mb-6 rounded-lg border border-red-300 bg-red-50 p-4">
        <div class="flex">
          <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
          <div class="ml-3">
            <p class="text-sm font-medium text-red-800">{error}</p>
          </div>
        </div>
      </div>
    )}

    {success && (
      <div class="mb-6 rounded-lg border border-green-300 bg-green-50 p-4">
        <div class="flex">
          <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          <div class="ml-3">
            <p class="text-sm font-medium text-green-800">{success}</p>
          </div>
        </div>
      </div>
    )}

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Preview de la imagen actual -->
      <div class="rounded-lg border border-gray-200 bg-white p-6">
        <h2 class="mb-4 text-xl font-bold text-gray-900">Vista Previa Actual</h2>
        <div class="aspect-video w-full overflow-hidden rounded-lg bg-gray-100">
          <img
            src={heroImage}
            alt="Hero Image"
            class="h-full w-full object-cover"
            onerror="this.src='/images/placeholder.svg'"
          />
        </div>
        <p class="mt-2 text-sm text-gray-500 break-all">
          {heroImage}
        </p>
      </div>

      <!-- Formularios para actualizar -->
      <div class="space-y-6">
        <!-- Opci贸n 1: Subir imagen -->
        <div class="rounded-lg border border-gray-200 bg-white p-6">
          <h2 class="mb-4 text-xl font-bold text-gray-900">Subir Nueva Imagen</h2>
          <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="action" value="update_hero_image" />

            <div>
              <label for="hero_image" class="block text-sm font-medium text-gray-700 mb-2">
                Selecciona una imagen
              </label>
              <input
                type="file"
                id="hero_image"
                name="hero_image"
                accept="image/*"
                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
              />
              <p class="mt-2 text-sm text-gray-500">
                Recomendado: 1920x1080px o mayor. Formatos: JPG, PNG, WebP
              </p>
            </div>

            <button
              type="submit"
              class="mt-4 w-full rounded-lg bg-blue-600 px-6 py-3 font-medium text-white transition-colors hover:bg-blue-700"
            >
              Subir y Actualizar
            </button>
          </form>
        </div>

        <!-- Opci贸n 2: URL directa -->
        <div class="rounded-lg border border-gray-200 bg-white p-6">
          <h2 class="mb-4 text-xl font-bold text-gray-900">O usar una URL</h2>
          <form method="POST">
            <input type="hidden" name="action" value="update_hero_url" />

            <div>
              <label for="hero_image_url" class="block text-sm font-medium text-gray-700 mb-2">
                URL de la imagen
              </label>
              <input
                type="url"
                id="hero_image_url"
                name="hero_image_url"
                placeholder="https://ejemplo.com/imagen-hero.jpg"
                class="block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              />
              <p class="mt-2 text-sm text-gray-500">
                Ingresa la URL completa de una imagen existente
              </p>
            </div>

            <button
              type="submit"
              class="mt-4 w-full rounded-lg bg-gray-600 px-6 py-3 font-medium text-white transition-colors hover:bg-gray-700"
            >
              Actualizar con URL
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Consejos -->
    <div class="mt-8 rounded-lg border border-blue-200 bg-blue-50 p-6">
      <h3 class="mb-2 font-semibold text-blue-900"> Consejos para la imagen del Hero:</h3>
      <ul class="list-disc list-inside space-y-1 text-sm text-blue-800">
        <li>Usa im谩genes de alta calidad con buena resoluci贸n</li>
        <li>Recomendado: 1920x1080px (Full HD) o mayor</li>
        <li>Aseg煤rate de que la imagen tenga buen contraste para que el texto sea legible</li>
        <li>Evita im谩genes con demasiados detalles que puedan distraer del contenido</li>
        <li>Tama帽o de archivo recomendado: menos de 500KB para mejor rendimiento</li>
      </ul>
    </div>
  </div>
</AdminLayout>
