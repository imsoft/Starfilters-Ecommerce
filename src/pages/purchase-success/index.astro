---
import WebsiteLayout from "@/layouts/websiteLayout.astro";
import SEO from "@/components/shared/SEO.astro";
import { getAuthenticatedUser } from "@/lib/auth-utils";

// Obtener usuario para mostrar información personalizada
const user = getAuthenticatedUser(Astro.cookies);

// Obtener información del pago desde la URL si está disponible
const url = new URL(Astro.request.url);
const paymentIntentId = url.searchParams.get('payment_intent');
const paymentIntentClientSecret = url.searchParams.get('payment_intent_client_secret');
---

<WebsiteLayout 
  title="Compra Exitosa"
  seoTitle="Compra Exitosa - Star Filters"
  description="Tu compra se ha procesado exitosamente"
>
  <SEO 
    slot="seo"
    title="Compra Exitosa - Star Filters"
    description="Tu compra se ha procesado exitosamente"
  />

  <div class="mx-auto max-w-2xl px-4 sm:px-6 lg:px-8 py-16">
    <div class="text-center">
      <!-- Icono de éxito -->
      <div id="success-icon" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-6">
        <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>

      <h1 id="success-title" class="text-3xl font-bold tracking-tight text-foreground sm:text-4xl mb-4">
        ¡Compra Exitosa!
      </h1>

      <p id="success-description" class="text-lg text-muted-foreground mb-8">
        Tu pedido ha sido procesado correctamente. Recibirás un correo de confirmación con los detalles de tu compra.
      </p>

      {paymentIntentId && (
        <div class="mb-8 p-4 bg-muted rounded-lg">
          <p class="text-sm text-muted-foreground mb-2">ID de pago:</p>
          <p class="text-sm font-mono text-foreground break-all">{paymentIntentId}</p>
        </div>
      )}

      <div class="space-y-4">
        <a
          href="/pedidos"
          class="inline-flex items-center justify-center rounded-md bg-primary px-6 py-3 text-sm font-medium text-primary-foreground hover:bg-primary/90 transition-colors"
        >
          Ver mis pedidos
        </a>
        
        <div>
          <a
            href="/"
            class="text-sm text-primary hover:text-primary/80 transition-colors"
          >
            Volver al inicio
          </a>
        </div>
      </div>

      <div id="next-steps" class="mt-12 pt-8 border-t border-border">
        <h2 class="text-lg font-semibold text-foreground mb-4">¿Qué sigue?</h2>
        <ul class="text-left space-y-2 text-sm text-muted-foreground max-w-md mx-auto">
          <li class="flex items-start">
            <svg class="h-5 w-5 text-green-600 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>Recibirás un correo de confirmación con los detalles de tu pedido</span>
          </li>
          <li class="flex items-start">
            <svg class="h-5 w-5 text-green-600 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>Procesaremos tu pedido y te notificaremos cuando sea enviado</span>
          </li>
          <li class="flex items-start">
            <svg class="h-5 w-5 text-green-600 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>Puedes rastrear tu pedido desde la sección "Mis Pedidos"</span>
          </li>
        </ul>
      </div>
    </div>
  </div>
</WebsiteLayout>

<script>
  import { loadStripe } from '@stripe/stripe-js';

  // Limpiar el carrito en el cliente
  if (typeof window !== 'undefined') {
    try {
      const { clearCart } = await import('@/lib/cart');
      clearCart();
      console.log('✅ Carrito limpiado después de compra exitosa');
    } catch (error) {
      console.error('Error limpiando carrito:', error);
    }

    // Verificar estado del pago para transferencias bancarias
    const urlParams = new URLSearchParams(window.location.search);
    const clientSecret = urlParams.get('payment_intent_client_secret');

    if (clientSecret) {
      try {
        const stripe = await loadStripe(import.meta.env.PUBLIC_STRIPE_PUBLISHABLE_KEY!);
        if (stripe) {
          const { paymentIntent } = await stripe.retrievePaymentIntent(clientSecret);

          if (paymentIntent?.status === 'processing' || paymentIntent?.status === 'requires_action') {
            // Mostrar mensaje de pago pendiente (transferencia bancaria)
            const titleEl = document.getElementById('success-title');
            const descEl = document.getElementById('success-description');
            const iconContainer = document.getElementById('success-icon');
            const nextSteps = document.getElementById('next-steps');

            if (titleEl) {
              titleEl.textContent = 'Transferencia bancaria pendiente';
            }
            if (descEl) {
              descEl.textContent = 'Hemos recibido tu pedido. Realiza la transferencia bancaria con los datos que te fueron proporcionados. Una vez que recibamos el pago, procesaremos tu pedido y te enviaremos un correo de confirmación.';
            }
            if (iconContainer) {
              iconContainer.classList.remove('bg-green-100');
              iconContainer.classList.add('bg-yellow-100');
              iconContainer.innerHTML = '<svg class="h-8 w-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            }
            if (nextSteps) {
              nextSteps.innerHTML = `
                <h2 class="text-lg font-semibold text-foreground mb-4">Instrucciones</h2>
                <ul class="text-left space-y-2 text-sm text-muted-foreground max-w-md mx-auto">
                  <li class="flex items-start">
                    <svg class="h-5 w-5 text-yellow-600 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>Realiza la transferencia bancaria con los datos proporcionados por Stripe</span>
                  </li>
                  <li class="flex items-start">
                    <svg class="h-5 w-5 text-yellow-600 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>Una vez confirmado el pago, recibirás un correo de confirmación</span>
                  </li>
                  <li class="flex items-start">
                    <svg class="h-5 w-5 text-yellow-600 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>Puedes revisar el estado de tu pedido en la sección "Mis Pedidos"</span>
                  </li>
                </ul>
              `;
            }
          }
        }
      } catch (error) {
        console.error('Error verificando estado del pago:', error);
      }
    }
  }
</script>
