---
import WebsiteLayout from "@/layouts/websiteLayout.astro";
import SEO from "@/components/shared/SEO.astro";
import LazyImage from "@/components/shared/LazyImage.astro";
import { getActiveProducts } from "@/lib/product-service";
import { getProductPlaceholderImage } from "@/lib/image-utils";
import { generateBreadcrumbSchema } from "@/lib/seo-utils";

export const prerender = false;

// Obtener productos activos y agruparlos por categor√≠a
let categoriesData: Array<{
  category: string;
  products: Array<{
    id: number;
    uuid: string;
    name: string;
    description: string;
    price: number;
    stock: number;
    imageUrl: string;
  }>;
  totalProducts: number;
  minPrice: number;
  maxPrice: number;
  totalStock: number;
}> = [];

try {
  const allProducts = await getActiveProducts();
  console.log(`üì¶ P√°gina /filtros: ${allProducts.length} productos activos encontrados`);

  // Agrupar productos por categor√≠a
  const productsByCategory = new Map<string, typeof allProducts>();
  
  allProducts.forEach(product => {
    const category = product.category || 'Sin categor√≠a';
    if (!productsByCategory.has(category)) {
      productsByCategory.set(category, []);
    }
    productsByCategory.get(category)!.push(product);
  });

  // Preparar datos de categor√≠as
  categoriesData = Array.from(productsByCategory.entries()).map(([category, products]) => {
    const prices = products.map(p => p.price || 0).filter(p => p > 0);
    const minPrice = prices.length > 0 ? Math.min(...prices) : 0;
    const maxPrice = prices.length > 0 ? Math.max(...prices) : 0;
    const totalStock = products.reduce((sum, p) => sum + (p.stock || 0), 0);

    return {
      category,
      products: products.map(product => ({
        id: product.id,
        uuid: product.uuid,
        name: product.name,
        description: product.description || '',
        price: product.price || 0,
        stock: product.stock || 0,
        imageUrl: getProductPlaceholderImage(product.category)
      })),
      totalProducts: products.length,
      minPrice,
      maxPrice,
      totalStock
    };
  });

  console.log(`‚úÖ P√°gina /filtros: ${categoriesData.length} categor√≠as de productos listas para mostrar`);
} catch (error) {
  console.error('‚ùå Error en p√°gina /filtros:', error);
  console.error('‚ùå Stack trace:', error instanceof Error ? error.stack : 'No stack available');
}

// Funci√≥n para formatear precio
const formatPrice = (price: number): string => {
  return new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN'
  }).format(price);
};

// Obtener todas las categor√≠as √∫nicas
const categories = categoriesData.map(c => c.category);

// Generar datos SEO
const siteUrl = Astro.site?.href || Astro.url.origin;
const breadcrumbSchema = generateBreadcrumbSchema([
  { name: 'Inicio', url: siteUrl },
  { name: 'Filtros de Aire', url: `${siteUrl}/filtros` }
]);
---

<WebsiteLayout 
  title="Filtros de Aire"
  seoTitle="Filtros de Aire - Cat√°logo StarFilters"
  description="Explora nuestro cat√°logo completo de filtros de aire organizados por categor√≠as. Productos de alta calidad con env√≠o a toda la Rep√∫blica Mexicana."
  keywords={[
    'filtros de aire',
    'comprar filtros de aire',
    'filtros industriales',
    'tienda filtros M√©xico'
  ]}
>
  <SEO 
    slot="seo"
    title="Filtros de Aire"
    description="Explora nuestro cat√°logo completo de filtros de aire organizados por categor√≠as. Productos de alta calidad con env√≠o a toda la Rep√∫blica Mexicana."
    ogType="website"
    keywords={[
      'filtros de aire',
      'comprar filtros de aire',
      'filtros industriales'
    ]}
  />
  
  <!-- Breadcrumb Schema -->
  <script slot="seo" type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  <div class="bg-background py-24">
    <!-- Breadcrumb -->
    <div class="mx-auto max-w-xl px-4 sm:px-6 lg:max-w-7xl lg:px-8">
      <nav class="mb-8" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2 text-sm text-muted-foreground">
          <li>
            <a href="/" class="hover:text-foreground transition-colors">Inicio</a>
          </li>
          <li>
            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
          </li>
          <li class="text-foreground font-medium">Filtros de Aire</li>
        </ol>
      </nav>
    </div>

    <section
      aria-labelledby="collection-heading"
      class="mx-auto max-w-xl px-4 sm:px-6 lg:max-w-7xl lg:px-8"
    >
      <div class="mb-12">
        <h1
          id="collection-heading"
          class="text-3xl font-bold tracking-tight text-foreground sm:text-4xl"
        >
          Filtros de Aire StarFilters
        </h1>
        <p class="mt-4 text-lg text-muted-foreground">
          Explora nuestras categor√≠as de filtros de aire. Calidad garantizada y env√≠o r√°pido.
        </p>
      </div>

      <!-- Filtros -->
      <div class="mb-8 space-y-6">
        <!-- B√∫squeda -->
        <div>
          <label for="search-categories" class="block text-sm font-medium text-foreground mb-2">
            Buscar categor√≠as
          </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="h-5 w-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
            <input
              type="text"
              id="search-categories"
              placeholder="Buscar por nombre de categor√≠a..."
              class="w-full rounded-md border border-border bg-background pl-10 pr-3 py-2 text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
            />
          </div>
        </div>

        <!-- Contador de resultados -->
        <div class="text-sm text-muted-foreground">
          Mostrando <span id="results-count" class="font-medium text-foreground">{categoriesData.length}</span> categor√≠as
        </div>
      </div>

      <!-- Grid de categor√≠as -->
      <div class="grid grid-cols-1 gap-x-6 gap-y-10 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 xl:gap-x-8" id="categories-grid">
        {categoriesData.map((categoryData) => (
          <div 
            class="group category-card relative flex flex-col border border-border rounded-lg p-6 hover:shadow-lg transition-shadow" 
            data-category={categoryData.category}
          >
            <div class="flex-shrink-0">
              <h3 class="text-xl font-bold text-foreground mb-2">
                {categoryData.category}
              </h3>
              <p class="text-sm text-muted-foreground mb-4">
                {categoryData.totalProducts} {categoryData.totalProducts === 1 ? 'producto' : 'productos'} disponible{categoryData.totalProducts === 1 ? '' : 's'}
              </p>
            </div>
            
            <div class="mt-auto space-y-3">
              <div class="flex items-center justify-between">
                <p class="text-lg font-medium text-foreground">
                  {categoryData.minPrice === categoryData.maxPrice 
                    ? formatPrice(categoryData.minPrice)
                    : `${formatPrice(categoryData.minPrice)} - ${formatPrice(categoryData.maxPrice)}`
                  }
                </p>
                {categoryData.totalStock > 0 ? (
                  <span class="text-xs text-green-600 font-medium">
                    En stock
                  </span>
                ) : (
                  <span class="text-xs text-red-600 font-medium">
                    Agotado
                  </span>
                )}
              </div>
              
              <a
                href={`/productos?category=${encodeURIComponent(categoryData.category)}`}
                class="block w-full text-center rounded-md bg-primary px-3 py-2 text-sm font-semibold text-primary-foreground hover:bg-primary/90 transition-colors"
              >
                Ver Productos
              </a>
            </div>
          </div>
        ))}
      </div>

      {categoriesData.length === 0 && (
        <div class="text-center py-12">
          <h3 class="text-lg font-medium text-foreground">
            No hay categor√≠as disponibles
          </h3>
          <p class="mt-2 text-sm text-muted-foreground">
            Vuelve pronto para ver nuevas categor√≠as de productos
          </p>
        </div>
      )}
    </section>
  </div>
</WebsiteLayout>

<script>
  // Datos de categor√≠as del servidor
  const allCategories = document.querySelectorAll('.category-card');
  let currentSearchTerm = '';

  // Funci√≥n principal de filtrado
  function applyFilters(): void {
    const categoryCards = Array.from(allCategories);
    let visibleCount = 0;

    categoryCards.forEach(card => {
      const element = card as HTMLElement;
      const categoryName = element.querySelector('h3')?.textContent?.toLowerCase() || '';

      // Aplicar filtros
      const matchesSearch = currentSearchTerm === '' || categoryName.includes(currentSearchTerm.toLowerCase());

      if (matchesSearch) {
        element.style.display = '';
        visibleCount++;
      } else {
        element.style.display = 'none';
      }
    });

    // Actualizar contador
    const resultsCount = document.getElementById('results-count');
    if (resultsCount) {
      resultsCount.textContent = visibleCount.toString();
    }
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', () => {
    // B√∫squeda
    const searchInput = document.getElementById('search-categories');
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        currentSearchTerm = (e.target as HTMLInputElement).value;
        applyFilters();
      });
    }

    console.log('üéØ Filtros de categor√≠as inicializados');
  });
</script>
