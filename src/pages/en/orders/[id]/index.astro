---
import WebsiteLayout from "@/layouts/websiteLayout.astro";
import CustomModal from "@/components/shared/CustomModal.astro";
import { getAuthenticatedUser } from "@/lib/auth-utils";
import { getUserOrderWithItems } from "@/lib/database";

// Verify authentication
const user = getAuthenticatedUser(Astro.cookies);
if (!user) {
  return Astro.redirect('/en/login?redirect=' + encodeURIComponent(Astro.url.pathname));
}

// Get order ID from URL
const { id } = Astro.params;
const orderId = parseInt(id as string);

if (!orderId || isNaN(orderId)) {
  return Astro.redirect('/en/orders');
}

// Get order with items
const orderWithItems = await getUserOrderWithItems(user.id, orderId);

if (!orderWithItems) {
  return Astro.redirect('/en/orders');
}

const { items, ...order } = orderWithItems;

// Utility functions
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  }).format(new Date(date));
};

const formatCurrency = (amount: number) => {
  return new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN'
  }).format(amount);
};

const getStatusColor = (status: string) => {
  switch (status) {
    case 'pending':
      return 'bg-yellow-100 text-yellow-800';
    case 'processing':
      return 'bg-blue-100 text-blue-800';
    case 'shipped':
      return 'bg-purple-100 text-purple-800';
    case 'delivered':
      return 'bg-green-100 text-green-800';
    case 'cancelled':
      return 'bg-red-100 text-red-800';
    default:
      return 'bg-gray-100 text-gray-800';
  }
};

const getStatusText = (status: string) => {
  switch (status) {
    case 'pending':
      return 'Pending';
    case 'processing':
      return 'Processing';
    case 'shipped':
      return 'Shipped';
    case 'delivered':
      return 'Delivered';
    case 'cancelled':
      return 'Cancelled';
    default:
      return status;
  }
};

// Calculate subtotal
const subtotal = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
const shipping = 0; // No shipping cost for now
const tax = subtotal * 0.16; // VAT 16%
const total = subtotal + shipping + tax;
---

<WebsiteLayout title={`Order #${order.order_number}`}>
  <div class="min-h-screen bg-background">
    <div class="mx-auto max-w-4xl px-6 lg:px-8">
      <!-- Breadcrumb -->
      <nav class="mb-8" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2 text-sm text-muted-foreground">
          <li>
            <a href="/en" class="hover:text-foreground transition-colors">Home</a>
          </li>
          <li>
            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
          </li>
          <li>
            <a href="/en/orders" class="hover:text-foreground transition-colors">My Orders</a>
          </li>
          <li>
            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
          </li>
          <li class="text-foreground font-medium">Order #{order.order_number}</li>
        </ol>
      </nav>

      <!-- Header -->
      <div class="mb-12">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <div>
            <h1 class="text-3xl font-bold text-foreground">
              Order #{order.order_number}
            </h1>
            <p class="mt-2 text-muted-foreground">
              Placed on {formatDate(order.created_at)}
            </p>
          </div>
          <span class={`inline-flex items-center rounded-full px-4 py-2 text-sm font-medium ${getStatusColor(order.status)}`}>
            {getStatusText(order.status)}
          </span>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
        <!-- Main content -->
        <div class="lg:col-span-2 space-y-8">
          <!-- Order items -->
          <div class="bg-card rounded-lg border border-border p-8">
            <h2 class="text-lg font-semibold text-foreground mb-6">
              Ordered Products
            </h2>
            <div class="space-y-6">
              {items.map((item) => (
                <div class="flex items-center gap-4 p-4 rounded-lg bg-muted/30">
                  <div class="flex-shrink-0">
                    {item.image_url ? (
                      <img
                        src={item.image_url}
                        alt={item.product_name}
                        class="w-16 h-16 object-cover rounded-md"
                      />
                    ) : (
                      <div class="w-16 h-16 bg-muted rounded-md flex items-center justify-center">
                        <svg
                          class="w-8 h-8 text-muted-foreground"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                          ></path>
                        </svg>
                      </div>
                    )}
                  </div>
                  <div class="flex-grow">
                    <h3 class="font-medium text-foreground">
                      {item.product_name}
                    </h3>
                    <p class="text-sm text-muted-foreground">
                      Quantity: {item.quantity}
                    </p>
                  </div>
                  <div class="text-right">
                    <p class="font-medium text-foreground">
                      {formatCurrency(item.price)}
                    </p>
                    <p class="text-sm text-muted-foreground">
                      each
                    </p>
                  </div>
                  <div class="text-right">
                    <p class="font-semibold text-foreground">
                      {formatCurrency(item.price * item.quantity)}
                    </p>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <!-- Order information -->
          <div class="bg-card rounded-lg border border-border p-8">
            <h2 class="text-lg font-semibold text-foreground mb-6">
              Order Information
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h3 class="text-sm font-medium text-foreground mb-3">
                  Customer Data
                </h3>
                <div class="space-y-2 text-sm">
                  <div>
                    <span class="text-muted-foreground">Name:</span>
                    <span class="ml-2 text-foreground">{order.customer_name}</span>
                  </div>
                  <div>
                    <span class="text-muted-foreground">Email:</span>
                    <span class="ml-2 text-foreground">{order.customer_email}</span>
                  </div>
                  {order.customer_phone && (
                    <div>
                      <span class="text-muted-foreground">Phone:</span>
                      <span class="ml-2 text-foreground">{order.customer_phone}</span>
                    </div>
                  )}
                </div>
              </div>

              {order.shipping_address && (
                <div>
                  <h3 class="text-sm font-medium text-foreground mb-3">
                    Shipping Address
                  </h3>
                  <p class="text-sm text-foreground whitespace-pre-line">
                    {order.shipping_address}
                  </p>
                </div>
              )}
            </div>
          </div>

          <!-- Order status -->
          <div class="bg-card rounded-lg border border-border p-8">
            <h2 class="text-lg font-semibold text-foreground mb-6">
              Order Status
            </h2>
            <div class="space-y-4">
              <div class="flex items-center gap-4">
                <div class={`w-3 h-3 rounded-full ${order.status !== 'cancelled' ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                <div>
                  <p class="font-medium text-foreground">Order Confirmed</p>
                  <p class="text-sm text-muted-foreground">
                    {formatDate(order.created_at)}
                  </p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class={`w-3 h-3 rounded-full ${['processing', 'shipped', 'delivered'].includes(order.status) ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                <div>
                  <p class="font-medium text-foreground">In Process</p>
                  {order.status === 'processing' && (
                    <p class="text-sm text-muted-foreground">Your order is being prepared</p>
                  )}
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class={`w-3 h-3 rounded-full ${['shipped', 'delivered'].includes(order.status) ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                <div>
                  <p class="font-medium text-foreground">Shipped</p>
                  {order.status === 'shipped' && (
                    <p class="text-sm text-muted-foreground">Your order is on its way</p>
                  )}
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class={`w-3 h-3 rounded-full ${order.status === 'delivered' ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                <div>
                  <p class="font-medium text-foreground">Delivered</p>
                  {order.status === 'delivered' && (
                    <p class="text-sm text-muted-foreground">Order delivered successfully</p>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-8">
          <!-- Order summary -->
          <div class="bg-card rounded-lg border border-border p-8">
            <h2 class="text-lg font-semibold text-foreground mb-6">
              Order Summary
            </h2>
            <div class="space-y-3">
              <div class="flex justify-between text-sm">
                <span class="text-muted-foreground">Subtotal:</span>
                <span class="text-foreground">{formatCurrency(subtotal)}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-muted-foreground">Shipping:</span>
                <span class="text-foreground">{shipping === 0 ? 'Free' : formatCurrency(shipping)}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-muted-foreground">Tax (VAT 16%):</span>
                <span class="text-foreground">{formatCurrency(tax)}</span>
              </div>
              <div class="border-t border-border pt-3">
                <div class="flex justify-between">
                  <span class="font-semibold text-foreground">Total:</span>
                  <span class="font-bold text-lg text-foreground">
                    {formatCurrency(order.total_amount)}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="bg-card rounded-lg border border-border p-8">
            <h2 class="text-lg font-semibold text-foreground mb-4">
              Actions
            </h2>
            <div class="space-y-3">
              {order.status === 'delivered' && (
                <a
                  href={`/orders/${order.id}/invoice`}
                  class="block w-full text-center rounded-md bg-primary px-4 py-2 text-sm font-semibold text-primary-foreground hover:bg-primary/90 transition-colors"
                >
                  Download Invoice
                </a>
              )}
              {(order.status === 'pending' || order.status === 'processing') && (
                <button
                  type="button"
                  class="block w-full text-center rounded-md bg-red-600 px-4 py-2 text-sm font-semibold text-white hover:bg-red-700 transition-colors"
                  onclick={`cancelOrder(${order.id})`}
                >
                  Cancel Order
                </button>
              )}
              <a
                href="/en/orders"
                class="block w-full text-center rounded-md bg-secondary px-4 py-2 text-sm font-semibold text-secondary-foreground hover:bg-secondary/90 transition-colors"
              >
                View All Orders
              </a>
              <a
                href="/en/filters"
                class="block w-full text-center rounded-md bg-secondary px-4 py-2 text-sm font-semibold text-secondary-foreground hover:bg-secondary/90 transition-colors"
              >
                Continue Shopping
              </a>
            </div>
          </div>

          <!-- Help -->
          <div class="bg-card rounded-lg border border-border p-8">
            <h2 class="text-lg font-semibold text-foreground mb-4">
              Need Help?
            </h2>
            <div class="space-y-3 text-sm">
              <p class="text-muted-foreground">
                If you have questions about your order, feel free to contact us.
              </p>
              <a
                href="/en/contact"
                class="inline-flex items-center text-primary hover:text-primary/90 font-medium"
              >
                Contact Support â†’
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom confirmation modal -->
  <CustomModal id="confirm-dialog" />
</WebsiteLayout>

<script>
  // Function to cancel order
  function cancelOrder(orderId: number) {
    if (typeof (window as any).showCustomModal === 'function') {
      (window as any).showCustomModal(
        'confirm-dialog',
        'Cancel order',
        'Are you sure you want to cancel this order?',
        () => {
          // Implement cancellation logic
          console.log(`Cancelling order ${orderId}`);
          // TODO: Implement backend call to cancel
        },
        'Cancel order',
        "Don't cancel"
      );
    }
  }

  // Make function global
  (window as any).cancelOrder = cancelOrder;
</script>
