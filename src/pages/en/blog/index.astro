---
import WebsiteLayout from "@/layouts/websiteLayout.astro";
import SEO from "@/components/shared/SEO.astro";
import { getBlogPosts } from "@/lib/database";
import type { BlogPost } from "@/lib/database";
import { generateBreadcrumbSchema } from "@/lib/seo-utils";
import { getHighQualityImageUrl } from "@/lib/image-utils";

// Get blog posts from database
const blogPosts = await getBlogPosts(6, 0);

// Function to format date
const formatDate = (date: Date): string => {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(new Date(date));
};

// Function to extract excerpt if it doesn't exist
const getExcerpt = (content: string, maxLength: number = 150): string => {
  if (!content) return '';

  // Remove HTML tags
  const textContent = content.replace(/<[^>]*>/g, '');

  if (textContent.length <= maxLength) {
    return textContent;
  }

  return textContent.substring(0, maxLength).trim() + '...';
};

// Function to get tags as array
const getTagsArray = (tags: string): string[] => {
  if (!tags) return [];
  return tags.split(',').map(tag => tag.trim()).filter(Boolean);
};

// Generate SEO data
const siteUrl = Astro.site?.href || Astro.url.origin;
const breadcrumbSchema = generateBreadcrumbSchema([
  { name: 'Home', url: `${siteUrl}/en` },
  { name: 'Blog', url: `${siteUrl}/en/blog` }
]);
---

<WebsiteLayout
  title="Blog"
  seoTitle="Star Filters Blog - Articles about Industrial Filters and Cleanrooms"
  description="Discover articles, guides and advice about industrial filters, HEPA filters, cleanrooms and air purification. Technical and professional information from experts."
  keywords={[
    'filter blog',
    'industrial filter articles',
    'cleanroom guides',
    'HEPA filter information',
    'industrial blog',
    'air purification'
  ]}
>
  <SEO
    slot="seo"
    title="Star Filters Blog"
    description="Discover articles, guides and advice about industrial filters, HEPA filters, cleanrooms and air purification. Technical and professional information from experts."
    ogType="website"
    keywords={[
      'filter blog',
      'industrial filter articles',
      'cleanroom guides',
      'HEPA filter information'
    ]}
  />

  <!-- Breadcrumb Schema -->
  <script slot="seo" type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  <div class="bg-background py-24 sm:py-32">
    <div class="mx-auto max-w-7xl px-6 lg:px-8">
      <div class="mx-auto max-w-4xl text-center">
        <h2
          class="text-4xl font-semibold tracking-tight text-balance text-foreground sm:text-5xl"
        >
          Star Filters Blog
        </h2>
        <p class="mt-2 text-lg/8 text-muted-foreground">
          Articles and technical guides about industrial filters, cleanrooms and filtration systems.
        </p>
      </div>
      {blogPosts.length > 0 ? (
        <div
          class="mx-auto mt-16 grid max-w-2xl grid-cols-1 gap-x-8 gap-y-20 lg:mx-0 lg:max-w-none lg:grid-cols-3"
        >
          {blogPosts.map((post) => {
            const tags = getTagsArray(post.tags);
            const excerpt = post.excerpt || getExcerpt(post.content);

            return (
              <article class="flex flex-col items-start justify-between">
                <div class="relative w-full">
                  <img
                    src={getHighQualityImageUrl(post.featured_image, { width: 900 }) || 'https://via.placeholder.com/600x400?text=Star Filters'}
                    alt={post.title}
                    class="aspect-video w-full rounded-2xl bg-muted object-cover sm:aspect-2/1 lg:aspect-3/2"
                    width={900}
                    height={600}
                    loading="lazy"
                    decoding="async"
                  />
                  <div
                    class="absolute inset-0 rounded-2xl inset-ring inset-ring-gray-900/10"
                  >
                  </div>
                </div>
                <div class="flex max-w-xl grow flex-col justify-between">
                  <div class="mt-8 flex items-center gap-x-4 text-xs">
                    <time datetime={post.created_at.toISOString()} class="text-muted-foreground">
                      {formatDate(post.created_at)}
                    </time>
                    {tags.length > 0 && (
                      <a
                        href="#"
                        class="relative z-10 rounded-full bg-muted px-3 py-1.5 font-medium text-muted-foreground hover:bg-muted/80"
                      >
                        {tags[0]}
                      </a>
                    )}
                  </div>
                  <div class="group relative grow">
                    <h3
                      class="mt-3 text-lg/6 font-semibold text-foreground group-hover:text-muted-foreground"
                    >
                      <a href={`/en/blog/${post.uuid}`}>
                        <span class="absolute inset-0"></span>
                        {post.title}
                      </a>
                    </h3>
                    <p class="mt-5 line-clamp-3 text-sm/6 text-muted-foreground">
                      {excerpt}
                    </p>
                  </div>
                </div>
              </article>
            );
          })}
        </div>
      ) : (
        <div class="mx-auto mt-16 text-center">
          <div class="rounded-lg bg-muted p-12">
            <svg class="mx-auto h-12 w-12 text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-foreground">No articles available</h3>
            <p class="mt-1 text-sm text-muted-foreground">We will soon publish technical content about industrial filters and cleanrooms.</p>
          </div>
        </div>
      )}
    </div>
  </div>
</WebsiteLayout>
