---
import WebsiteLayout from "@/layouts/websiteLayout.astro";
import { getAuthenticatedUser } from "@/lib/auth-utils";

// Verify user is authenticated
const user = getAuthenticatedUser(Astro.cookies);
if (!user) {
  return Astro.redirect('/en/login');
}
---

<WebsiteLayout title="Checkout">
  <div class="bg-background">
    <main class="mx-auto max-w-7xl px-4 pt-16 pb-24 sm:px-6 lg:px-8">
      <div class="mx-auto max-w-2xl lg:max-w-none">
        <h1 class="sr-only">Checkout</h1>
  
        <div class="lg:grid lg:grid-cols-2 lg:gap-x-12 xl:gap-x-16">
          <div>
            <div>
              <h2 class="mt-10 text-lg font-medium text-foreground">
                Contact Information
              </h2>
  
              <div class="mt-4">
                <label
                  for="email-address"
                  class="block text-sm/6 font-medium text-foreground"
                  >Email Address</label
                >
                <div class="mt-2">
                  <input
                    id="email-address"
                    type="email"
                    name="email-address"
                    value={user.email}
                    readonly
                    class="block w-full rounded-md bg-muted px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary sm:text-sm/6"
                  />
                </div>
              </div>
            </div>
  
            <div class="mt-10 border-t border-border pt-10">
              <h2 class="text-lg font-medium text-foreground">
                Shipping Information
              </h2>

              <div class="mt-4 grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-4">
                <div>
                  <label for="first-name" class="block text-sm/6 font-medium text-foreground">First Name</label>
                  <div class="mt-2">
                    <input
                      id="first-name"
                      type="text"
                      name="first-name"
                      value={user.firstName}
                      readonly
                      class="block w-full rounded-md bg-muted px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary sm:text-sm/6"
                    />
                  </div>
                </div>
  
                <div>
                  <label for="last-name" class="block text-sm/6 font-medium text-foreground">Last Name</label>
                  <div class="mt-2">
                    <input
                      id="last-name"
                      type="text"
                      name="last-name"
                      value={user.lastName}
                      readonly
                      class="block w-full rounded-md bg-muted px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary sm:text-sm/6"
                    />
                  </div>
                </div>
  
                <div class="sm:col-span-2">
                  <label for="address" class="block text-sm/6 font-medium text-foreground">Address</label>
                  <div class="mt-2">
                    <input
                      id="address"
                      type="text"
                      name="address"
                      required
                      class="block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary sm:text-sm/6"
                    />
                  </div>
                </div>
  
                <div>
                  <label for="city" class="block text-sm/6 font-medium text-foreground">City</label>
                  <div class="mt-2">
                    <input
                      id="city"
                      type="text"
                      name="city"
                      required
                      class="block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary sm:text-sm/6"
                    />
                  </div>
                </div>
  
                <div>
                  <label for="state" class="block text-sm/6 font-medium text-foreground">State</label>
                  <div class="mt-2">
                    <input
                      id="state"
                      type="text"
                      name="state"
                      required
                      class="block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary sm:text-sm/6"
                    />
                  </div>
                </div>
  
                <div>
                  <label for="postal-code" class="block text-sm/6 font-medium text-foreground">Postal Code</label>
                  <div class="mt-2">
                    <input
                      id="postal-code"
                      type="text"
                      name="postal-code"
                      required
                      class="block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary sm:text-sm/6"
                    />
                  </div>
                </div>
  
                <div>
                  <label for="country" class="block text-sm/6 font-medium text-foreground">Country</label>
                  <div class="mt-2">
                    <input
                      id="country"
                      type="text"
                      name="country"
                      value="Mexico"
                      readonly
                      class="block w-full rounded-md bg-muted px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary sm:text-sm/6"
                    />
                  </div>
                </div>
              </div>
            </div>
  
            <!-- Payment -->
            <div class="mt-10 border-t border-border pt-10">
              <h2 class="text-lg font-medium text-foreground">Payment</h2>
  
              <div class="mt-6">
                <div id="stripe-payment-form" class="space-y-4">
                  <!-- Stripe component will load here -->
                </div>
              </div>
            </div>
          </div>
  
          <!-- Order summary -->
          <div class="mt-10 lg:mt-0">
            <h2 class="mt-10 text-lg font-medium text-foreground">Order Summary</h2>

            <div class="mt-4 rounded-lg border border-border bg-background shadow-xs">
              <h3 class="sr-only">Items in your cart</h3>
              <ul role="list" class="divide-y divide-border" id="order-items-list">
                <!-- Items will be loaded dynamically -->
              </ul>

              <!-- Discount code -->
              <div class="border-t border-border px-4 py-6 sm:px-6">
                <label for="discount-code" class="block text-sm font-medium text-foreground mb-2">
                  Discount Code
                </label>
                <div class="flex gap-2">
                  <input
                    type="text"
                    id="discount-code"
                    name="discount-code"
                    placeholder="Enter your code"
                    class="flex-1 rounded-md bg-background px-3 py-2 text-sm text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary uppercase"
                  />
                  <button
                    type="button"
                    id="apply-discount"
                    class="rounded-md bg-primary px-4 py-2 text-sm font-semibold text-primary-foreground shadow-xs hover:bg-primary/90 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:opacity-50"
                  >
                    Apply
                  </button>
                </div>
                <div id="discount-message" class="mt-2 text-sm hidden"></div>
              </div>

              <dl class="space-y-6 border-t border-border px-4 py-6 sm:px-6" id="order-summary">
                <!-- Summary will be loaded dynamically -->
              </dl>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script>
    import { getCart } from '@/lib/cart';
    
    // Function to get cart from localStorage (client-side)
    function getCartFromStorage() {
      try {
        const cartData = localStorage.getItem('starfilters_cart');
        if (cartData) {
          return JSON.parse(cartData);
        }
      } catch (error) {
        console.error('Error reading cart:', error);
      }
      return { items: [], total: 0, itemCount: 0 };
    }

    // Function to format price according to cart currency
    function formatPrice(price: number, currency: string = 'USD'): string {
      return new Intl.NumberFormat(
        currency === 'USD' ? 'en-US' : 'es-MX',
        {
          style: 'currency',
          currency: currency
        }
      ).format(price);
    }

    // Function to load Stripe Elements directly
    async function loadStripeForm(container: HTMLElement, clientSecret: string, amount: number, currency: string = 'USD') {
      try {
        // Load Stripe from CDN
        const stripeScript = document.createElement('script');
        stripeScript.src = 'https://js.stripe.com/v3/';
        stripeScript.onload = () => {
          initializeStripe(container, clientSecret, amount, currency);
        };
        document.head.appendChild(stripeScript);
      } catch (error) {
        console.error('Error loading Stripe:', error);
        container.innerHTML = '<p class="text-red-600">Error loading Stripe. Please try again.</p>';
      }
    }

    // Function to initialize Stripe
    function initializeStripe(container: HTMLElement, clientSecret: string, amount: number, currency: string = 'USD') {
      try {
        console.log('üí≥ Initializing Stripe Elements...');
        const stripe = (window as any).Stripe(import.meta.env.PUBLIC_STRIPE_PUBLISHABLE_KEY);
        
        const elements = stripe.elements({
          clientSecret: clientSecret,
          appearance: {
            theme: 'stripe',
            variables: {
              colorPrimary: '#3b82f6',
              colorBackground: 'transparent',
              colorText: '#1f2937',
            }
          }
        });

        const paymentElement = elements.create('payment');
        
        // Get cart currency
        const cart = getCartFromStorage();
        const cartCurrency = cart.currency || 'USD';
        
        container.innerHTML = `
          <div class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-foreground mb-2">
                Card Information
              </label>
              <div id="payment-element" class="p-4 border border-border rounded-md bg-background">
                <!-- Stripe Elements will load here -->
              </div>
            </div>
            
            <div class="flex items-center justify-between text-sm">
              <span class="text-muted-foreground">Total to pay:</span>
              <span class="font-semibold text-foreground">${formatPrice(amount, cartCurrency)}</span>
            </div>

            <button 
              id="submit-payment" 
              class="w-full bg-primary text-primary-foreground py-2 px-4 rounded-md hover:bg-primary/90 transition-colors disabled:opacity-50"
            >
              Pay ${formatPrice(amount, cartCurrency)}
            </button>

            <div id="payment-message" class="hidden"></div>
          </div>
        `;

        const paymentElementDiv = document.getElementById('payment-element');
        if (paymentElementDiv) {
          paymentElement.mount(paymentElementDiv);
        }

        const submitButton = document.getElementById('submit-payment');
        const messageDiv = document.getElementById('payment-message');

        if (submitButton) {
          submitButton.addEventListener('click', async () => {
            (submitButton as HTMLButtonElement).disabled = true;
            
            const { error } = await stripe.confirmPayment({
              elements,
              confirmParams: {
                return_url: `${window.location.origin}/purchase-success`,
              },
            });

            if (error) {
              if (messageDiv) {
                messageDiv.textContent = error.message || 'An unexpected error occurred.';
                messageDiv.className = 'text-red-600 text-sm mt-2';
                messageDiv.classList.remove('hidden');
              }
              (submitButton as HTMLButtonElement).disabled = false;
            } else {
              if (messageDiv) {
                messageDiv.textContent = 'Payment successful! Redirecting...';
                messageDiv.className = 'text-green-600 text-sm mt-2';
                messageDiv.classList.remove('hidden');
              }
            }
          });
        }

      } catch (error) {
        console.error('Error initializing Stripe:', error);
        container.innerHTML = '<p class="text-red-600">Error initializing Stripe. Please try again.</p>';
      }
    }

    // Discount state
    let appliedDiscount: {
      code: string;
      discountCodeId: number;
      amount: number;
    } | null = null;

    // Function to render order summary
    function renderOrderSummary() {
      console.log('üîç Starting renderOrderSummary...');
      const cart = getCartFromStorage();
      console.log('üõí Cart obtained:', cart);

      // If cart is empty, redirect to cart page
      if (cart.items.length === 0) {
        console.log('üõí Empty cart, redirecting...');
        window.location.href = '/en/cart';
        return null;
      }

      const orderItemsList = document.getElementById('order-items-list');
      const orderSummary = document.getElementById('order-summary');
      console.log('üéØ Elements found:', { orderItemsList, orderSummary });

      if (!orderItemsList || !orderSummary) {
        console.log('‚ùå DOM elements not found');
        return cart;
      }

      // Render items
      orderItemsList.innerHTML = cart.items.map(item => `
        <li class="flex px-4 py-6 sm:px-6">
          <div class="shrink-0">
            ${item.image_url ?
              `<img src="${item.image_url}" alt="${item.name}" class="w-20 rounded-md" />` :
              `<div class="w-20 h-20 bg-muted rounded-md flex items-center justify-center">
                <span class="text-muted-foreground text-xs">No image</span>
              </div>`
            }
          </div>
          <div class="ml-6 flex flex-1 flex-col">
            <div class="flex">
              <div class="min-w-0 flex-1">
                <h4 class="text-sm">
                  <span class="font-medium text-foreground">${item.name}</span>
                </h4>
                ${item.color ? `<p class="mt-1 text-sm text-muted-foreground">Color: ${item.color}</p>` : ''}
                ${item.size ? `<p class="mt-1 text-sm text-muted-foreground">Size: ${item.size}</p>` : ''}
                ${item.category ? `<p class="mt-1 text-sm text-muted-foreground">Category: ${item.category}</p>` : ''}
              </div>
            </div>
            <div class="flex flex-1 items-end justify-between pt-2">
              <p class="mt-1 text-sm font-medium text-foreground">${formatPrice(item.price, item.currency || cartCurrency)}</p>
              <div class="ml-4">
                <span class="text-sm text-muted-foreground">Quantity: ${item.quantity}</span>
              </div>
            </div>
          </div>
        </li>
      `).join('');

      // Get cart currency
      const cartCurrency = cart.currency || 'USD';
      
      // Calculate totals
      const subtotal = cart.total;
      const discountAmount = appliedDiscount?.amount || 0;
      const subtotalAfterDiscount = subtotal - discountAmount;
      const shipping = 5.00; // Standard shipping
      const tax = subtotalAfterDiscount * 0.16;
      const total = subtotalAfterDiscount + shipping + tax;

      // Render summary
      let summaryHTML = `
        <div class="flex items-center justify-between">
          <dt class="text-sm text-muted-foreground">Subtotal</dt>
          <dd class="text-sm font-medium text-foreground">${formatPrice(subtotal, cartCurrency)}</dd>
        </div>
      `;

      if (appliedDiscount) {
        summaryHTML += `
          <div class="flex items-center justify-between">
            <dt class="text-sm text-green-600">Discount (${appliedDiscount.code})</dt>
            <dd class="text-sm font-medium text-green-600">-${formatPrice(discountAmount, cartCurrency)}</dd>
          </div>
        `;
      }

      summaryHTML += `
        <div class="flex items-center justify-between">
          <dt class="text-sm text-muted-foreground">Shipping (4-10 business days)</dt>
          <dd class="text-sm font-medium text-foreground">${formatPrice(shipping, cartCurrency)}</dd>
        </div>
        <div class="flex items-center justify-between">
          <dt class="text-sm text-muted-foreground">Tax (VAT 16%)</dt>
          <dd class="text-sm font-medium text-foreground">${formatPrice(tax, cartCurrency)}</dd>
        </div>
        <div class="flex items-center justify-between border-t border-border pt-6">
          <dt class="text-base font-medium text-foreground">Total</dt>
          <dd class="text-base font-medium text-foreground">${formatPrice(total, cartCurrency)}</dd>
        </div>
      `;

      orderSummary.innerHTML = summaryHTML;

      console.log('‚úÖ Order summary rendered correctly');
      return cart;
    }

    // Function to apply discount code
    async function applyDiscountCode() {
      const input = document.getElementById('discount-code') as HTMLInputElement;
      const button = document.getElementById('apply-discount') as HTMLButtonElement;
      const messageDiv = document.getElementById('discount-message');

      if (!input || !button || !messageDiv) return;

      const code = input.value.trim().toUpperCase();
      if (!code) {
        messageDiv.textContent = 'Please enter a code';
        messageDiv.className = 'mt-2 text-sm text-red-600';
        messageDiv.classList.remove('hidden');
        return;
      }

      button.disabled = true;
      button.textContent = 'Applying...';

      try {
        const cart = getCartFromStorage();
        const response = await fetch('/api/validate-discount-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: code,
            subtotal: cart.total,
            cartItems: cart.items, // Send cart items to validate allowed products
          }),
        });

        const data = await response.json();

        if (data.success) {
          appliedDiscount = {
            code: code,
            discountCodeId: data.discountCode.id,
            amount: data.discountAmount,
          };
          messageDiv.textContent = `‚úì ${data.message} - Savings: ${formatPrice(data.discountAmount, cartCurrency)}`;
          messageDiv.className = 'mt-2 text-sm text-green-600';
          messageDiv.classList.remove('hidden');
          input.disabled = true;
          button.textContent = 'Applied';
          renderOrderSummary();
        } else {
          messageDiv.textContent = data.message;
          messageDiv.className = 'mt-2 text-sm text-red-600';
          messageDiv.classList.remove('hidden');
          button.disabled = false;
          button.textContent = 'Apply';
        }
      } catch (error) {
        console.error('Error applying discount code:', error);
        messageDiv.textContent = 'Error applying discount code';
        messageDiv.className = 'mt-2 text-sm text-red-600';
        messageDiv.classList.remove('hidden');
        button.disabled = false;
        button.textContent = 'Apply';
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      console.log('üöÄ DOMContentLoaded started');
      
      // First render order summary
      console.log('üì¶ Rendering order summary...');
      const cart = renderOrderSummary();
      console.log('üì¶ Cart after rendering:', cart);
      
      if (!cart) {
        console.log('‚ùå No cart, returning');
        return; // If cart is empty, already redirected
      }

      const paymentFormContainer = document.getElementById('stripe-payment-form');
      console.log('üí≥ Payment form container:', paymentFormContainer);
      
      if (!paymentFormContainer) {
        console.log('‚ùå Payment container not found');
        return;
      }

      // Show initial message while waiting for user to complete fields
      paymentFormContainer.innerHTML = '<div class="p-4 bg-muted rounded-lg"><p class="text-sm text-muted-foreground">Please complete all shipping information fields to continue with payment.</p></div>';
      console.log('‚úÖ Initial message shown');

      // Add discount code button listener
      const applyDiscountButton = document.getElementById('apply-discount');
      if (applyDiscountButton) {
        applyDiscountButton.addEventListener('click', applyDiscountCode);
      }

      // Also allow Enter key on discount input
      const discountInput = document.getElementById('discount-code');
      if (discountInput) {
        discountInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            applyDiscountCode();
          }
        });
      }

      // Function to try loading payment form
      const loadPaymentForm = async () => {
        try {
          // Get form data
          const email = (document.getElementById('email-address') as HTMLInputElement)?.value;
          const firstName = (document.getElementById('first-name') as HTMLInputElement)?.value;
          const lastName = (document.getElementById('last-name') as HTMLInputElement)?.value;
          const address = (document.getElementById('address') as HTMLInputElement)?.value;
          const city = (document.getElementById('city') as HTMLInputElement)?.value;
          const state = (document.getElementById('state') as HTMLInputElement)?.value;
          const postalCode = (document.getElementById('postal-code') as HTMLInputElement)?.value;
          const country = (document.getElementById('country') as HTMLInputElement)?.value;

          // Validate all required fields are filled
          if (!email || !firstName || !lastName || !address || !city || !state || !postalCode || !country) {
            return;
          }

          // Show loading
          paymentFormContainer.innerHTML = '<div class="flex items-center justify-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div>';

          const checkoutData = {
            email,
            firstName,
            lastName,
            address,
            city,
            state,
            postalCode,
            country,
          };

          console.log('üí≥ Creating Payment Intent with Stripe...');

          // Get current cart
          const cart = getCartFromStorage();
          
          if (cart.items.length === 0) {
            paymentFormContainer.innerHTML = '<p class="text-red-600">Your cart is empty. Please add products before continuing.</p>';
            return;
          }

          // Call API to create real Payment Intent
          const response = await fetch('/api/create-payment-intent', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              ...checkoutData,
              items: cart.items, // Send cart items
              shippingMethod: 'standard', // Can be 'standard' or 'express'
              discountCode: appliedDiscount ? {
                code: appliedDiscount.code,
                discountCodeId: appliedDiscount.discountCodeId,
                amount: appliedDiscount.amount
              } : undefined
            }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Error creating payment');
          }

          const paymentData = await response.json();
          console.log('‚úÖ Payment Intent created:', paymentData.paymentIntentId);

          // Load Stripe with real client_secret
          const cartForCurrency = getCartFromStorage();
          const cartCurrency = cartForCurrency.currency || 'USD';
          await loadStripeForm(paymentFormContainer, paymentData.client_secret, paymentData.order_total, cartCurrency);

        } catch (error) {
          console.error('Error:', error);
          paymentFormContainer.innerHTML = '<p class="text-red-600">Error initializing payment. Please try again.</p>';
        }
      };

      // Add listeners to all required fields
      const requiredFields = ['address', 'city', 'state', 'postal-code'];
      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('blur', loadPaymentForm);
          field.addEventListener('change', loadPaymentForm);
        }
      });
    });
  </script>
</WebsiteLayout>
