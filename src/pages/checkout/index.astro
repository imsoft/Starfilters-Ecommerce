---
import WebsiteLayout from "@/layouts/websiteLayout.astro";
import { getAuthenticatedUser } from "@/lib/auth-utils";

// Verificar que el usuario est√© autenticado
const user = getAuthenticatedUser(Astro.cookies);
if (!user) {
  return Astro.redirect('/login');
}
---

<WebsiteLayout title="Checkout">
  <div class="bg-background">
    <main class="mx-auto max-w-7xl px-4 pt-16 pb-24 sm:px-6 lg:px-8">
      <div class="mx-auto max-w-2xl lg:max-w-none">
        <h1 class="sr-only">Checkout</h1>
  
        <div class="lg:grid lg:grid-cols-2 lg:gap-x-12 xl:gap-x-16">
          <div>
            <div>
              <h2 class="mt-10 text-lg font-medium text-foreground">
                Informaci√≥n de contacto
              </h2>
  
              <div class="mt-4">
                <label
                  for="email-address"
                  class="block text-sm/6 font-medium text-foreground"
                  >Direcci√≥n de correo electr√≥nico</label
                >
                <div class="mt-2">
                  <input
                    id="email-address"
                    type="email"
                    name="email-address"
                    value={user.email}
                    readonly
                    class="block w-full rounded-md bg-muted px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary sm:text-sm/6"
                  />
                </div>
              </div>
            </div>
  
            <div class="mt-10 border-t border-border pt-10">
              <h2 class="text-lg font-medium text-foreground">
                Informaci√≥n de env√≠o
              </h2>

              <div class="mt-4 grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-4">
                <div>
                  <label for="first-name" class="block text-sm/6 font-medium text-foreground">Nombre</label>
                  <div class="mt-2">
                    <input
                      id="first-name"
                      type="text"
                      name="first-name"
                      value={user.firstName}
                      readonly
                      class="block w-full rounded-md bg-muted px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary sm:text-sm/6"
                    />
                  </div>
                </div>
  
                <div>
                  <label for="last-name" class="block text-sm/6 font-medium text-foreground">Apellido</label>
                  <div class="mt-2">
                    <input
                      id="last-name"
                      type="text"
                      name="last-name"
                      value={user.lastName}
                      readonly
                      class="block w-full rounded-md bg-muted px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary sm:text-sm/6"
                    />
                  </div>
                </div>
  
                <div class="sm:col-span-2">
                  <label for="address" class="block text-sm/6 font-medium text-foreground">Direcci√≥n</label>
                  <div class="mt-2">
                    <input
                      id="address"
                      type="text"
                      name="address"
                      required
                      class="block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary sm:text-sm/6"
                    />
                  </div>
                </div>
  
                <div>
                  <label for="city" class="block text-sm/6 font-medium text-foreground">Ciudad</label>
                  <div class="mt-2">
                    <input
                      id="city"
                      type="text"
                      name="city"
                      required
                      class="block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary sm:text-sm/6"
                    />
                  </div>
                </div>
  
                <div>
                  <label for="state" class="block text-sm/6 font-medium text-foreground">Estado</label>
                  <div class="mt-2">
                    <input
                      id="state"
                      type="text"
                      name="state"
                      required
                      class="block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary sm:text-sm/6"
                    />
                  </div>
                </div>
  
                <div>
                  <label for="postal-code" class="block text-sm/6 font-medium text-foreground">C√≥digo postal</label>
                  <div class="mt-2">
                    <input
                      id="postal-code"
                      type="text"
                      name="postal-code"
                      required
                      class="block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary sm:text-sm/6"
                    />
                  </div>
                </div>
  
                <div>
                  <label for="country" class="block text-sm/6 font-medium text-foreground">Pa√≠s</label>
                  <div class="mt-2">
                    <input
                      id="country"
                      type="text"
                      name="country"
                      value="M√©xico"
                      readonly
                      class="block w-full rounded-md bg-muted px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary sm:text-sm/6"
                    />
                  </div>
                </div>
              </div>
            </div>
  
            <!-- Payment -->
            <div class="mt-10 border-t border-border pt-10">
              <h2 class="text-lg font-medium text-foreground">Pago</h2>
  
              <div class="mt-6">
                <div id="stripe-payment-form" class="space-y-4">
                  <!-- El componente Stripe se cargar√° aqu√≠ -->
                </div>
              </div>
            </div>
          </div>
  
          <!-- Order summary -->
          <div class="mt-10 lg:mt-0">
            <h2 class="mt-10 text-lg font-medium text-foreground">Resumen del Pedido</h2>

            <div class="mt-4 rounded-lg border border-border bg-background shadow-xs">
              <h3 class="sr-only">Items in your cart</h3>
              <ul role="list" class="divide-y divide-border" id="order-items-list">
                <!-- Los items se cargar√°n din√°micamente -->
              </ul>

              <!-- C√≥digo de descuento -->
              <div class="border-t border-border px-4 py-6 sm:px-6">
                <label for="discount-code" class="block text-sm font-medium text-foreground mb-2">
                  C√≥digo de descuento
                </label>
                <div class="flex gap-2">
                  <input
                    type="text"
                    id="discount-code"
                    name="discount-code"
                    placeholder="Ingresa tu c√≥digo"
                    class="flex-1 rounded-md bg-background px-3 py-2 text-sm text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary uppercase"
                  />
                  <button
                    type="button"
                    id="apply-discount"
                    class="rounded-md bg-primary px-4 py-2 text-sm font-semibold text-primary-foreground shadow-xs hover:bg-primary/90 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary disabled:opacity-50"
                  >
                    Aplicar
                  </button>
                </div>
                <div id="discount-message" class="mt-2 text-sm hidden"></div>
              </div>

              <dl class="space-y-6 border-t border-border px-4 py-6 sm:px-6" id="order-summary">
                <!-- El resumen se cargar√° din√°micamente -->
              </dl>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script>
    // Funci√≥n para obtener carrito desde localStorage (cliente)
    function getCartFromStorage() {
      try {
        const cartData = localStorage.getItem('starfilters_cart');
        if (cartData) {
          return JSON.parse(cartData);
        }
      } catch (error) {
        console.error('Error al leer carrito:', error);
      }
      return { items: [], total: 0, itemCount: 0 };
    }

    // Funci√≥n para formatear precio seg√∫n moneda del carrito
    function formatPrice(price: number, currency: string = 'MXN'): string {
      return new Intl.NumberFormat(
        currency === 'USD' ? 'en-US' : 'es-MX',
        {
          style: 'currency',
          currency: currency
        }
      ).format(price);
    }

    // Funci√≥n para cargar Stripe Elements directamente
    async function loadStripeForm(container: HTMLElement, clientSecret: string, amount: number, currency: string = 'MXN') {
      try {
        console.log('üì¶ Cargando Stripe...');
        
        // Verificar si Stripe ya est√° cargado
        if ((window as any).Stripe) {
          console.log('‚úÖ Stripe ya est√° cargado');
          initializeStripe(container, clientSecret, amount, currency);
          return;
        }

        // Verificar que tenemos la clave p√∫blica
        const publishableKey = import.meta.env.PUBLIC_STRIPE_PUBLISHABLE_KEY;
        if (!publishableKey) {
          throw new Error('PUBLIC_STRIPE_PUBLISHABLE_KEY no est√° configurada');
        }
        console.log('üîë Clave p√∫blica de Stripe encontrada');

        // Cargar Stripe desde CDN
        return new Promise<void>((resolve, reject) => {
          // Verificar si el script ya existe
          const existingScript = document.querySelector('script[src="https://js.stripe.com/v3/"]');
          if (existingScript) {
            console.log('‚úÖ Script de Stripe ya existe');
            initializeStripe(container, clientSecret, amount, currency);
            resolve();
            return;
          }

          const stripeScript = document.createElement('script');
          stripeScript.src = 'https://js.stripe.com/v3/';
          stripeScript.onload = () => {
            console.log('‚úÖ Script de Stripe cargado exitosamente');
            try {
              initializeStripe(container, clientSecret, amount, currency);
              resolve();
            } catch (error) {
              console.error('‚ùå Error inicializando Stripe despu√©s de cargar:', error);
              reject(error);
            }
          };
          stripeScript.onerror = () => {
            console.error('‚ùå Error cargando script de Stripe');
            reject(new Error('No se pudo cargar el script de Stripe'));
          };
          document.head.appendChild(stripeScript);
        });
      } catch (error) {
        console.error('‚ùå Error cargando Stripe:', error);
        const errorMessage = error instanceof Error ? error.message : 'Error desconocido';
        container.innerHTML = `
          <div class="p-4 bg-red-50 border border-red-200 rounded-md">
            <p class="text-red-800 font-medium">Error al cargar Stripe</p>
            <p class="text-red-600 text-sm mt-1">${errorMessage}</p>
            <p class="text-red-600 text-xs mt-2">Por favor verifica que PUBLIC_STRIPE_PUBLISHABLE_KEY est√© configurada correctamente.</p>
          </div>
        `;
        throw error;
      }
    }

    // Variable global para almacenar la instancia del Payment Element
    let currentPaymentElement: any = null;
    let currentStripe: any = null;
    let currentElements: any = null;
    let isElementMounted = false;

    // Funci√≥n para inicializar Stripe
    function initializeStripe(container: HTMLElement, clientSecret: string, amount: number, currency: string = 'MXN') {
      try {
        console.log('üí≥ Inicializando Stripe Elements...');
        console.log('üîë Client Secret recibido:', clientSecret ? 'S√≠ (oculto por seguridad)' : 'No');
        
        const publishableKey = import.meta.env.PUBLIC_STRIPE_PUBLISHABLE_KEY;
        if (!publishableKey) {
          throw new Error('PUBLIC_STRIPE_PUBLISHABLE_KEY no est√° configurada');
        }
        
        if (!clientSecret) {
          throw new Error('Client secret no recibido del servidor');
        }

        // Desmontar Payment Element anterior si existe
        if (currentPaymentElement) {
          try {
            console.log('üóëÔ∏è Desmontando Payment Element anterior...');
            currentPaymentElement.unmount();
            currentPaymentElement = null;
            isElementMounted = false;
          } catch (unmountError) {
            console.warn('‚ö†Ô∏è Error al desmontar Payment Element anterior:', unmountError);
          }
        }

        const stripe = (window as any).Stripe(publishableKey);
        
        if (!stripe) {
          throw new Error('No se pudo inicializar Stripe. Verifica que el script se haya cargado correctamente.');
        }
        
        console.log('‚úÖ Stripe inicializado correctamente');
        
        const elements = stripe.elements({
          clientSecret: clientSecret,
          appearance: {
            theme: 'stripe',
            variables: {
              colorPrimary: '#3b82f6',
              colorBackground: 'transparent',
              colorText: '#1f2937',
            }
          }
        });

        const paymentElement = elements.create('payment');
        
        // Guardar referencias globales
        currentStripe = stripe;
        currentElements = elements;
        currentPaymentElement = paymentElement;
        
        // Obtener moneda del carrito (usar getCartFromStorage en cliente)
        const cart = getCartFromStorage();
        const cartCurrency = cart.currency || 'MXN';
        
        container.innerHTML = `
          <div class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-foreground mb-2">
                M√©todo de pago
              </label>
              <div id="payment-element" class="p-4 border border-border rounded-md bg-background">
                <!-- Stripe Elements se cargar√° aqu√≠ -->
              </div>
            </div>
            
            <div class="flex items-center justify-between text-sm">
              <span class="text-muted-foreground">Total a pagar:</span>
              <span class="font-semibold text-foreground">${formatPrice(amount, cartCurrency)}</span>
            </div>

            <button 
              id="submit-payment" 
              class="w-full bg-primary text-primary-foreground py-2 px-4 rounded-md hover:bg-primary/90 transition-colors disabled:opacity-50"
            >
              Pagar ${formatPrice(amount, cartCurrency)}
            </button>

            <div id="payment-message" class="hidden"></div>
          </div>
        `;

        const paymentElementDiv = document.getElementById('payment-element');
        if (!paymentElementDiv) {
          throw new Error('No se encontr√≥ el contenedor para el elemento de pago');
        }

        const submitButton = document.getElementById('submit-payment');
        const messageDiv = document.getElementById('payment-message');

        if (!submitButton) {
          throw new Error('No se encontr√≥ el bot√≥n de env√≠o');
        }

        // Deshabilitar el bot√≥n hasta que el Payment Element est√© listo
        (submitButton as HTMLButtonElement).disabled = true;
        (submitButton as HTMLButtonElement).textContent = 'Cargando formulario de pago...';

        console.log('üì¶ Montando Payment Element...');
        
        // Reiniciar el estado de montaje
        isElementMounted = false;
        
        // Esperar al siguiente frame para asegurar que el DOM est√© listo
        requestAnimationFrame(() => {
          paymentElement.mount(paymentElementDiv);
        });
        
        // Esperar a que el Payment Element est√© completamente listo
        paymentElement.on('ready', () => {
          console.log('‚úÖ Payment Element listo y montado');
          isElementMounted = true;
          submitBtn.disabled = false;
          submitBtn.textContent = `Pagar ${formatPrice(amount, currency)}`;
        });

        // Manejar errores del Payment Element
        paymentElement.on('change', (event: any) => {
          if (event.error) {
            console.error('‚ùå Error en Payment Element:', event.error);
            if (messageDiv) {
              messageDiv.textContent = event.error.message || 'Error en el formulario de pago';
              messageDiv.className = 'text-red-600 text-sm mt-2 p-2 bg-red-50 rounded';
              messageDiv.classList.remove('hidden');
            }
          } else {
            // Limpiar mensaje de error si se corrige
            if (messageDiv) {
              messageDiv.classList.add('hidden');
            }
          }
        });

        // Manejar error de carga del Payment Element (ej. 400 de Stripe - dominio no registrado)
        paymentElement.on('loaderror', (event: any) => {
          console.error('‚ùå Error cargando Payment Element:', event);
          isElementMounted = false;
          if (messageDiv) {
            messageDiv.innerHTML = 'No se pudo cargar el formulario de pago. Si est√°s en producci√≥n, agrega tu dominio en el panel de Stripe: <a href="https://dashboard.stripe.com/settings/payment_method_domains" target="_blank" rel="noopener" class="underline">Configuraci√≥n de dominios</a>.';
            messageDiv.className = 'text-red-600 text-sm mt-2 p-2 bg-red-50 rounded';
            messageDiv.classList.remove('hidden');
          }
          submitBtn.disabled = false;
          submitBtn.textContent = `Reintentar - Pagar ${formatPrice(amount, currency)}`;
        });

        // Obtener referencia al bot√≥n visible (se usar√° en callbacks)
        const submitBtn = submitButton as HTMLButtonElement;
        
        // Agregar listener al bot√≥n
        submitBtn.addEventListener('click', async () => {
          // Verificar que el elemento est√© montado antes de confirmar
          if (!isElementMounted) {
            console.warn('‚ö†Ô∏è Payment Element a√∫n no est√° listo');
            if (messageDiv) {
              messageDiv.textContent = 'Por favor espera a que el formulario de pago termine de cargar';
              messageDiv.className = 'text-yellow-600 text-sm mt-2 p-2 bg-yellow-50 rounded';
              messageDiv.classList.remove('hidden');
            }
            return;
          }

          // Verificar que el Payment Element est√© realmente montado
          if (!currentPaymentElement || !currentStripe || !currentElements) {
            console.error('‚ùå Payment Element no est√° disponible');
            if (messageDiv) {
              messageDiv.textContent = 'Error: El formulario de pago no est√° listo. Por favor recarga la p√°gina.';
              messageDiv.className = 'text-red-600 text-sm mt-2 p-2 bg-red-50 rounded';
              messageDiv.classList.remove('hidden');
            }
            return;
          }

          console.log('üîÑ Procesando pago...');
          submitBtn.disabled = true;
          submitBtn.textContent = 'Procesando...';
          
          // Limpiar mensajes anteriores
          if (messageDiv) {
            messageDiv.classList.add('hidden');
          }
          
          try {
            const { error } = await currentStripe.confirmPayment({
              elements: currentElements,
              confirmParams: {
                return_url: `${window.location.origin}/purchase-success`,
              },
            });

            if (error) {
              console.error('‚ùå Error en el pago:', error);
              if (messageDiv) {
                messageDiv.textContent = error.message || 'Ocurri√≥ un error inesperado.';
                messageDiv.className = 'text-red-600 text-sm mt-2 p-2 bg-red-50 rounded';
                messageDiv.classList.remove('hidden');
              }
              submitBtn.disabled = false;
              submitBtn.textContent = `Pagar ${formatPrice(amount, currency)}`;
            } else {
              console.log('‚úÖ Pago procesado exitosamente');
              if (messageDiv) {
                messageDiv.textContent = '¬°Pago exitoso! Redirigiendo...';
                messageDiv.className = 'text-green-600 text-sm mt-2 p-2 bg-green-50 rounded';
                messageDiv.classList.remove('hidden');
              }
            }
          } catch (error) {
            console.error('‚ùå Error procesando pago:', error);
            if (messageDiv) {
              messageDiv.textContent = error instanceof Error ? error.message : 'Error al procesar el pago';
              messageDiv.className = 'text-red-600 text-sm mt-2 p-2 bg-red-50 rounded';
              messageDiv.classList.remove('hidden');
            }
            submitBtn.disabled = false;
            submitBtn.textContent = `Pagar ${formatPrice(amount, currency)}`;
          }
        });

        console.log('‚úÖ Stripe Elements inicializado completamente');

      } catch (error) {
        console.error('‚ùå Error inicializando Stripe:', error);
        const errorMessage = error instanceof Error ? error.message : 'Error desconocido';
        container.innerHTML = `
          <div class="p-4 bg-red-50 border border-red-200 rounded-md">
            <p class="text-red-800 font-medium">Error al inicializar Stripe</p>
            <p class="text-red-600 text-sm mt-1">${errorMessage}</p>
            <p class="text-red-600 text-xs mt-2">Por favor verifica la consola del navegador para m√°s detalles.</p>
          </div>
        `;
        throw error;
      }
    }

    // Estado del descuento
    let appliedDiscount: {
      code: string;
      discountCodeId: number;
      amount: number;
    } | null = null;

    // Funci√≥n para renderizar el resumen del pedido
    function renderOrderSummary() {
      console.log('üîç Iniciando renderOrderSummary...');
      const cart = getCartFromStorage();
      console.log('üõí Carrito obtenido:', cart);

      // Si el carrito est√° vac√≠o, redirigir a la p√°gina del carrito
      if (cart.items.length === 0) {
        console.log('üõí Carrito vac√≠o, redirigiendo...');
        window.location.href = '/cart';
        return null;
      }

      const orderItemsList = document.getElementById('order-items-list');
      const orderSummary = document.getElementById('order-summary');
      console.log('üéØ Elementos encontrados:', { orderItemsList, orderSummary });

      if (!orderItemsList || !orderSummary) {
        console.log('‚ùå No se encontraron los elementos del DOM');
        return cart;
      }

      // Obtener moneda del carrito (antes del map para usarla dentro)
      const cartCurrency = cart.currency || 'MXN';

      // Renderizar items
      orderItemsList.innerHTML = cart.items.map(item => `
        <li class="flex px-4 py-6 sm:px-6">
          <div class="shrink-0">
            ${item.image_url ?
              `<img src="${item.image_url}" alt="${item.name}" class="w-20 rounded-md" />` :
              `<div class="w-20 h-20 bg-muted rounded-md flex items-center justify-center">
                <span class="text-muted-foreground text-xs">Sin imagen</span>
              </div>`
            }
          </div>
          <div class="ml-6 flex flex-1 flex-col">
            <div class="flex">
              <div class="min-w-0 flex-1">
                <h4 class="text-sm">
                  <span class="font-medium text-foreground">${item.name}</span>
                </h4>
                ${item.color ? `<p class="mt-1 text-sm text-muted-foreground">Color: ${item.color}</p>` : ''}
                ${item.size ? `<p class="mt-1 text-sm text-muted-foreground">Talla: ${item.size}</p>` : ''}
                ${item.category ? `<p class="mt-1 text-sm text-muted-foreground">Categor√≠a: ${item.category}</p>` : ''}
              </div>
            </div>
            <div class="flex flex-1 items-end justify-between pt-2">
              <p class="mt-1 text-sm font-medium text-foreground">${formatPrice(item.price, item.currency || cartCurrency)}</p>
              <div class="ml-4">
                <span class="text-sm text-muted-foreground">Cantidad: ${item.quantity}</span>
              </div>
            </div>
          </div>
        </li>
      `).join('');

      // Calcular totales
      const subtotal = cart.total;
      const discountAmount = appliedDiscount?.amount || 0;
      const subtotalAfterDiscount = subtotal - discountAmount;
      const shipping = 5.00; // Env√≠o est√°ndar
      const tax = subtotalAfterDiscount * 0.16;
      const total = subtotalAfterDiscount + shipping + tax;

      // Renderizar resumen
      let summaryHTML = `
        <div class="flex items-center justify-between">
          <dt class="text-sm text-muted-foreground">Subtotal</dt>
          <dd class="text-sm font-medium text-foreground">${formatPrice(subtotal, cartCurrency)}</dd>
        </div>
      `;

      if (appliedDiscount) {
        summaryHTML += `
          <div class="flex items-center justify-between">
            <dt class="text-sm text-green-600">Descuento (${appliedDiscount.code})</dt>
            <dd class="text-sm font-medium text-green-600">-${formatPrice(discountAmount, cartCurrency)}</dd>
          </div>
        `;
      }

      summaryHTML += `
        <div class="flex items-center justify-between">
          <dt class="text-sm text-muted-foreground">Env√≠o (4-10 d√≠as h√°biles)</dt>
          <dd class="text-sm font-medium text-foreground">${formatPrice(shipping, cartCurrency)}</dd>
        </div>
        <div class="flex items-center justify-between">
          <dt class="text-sm text-muted-foreground">Impuestos (IVA 16%)</dt>
          <dd class="text-sm font-medium text-foreground">${formatPrice(tax, cartCurrency)}</dd>
        </div>
        <div class="flex items-center justify-between border-t border-border pt-6">
          <dt class="text-base font-medium text-foreground">Total</dt>
          <dd class="text-base font-medium text-foreground">${formatPrice(total, cartCurrency)}</dd>
        </div>
      `;

      orderSummary.innerHTML = summaryHTML;

      console.log('‚úÖ Resumen del pedido renderizado correctamente');
      return cart;
    }

    // Funci√≥n para aplicar c√≥digo de descuento
    async function applyDiscountCode() {
      const input = document.getElementById('discount-code') as HTMLInputElement;
      const button = document.getElementById('apply-discount') as HTMLButtonElement;
      const messageDiv = document.getElementById('discount-message');

      if (!input || !button || !messageDiv) return;

      const code = input.value.trim().toUpperCase();
      if (!code) {
        messageDiv.textContent = 'Por favor ingresa un c√≥digo';
        messageDiv.className = 'mt-2 text-sm text-red-600';
        messageDiv.classList.remove('hidden');
        return;
      }

      button.disabled = true;
      button.textContent = 'Aplicando...';

      try {
        const cart = getCartFromStorage();
        const response = await fetch('/api/validate-discount-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code: code,
            subtotal: cart.total,
            cartItems: cart.items, // Enviar items del carrito para validar productos permitidos
          }),
        });

        const data = await response.json();

        if (data.success) {
          appliedDiscount = {
            code: code,
            discountCodeId: data.discountCode.id,
            amount: data.discountAmount,
          };
          const currency = cart.currency || 'MXN';
          messageDiv.textContent = `‚úì ${data.message} - Ahorro: ${formatPrice(data.discountAmount, currency)}`;
          messageDiv.className = 'mt-2 text-sm text-green-600';
          messageDiv.classList.remove('hidden');
          input.disabled = true;
          button.textContent = 'Aplicado';
          renderOrderSummary();
        } else {
          messageDiv.textContent = data.message;
          messageDiv.className = 'mt-2 text-sm text-red-600';
          messageDiv.classList.remove('hidden');
          button.disabled = false;
          button.textContent = 'Aplicar';
        }
      } catch (error) {
        console.error('Error applying discount code:', error);
        messageDiv.textContent = 'Error al aplicar el c√≥digo de descuento';
        messageDiv.className = 'mt-2 text-sm text-red-600';
        messageDiv.classList.remove('hidden');
        button.disabled = false;
        button.textContent = 'Aplicar';
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      console.log('üöÄ DOMContentLoaded iniciado');
      
      // Primero renderizar el resumen del pedido
      console.log('üì¶ Renderizando resumen del pedido...');
      const cart = renderOrderSummary();
      console.log('üì¶ Cart despu√©s de renderizar:', cart);
      
      if (!cart) {
        console.log('‚ùå No hay cart, retornando');
        return; // Si el carrito est√° vac√≠o, ya redirigi√≥
      }

      const paymentFormContainer = document.getElementById('stripe-payment-form');
      console.log('üí≥ Payment form container:', paymentFormContainer);
      
      if (!paymentFormContainer) {
        console.log('‚ùå No se encontr√≥ el contenedor de pago');
        return;
      }

      // Mostrar mensaje inicial mientras se espera que el usuario complete los campos
      paymentFormContainer.innerHTML = '<div class="p-4 bg-muted rounded-lg"><p class="text-sm text-muted-foreground">Por favor completa todos los campos de informaci√≥n de env√≠o para continuar con el pago.</p></div>';
      console.log('‚úÖ Mensaje inicial mostrado');

      // Add discount code button listener
      const applyDiscountButton = document.getElementById('apply-discount');
      if (applyDiscountButton) {
        applyDiscountButton.addEventListener('click', applyDiscountCode);
      }

      // Also allow Enter key on discount input
      const discountInput = document.getElementById('discount-code');
      if (discountInput) {
        discountInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            applyDiscountCode();
          }
        });
      }

      // Control para evitar llamadas concurrentes y debounce
      let loadPaymentFormTimeout: ReturnType<typeof setTimeout> | null = null;
      let isLoadingPaymentForm = false;

      // Funci√≥n para intentar cargar el formulario de pago
      const loadPaymentForm = async () => {
        if (isLoadingPaymentForm) return;
        
        try {
          // Obtener datos del formulario
          const email = (document.getElementById('email-address') as HTMLInputElement)?.value;
          const firstName = (document.getElementById('first-name') as HTMLInputElement)?.value;
          const lastName = (document.getElementById('last-name') as HTMLInputElement)?.value;
          const address = (document.getElementById('address') as HTMLInputElement)?.value;
          const city = (document.getElementById('city') as HTMLInputElement)?.value;
          const state = (document.getElementById('state') as HTMLInputElement)?.value;
          const postalCode = (document.getElementById('postal-code') as HTMLInputElement)?.value;
          const country = (document.getElementById('country') as HTMLInputElement)?.value;

          // Validar que todos los campos requeridos est√©n llenos
          if (!email || !firstName || !lastName || !address || !city || !state || !postalCode || !country) {
            return;
          }

          isLoadingPaymentForm = true;

          // Mostrar loading
          paymentFormContainer.innerHTML = '<div class="flex items-center justify-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div>';

          const checkoutData = {
            email,
            firstName,
            lastName,
            address,
            city,
            state,
            postalCode,
            country,
          };

          console.log('üí≥ Creando Payment Intent con Stripe...');

          // Obtener carrito actual desde localStorage
          const cart = getCartFromStorage();
          
          if (cart.items.length === 0) {
            isLoadingPaymentForm = false;
            paymentFormContainer.innerHTML = '<p class="text-red-600">El carrito est√° vac√≠o. Por favor agrega productos antes de continuar.</p>';
            return;
          }

          // Calcular totales para validar m√≠nimo
          const cartCurrency = cart.currency || 'MXN';
          const subtotal = cart.total;
          const discountAmount = appliedDiscount?.amount || 0;
          const subtotalAfterDiscount = subtotal - discountAmount;
          const shipping = 5.00;
          const tax = subtotalAfterDiscount * 0.16;
          const total = subtotalAfterDiscount + shipping + tax;

          // Validar m√≠nimo de precio (Stripe requiere m√≠nimo $0.50 USD o $10 MXN)
          const minAmount = cartCurrency === 'USD' ? 0.50 : 10.00;
          if (total < minAmount) {
            isLoadingPaymentForm = false;
            paymentFormContainer.innerHTML = `
              <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-md">
                <p class="text-yellow-800 font-medium">Monto m√≠nimo requerido</p>
                <p class="text-yellow-700 text-sm mt-1">
                  El monto m√≠nimo de compra es ${formatPrice(minAmount, cartCurrency)}. 
                  Tu total actual es ${formatPrice(total, cartCurrency)}.
                </p>
                <p class="text-yellow-600 text-xs mt-2">
                  Por favor agrega m√°s productos a tu carrito para continuar con la compra.
                </p>
              </div>
            `;
            return;
          }

          // Llamar al API para crear el Payment Intent real
          const response = await fetch('/api/create-payment-intent', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              ...checkoutData,
              items: cart.items, // Enviar items del carrito
              shippingMethod: 'standard', // Puede ser 'standard' o 'express'
              discountCode: appliedDiscount ? {
                code: appliedDiscount.code,
                discountCodeId: appliedDiscount.discountCodeId,
                amount: appliedDiscount.amount
              } : undefined
            }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            console.error('‚ùå Error del servidor:', errorData);
            throw new Error(errorData.error || errorData.details?.[0] || 'Error al crear el pago');
          }

          const paymentData = await response.json();
          console.log('‚úÖ Payment Intent creado:', {
            paymentIntentId: paymentData.payment_intent_id,
            orderTotal: paymentData.order_total,
            hasClientSecret: !!paymentData.client_secret
          });

          if (!paymentData.client_secret) {
            throw new Error('No se recibi√≥ client_secret del servidor');
          }

          // Cargar Stripe con el client_secret real (cartCurrency ya definido arriba)
          await loadStripeForm(paymentFormContainer, paymentData.client_secret, paymentData.order_total, cartCurrency);
        } catch (error) {
          console.error('‚ùå Error completo:', error);
          isLoadingPaymentForm = false;
          const errorMessage = error instanceof Error ? error.message : 'Error desconocido';
          paymentFormContainer.innerHTML = `
            <div class="p-4 bg-red-50 border border-red-200 rounded-md">
              <p class="text-red-800 font-medium">Error al inicializar el pago</p>
              <p class="text-red-600 text-sm mt-1">${errorMessage}</p>
              <p class="text-red-600 text-xs mt-2">Por favor verifica la consola del navegador (F12) para m√°s detalles.</p>
            </div>
          `;
        } finally {
          isLoadingPaymentForm = false;
        }
      };

      // Funci√≥n con debounce para cargar el formulario
      const loadPaymentFormDebounced = () => {
        if (loadPaymentFormTimeout) clearTimeout(loadPaymentFormTimeout);
        loadPaymentFormTimeout = setTimeout(loadPaymentForm, 400);
      };

      // Agregar listeners a todos los campos requeridos (con debounce)
      const requiredFields = ['address', 'city', 'state', 'postal-code'];
      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('blur', loadPaymentFormDebounced);
          field.addEventListener('change', loadPaymentFormDebounced);
        }
      });

      // Cargar formulario al iniciar si los campos ya est√°n llenos (ej. autofill)
      setTimeout(() => {
        const email = (document.getElementById('email-address') as HTMLInputElement)?.value;
        const address = (document.getElementById('address') as HTMLInputElement)?.value;
        const city = (document.getElementById('city') as HTMLInputElement)?.value;
        const state = (document.getElementById('state') as HTMLInputElement)?.value;
        const postalCode = (document.getElementById('postal-code') as HTMLInputElement)?.value;
        if (email && address && city && state && postalCode) {
          loadPaymentForm();
        }
      }, 800);
    });
  </script>
</WebsiteLayout>
