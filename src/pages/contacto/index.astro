---
import WebsiteLayout from "@/layouts/websiteLayout.astro";
import SEO from "@/components/shared/SEO.astro";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";
import { sendEmail } from "@/lib/email";
import { getWhatsAppNumber, getWhatsAppMessage } from "@/lib/site-settings-service";

export const prerender = false;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const whatsappNumber = (await getWhatsAppNumber()) || '523322569541';
const whatsappMessage = (await getWhatsAppMessage()) || 'Hola, me gustaría obtener más información sobre sus productos.';
const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(whatsappMessage)}`;

type ContactFormValues = {
  name: string;
  city: string;
  email: string;
  phone: string;
  company: string;
  message: string;
};

const initialValues: ContactFormValues = {
  name: "",
  city: "",
  email: "",
  phone: "",
  company: "",
  message: "",
};

let formValues: ContactFormValues = { ...initialValues };
let submissionStatus: "success" | "error" | null = null;
let submissionMessage = "";

const alertStyles = {
  success: "border-emerald-300 bg-emerald-50 text-emerald-700",
  error: "border-red-300 bg-red-50 text-red-700",
} as const;

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();

  formValues = {
    name: (formData.get("name")?.toString() ?? "").trim(),
    city: (formData.get("city")?.toString() ?? "").trim(),
    email: (formData.get("email")?.toString() ?? "").trim(),
    phone: (formData.get("phone")?.toString() ?? "").trim(),
    company: (formData.get("company")?.toString() ?? "").trim(),
    message: (formData.get("message")?.toString() ?? "").trim(),
  };

  const hasEmpty = Object.entries(formValues).some(([key, value]) => key !== "company" && value.length === 0);

  if (hasEmpty) {
    submissionStatus = "error";
    submissionMessage = "Por favor completa todos los campos.";
  } else {
    try {
      const messageHtml = formValues.message.replace(/\n/g, "<br />");
      const emailSent = await sendEmail({
        to: "starinfo@starfilters.mx",
        subject: `Nuevo mensaje de contacto - ${formValues.name}`,
        html: `
          <h2>Nuevo mensaje desde el formulario de contacto</h2>
          <p><strong>Idioma:</strong> Español</p>
          <p><strong>Nombre:</strong> ${formValues.name}</p>
          <p><strong>Ciudad:</strong> ${formValues.city}</p>
          <p><strong>Correo electrónico:</strong> ${formValues.email}</p>
          <p><strong>Teléfono:</strong> ${formValues.phone}</p>
          <p><strong>Empresa:</strong> ${formValues.company || "N/A"}</p>
          <p><strong>Mensaje:</strong><br />${messageHtml}</p>
        `,
        text: `Nuevo mensaje desde el formulario de contacto (Español)\n\nNombre: ${formValues.name}\nCiudad: ${formValues.city}\nCorreo electrónico: ${formValues.email}\nTeléfono: ${formValues.phone}\nEmpresa: ${formValues.company || "N/A"}\n\nMensaje:\n${formValues.message}`,
      });

      if (emailSent) {
        submissionStatus = "success";
        submissionMessage =
          "Gracias por contactarnos. Nuestro equipo se pondrá en contacto contigo muy pronto.";
        formValues = { ...initialValues };
      } else {
        submissionStatus = "error";
        submissionMessage =
          "Ocurrió un problema al enviar tu mensaje. Inténtalo nuevamente más tarde.";
      }
    } catch (error) {
      console.error("Error al procesar el formulario de contacto:", error);
      submissionStatus = "error";
      submissionMessage =
        "Ocurrió un problema al enviar tu mensaje. Inténtalo nuevamente más tarde.";
    }
  }
}
---

<WebsiteLayout
  title="Contacto"
  seoTitle="Contacto | Star Filters"
  description="Contacta con Star Filters para servicios de filtración industrial, cuartos limpios y soporte técnico especializado. Estamos aquí para ayudarte."
  keywords={["contacto Star Filters", "soporte técnico", "servicios filtración", "cuartos limpios"]}
>
  <SEO
    slot="seo"
    title="Contacto"
    description="Contacta con Star Filters para servicios de filtración industrial."
    ogType="website"
    keywords={["contacto", "soporte técnico"]}
  />

  <div class="bg-background py-24 sm:py-32">
    <div class="mx-auto max-w-5xl px-6 lg:px-8">
      <div class="text-center max-w-3xl mx-auto mb-16">
        <h1 class="text-4xl font-semibold tracking-tight text-foreground sm:text-5xl">
          ¡Contáctanos!
        </h1>
        <p class="mt-6 text-lg leading-8 text-muted-foreground">
          ¿Listo para recibir tu cotización o necesitas asesoría técnica? Mándanos un correo, WhatsApp, llena el formulario o márcanos por teléfono y te atenderemos a la brevedad.
        </p>
      </div>

      <!-- 4 opciones de contacto -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-16">
        <a
          href="tel:+523338987991"
          class="group flex flex-col items-center gap-3 rounded-2xl border border-border/60 bg-card p-6 shadow-sm transition-all hover:border-primary/50 hover:shadow-md hover:bg-primary/5"
        >
          <div class="flex h-14 w-14 items-center justify-center rounded-xl bg-primary/10 text-primary group-hover:bg-primary group-hover:text-primary-foreground transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
          </div>
          <span class="font-semibold text-foreground">Teléfono</span>
          <span class="text-sm text-muted-foreground text-center">+52 33 3898 7991</span>
        </a>

        <a
          href={whatsappUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="group flex flex-col items-center gap-3 rounded-2xl border border-border/60 bg-card p-6 shadow-sm transition-all hover:border-[#25D366]/50 hover:shadow-md hover:bg-[#25D366]/5"
        >
          <div class="flex h-14 w-14 items-center justify-center rounded-xl bg-[#25D366]/10 text-[#25D366] group-hover:bg-[#25D366] group-hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
            </svg>
          </div>
          <span class="font-semibold text-foreground">WhatsApp</span>
          <span class="text-sm text-muted-foreground text-center">Chatea con nosotros</span>
        </a>

        <a
          href="mailto:starinfo@starfilters.mx"
          class="group flex flex-col items-center gap-3 rounded-2xl border border-border/60 bg-card p-6 shadow-sm transition-all hover:border-primary/50 hover:shadow-md hover:bg-primary/5"
        >
          <div class="flex h-14 w-14 items-center justify-center rounded-xl bg-primary/10 text-primary group-hover:bg-primary group-hover:text-primary-foreground transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
          </div>
          <span class="font-semibold text-foreground">Correo</span>
          <span class="text-sm text-muted-foreground text-center">starinfo@starfilters.mx</span>
        </a>

        <a
          href="#formulario"
          class="group flex flex-col items-center gap-3 rounded-2xl border border-border/60 bg-card p-6 shadow-sm transition-all hover:border-primary/50 hover:shadow-md hover:bg-primary/5"
        >
          <div class="flex h-14 w-14 items-center justify-center rounded-xl bg-primary/10 text-primary group-hover:bg-primary group-hover:text-primary-foreground transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
          <span class="font-semibold text-foreground">Formulario</span>
          <span class="text-sm text-muted-foreground text-center">Completa los campos</span>
        </a>
      </div>

      <!-- Formulario -->
      <div id="formulario" class="rounded-2xl border border-border/60 bg-muted/20 p-8 shadow-sm max-w-2xl mx-auto">
          <h2 class="text-2xl font-semibold text-foreground text-center">Formulario de Contacto</h2>
          <p class="mt-2 text-sm text-muted-foreground text-center">
            Completa los campos y nos pondremos en contacto contigo a la brevedad.
          </p>

          {submissionStatus && (
            <div class={`mt-6 rounded-lg border px-4 py-3 text-sm ${alertStyles[submissionStatus]}`}>
              {submissionMessage}
            </div>
          )}

          <form method="post" class="mt-8 space-y-6">
            <div class="grid gap-6 sm:grid-cols-2">
              <div>
                <label for="name" class="block text-sm font-medium text-foreground">Nombre</label>
                <input
                  id="name"
                  name="name"
                  type="text"
                  required
                  autocomplete="name"
                  value={formValues.name}
                  class="mt-2 block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary"
                />
              </div>
              <div>
                <label for="city" class="block text-sm font-medium text-foreground">Ciudad</label>
                <input
                  id="city"
                  name="city"
                  type="text"
                  required
                  autocomplete="address-level2"
                  value={formValues.city}
                  class="mt-2 block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary"
                />
              </div>
            </div>

            <div class="grid gap-6 sm:grid-cols-2">
              <div>
                <label for="email" class="block text-sm font-medium text-foreground">Correo electrónico</label>
                <input
                  id="email"
                  name="email"
                  type="email"
                  required
                  autocomplete="email"
                  value={formValues.email}
                  class="mt-2 block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary"
                />
              </div>
              <div>
                <label for="phone" class="block text-sm font-medium text-foreground">Teléfono</label>
                <input
                  id="phone"
                  name="phone"
                  type="tel"
                  required
                  autocomplete="tel"
                  value={formValues.phone}
                  class="mt-2 block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary"
                />
              </div>
            </div>

            <div>
              <label for="company" class="block text-sm font-medium text-foreground">Nombre de la empresa</label>
              <input
                id="company"
                name="company"
                type="text"
                autocomplete="organization"
                value={formValues.company}
                class="mt-2 block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary"
              />
            </div>

            <div>
              <label for="message" class="block text-sm font-medium text-foreground">Mensaje</label>
              <textarea
                id="message"
                name="message"
                required
                rows={5}
                class="mt-2 block w-full rounded-md bg-background px-3 py-2 text-base text-foreground outline-1 -outline-offset-1 outline-border placeholder:text-muted-foreground focus:outline-2 focus:-outline-offset-2 focus:outline-primary"
              >{formValues.message}</textarea>
            </div>

            <button
              type="submit"
              class="inline-flex w-full items-center justify-center rounded-md bg-primary px-4 py-2.5 text-sm font-semibold text-primary-foreground shadow-xs transition hover:bg-primary/90 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
            >
              Enviar mensaje
            </button>
          </form>
      </div>
    </div>
  </div>
</WebsiteLayout>
